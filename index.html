<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FitGarden 2.0 â€“ Fejedelem Edition ğŸ’ªğŸŒ¿</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ”¥</text></svg>">
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
  margin: 0;
  padding: 0;
  color: #222;
  overflow-x: hidden;
}
#motivationBar {
  background: #004d40;
  color: white;
  padding: 8px;
  text-align: center;
  font-style: italic;
  font-size: 0.95em;
  letter-spacing: 0.3px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
main {
  max-width: 1200px;
  margin: 10px auto;
  padding: 10px;
}
.card {
  background: white;
  border-radius: 18px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  padding: 8px;
  margin-bottom: 5px;
}
h2 {
  color: #00796b;
  margin-bottom: 10px;
}
button {
  background: #00796b;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 8px 15px;
  font-size: 0.95em;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  background: #004d40;
}
.icon-box {
  display: flex;
  justify-content: space-around;
  align-items: stretch;
  gap: 15px;
  flex-wrap: wrap;
}
.icon-card {
  flex: 1;
  min-width: 280px;
  background: #e8f5e9;
  border-radius: 12px;
  text-align: center;
  padding: 20px;
  position: relative;
  display: flex;
  flex-direction: column;
}
.icon-card i {
  font-size: 2em;
  color: #00796b;
  display: block;
}
.icon-card span {
  display: block;
  margin-top: 5px;
  font-weight: bold;
  font-size: 1.1em;
}
.edit-btn {
  position: absolute;
  top: 8px;
  right: 10px;
  background: none;
  color: #00796b;
  border: none;
  font-size: 1.1em;
  cursor: pointer;
}
.hidden { display: none; }

#tabs {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 10px;
  gap: 8px;
}
.tab-btn {
  background: #dcedc8;
  color: black;
  padding: 10px 20px;
  border-radius: 10px;
  margin: 0;
  cursor: pointer;
  transition: 0.3s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.tab-btn.active {
  background: #00796b;
  color: white;
  font-weight: bold;
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ================================================== */
/* ===== CÃ‰L/JUTALOM ELRENDEZÃ‰S ===== */
/* ================================================== */
.flex-container {
  display: flex;
  gap: 25px;
  flex-wrap: wrap;
  align-items: flex-start;
}
.flex-container > .card {
  flex: 1;
  min-width: 300px;
}

/* ================================================== */
/* ===== KÃRTYA FEJLÃ‰C (CÃM + GOMB/PONTOK) STÃLUS ===== */
/* ================================================== */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.card-header h2 {
  margin-bottom: 0;
}
/* ÃšJ STÃLUS A FEJLÃ‰C ARCHÃV GOMBJÃHOZ */
.card-header .card-header-add-btn {
Â  background: #00796b;  /* VilÃ¡gosabb zÃ¶ld, mint az archÃ­v gomb */
Â  font-size: 0.9em;
Â  padding: 6px 12px;
Â  font-weight: bold;
}
.card-header .new-note-btn-left {
    margin-right: auto; /* Ez tolja el a gombot balra, amennyire csak lehet */

}
.card-header .card-header-add-btn:hover {
Â  background: #004d40; /* SÃ¶tÃ©tebb zÃ¶ld hover-re */
}
/* ================================================== */

/* ================================================== */
/* ===== PONTSZÃMLÃLÃ“ (JUTALMAK FEJLÃ‰C) ===== */
/* ================================================== */
.header-points-display {
  display: flex;
  align-items: center;
  font-weight: bold;
}
.header-points-display .points-icon {
  font-size: 1.3em;
  margin-right: 8px;
  color: #00796b; /* TÃ©ma zÃ¶ld */
  line-height: 1;
}
.header-points-display .points-number {
  color: #004d40; /* SÃ¶tÃ©t zÃ¶ld */
  font-size: 1.4em; /* Kiemelt szÃ¡m */
  line-height: 1;
}
.header-points-display .points-label {
  color: #00796b; /* TÃ©ma zÃ¶ld */
  margin-left: 5px;
  font-size: 1.1em;
  line-height: 1;
}
/* ================================================== */

/* ================================================== */
/* ===== ÃšJ GOMB STÃLUS (KÃRTYA ALJÃN) ===== */
/* ================================================== */
.new-item-button {
  width: 100%; /* Teljes szÃ©lessÃ©g */
  padding: 12px; /* Nagyobb, kÃ©nyelmesebb gomb */
  font-size: 1em;
  font-weight: bold;
  margin-top: 15px; /* TÃ¡volsÃ¡g a listÃ¡tÃ³l */
}
/* ================================================== */


/* ================================================== */
/* ===== CÃ‰L, JUTALOM, Ã‰TEL SÃV STÃLUS ===== */
/* ================================================== */
.goal-item, .reward-item, .food-item {
  background: transparent;
  border-radius: 10px;
  padding: 0;
  margin-bottom: 8px;
  display: flex;
  overflow: hidden;
  align-items: stretch;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.completed {
  text-decoration: line-through;
  opacity: 0.7;
}

.item-name {
  flex: 1;
  padding: 10px 15px;
  background: #e8f5e9; /* VilÃ¡gos zÃ¶ld */
  display: flex;
  flex-direction: column; /* MÃ“DOSÃTVA */
  align-items: flex-start; /* MÃ“DOSÃTVA */
}
.item-points {
  flex-shrink: 0;
  align-items: center;
  justify-content: center;
  width: 69px;
  padding: 10px;
  background: #dcedc8; /* Ãrnyalattal sÃ¶tÃ©tebb zÃ¶ld */
  text-align: center;
  font-weight: bold;
  border-left: 1px solid #c8e6c9;
  border-right: 1px solid #c8e6c9;
  display: flex;
  align-items: center;
  justify-content: center;
}
/* ÃšJ STÃLUS AZ Ã‰TEL KÃRTYÃHOZ */
.food-item .item-details {
  flex-shrink: 0;
  width: 120px;
  padding: 10px;
  background: #dcedc8;
  text-align: center;
  font-weight: bold;
  border-left: 1px solid #c8e6c9;
  border-right: 1px solid #c8e6c9;
  font-size: 0.9em;
  line-height: 1.3;
}
.food-item .item-details span {
  display: block;
}
/* ================================================== */

.item-actions {
  flex-shrink: 0;
  padding: 10px 10px;
  background: #e8f5e9; /* VilÃ¡gos zÃ¶ld */
  display: flex;
  gap: 5px;
  justify-content: center;
  align-items: center;
}

.item-actions button {
  background: transparent;
  color: #00796b;
  font-size: 1.1em;
  cursor: pointer;
  padding: 5px;
}

/* ÃšJ STÃLUSOK AZ ARCHIVÃLÃSHOZ */
.item-actions button.archive-btn {
  color: #004d40; /* SÃ¶tÃ©tzÃ¶ld az archivÃ¡lÃ¡shoz */
}
/* StÃ­lus az archivÃ¡lt elemek gombjaihoz */
#archivedGoalList .item-actions button.reactivate-btn {
  color: #00796b; /* ZÃ¶ld */
}
#archivedGoalList .item-actions button.delete-btn {
  color: #c00; /* Piros */
}


.category-title {
  margin-top: 20px;
  margin-bottom: 8px;
  color: #004d40;
  border-bottom: 2px solid #b2dfdb;
  padding-bottom: 4px;
  font-size: 1.1em;
}
#goalList .category-title:first-of-type {
  margin-top: 10px;
}

/* ================================================== */
/* ===== ÃšJ ALCÃ‰L (SUB-GOAL) STÃLUSOK ===== */
/* ================================================== */
.subgoal-list {
  margin-top: 10px;
  padding-left: 15px;
  font-size: 0.9em;
  text-align: left;
  width: 100%; /* KitÃ¶lti a .item-name szÃ©lessÃ©gÃ©t */
}
.subgoal-list div {
  display: flex;
  align-items: center;
  margin-bottom: 5px;
  text-decoration: none; /* Ne hÃºzza Ã¡t az alcÃ©l szÃ¶vegÃ©t */
}
.subgoal-list input[type="checkbox"] {
  width: auto;
  margin: 0 10px 0 0;
}
.subgoal-list span.subgoal-done {
  text-decoration: line-through;
  opacity: 0.7;
}
/* Amikor a FÅ cÃ©l kÃ©sz, a FÅ cÃ­m Ã¡thÃºzva */
.goal-item.completed .item-name-main {
  text-decoration: line-through;
}
/* De a sub-goal lista soha (csak a belsÅ‘ span) */
.goal-item.completed .subgoal-list {
  text-decoration: none;
}
/* ================================================== */


.log {
  background: #f8f8f8;
  border-radius: 10px;
  padding: 10px;
  max-height: 300px;
  overflow-y: auto;
}
.log-entry {
  border-bottom: 1px solid #ddd;
  padding: 6px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.log-entry span {
  flex: 1;
  padding-right: 10px;
}
.log-entry small { color: #777; font-size: 0.85em; margin-left: 10px; }
.log-entry button {
  flex-shrink: 0;
}

.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  border-radius: 15px;
  padding: 20px;
  width: 90%;
  max-width: 400px;
}
.modal-content h3 { margin-top: 0; color: #00796b; text-align: center; }

input, textarea, select {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 1em;
  box-sizing: border-box;
  background-color: white; /* Select hÃ¡tÃ©rszÃ­n */
}

/* ================================================== */
/* ===== GRAFIKON MODAL STÃLUSOK ===== */
/* ================================================== */
#chartModalContent {
  max-width: 90%;
  width: 800px;
}

#progressChart {
  width: 100%;
  height: 400px;
}
/* ================================================== */


/* ====== KÃ–VETÃ‰S STÃLUSOK ====== */
.icon-card .content-wrapper {
  margin-top: 15px;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
}
.progress-summary {
  font-size: 0.9em;
  font-weight: bold;
  color: #004d40;
  margin-top: 10px;
  margin-bottom: 10px;
  height: 1.2em;
}
.input-group {
  display: flex;
  margin-top: 10px;
  gap: 5px;
}
.input-group input {
  flex: 1;
  width: 60%;
  margin: 0;
  font-size: 0.9em;
  text-align: center;
}
.input-group button {
  flex-shrink: 0;
  font-size: 0.85em;
  padding: 8px 10px;
}
.progress-bar-container {
  background: #c8e6c9;
  border-radius: 10px;
  height: 12px;
  width: 100%;
  margin-top: 10px;
  overflow: hidden;
  border: 1px solid #a5d6a7;
}
.progress-bar {
  background: #00796b;
  height: 100%;
  width: 0%;
  border-radius: 10px;
  transition: width 0.5s ease;
}

/* ÃšJ: A PROTEIN SÃV SZÃNE */
#proteinProgressBar {
  background: #8e24aa; /* Lila */
}

/* ====== ANIMÃCIÃ“K ====== */
.fade-in {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeIn 0.6s ease forwards;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
button, .tab-btn {
  transition: transform 0.15s ease, background-color 0.3s;
}
button:hover, .tab-btn:hover {
  transform: scale(1.03);
}

/* ====== EXPORT / RESET PANEL ====== */
#controlPanel {
  text-align: center;
  margin-top: 25px;
}
#controlPanel button {
  background: #004d40;
  margin: 5px;
}
#controlPanel input[type="file"] {
  display: none;
}


/* ================================================== */
/* ===== ÃšJ JEGYZET STÃLUSOK ===== */
/* ================================================== */
#noteViewModal .modal-content {
  background: #f1f8e9;
  max-width: 600px;
}
#noteViewText {
  background: #ffffff;
  border-radius: 8px;
  padding: 15px;
  min-height: 100px;
  max-height: 60vh;
  overflow-y: auto;
  white-space: pre-wrap;
  border: 1px solid #dcedc8;
}
.note-summary-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #e8f5e9;
  padding: 12px 15px;
  border-radius: 10px;
  margin-bottom: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.note-summary-title {
  flex: 1;
  font-weight: bold;
  font-size: 1.1em;
  color: #004d40;
  cursor: pointer;
  margin-right: 10px;
}
.note-summary-date {
  font-size: 0.85em;
  color: #555;
  margin-right: 15px;
  flex-shrink: 0;
}
.note-summary-actions button {
  background: transparent;
  color: #00796b;
  font-size: 1.1em;
  padding: 5px;
}
#editInputText {
  height: 150px;
  resize: vertical;
  font-family: 'Segoe UI', sans-serif;
}
/* ================================================== */
/* ===== ÃšJ KOMPAKT FÅOLDALI CÃ‰LOK STÃLUS ===== */
/* ================================================== */
#compactGoalsContainer {
  display: grid; /* JAVÃTÃS: ÃtÃ¡llÃ¡s Grid-re */
  grid-template-columns: 1fr 1fr 1fr 1fr auto; /* AlapÃ©rtelmezett: 4 adat oszlop + 1 gomb oszlop */
  background: white;
  border-radius: 18px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  padding: 12px 15px;
  margin-bottom: 5px;
  align-items: center; /* JAVÃTÃS: FÃ¼ggÅ‘legesen kÃ¶zÃ©pre igazÃ­tjuk az egÃ©szet */
  gap: 12px; 
  /* flex-wrap tÃ¶rÃ¶lve */
}
.compact-goal-item {
  min-width: 0; /* Ez marad, hogy a szÃ¶veg levÃ¡gÃ³dhasson (...) */
  text-align: left; 
}
.compact-goal-item .label {
  font-size: 0.85em;
  color: #00796b;
  display: block;
  font-weight: bold;
  white-space: nowrap; 
}
.compact-goal-item .value {
  display: block;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
/* ÃšJ: FelsÅ‘ szÃ¶veg (pl. 0.7/2.0 L) */
.compact-goal-item .value-top {
  font-size: 1.0em;
  color: #333; /* KevÃ©sbÃ© hangsÃºlyos */
  font-weight: 500;
  margin-top: 2px;
}
/* ÃšJ: AlsÃ³ szÃ¶veg (pl. MÃ©g 1.3 L) */
.compact-goal-item .value-bottom {
  font-size: 0.9em;
  color: #004d40;
  font-weight: bold;
  margin-top: 3px;
}
/* A SÃºly felsÅ‘ sora mÃ¡skÃ©pp nÃ©z ki */
.compact-goal-item .value-weight-top {
  font-size: 0.9em;
  color: #333;
  font-weight: 500;
}


#compactBtnWrapper {
  display: flex;
  gap: 8px;
  /* margin-left: auto; TÃ–RÃ–LVE */
  /* flex-shrink: 0; TÃ–RÃ–LVE */
  align-self: center; 
}

#quickAddBtn, #compactEditBtn, #compactChartBtn {
Â  flex-shrink: 0;Â 
Â  background: #004d40;
Â  padding: 10px 12px;
Â  font-size: 1.2em;
Â  line-height: 1;
Â  border-radius: 12px;
}

#compactEditBtn, #compactChartBtn {
Â  background: #00796b;
Â  font-size: 1.1em;Â 
Â  padding: 11px 12px;Â 
}
.compact-progress-bar-container {
  background: #c8e6c9;
  border-radius: 10px;
  height: 10px; 
  width: 100%;
  margin-top: 4px; /* KÃ¶zelebb a felsÅ‘ szÃ¶veghez */
  overflow: hidden;
  border: 1px solid #a5d6a7;
}
.compact-progress-bar {
  background: #00796b;
  height: 100%;
  width: 0%;
  border-radius: 10px;
  transition: width 0.5s ease;
}
/* Protein sÃ¡v szÃ­ne */
#compactProteinBar, #compactWeightBar { /* SÃºly is lila lesz */
  background: #8e24aa; 
}

/* ÃšJ: ReszponzÃ­v tÃ¶rÃ©spont telefonra */
@media (max-width: 800px) {
  #compactGoalsContainer {
    grid-template-columns: 1fr 1fr; /* 2 oszlopos elrendezÃ©s */
    gap: 15px; /* Nagyobb tÃ©rkÃ¶z mobilon */
    align-items: flex-end; /* VisszaÃ¡llÃ­tjuk alulra igazÃ­tÃ¡sra */
  }
  #compactBtnWrapper {
    grid-column: 1 / -1; /* A gombok Ã¡tnyÃºlnak mindkÃ©t oszlopon */
    justify-content: center; /* KÃ¶zÃ©pre igazÃ­tja a gombokat a soron belÃ¼l */
  }
}
/* ================================================== */
/* ===== ÃšJ EDZÃ‰S STÃLUSOK (NAPTÃR TÃ–RÃ–LVE) ===== */
/* ================================================== */
.workout-adder {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}
.workout-adder input[type="date"] {
  flex: 1; /* A dÃ¡tumvÃ¡lasztÃ³ tÃ¶ltse ki a helyet */
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 10px;
  font-size: 1em;
}
.workout-adder button {
  flex-shrink: 0; /* A gomb ne zsugorodjon */
  padding: 10px 15px;
  font-weight: bold;
}
.workout-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #e8f5e9;
  padding: 12px 15px;
  border-radius: 10px;
  margin-bottom: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.workout-item span {
  font-weight: bold;
  font-size: 1.1em;
  color: #004d40;
  cursor: pointer; /* HOZZÃADVA */
  flex: 1; /* HOZZÃADVA */
  margin-right: 10px; /* HOZZÃADVA */
}
.workout-item button {
  background: transparent;
  color: #c00; /* VÃ¶rÃ¶s a tÃ¶rlÃ©shez */
  font-size: 1.2em;
}
/* EZT A GOMBOT ADJUK HOZZÃ A SZERKESZTÃ‰SHEZ */
.workout-item button.edit-note-btn {
  color: #00796b; /* TÃ©ma zÃ¶ld */
  font-size: 1.1em;
}

/* ================================================== */
/* ===== ÃšJ Ã‰TEL PROGRESS BAR STÃLUSOK ===== */
/* ================================================== */
.meal-progress-container {
    margin-top: 10px;
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.meal-progress-wrapper {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.85em;
}
.meal-progress-label {
    width: 65px; /* SzÃ©lesebb a "KalÃ³ria:" miatt */
    font-weight: bold;
    color: #333;
    flex-shrink: 0;
}
.meal-progress-bar-bg {
    background: #e0e0e0;
    border-radius: 5px;
    height: 10px;
    width: 100%;
    overflow: hidden;
}
.meal-progress-bar-fill {
    background: #ff9800; /* KalÃ³ria - narancs */
    height: 100%;
    border-radius: 5px;
    transition: width 0.5s ease;
}
.meal-progress-bar-fill.protein {
    background: #8e24aa; /* Protein - lila */
}
/* ================================================== */
/* ================================================== */
</style>
</head>
<body>

<div id="loginContainer" style="padding: 20px; max-width: 400px; margin: 40px auto; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
  <h2 style="color: #00796b; text-align: center;">FitGarden 2.0</h2>
  <h3 style="text-align: center;">BelÃ©pÃ©s / RegisztrÃ¡ciÃ³</h3>
  <label>Email</label>
  <input type="email" id="loginEmail" placeholder="email@cim.com">
  <label>JelszÃ³</label>
  <input type="password" id="loginPassword" placeholder="min. 6 karakter">
  <div style="display: flex; gap: 10px; margin-top: 15px;">
    <button onclick="handleLogin()" style="flex: 1;">BelÃ©pÃ©s</button>
    <button onclick="handleSignUp()" style="flex: 1; background: #004d40;">RegisztrÃ¡ciÃ³</button>
  </div>
  <p id="loginError" style="color: red; text-align: center; margin-top: 10px;"></p>
</div>

<div id="appContainer" style="display: none;">

	<div id="motivationBar">Tipp: â€A lustasÃ¡g a gyengÃ©k vallÃ¡sa. TÃ¶rj ki belÅ‘le.â€</div>

	<main>
	  <div id="tabs">
	    <div class="tab-btn active" onclick="showTab('main')">ğŸ  FÅ‘oldal</div>
	    <div class="tab-btn" onclick="showTab('notes')">ğŸ“ Jegyzetek</div>
        <div class="tab-btn" onclick="showTab('reminders')">ğŸ”” EmlÃ©keztetÅ‘k</div>
        <div class="tab-btn" onclick="showTab('meals')">ğŸ— Ã‰tkezÃ©s</div>
	    <div class="tab-btn" onclick="showTab('history')">ğŸ“ˆ HaladÃ¡s</div>
	    <div class="tab-btn" onclick="showTab('workouts')">ğŸ‹ï¸â€â™‚ï¸ EdzÃ©sek</div>
	  </div>
	  <div id="compactGoalsContainer">
	      
	      <div class="compact-goal-item">
	        <span class="label">SÃºly âš–ï¸</span>
	        <span class="value value-top" id="compactWeightTop">--/-- kg</span>
	        <div class="compact-progress-bar-container">
	          <div class="compact-progress-bar" id="compactWeightBar"></div>
	        </div>
	        <span class="value value-bottom" id="compactWeightBottom">MÃ©g...</span>
	      </div>
	      
	      <div class="compact-goal-item">
	        <span class="label">VÃ­z ğŸ’§</span>
	        <span class="value value-top" id="compactWaterTop">--/-- L</span>
	        <div class="compact-progress-bar-container">
	          <div class="compact-progress-bar" id="compactWaterBar"></div>
	        </div>
	        <span class="value value-bottom" id="compactWaterBottom">MÃ©g...</span>
	      </div>
	      
	      <div class="compact-goal-item">
	        <span class="label">KalÃ³ria ğŸ”¥</span>
	        <span class="value value-top" id="compactCalTop">--/-- kcal</span>
	        <div class="compact-progress-bar-container">
	          <div class="compact-progress-bar" id="compactCalBar"></div>
	        </div>
	        <span class="value value-bottom" id="compactCalBottom">MÃ©g...</span>
	      </div>
	      
	      <div class="compact-goal-item">
	        <span class="label">Protein ğŸ¥©</span>
	        <span class="value value-top" id="compactProteinTop">--/-- g</span>
	        <div class="compact-progress-bar-container">
	          <div class="compact-progress-bar" id="compactProteinBar"></div>
	        </div>
	        <span class="value value-bottom" id="compactProteinBottom">MÃ©g...</span>
	      </div>
	      
	      <div id="compactBtnWrapper">
	        <button id="compactChartBtn" onclick="openChartModal()" title="SÃºly Grafikon">ğŸ“ˆ</button>
	        <button id="compactEditBtn" onclick="editGoals()" title="CÃ©lok BeÃ¡llÃ­tÃ¡sa">âœï¸</button>
	        <button id="quickAddBtn" onclick="openQuickAddModal()" title="Gyors BejegyzÃ©s">+</button>
	    </div>
</div>
	  <div id="main" class="tab-content active">
	    <div class="flex-container">
	      <div class="card">
	        <div class="card-header">
	          <h2>âœ… CÃ©lok</h2>
	          <button class="archive-header-btn" onclick="openArchiveModal()">ğŸ“¥ ArchÃ­vum</button>
	        </div>
	        <div id="goalList"></div>
	        <button onclick="openModal('goalModal')" class="new-item-button">+ Ãšj cÃ©l</button>
	      </div>
	      <div class="card">
	        <div class="card-header">
	          <h2>ğŸ Jutalmak</h2>
	          <div class="header-points-display">
	            <span class="points-icon">ğŸ’</span>
	            <span id="totalPointsDisplay" class="points-number">0</span>
	            <span class="points-label"> pont</span>
	          </div>
	        </div>
	        <div id="rewardList"></div>
	        <button onclick="openModal('rewardModal')" class="new-item-button">+ Ãšj jutalom</button>
	      </div>
	    </div> 
	  </div>
	  <div id="notes" class="tab-content">
	Â  Â  <div class="card">
	Â  Â  	<div class="card-header">
	Â  Â  Â  		<button onclick="openAddNoteModal()" class="card-header-add-btn new-note-btn-left">+ Ãšj jegyzet</button>
	Â  Â  	</div>
	Â  Â  	<div id="notesList"></div>
	Â  Â  </div>
	Â  </div>
      <div id="reminders" class="tab-content">
	    <div class="card">
	      <h2>ğŸ”” Ãšj emlÃ©keztetÅ‘</h2>
	      <p>Kapj Ã©rtesÃ­tÃ©st a bÃ¶ngÃ©szÅ‘dtÅ‘l a megadott idÅ‘pontban. A funkciÃ³ hasznÃ¡latÃ¡hoz engedÃ©lyezned kell az Ã©rtesÃ­tÃ©seket, ha a bÃ¶ngÃ©szÅ‘ rÃ¡kÃ©rdez.</p>
	      
	      <label for="reminderTextInput">EmlÃ©keztetÅ‘ szÃ¶vege</label>
	      <input type="text" id="reminderTextInput" placeholder="pl. Idd meg a vizet!">
	      
	      <label for="reminderTimeInput">IdÅ‘pont</label>
	      <input type="datetime-local" id="reminderTimeInput">
	      
	      <button onclick="addReminder()" style="margin-top: 10px;">ğŸ’¾ EmlÃ©keztetÅ‘ MentÃ©se</button>
	    </div> 
	    <div class="card">
	      <h2>AktÃ­v emlÃ©keztetÅ‘k</h2>
	      <div id="reminderList" class="log" style="max-height: 400px; overflow-y: auto;">
	        <p>Nincsenek aktÃ­v emlÃ©keztetÅ‘k.</p>
	      </div>
	    </div>
	  </div>
      <div id="meals" class="tab-content">
	    
	    <div class="card">
	      <h2>Mentett Ã©telek</h2>
	      <p>Itt kezelheted az Ã©teleket, amiket gyakran fogyasztasz. Fogyaszd el Å‘ket, hogy automatikusan frissÃ¼ljÃ¶n a kalÃ³ria- Ã©s fehÃ©rjebeviteled.</p>
	      <div id="mealList">
	        </div>
	      <button onclick="openMealModal()" class="new-item-button">+ Ãšj Ã©tel hozzÃ¡adÃ¡sa</button>
	    </div>
	  </div>

<div id="history" class="tab-content">
	    <div class="card">
	      <h2>ğŸ“… Adat TÃ¶rtÃ©net (SÃºly, VÃ­z, KalÃ³ria, Protein)</h2>
	      <div id="historyList" class="log"></div>
	    </div>

		<div class="card">
	      <h2>ğŸ’ Pont TÃ¶rtÃ©net</h2>
	      <div id="pointsHistoryList" class="log"></div>
	      </div>
		<div class="card">
	      <h2>ğŸ“œ NaplÃ³</h2>
	      <div class="log" id="activityLog"></div>
	      <button style="margin-top:10px" onclick="clearAllLogs()">ğŸ§¹ NaplÃ³ tÃ¶rlÃ©se</button>
	    </div>
	    
	    <div class="card fade-in" id="controlPanel">
	      <h2>ğŸ§  Fejedelem Kontrollpanel</h2>
	      <p>AdatmentÃ©s, visszaÃ¡llÃ­tÃ¡s Ã©s teljes reset</p>
	      <button onclick="exportData()">ğŸ’¾ ExportÃ¡lÃ¡s</button>
	      <button onclick="document.getElementById('importFile').click()">ğŸ“‚ ImportÃ¡lÃ¡s</button>
	      <input type="file" id="importFile" accept=".json" onchange="importData(event)">
	      <button style="background:#b71c1c" onclick="resetAll()">âš ï¸ Teljes reset</button>
          <button onclick="handleLogout()" style="background:#555">ğŸšª KijelentkezÃ©s</button>
	    </div>
		</div>

	  <div id="workouts" class="tab-content">
	    <div class="card">
	      <h2>ğŸ“… EdzÃ©s rÃ¶gzÃ­tÃ©se</h2>
	      <p>VÃ¡laszd ki a napot, Ã©s rÃ¶gzÃ­tsd az edzÃ©st.</p>
	      <div class="workout-adder">
	        <input type="date" id="workoutDateInput">
	        <button onclick="addWorkout()">ğŸ‹ï¸â€â™‚ï¸ EdzÃ©s rÃ¶gzÃ­tÃ©se</button>
	      </div>
	      
	      <h2 style="margin-top: 25px;">RÃ¶gzÃ­tett edzÃ©sek</h2>
	      <div id="workoutList">
	        </div>
	    </div>
	  </div>

	</main>

	<div class="modal" id="noteViewModal">
	  <div class="modal-content">
	    <h3 id="noteViewTitle">Jegyzet cÃ­me</h3>
	    <div id="noteViewText">
	      Jegyzet tartalma...
	    </div>
	    <div style="text-align:center;margin-top:15px;">
	      <button style="background:#ccc;color:black;" onclick="closeModal('noteViewModal')">BezÃ¡rÃ¡s</button>
	    </div>
	  </div>
	</div>

	<div class="modal" id="chartModal">
	  <div class="modal-content" id="chartModalContent">
	    <h3>ğŸ“ˆ SÃºly Grafikon</h3>
	    <canvas id="progressChart"></canvas>
	    <div style="text-align:center;margin-top:15px;">
	      <button style="background:#ccc;color:black;" onclick="closeModal('chartModal')">BezÃ¡rÃ¡s</button>
	    </div>
	  </div>
	</div>
	<div class="modal" id="noteModal">
	Â  <div class="modal-content">
	Â  Â  <h3>ğŸ“ Ãšj jegyzet</h3>
	Â  Â  <label for="noteTitleInput">CÃ­m</label>
	Â  Â  <input id="noteTitleInput" type="text" placeholder="Jegyzet cÃ­me...">
	Â  Â  
	Â  Â  <label for="noteCategoryInput">KategÃ³ria (opcionÃ¡lis)</label>
	Â  Â  <input id="noteCategoryInput" type="text" placeholder="pl. EdzÃ©sterv, BevÃ¡sÃ¡rlÃ¡s..." list="noteCategoryDatalist">
	Â  Â  <datalist id="noteCategoryDatalist"></datalist>
	Â  Â  
	Â  Â  <label for="noteTextInput">SzÃ¶veg</label>
	Â  Â  <textarea id="noteTextInput" rows="6" placeholder="Ãrj ide valamit..."></textarea>
	Â  Â  
	Â  Â  <div style="text-align:center;margin-top:15px;">
	Â  Â  Â  <button onclick="saveNote()">âœ… MentÃ©s</button>
	Â  Â  Â  <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('noteModal')">MÃ©gse</button>
	Â  Â  </div>
	Â  </div>
	</div>
	<div class="modal" id="goalSetupModal">
	  <div class="modal-content">
	    <h3>ğŸ¯ CÃ©lok beÃ¡llÃ­tÃ¡sa</h3>
	    <label>IdeÃ¡lis sÃºly (kg)</label>
	    <input id="goalWeightInput" type="number" placeholder="pl. 75">
	    <label>Napi vÃ­z cÃ©l (liter)</label>
	    <input id="goalWaterInput" type="number" step="0.1" placeholder="pl. 2.5">
	    <label>Napi kalÃ³ria cÃ©l (kcal)</label>
	    <input id="goalCalInput" type="number" placeholder="pl. 2200">
	    <label>Napi protein cÃ©l (gramm)</label>
	    <input id="goalProteinInput" type="number" placeholder="pl. 120">
	    
	    <div style="text-align:center;margin-top:15px;">
	      <button onclick="saveGoalSettings()">ğŸ’¾ MentÃ©s</button>
	      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('goalSetupModal')">MÃ©gse</button>
	    </div>
	  </div>
	</div>

	<div class="modal" id="goalModal">
	  <div class="modal-content">
	    <h3>ğŸ¯ Ãšj cÃ©l</h3>
	    <label>CÃ©l neve</label>
	    <input id="goalNameInput" type="text" placeholder="pl. 10.000 lÃ©pÃ©s">
	    <label>Pont Ã©rtÃ©k</label>
	    <input id="goalPointsInput" type="number" placeholder="pl. 10 (0 is lehet)">
	    <label>KategÃ³ria (opcionÃ¡lis)</label>
	    <input id="goalCategoryInput" type="text" placeholder="pl. ValÃ³sÃ¡g (vÃ¡lassz vagy Ã­rj be Ãºjat)" list="categoryDatalist">
	    <datalist id="categoryDatalist">
	      </datalist>
	    
	    <label>AlcÃ©lok (opcionÃ¡lis, minden sor egy alcÃ©l)</label>
    <textarea id="goalSubGoalsInput" rows="5" placeholder="pl. Csere cipÅ‘&#10;EdzÅ‘ nadrÃ¡g&#10;TÃ¶rÃ¶lkÃ¶zÅ‘..."></textarea>
    
    <div style="margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <label for="goalIsRecurringInput" style="margin: 0; cursor: pointer;">IsmÃ©tlÅ‘dÅ‘ cÃ©l?</label>
            <input type="checkbox" id="goalIsRecurringInput" onchange="document.getElementById('goalRecurrenceOptions').style.display = this.checked ? 'block' : 'none'" style="width: auto; margin: 0; transform: scale(1.3);">
        </div>
        <div id="goalRecurrenceOptions" style="display: none; margin-top: 10px;">
            <label for="goalRecurrenceSelect">IsmÃ©tlÅ‘dÃ©s gyakorisÃ¡ga</label>
            <select id="goalRecurrenceSelect">
                <option value="daily">Naponta</option>
                <option value="2days">2 naponta</option>
                <option value="3days">3 naponta</option>
                <option value="4days">4 naponta</option>
                <option value="5days">5 naponta</option>
                <option value="6days">6 naponta</option>
                <option value="weekly">Hetente</option>
                <option value="monthly">Havonta</option>
            </select>
        </div>
    </div>
    <div style="text-align:center;margin-top:15px;">
      <button onclick="saveGoal()">âœ… MentÃ©s</button>
      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('goalModal')">MÃ©gse</button>
    </div>
	  </div>
	</div>

	<div class="modal" id="rewardModal">
	  <div class="modal-content">
	    <h3>ğŸ Ãšj jutalom</h3>
	    <label>Jutalom neve</label>
	    <input id="rewardNameInput" type="text" placeholder="pl. PihenÅ‘nap">
	    <label>Pont Ã¡ra</label>
	    <input id="rewardCostInput" type="number" placeholder="pl. 20">
	    <div style="text-align:center;margin-top:15px;">
	      <button onclick="saveReward()">âœ… MentÃ©s</button>
	      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('rewardModal')">MÃ©gse</button>
	    </div>
	  </div>
	</div>

	<div class="modal" id="editModal">
	  <div class="modal-content">
	    <h3 id="editTitle">âœï¸ SzerkesztÃ©s</h3>
	    
	    <label id="editLabel1"></label>
	    <input id="editInput1" type="text">
	    
	    <label id="editLabel2"></label>
	    <input id="editInput2" type="number">
	    
	    <label id="editLabel3" style="display:none;"></label>
	    <input id="editInput3" type="text" style="display:none;">
		<label id="editLabelSubGoals" style="display:none;">AlcÃ©lok (minden sor egy alcÃ©l)</label>
	    <textarea id="editInputSubGoals" rows="5" style="display:none;"></textarea>

	    <label id="editLabelText" style="display:none;">SzÃ¶veg</label>
	    <textarea id="editInputText" style="display:none;"></textarea>
	    
<div id="editRecurringFields" style="display: none; margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <label for="editIsRecurringInput" style="margin: 0; cursor: pointer;">IsmÃ©tlÅ‘dÅ‘ cÃ©l?</label>
            <input type="checkbox" id="editIsRecurringInput" onchange="document.getElementById('editRecurrenceOptions').style.display = this.checked ? 'block' : 'none'" style="width: auto; margin: 0; transform: scale(1.3);">
        </div>
        <div id="editRecurrenceOptions" style="display: none; margin-top: 10px;">
            <label for="editRecurrenceSelect">IsmÃ©tlÅ‘dÃ©s gyakorisÃ¡ga</label>
            <select id="editRecurrenceSelect">
                <option value="daily">Naponta</option>
                <option value="2days">2 naponta</option>
                <option value="3days">3 naponta</option>
                <option value="4days">4 naponta</option>
                <option value="5days">5 naponta</option>
                <option value="6days">6 naponta</option>
                <option value="weekly">Hetente</option>
                <option value="monthly">Havonta</option>
            </select>
        </div>
    </div>
	    <div id="editMealFields" style="display: none;">
	        <label for="editMealType">TÃ­pus</label>
	        <select id="editMealType">
	            <option value="unit">Darab alapÃº</option>
	            <option value="weight">SÃºly alapÃº (100g)</option>
	        </select>
	        <label for="editMealKcal">KalÃ³ria (kcal)</label>
	        <input id="editMealKcal" type="number" placeholder="pl. 150">
	        <label for="editMealProtein">FehÃ©rje (g)</label>
	        <input id="editMealProtein" type="number" placeholder="pl. 12">
	    </div>

	    <div style="text-align:center;margin-top:15px;">
	      <button onclick="confirmEdit()">ğŸ’¾ MentÃ©s</button>
	      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('editModal')">MÃ©gse</button>
	    </div>
	  </div>
	</div>

	<div class="modal" id="archiveModal">
	  <div class="modal-content" style="max-width: 600px;">
	    <h3>ğŸ“¥ ArchivÃ¡lt CÃ©lok</h3>
	    <div id="archivedGoalList" style="max-height: 400px; overflow-y: auto;">
	      </div>
	    <div style="text-align:center;margin-top:15px;">
	      <button style="background:#ccc;color:black;" onclick="closeModal('archiveModal')">BezÃ¡rÃ¡s</button>
	    </div>
	  </div>
	</div>
	
	<div class="modal" id="mealModal">
	  <div class="modal-content">
	    <h3>Ãšj Ã©tel hozzÃ¡adÃ¡sa</h3>
	    <label for="mealNameInput">Ã‰tel neve</label>
	    <input id="mealNameInput" type="text" placeholder="pl. FÅ‘tt tojÃ¡s">
	    
	    <label for="mealTypeSelect">SzÃ¡molÃ¡s tÃ­pusa</label>
	    <select id="mealTypeSelect" onchange="updateMealModalLabels()">
	        <option value="unit">Darab alapÃº</option>
	        <option value="weight">SÃºly alapÃº (100g)</option>
	    </select>
	    
	    <label id="mealKcalLabel" for="mealKcalInput">KalÃ³ria (kcal/darab)</label>
	    <input id="mealKcalInput" type="number" placeholder="pl. 78">
	    
	    <label id="mealProteinLabel" for="mealProteinInput">FehÃ©rje (g/darab)</label>
	    <input id="mealProteinInput" type="number" placeholder="pl. 6">
	    
	    <div style="text-align:center;margin-top:15px;">
	      <button onclick="saveMeal()">âœ… MentÃ©s</button>
	      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('mealModal')">MÃ©gse</button>
	    </div>
	  </div>
	</div>
	
	<div class="modal" id="consumeModal">
	Â  <div class="modal-content">
	Â  Â  <h3 id="consumeMealTitle">Ã‰tel fogyasztÃ¡sa</h3>
	Â  Â  <p style="text-align: center; font-weight: bold;" id="consumeMealDetails"></p>
	Â  Â Â 
	Â  Â  <label id="consumeAmountLabel" for="consumeAmountInput">MennyisÃ©g (Darab)</label>
	Â  Â  <input id="consumeAmountInput" type="number" placeholder="pl. 2">
	Â  Â Â 
	Â  Â  <div style="text-align:center;margin-top:15px;">
	Â  Â  Â  <button onclick="confirmConsume()">ğŸ½ï¸ FogyasztÃ¡s</button>
	Â  Â  Â  <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('consumeModal')">MÃ©gse</button>
	Â  Â  </div>
	Â  </div>
	</div>
	
	<div class="modal" id="quickAddModal">
	Â  <div class="modal-content">
	Â  Â  <h3>âš¡ Gyors BejegyzÃ©s</h3>
	Â  Â  <p style="text-align: center; margin-top: -10px; margin-bottom: 15px;">Add meg a mai napi adatokat.</p>
	Â  Â Â 
	Â  Â  <label>Jelenlegi sÃºly (kg) - FelÃ¼lÃ­rja a mait</label>
	Â  Â  <input id="quickWeightInput" type="number" placeholder="pl. 75.5">
	Â  Â Â 
	Â  Â  <label>VÃ­z hozzÃ¡adÃ¡sa (Liter)</label>
	Â  Â  <input id="quickWaterInput" type="number" step="0.1" placeholder="pl. 0.5">
	Â  Â Â 
	Â  Â  <label>KalÃ³ria hozzÃ¡adÃ¡sa (kcal)</label>
	Â  Â  <input id="quickCalInput" type="number" placeholder="pl. 500">
	Â  Â Â 
	Â  Â  <label>Protein hozzÃ¡adÃ¡sa (gramm)</label>
	Â  Â  <input id="quickProteinInput" type="number" placeholder="pl. 30">
	Â  Â Â 
	Â  Â  <div style="text-align:center;margin-top:15px;">
	Â  Â  Â  <button onclick="saveQuickAdd()">ğŸ’¾ MentÃ©s Ã©s BezÃ¡rÃ¡s</button>
	Â  Â  Â  <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('quickAddModal')">MÃ©gse</button>
	Â  Â  </div>
	Â  </div>
	</div>


</div> <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

<script>
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCZJLWZFJFEFWQqZYmAcZjgqoc88FDfPwQ",
    authDomain: "habit-tracker-32c11.firebaseapp.com",
    databaseURL: "https://habit-tracker-32c11-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "habit-tracker-32c11",
    storageBucket: "habit-tracker-32c11.appspot.com",
    messagingSenderId: "637775270587",
    appId: "1:637775270587:web:11b31d9f64510d81c20f9e",
    measurementId: "G-SS9TX286CF"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  
  // Create global variables to access Firebase services
  const auth = firebase.auth();
  const db = firebase.firestore();
  let currentUser = null; // This will be set on login
  
  console.log("Firebase is connected!");
  
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// =======================================================
// ===== ÃšJ FUNKCIÃ“: JEGYZET KATEGÃ“RIA LISTA LÃ‰TREHOZÃSA =====
// =======================================================
function populateNoteCategoryDatalist() {
Â  const datalist = document.getElementById('noteCategoryDatalist');
Â  if (!datalist) return;

Â  datalist.innerHTML = ""; // TÃ¶rÃ¶ljÃ¼k a rÃ©gi opciÃ³kat

Â  // Ã–sszegyÅ±jtjÃ¼k a meglÃ©vÅ‘ kategÃ³riÃ¡kat (csak egyedi Ã©rtÃ©kek)
Â  const existingCategories = new Set(
Â  Â  notes
Â  Â  Â  .map(note => note.category)
Â  Â  Â  .filter(category => category) // Csak a lÃ©tezÅ‘ kategÃ³riÃ¡k
Â  );

Â  // HozzÃ¡adjuk Å‘ket a listÃ¡hoz
Â  existingCategories.forEach(category => {
Â  Â  const option = document.createElement('option');
Â  Â  option.value = category;
Â  Â  datalist.appendChild(option);
Â  });
}
// ======= POPUP VEZÃ‰RLÃ‰S =======
function openModal(id) {
  document.getElementById(id).style.display = 'flex';
  // HOZZÃADVA: KategÃ³ria lista feltÃ¶ltÃ©se, amikor a cÃ©l modalt nyitjuk meg
  if (id === 'goalModal') {
    populateCategoryDatalist();
    // TÃ¶rÃ¶ljÃ¼k a rÃ©gi alcÃ©l bevitelt
    document.getElementById("goalSubGoalsInput").value = "";
    // ÃšJ: IsmÃ©tlÅ‘dÃ©s alaphelyzetbe Ã¡llÃ­tÃ¡sa
    document.getElementById("goalIsRecurringInput").checked = false;
    document.getElementById("goalRecurrenceOptions").style.display = "none";
    document.getElementById("goalRecurrenceSelect").value = "daily";
  }
}
// ÃšJ: Az Ã©tel modal megnyitÃ¡sa (alaphelyzetbe Ã¡llÃ­tÃ¡s)
function openMealModal() {
  // Ez biztosÃ­tja, hogy szerkesztÃ©s helyett "Ãºj" mÃ³dban nyÃ­ljon meg
  editTarget = null; 
  
  document.getElementById('mealModal').querySelector('h3').textContent = "Ãšj Ã©tel hozzÃ¡adÃ¡sa";
  document.getElementById("mealNameInput").value = "";
  document.getElementById("mealTypeSelect").value = "unit";
  document.getElementById("mealKcalInput").value = "";
  document.getElementById("mealProteinInput").value = "";
  updateMealModalLabels(); // CÃ­mkÃ©k frissÃ­tÃ©se
  
  openModal('mealModal');
}

function closeModal(id) {
  document.getElementById(id).style.display = 'none';
  // BiztosÃ­tjuk, hogy a szerkesztÃ©s mezÅ‘i elrejtsenek, amikor bezÃ¡rjuk
  if (id === 'editModal') {
    document.getElementById("editLabel1").style.display = "block";
    document.getElementById("editInput1").style.display = "block";
    document.getElementById("editLabel2").style.display = "block";
    document.getElementById("editInput2").style.display = "block";
    document.getElementById("editLabel3").style.display = "block";
    document.getElementById("editInput3").style.display = "block";
    document.getElementById("editLabelText").style.display = "none";
    document.getElementById("editInputText").style.display = "none";
    document.getElementById("editMealFields").style.display = "none";
    // AlcÃ©l mezÅ‘ elrejtÃ©se
    document.getElementById("editLabelSubGoals").style.display = "none";
    document.getElementById("editInputSubGoals").style.display = "none";
    // ÃšJ: IsmÃ©tlÅ‘dÅ‘ mezÅ‘k elrejtÃ©se
    document.getElementById("editRecurringFields").style.display = "none";
  }
}

function editGoals() {
  // Refactored to use global vars instead of localStorage
  document.getElementById("goalWeightInput").value = goalWeightSetting || "";
  document.getElementById("goalWaterInput").value = goalWaterSetting || "";
  document.getElementById("goalCalInput").value = goalCaloriesSetting || "";
  document.getElementById("goalProteinInput").value = goalProteinSetting || ""; // HOZZÃADVA
  openModal('goalSetupModal');
}

// =======================================================
// ===== ÃšJ GYORS BEJEGYZÃ‰S FUNKCIÃ“K =====
// =======================================================
function openQuickAddModal() {
Â  // KitÃ¶rli a rÃ©gi beviteli Ã©rtÃ©keket
Â  document.getElementById("quickWeightInput").value = "";
Â  document.getElementById("quickWaterInput").value = "";
Â  document.getElementById("quickCalInput").value = "";
Â  document.getElementById("quickProteinInput").value = "";
Â Â 
Â  // BetÃ¶lti a jelenlegi sÃºlyt, ha van -> EZ A RÃ‰SZ EL LETT TÃVOLÃTVA
Â  // if (dailyProgress.lastWeight > 0) {
Â  // Â  Â document.getElementById("quickWeightInput").value = dailyProgress.lastWeight;
Â  // }
Â Â 
Â  openModal('quickAddModal');
}

async function saveQuickAdd() {
Â  const weight = parseFloat(document.getElementById("quickWeightInput").value);
Â  const water = parseFloat(document.getElementById("quickWaterInput").value);
Â  const calories = parseFloat(document.getElementById("quickCalInput").value);
Â  const protein = parseFloat(document.getElementById("quickProteinInput").value);
Â  
Â  // SÃºly rÃ¶gzÃ­tÃ©se
Â  if (weight && weight > 0) {
Â  Â  const transaction = {
Â  Â  Â  Â  id: Date.now(), type: 'weight', value: weight, date: new Date()
Â  Â  };
Â  Â  transactions.push(transaction);
Â  Â  // A dailyProgress.lastWeight-et a calculateDailyProgress() frissÃ­ti
Â  Â  await logActivity(`âš–ï¸ SÃºly rÃ¶gzÃ­tve: ${weight}kg`);
Â  }
Â Â 
Â  // VÃ­z hozzÃ¡adÃ¡sa
Â  if (water && water > 0) {
Â  Â  const transaction = {
Â  Â  Â  Â  id: Date.now(), type: 'water', value: water, date: new Date()
Â  Â  };
Â  Â  transactions.push(transaction);
Â  Â  await logActivity(`ğŸ’§ VÃ­z hozzÃ¡adva: ${water}L`);
Â  }
Â Â 
Â  // KalÃ³ria hozzÃ¡adÃ¡sa
Â  if (calories && calories > 0) {
Â  Â  const transaction = {
Â  Â  Â  Â  id: Date.now(), type: 'calories', value: calories, date: new Date()
Â  Â  };
Â  Â  transactions.push(transaction);
Â  Â  await logActivity(`ğŸ”¥ KalÃ³ria hozzÃ¡adva: ${calories}kcal`);
Â  }
Â Â 
Â  // Protein hozzÃ¡adÃ¡sa
Â  if (protein && protein > 0) {
Â  Â  const transaction = {
Â  Â  Â  Â  id: Date.now(), type: 'protein', value: protein, date: new Date()
Â  Â  };
Â  Â  transactions.push(transaction);
Â  Â  await logActivity(`ğŸ¥© Protein hozzÃ¡adva: ${protein}g`);
Â  }
Â Â 
Â  closeModal('quickAddModal');
Â Â 
Â  // FrissÃ­tjÃ¼k az Ã¶sszes nÃ©zetet
Â  calculateDailyProgress(); // Ez ÃºjraszÃ¡molja a dailyProgress-t
Â  updateAllSummaries();Â  // Ez frissÃ­ti a kompakt sÃ¡vot
Â  updateHistory();
Â  if (document.getElementById('chartModal').style.display === 'flex') {
Â  Â  updateChart();
Â  }
}

// ===== ÃšJ FUNKCIÃ“: Kompakt nÃ©zet frissÃ­tÃ©se =====
function updateCompactSummaries() {
    // CÃ©lbeÃ¡llÃ­tÃ¡sok
    const gw = parseFloat(goalWeightSetting);     // CÃ©l sÃºly
    const gwat = parseFloat(goalWaterSetting);  // CÃ©l vÃ­z
    const gcal = parseFloat(goalCaloriesSetting); // CÃ©l kalÃ³ria
    const gprot = parseFloat(goalProteinSetting); // CÃ©l protein
    
    // Napi haladÃ¡s
    const dp = dailyProgress;
    
    // SÃºly logikÃ¡hoz: megkeressÃ¼k az elsÅ‘ sÃºlybejegyzÃ©st. Ez lesz az "Ãºt" kiindulÃ³pontja.
    let startWeight = dp.lastWeight; // AlapÃ©rtelmezett, ha nincs mÃ¡s
    const firstWeightEntry = transactions.find(t => t.type === 'weight');
    if (firstWeightEntry) {
        startWeight = firstWeightEntry.value;
    }

    // FelsÅ‘ szÃ¶veges elemek
    const compactWeightTop = document.getElementById("compactWeightTop");
    const compactWaterTop = document.getElementById("compactWaterTop");
    const compactCalTop = document.getElementById("compactCalTop");
    const compactProteinTop = document.getElementById("compactProteinTop");

    // AlsÃ³ "MÃ©g X" elemek
    const compactWeightBottom = document.getElementById("compactWeightBottom");
    const compactWaterBottom = document.getElementById("compactWaterBottom");
    const compactCalBottom = document.getElementById("compactCalBottom");
    const compactProteinBottom = document.getElementById("compactProteinBottom");
    
    // HaladÃ³sÃ¡v elemek
    const compactWeightBar = document.getElementById("compactWeightBar");
    const compactWaterBar = document.getElementById("compactWaterBar");
    const compactCalBar = document.getElementById("compactCalBar");
    const compactProteinBar = document.getElementById("compactProteinBar");

    // Ha nem a fÅ‘oldalon vagyunk, ne fusson le
    if (!compactWeightTop) return; 

    // --- SÃºly (JAVÃTOTT logika) ---
    if (gw && dp.lastWeight > 0 && startWeight > 0) {
        const goalDiff = gw - dp.lastWeight; // Mennyi van hÃ¡tra a cÃ©lig (pl. 69.5 - 76.8 = -7.3)
        
        // A teljes utazÃ¡s abszolÃºt Ã©rtÃ©ke (kezdÅ‘ sÃºlytÃ³l a cÃ©lig)
        const totalJourneyAbs = Math.abs(startWeight - gw); 
        // A mÃ¡r megtett Ãºt abszolÃºt Ã©rtÃ©ke (kezdÅ‘ sÃºlytÃ³l a jelenlegiig)
        const journeyDoneAbs = Math.abs(startWeight - dp.lastWeight); 

        let perc_weight = 0;
        if (totalJourneyAbs === 0) {
             // Ha a cÃ©l a kezdÅ‘ sÃºly, Ã©s elÃ©rtÃ¼k, 100%
             perc_weight = (dp.lastWeight === gw) ? 100 : 0;
        } else {
             perc_weight = (journeyDoneAbs / totalJourneyAbs) * 100;
        }
        
        if (perc_weight > 100) perc_weight = 100; // Ne menjen 100% fÃ¶lÃ©
        if (perc_weight < 0) perc_weight = 0;

        compactWeightTop.textContent = `${dp.lastWeight.toFixed(1)} kg / CÃ©l: ${gw} kg`;
        
        // JAVÃTOTT RÃ‰SZ: Csak akkor Ã­rja, hogy "CÃ©l elÃ©rve", ha a kÃ¼lÃ¶nbsÃ©g 0.
        if (goalDiff.toFixed(1) == 0) { // KerekÃ­tve nÃ©zzÃ¼k
            compactWeightBottom.textContent = "CÃ©l elÃ©rve! ğŸ‰";
            perc_weight = 100; // Biztos, ami biztos
        } else {
            // A "MÃ©g" szÃ¶veg elÅ‘jelÃ©nek formÃ¡zÃ¡sa
            const diffSign = goalDiff > 0 ? '+' : '';
            compactWeightBottom.textContent = `MÃ©g ${diffSign}${goalDiff.toFixed(1)} kg`;
        }
        
        compactWeightBar.style.width = perc_weight + '%';
    } else {
        compactWeightTop.textContent = `${dp.lastWeight > 0 ? dp.lastWeight : '--'} kg / CÃ©l: ${gw ? gw : '--'} kg`;
        compactWeightBottom.textContent = "Nincs sÃºlycÃ©l";
        compactWeightBar.style.width = '0%';
    }

    // --- VÃ­z (Marad a helyes logika) ---
    if (gwat) {
        const rem_water = gwat - dp.water;
        let perc_water = (dp.water / gwat) * 100;
        if (perc_water > 100) perc_water = 100;
        if (perc_water < 0) perc_water = 0;
        
        compactWaterTop.textContent = `${dp.water.toFixed(1)} / ${gwat.toFixed(1)} L`;
        compactWaterBottom.textContent = rem_water > 0 ? `MÃ©g ${rem_water.toFixed(1)} L` : `CÃ©l teljesÃ­tve!`;
        compactWaterBar.style.width = perc_water + '%';
    } else {
        compactWaterTop.textContent = `${dp.water.toFixed(1)} L`;
        compactWaterBottom.textContent = "Nincs vÃ­zcÃ©l";
        compactWaterBar.style.width = '0%';
    }

    // --- KalÃ³ria (Marad a helyes logika) ---
    if (gcal) {
        const rem_cal = gcal - dp.calories;
        let perc_cal = (dp.calories / gcal) * 100;
        if (perc_cal > 100) perc_cal = 100;
        if (perc_cal < 0) perc_cal = 0;

        compactCalTop.textContent = `${dp.calories.toFixed(0)} / ${gcal.toFixed(0)} kcal`;
        compactCalBottom.textContent = rem_cal > 0 ? `MÃ©g ${rem_cal.toFixed(0)} kcal` : `CÃ©l elÃ©rve!`;
        compactCalBar.style.width = perc_cal + '%';
    } else {
        compactCalTop.textContent = `${dp.calories.toFixed(0)} kcal`;
        compactCalBottom.textContent = "Nincs kalÃ³riacÃ©l";
        compactCalBar.style.width = '0%';
    }

    // --- Protein (Marad a helyes logika) ---
    if (gprot) {
        const rem_prot = gprot - dp.protein;
        let perc_prot = (dp.protein / gprot) * 100;
        if (perc_prot > 100) perc_prot = 100;
        if (perc_prot < 0) perc_prot = 0;
        
        compactProteinTop.textContent = `${dp.protein.toFixed(0)} / ${gprot.toFixed(0)} g`;
        compactProteinBottom.textContent = rem_prot > 0 ? `MÃ©g ${rem_prot.toFixed(0)} g` : `CÃ©l teljesÃ­tve!`;
        compactProteinBar.style.width = perc_prot + '%';
    } else {
        compactProteinTop.textContent = `${dp.protein.toFixed(0)} g`;
        compactProteinBottom.textContent = "Nincs proteincÃ©l";
        compactProteinBar.style.width = '0%';
    }
}
// =======================================================
// ===== ALL APP LOGIC (NOW FIREBASE ENABLED) =====
// =======================================================
// =======================================================
// ===== GLOBÃLIS VÃLTOZÃ“K (REFACTORED) =====
// =======================================================
// These are now initialized as empty.
// They will be filled by loadDataFromFirestore()
let goals = [];
let rewards = [];
let notes = [];
let logs = [];
let workouts = [];
let meals = [];
let reminders = []; // ÃšJ EMLÃ‰KEZTETÅ TÃ–MB
let totalPoints = 0;
let transactions = [];
let archivedGoals = [];
let pointsLog = []; // ÃšJ PONT TÃ–RTÃ‰NET TÃ–MB

// App settings
let goalWeightSetting = "";
let goalWaterSetting = "";
let goalCaloriesSetting = "";
let goalProteinSetting = ""; // ÃšJ

// Other global vars
let chart;
let editTarget = null;
let dailyProgress = { water: 0, calories: 0, protein: 0, lastWeight: 0, date: "" }; // 'protein' HOZZÃADVA
let reminderCheckInterval = null; // ÃšJ EMLÃ‰KEZTETÅ IDÅZÃTÅ


// =======================================================
// ===== ÃšJ FUNKCIÃ“: KATEGÃ“RIA LISTA LÃ‰TREHOZÃSA =====
// =======================================================
function populateCategoryDatalist() {
  const datalist = document.getElementById('categoryDatalist');
  if (!datalist) return;

  datalist.innerHTML = ""; // TÃ¶rÃ¶ljÃ¼k a rÃ©gi opciÃ³kat

  // Ã–sszegyÅ±jtjÃ¼k a meglÃ©vÅ‘ kategÃ³riÃ¡kat (csak egyedi Ã©rtÃ©kek)
  const existingCategories = new Set(
    goals
      .map(goal => goal.category)
      .filter(category => category) // Csak a lÃ©tezÅ‘ kategÃ³riÃ¡k
  );
  
  // HozzÃ¡adjuk az archivÃ¡lt cÃ©lok kategÃ³riÃ¡it is
  archivedGoals
    .map(goal => goal.category)
    .filter(category => category)
    .forEach(category => existingCategories.add(category));

  // HozzÃ¡adjuk Å‘ket a listÃ¡hoz
  existingCategories.forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    datalist.appendChild(option);
  });
}
// =======================================================


// =======================================================
// ===== AUTHENTICATION (NEW FUNCTIONS) =====
// =======================================================
function handleLogin() {
  const email = document.getElementById('loginEmail').value;
  const pass = document.getElementById('loginPassword').value;
  document.getElementById('loginError').innerText = "";
  
  auth.signInWithEmailAndPassword(email, pass)
    .then((userCredential) => {
      // Sign-in successful, onAuthStateChanged will handle the rest
      console.log("User logged in:", userCredential.user.uid);
    })
    .catch((error) => {
      document.getElementById('loginError').innerText = "Hiba: " + error.message;
    });
}

function handleSignUp() {
  const email = document.getElementById('loginEmail').value;
  const pass = document.getElementById('loginPassword').value;
  document.getElementById('loginError').innerText = "";

  auth.createUserWithEmailAndPassword(email, pass)
    .then((userCredential) => {
      // Sign-up successful, onAuthStateChanged will handle the rest
      console.log("User created:", userCredential.user.uid);
    })
    .catch((error) => {
      document.getElementById('loginError').innerText = "Hiba: " + error.message;
    });
}

function handleLogout() {
  auth.signOut();
}

// =======================================================
// ===== DATA SYNC (NEW FUNCTIONS) =====
// =======================================================

// A function to get all data from Firestore
async function loadDataFromFirestore() {
  if (!currentUser) return; // Safety check
  console.log("Loading data from Firestore...");
  const docRef = db.collection('users').doc(currentUser.uid);
  
  try {
    const doc = await docRef.get();
    if (doc.exists) {
      // Document exists, load the data into our global variables
      const data = doc.data();
      goals = data.goals || [];
      rewards = data.rewards || [];
      notes = data.notes || [];
      logs = Array.isArray(data.logs) ? data.logs : [];
      workouts = data.workouts || [];
      meals = data.meals || []; 
      reminders = data.reminders || []; // ÃšJ
      archivedGoals = data.archivedGoals || [];
      totalPoints = data.totalPoints || 0;
      transactions = Array.isArray(data.transactions) ? data.transactions : [];
      pointsLog = data.pointsLog || []; // PONTNAPLÃ“ BETÃ–LTÃ‰SE
      // Also load the settings
      goalWeightSetting = data.goalWeight || "";
      goalWaterSetting = data.goalWater || "";
      goalCaloriesSetting = data.goalCalories || "";
      goalProteinSetting = data.goalProtein || ""; 
      
      // ===== EDZÃ‰S ADAT MIGRÃCIÃ“ (ÃšJ) =====
      if (workouts.length > 0 && typeof workouts[0] === 'string') {
        console.log("Migrating workouts data structure...");
        workouts = workouts.map(dateStr => ({ date: dateStr, note: "" }));
      }
      // ===== MIGRÃCIÃ“ VÃ‰GE =====

      console.log("Data loaded successfully.");
    } else {
      console.log("No data found for this user, starting fresh.");
    }
  } catch (error) {
    console.error("Error loading data:", error);
    alert("Hiba tÃ¶rtÃ©nt az adatok betÃ¶ltÃ©se kÃ¶zben.");
  }
}

// A function to save all data to Firestore
async function saveDataToFirestore() {
  if (!currentUser) return; // Safety check

  console.log("Saving data to Firestore...");
  const docRef = db.collection('users').doc(currentUser.uid);
  
  const dataToSave = {
    goals,
    rewards,
    notes,
    logs,
    workouts,
    meals,
    reminders, // ÃšJ
    archivedGoals,
    totalPoints,
    transactions,
	pointsLog, // PONTNAPLÃ“ MENTÃ‰SE
    goalWeight: goalWeightSetting,
    goalWater: goalWaterSetting,
    goalCalories: goalCaloriesSetting,
    goalProtein: goalProteinSetting 
  };
  
  try {
    await docRef.set(dataToSave);
    console.log("Data saved successfully.");
  } catch (error) {
    console.error("Error saving data:", error);
  }
}

// =======================================================
// ===== APP INITIALIZATION (REFACTORED) =====
// =======================================================

auth.onAuthStateChanged(async (user) => {
  if (user) {
    // === USER IS LOGGED IN ===
    currentUser = user;
    console.log("Auth state changed: Logged in as", user.uid);
    
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('loginContainer').style.display = 'none';
    
    await loadDataFromFirestore();
    await checkRecurringGoals(); // ÃšJ: IsmÃ©tlÅ‘dÅ‘ cÃ©lok ellenÅ‘rzÃ©se
    calculateDailyProgress();
    loadMotivation();
    renderAll(); 
    
    startReminderEngine(); // ÃšJ EMLÃ‰KEZTETÅ MOTOR INDÃTÃSA

  } else {
    // === USER IS LOGGED OUT ===
    currentUser = null;
    console.log("Auth state changed: Logged out");

    document.getElementById('appContainer').style.display = 'none';
    document.getElementById('loginContainer').style.display = 'block';
    
    // Clear all local data
    goals = [];
    rewards = [];
    notes = [];
    logs = [];
    workouts = [];
    meals = []; 
    reminders = []; // ÃšJ
    archivedGoals = [];
    totalPoints = 0;
	pointsLog = []; // PONTNAPLÃ“ NULLÃZÃSA
    transactions = [];
    goalWeightSetting = "";
    goalWaterSetting = "";
    goalCaloriesSetting = "";
    goalProteinSetting = ""; 
  }
});


// =======================================================
// ===== PONTSZÃMLÃLÃ“ ANIMÃCIÃ“ =====
// =======================================================
function animatePoints(newValue) {
  const displayElement = document.getElementById("totalPointsDisplay");
  if (!displayElement) return;

  let startValue = parseInt(displayElement.textContent);
  if (isNaN(startValue)) {
      startValue = 0;
  }
  if (startValue === newValue) return;

  const duration = 750;
  const range = newValue - startValue;
  let startTime = null;

  function step(timestamp) {
    if (!startTime) startTime = timestamp;
    const progress = Math.min((timestamp - startTime) / duration, 1);
    const currentValue = Math.floor(startValue + range * progress);
    
    displayElement.textContent = currentValue;

    if (progress < 1) {
      window.requestAnimationFrame(step);
    } else {
      displayElement.textContent = newValue;
    }
  }
  window.requestAnimationFrame(step);
}


// =======================================================
// ===== GRAFIKON MODAL FUNKCIÃ“ =====
// =======================================================
function openChartModal() {
  openModal('chartModal');
  setTimeout(updateChart, 100);
}

// =======================================================
// ===== ADATKEZELÅ FÃœGGVÃ‰NYEK =====
// =======================================================

function calculateDailyProgress() {
  const today = new Date().toISOString().slice(0, 10);
  // 'protein' HOZZÃADVA
  dailyProgress = { water: 0, calories: 0, protein: 0, lastWeight: 0, date: today };
  
  let lastWeightEntry = null;

  if (!Array.isArray(transactions)) {
    console.error("Transactions is not an array!", transactions);
    transactions = [];
    return;
  }

  for (const t of transactions) {
    if (t.type === 'weight' && t.value > 0) {
      lastWeightEntry = t;
    }
    
    try {
      let entryDate;
      if (t.date && typeof t.date.toDate === 'function') {
        entryDate = t.date.toDate(); 
      } else {
        entryDate = new Date(t.date);
      }
      
      if (!entryDate || isNaN(entryDate.getTime())) {
          console.warn("Invalid date object encountered:", t.date);
          continue;
      }

      if (entryDate.toISOString().slice(0, 10) === today) {
        if (t.type === 'water') {
          dailyProgress.water += t.value;
        } else if (t.type === 'calories') {
          dailyProgress.calories += t.value;
        } else if (t.type === 'protein') { // ÃšJ
          dailyProgress.protein += t.value;
        } else if (t.type === 'meal') { // ÃšJ
          dailyProgress.calories += t.totalKcal;
          dailyProgress.protein += t.totalProtein;
        }
      }
    } catch (e) {
      console.error("DÃ¡tumfeldolgozÃ¡si hiba a calculateDailyProgress-ben:", e, t.date);
    }
  }

  if (lastWeightEntry) {
    dailyProgress.lastWeight = lastWeightEntry.value;
  }
}

// =======================================================
// ===== MÃ“DOSÃTOTT TAB KEZELÃ‰S =====
// =======================================================
function showTab(id) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  
  if (event && event.target) {
     event.target.classList.add('active');
  } else {
     document.querySelector(`.tab-btn[onclick="showTab('${id}')"]`).classList.add('active');
  }
  
  document.getElementById(id).classList.add('active');
  
  if (id === 'workouts') {
    renderWorkouts();
  }
  // ÃšJ: Ã‰tkezÃ©s fÃ¼l renderelÃ©se
  if (id === 'meals') {
    renderMeals();
  }

  // ÃšJ: EmlÃ©keztetÅ‘ fÃ¼l renderelÃ©se Ã©s engedÃ©lykÃ©rÃ©s
  if (id === 'reminders') {
    checkNotificationPermission(); // RÃ¡kÃ©rdez az engedÃ©lyre
    renderReminders();
  }
  
  // ÃšJ: HaladÃ¡s fÃ¼l naplÃ³inak frissÃ­tÃ©se
  if (id === 'history') {
    renderLogs();
    renderPointsLog();
  }
  
// ===== ÃšJ KOMPAKT SÃV MEGJELENÃTÃ‰SI LOGIKA =====
	Â  const compactGoalsBar = document.getElementById('compactGoalsContainer');
	Â  if (compactGoalsBar) {
	Â  Â  if (id === 'main' || id === 'meals') {
			  // A kompakt sÃ¡v megjelenÃ­tÃ©se a FÅ‘oldalon Ã©s az Ã‰tkezÃ©s fÃ¼lÃ¶n.
			  // A CSS-ed 'display: grid'-et hasznÃ¡l, ezÃ©rt azt Ã¡llÃ­tjuk be.
	Â  Â  Â  compactGoalsBar.style.display = 'grid'; 
	Â  Â  } else {
			  // Minden mÃ¡s fÃ¼lÃ¶n elrejtjÃ¼k.
	Â  Â  Â  compactGoalsBar.style.display = 'none';
	Â  Â  }
	Â  }
	Â  // ===== MÃ“DOSÃTOTT LOGIKA VÃ‰GE =====
}


// =======================================================
// ===== EDZÃ‰S FUNKCIÃ“K (REFACTORED) =====
// =======================================================
async function addWorkout() { // Make async
  const dateInput = document.getElementById("workoutDateInput");
  const selectedDate = dateInput.value; 

  if (!selectedDate) {
    alert("KÃ©rlek vÃ¡lassz ki egy dÃ¡tumot!");
    return;
  }
  
  if (workouts.find(w => w.date === selectedDate)) {
    alert("Ehhez a naphoz mÃ¡r rÃ¶gzÃ­tettÃ©l edzÃ©st!");
    return;
  }
  
  workouts.push({ date: selectedDate, note: "" });
  await saveWorkouts();
  logActivity(`ğŸ‹ï¸â€â™‚ï¸ EdzÃ©s rÃ¶gzÃ­tve: ${selectedDate}`);
  renderWorkouts();
  
  dateInput.value = "";
}

function renderWorkouts() {
  const list = document.getElementById("workoutList");
  if (!list) return; 

  workouts.sort((a, b) => b.date.localeCompare(a.date));
  list.innerHTML = "";
  
  if (workouts.length === 0) {
    list.innerHTML = "<p>MÃ©g nincsenek rÃ¶gzÃ­tett edzÃ©seid.</p>";
    return;
  }
  
  workouts.forEach((workout, index) => {
    const div = document.createElement("div");
    div.className = "workout-item";
    div.innerHTML = `
      <span onclick="openWorkoutNoteModal(${index})">ğŸ‹ï¸â€â™‚ï¸ ${workout.date}</span>
      <div>
        <button class="edit-note-btn" onclick="editWorkout(${index})">âœï¸</button>
        <button onclick="deleteWorkout(${index})">ğŸ—‘ï¸</button>
      </div>
    `;
    list.appendChild(div);
  });
}

async function deleteWorkout(index) {
  if (!confirm(`Biztosan tÃ¶rlÃ¶d az edzÃ©st errÅ‘l a naprÃ³l: ${workouts[index].date}?`)) {
    return;
  }
  
  const deletedWorkout = workouts.splice(index, 1)[0];
  if (deletedWorkout) {
    await saveWorkouts();
    logActivity(`ğŸ—‘ï¸ EdzÃ©s tÃ¶rÃ¶lve: ${deletedWorkout.date}`);
    renderWorkouts();
  }
}

async function saveWorkouts() {
  await saveDataToFirestore();
}

function editWorkout(index) {
  editTarget = { type: 'workout', index: index };
  
  const workoutDate = workouts[index].date;
  document.getElementById("editTitle").textContent = `ğŸ‹ï¸â€â™‚ï¸ EdzÃ©sjegyzet (${workoutDate})`;

  document.getElementById("editLabel1").style.display = "none";
  document.getElementById("editInput1").style.display = "none";
  document.getElementById("editLabel2").style.display = "none";
  document.getElementById("editInput2").style.display = "none";
  document.getElementById("editLabel3").style.display = "none";
  document.getElementById("editInput3").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";

  document.getElementById("editLabelText").textContent = "Jegyzet";
  document.getElementById("editLabelText").style.display = "block";
  document.getElementById("editInputText").value = workouts[index].note || "";
  document.getElementById("editInputText").style.display = "block";

  openModal('editModal');
}
// =======================================================


// ===== CÃ‰LBEÃLLÃTÃS (REFACTORED) =====
// =======================================================
// ===== ÃšJ FUNKCIÃ“: ISMÃ‰TLÅDÅ CÃ‰LOK LOGIKÃJA =====
// =======================================================

/**
 * EllenÅ‘rzi, hogy egy adott dÃ¡tum (utolsÃ³ teljesÃ­tÃ©s) Ã©s
 * gyakorisÃ¡g alapjÃ¡n vissza kell-e Ã¡llÃ­tani egy cÃ©lt a mai napon.
 */
function isResetDue(lastCompletedISO, recurrence) {
  if (!lastCompletedISO) return false;

  const today = new Date();
  today.setHours(0, 0, 0, 0); // Ma Ã©jfÃ©l

  const lastDate = new Date(lastCompletedISO);
  lastDate.setHours(0, 0, 0, 0); // UtolsÃ³ teljesÃ­tÃ©s Ã©jfÃ©l

  // Ha ma lett teljesÃ­tve, nem Ã¡llÃ­tjuk vissza
  if (today.getTime() === lastDate.getTime()) {
    return false;
  }

  // IdÅ‘kÃ¼lÃ¶nbsÃ©g napokban
  const diffTime = today.getTime() - lastDate.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays <= 0) return false;

  switch (recurrence) {
    case 'daily':
      return diffDays >= 1;
    case '2days':
      return diffDays >= 2;
    case '3days':
      return diffDays >= 3;
    case '4days':
      return diffDays >= 4;
    case '5days':
      return diffDays >= 5;
    case '6days':
      return diffDays >= 6;
    case 'weekly':
      return diffDays >= 7;
    case 'monthly':
      // HÃ³napfordulÃ³t ellenÅ‘rzÃ¼nk
      const nextMonthDate = new Date(lastDate);
      nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
      // Ha a mai dÃ¡tum nagyobb vagy egyenlÅ‘, mint az utolsÃ³
      // teljesÃ­tÃ©s + 1 hÃ³nap, akkor visszaÃ¡llÃ­tjuk.
      return today.getTime() >= nextMonthDate.getTime();
    default:
      return false;
  }
}

/**
 * VÃ©gigmegy az Ã¶sszes aktÃ­v (nem archivÃ¡lt) cÃ©lon,
 * Ã©s visszaÃ¡llÃ­tja azokat, amelyek ismÃ©tlÅ‘dÅ‘ek Ã©s lejÃ¡rtak.
 */
async function checkRecurringGoals() {
  let goalsWereReset = false;
  
  // VisszafelÃ© kell iterÃ¡lnunk, mert ki fogunk venni elemeket a tÃ¶mbbÅ‘l!
  for (let i = archivedGoals.length - 1; i >= 0; i--) {
    const goal = archivedGoals[i];
    
    // Csak azokat nÃ©zzÃ¼k, amik ismÃ©tlÅ‘dÅ‘ek, teljesÃ­tve vannak, Ã©s van rÃ¶gzÃ­tett idejÃ¼k
    if (goal.isRecurring && goal.done && goal.lastCompleted) {
      if (isResetDue(goal.lastCompleted, goal.recurrence)) {
        console.log(`IsmÃ©tlÅ‘dÅ‘ cÃ©l reaktivÃ¡lÃ¡sa: ${goal.name}`);
        
        // 1. CÃ©l Ã¡llapotÃ¡nak visszaÃ¡llÃ­tÃ¡sa
        goal.done = false;
        goal.lastCompleted = null;
        
        // 2. AlcÃ©lok Ã¡llapotÃ¡nak visszaÃ¡llÃ­tÃ¡sa
        if (goal.subGoals && goal.subGoals.length > 0) {
          goal.subGoals.forEach(sg => {
            sg.done = false;
          });
        }
        
        // 3. ÃthelyezÃ©s az archÃ­vumbÃ³l a fÅ‘ cÃ©lok listÃ¡jÃ¡ra
        const goalToReactivate = archivedGoals.splice(i, 1)[0];
        goals.push(goalToReactivate);
        
        goalsWereReset = true;
      }
    }
  }

  if (goalsWereReset) {
    console.log("IsmÃ©tlÅ‘dÅ‘ cÃ©lok frissÃ­tve, mentÃ©s Ã©s renderelÃ©s...");
    // MindkÃ©t listÃ¡t Ãºjra kell rajzolni
    renderGoals();
    if (document.getElementById('archiveModal').style.display === 'flex') {
      renderArchivedGoals();
    }
    await saveDataToFirestore();
  }
}

// =======================================================
async function saveGoalSettings() { // Make async
Â  const gw = parseFloat(document.getElementById("goalWeightInput").value) || null;
Â  const gwat = parseFloat(document.getElementById("goalWaterInput").value) || null;
Â  const gcal = parseFloat(document.getElementById("goalCalInput").value) || null;
Â  const gprot = parseFloat(document.getElementById("goalProteinInput").value) || null; // ÃšJ

Â  // Save to global variables
Â  goalWeightSetting = gw ? gw.toString() : "";
Â  goalWaterSetting = gwat ? gwat.toString() : "";
Â  goalCaloriesSetting = gcal ? gcal.toString() : "";
Â  goalProteinSetting = gprot ? gprot.toString() : ""; // ÃšJ

Â  updateAllSummaries(); // Ez frissÃ­ti a nagy kÃ¡rtyÃ¡t
Â  // logActivity will call saveDataToFirestore
Â  await logActivity(`ğŸ¯ CÃ©lok beÃ¡llÃ­tva: ${gw || "-"}kg, ${gwat || "-"}L, ${gcal || "-"}kcal, ${gprot || "-"}g protein`);
Â  closeModal('goalSetupModal');
  
  // ITT A JAVÃTÃS:
  // BiztosÃ­tjuk, hogy a kompakt sÃ¡v is frissÃ¼ljÃ¶n
Â  updateCompactSummaries();
}

function updateAllSummaries() {
  // Ez a fÃ¼ggvÃ©ny korÃ¡bban a rÃ©gi, nagy kÃ¡rtyÃ¡kat frissÃ­tette.
  // Mivel azok tÃ¶rÃ¶lve lettek, a tartalmÃ¡t kiÃ¼rÃ­tettÃ¼k,
  // de a kompakt sÃ¡v frissÃ­tÃ©sÃ©t itt hagyjuk,
  // hogy a program tÃ¶bbi rÃ©sze (pl. saveQuickAdd) zÃ¶kkenÅ‘mentesen mÅ±kÃ¶djÃ¶n.
Â  
Â  // FrissÃ­tjÃ¼k a kompakt nÃ©zetet
Â  updateCompactSummaries();
}


// =======================================================
// ===== ADATBEVITEL Ã‰S TÃ–RLÃ‰S (REFACTORED) =====
// =======================================================

async function deleteTransaction(index) { // Make async
  if (!confirm("Biztosan tÃ¶rlÃ¶d ezt a bejegyzÃ©st?")) {
    return;
  }
  
  const entry = transactions.splice(index, 1)[0];
  await logActivity(`ğŸ—‘ï¸ BejegyzÃ©s tÃ¶rÃ¶lve: ${entry.type} (${entry.value || entry.name})`);
  
  // ÃšjraszÃ¡moljuk az egÃ©szet
  calculateDailyProgress();
  updateAllSummaries();
  updateHistory();
  if (document.getElementById('chartModal').style.display === 'flex') {
    updateChart();
  }
}


// =======================================================
// ===== JEGYZETEK FUNKCIÃ“K (REFACTORED) =====
// =======================================================
// ÃšJ: Megnyitja a jegyzet hozzÃ¡adÃ¡sa modÃ¡lt
function openAddNoteModal() {
Â  // TÃ¶rÃ¶ljÃ¼k a modÃ¡l tartalmÃ¡t
Â  document.getElementById("noteTitleInput").value = "";
Â  document.getElementById("noteCategoryInput").value = "";
Â  document.getElementById("noteTextInput").value = "";
Â  
Â  // FeltÃ¶ltjÃ¼k a kategÃ³ria javaslatokat
Â  populateNoteCategoryDatalist();
Â  
Â  openModal('noteModal');
}

// MÃ“DOSÃTVA: MentÃ©s a modÃ¡lbÃ³l
async function saveNote() {
Â  const title = document.getElementById("noteTitleInput").value.trim();
Â  const category = document.getElementById("noteCategoryInput").value.trim();
Â  const text = document.getElementById("noteTextInput").value.trim();
Â Â 
Â  if (!title || !text) return alert("KÃ©rlek adj meg egy cÃ­met Ã©s szÃ¶veget is!");
Â Â 
Â  const note = {Â 
Â  Â  title,
Â  Â  category: category || null, // Menti a kategÃ³riÃ¡t, vagy null-t ha Ã¼res
Â  Â  text,Â 
Â  Â  date: new Date()
Â  };
Â  notes.unshift(note); // Az elejÃ©re szÃºrja be
Â Â 
Â  closeModal('noteModal');
Â  renderNotes(); // ÃšjrarajzolÃ¡s
Â  await logActivity(`ğŸ“ Jegyzet hozzÃ¡adva: ${title}`);
}

// TELJESEN ÃšJ RENDERNOTES FÃœGGVÃ‰NY (KATEGÃ“RIÃKKAL)
function renderNotes() {
Â  // JAVÃTÃS: Ez a 7 sor hiÃ¡nyzott. DefiniÃ¡lja a tÃ¡rolÃ³t Ã©s kezeli az Ã¼res listÃ¡t.
Â  const container = document.getElementById("notesList");
Â  if (!container) return; // BiztonsÃ¡gi ellenÅ‘rzÃ©s
Â  container.innerHTML = "";
Â  if (notes.length === 0) {
Â  Â  container.innerHTML = "<p style='text-align:center; padding: 10px;'>MÃ©g nincsenek mentett jegyzeteid.</p>";
Â  Â  return;
Â  }

Â  // 1. CsoportosÃ­tÃ¡s
Â  const categorized = {};
Â  const uncategorized = [];

Â  notes.forEach((note, i) => {
Â  Â  // Fontos, hogy megÅ‘rizzÃ¼k az eredeti indexet a tÃ¶rlÃ©shez/szerkesztÃ©shez
Â  Â  const item = { ...note, originalIndex: i };Â 
Â  Â Â 
Â  Â  if (item.category) {
Â  Â  Â  if (!categorized[item.category]) {
Â  Â  Â  Â  categorized[item.category] = [];
Â  Â  Â  }
Â  Â  Â  categorized[item.category].push(item);
Â  Â  } else {
Â  Â  Â  uncategorized.push(item);
Â  Â  }
Â  });

Â  // 2. MegjelenÃ­tÅ‘ segÃ©dfÃ¼ggvÃ©ny
Â  const renderItem = (n, index) => {
Â  Â  let displayDate = "...";
Â  Â  if (n.date) {
Â  Â  Â  if (typeof n.date.toDate === 'function') {
Â  Â  Â  Â  displayDate = n.date.toDate().toLocaleString().split(',')[0];
Â  Â  Â  } else {
Â  Â  Â  Â  displayDate = new Date(n.date).toLocaleString().split(',')[0];
Â  Â  Â  }
Â  Â  }

Â  Â  const div = document.createElement("div");
Â  Â  div.className = "note-summary-item";
Â  Â  div.innerHTML = `
Â  Â  Â  <div>
Â  Â  Â  Â  <span class="note-summary-title" onclick="openNoteModal(${index})">${n.title}</span>
Â  Â  Â  Â  <span class="note-summary-date">${displayDate}</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="note-summary-actions">
Â  Â  Â  Â  <button onclick='editNote(${index})'>âœï¸</button>
Â  Â  Â  Â  <button onclick='deleteNote(${index})'>ğŸ—‘ï¸</button>
Â  Â  Â  </div>`;
Â  Â  container.appendChild(div);
Â  };

Â  // 3. KategÃ³riÃ¡k kirajzolÃ¡sa (ABC sorrendben)
Â  const categoryNames = Object.keys(categorized).sort();
Â  categoryNames.forEach(categoryName => {
Â  Â  const title = document.createElement("h3");
Â  Â  title.className = "category-title"; // ÃšjrahasznosÃ­tjuk a CÃ©loknÃ¡l lÃ©vÅ‘ stÃ­lust
Â  Â  title.textContent = categoryName;
Â  Â  container.appendChild(title);

Â  Â  categorized[categoryName].forEach(item => {
Â  Â  Â  renderItem(item, item.originalIndex); // Az eredeti indexet adjuk Ã¡t!
Â  Â  });
Â  });

Â  // 4. KategÃ³ria nÃ©lkÃ¼liek kirajzolÃ¡sa
Â  if (uncategorized.length > 0) {
Â  Â  if (categoryNames.length > 0) { // Csak akkor Ã­rjuk ki, hogy "EgyÃ©b", ha mÃ¡r voltak kategÃ³riÃ¡k
Â  Â  Â  const title = document.createElement("h3");
Â  Â  Â  title.className = "category-title";
Â  Â  Â  title.textContent = "EgyÃ©b";
Â  Â  Â  container.appendChild(title);
Â  Â  }
Â  Â  uncategorized.forEach(item => {
Â  Â  Â  renderItem(item, item.originalIndex); // Az eredeti indexet adjuk Ã¡t!
Â  Â  });
Â  }
}
  
async function deleteNote(i) { // Make async
  if (!confirm(`Biztosan tÃ¶rlÃ¶d ezt a jegyzetet: "${notes[i].title}"?`)) {
    return;
  }
  const deletedTitle = notes[i].title;
  notes.splice(i, 1);
  renderNotes();
  await logActivity(`ğŸ—‘ï¸ Jegyzet tÃ¶rÃ¶lve: ${deletedTitle}`);
}

function openNoteModal(i) {
  const note = notes[i];
  document.getElementById("noteViewTitle").textContent = note.title;
  document.getElementById("noteViewText").textContent = note.text;
  openModal('noteViewModal');
}

function openWorkoutNoteModal(index) {
  const workout = workouts[index];
  document.getElementById("noteViewTitle").textContent = `EdzÃ©sjegyzet: ${workout.date}`;
  document.getElementById("noteViewText").textContent = workout.note || "Ehhez az edzÃ©shez nem tartozik jegyzet.";
  openModal('noteViewModal');
}

function editNote(i) {
Â  editTarget = { type: 'note', index: i };
Â Â 
Â  document.getElementById("editTitle").textContent = "ğŸ“ Jegyzet szerkesztÃ©se";
Â  document.getElementById("editLabel1").textContent = "CÃ­m";
Â  document.getElementById("editInput1").value = notes[i].title;
Â  document.getElementById("editInput1").style.display = "block";
Â  document.getElementById("editLabel1").style.display = "block";

Â  // ÃšJ: KategÃ³ria mezÅ‘ betÃ¶ltÃ©se
Â  document.getElementById("editLabel3").textContent = "KategÃ³ria";
Â  document.getElementById("editInput3").value = notes[i].category || "";
Â  document.getElementById("editInput3").style.display = "block";
Â  document.getElementById("editLabel3").style.display = "block";

Â  document.getElementById("editLabelText").style.display = "block";
Â  document.getElementById("editInputText").value = notes[i].text;
Â  document.getElementById("editInputText").style.display = "block";
Â Â 
Â  // ElrejtjÃ¼k a felesleges mezÅ‘ket
Â  document.getElementById("editLabel2").style.display = "none";
Â  document.getElementById("editInput2").style.display = "none";
Â  document.getElementById("editMealFields").style.display = "none";
Â  document.getElementById("editLabelSubGoals").style.display = "none";
Â  document.getElementById("editInputSubGoals").style.display = "none";
Â  document.getElementById("editRecurringFields").style.display = "none"; // Ezt is rejtsÃ¼k el

Â  openModal('editModal');
}
// =======================================================


// =======================================================
// ===== CÃ‰LOK (REFACTORED) =====
// =======================================================
async function saveGoal() { // Make async
  const name = document.getElementById("goalNameInput").value.trim();
  const points = parseInt(document.getElementById("goalPointsInput").value);
  const category = document.getElementById("goalCategoryInput").value.trim();
  
  if (!name) return alert("A cÃ©lnak nevet kell adni!");
  if (isNaN(points) || points < 0) return alert("Ã‰rvÃ©nytelen pontszÃ¡m! Adj meg 0-t vagy nagyobbat.");
  
  // ÃšJ: AlcÃ©lok beolvasÃ¡sa
  const subGoalsText = document.getElementById("goalSubGoalsInput").value;
  let subGoals = [];
  if (subGoalsText.trim() !== "") {
    subGoals = subGoalsText.split('\n')
      .map(text => text.trim())
      .filter(text => text.length > 0)
      .map(text => ({ text: text, done: false }));
  }
  
  // ÃšJ: IsmÃ©tlÅ‘dÃ©s beolvasÃ¡sa
  const isRecurring = document.getElementById("goalIsRecurringInput").checked;
  const recurrence = document.getElementById("goalRecurrenceSelect").value;
  
  const newGoal = { 
    name, 
    points, 
    done: false, 
    category: category, 
    subGoals: subGoals 
  };
  
  if (isRecurring) {
    newGoal.isRecurring = true;
    newGoal.recurrence = recurrence;
    newGoal.lastCompleted = null; // Kezdetben nincs teljesÃ­tve
  }
  
  goals.push(newGoal);
  
  document.getElementById("goalNameInput").value = "";
  document.getElementById("goalPointsInput").value = "";
  document.getElementById("goalCategoryInput").value = "";
  document.getElementById("goalSubGoalsInput").value = ""; // Textarea Ã¼rÃ­tÃ©se
  
  closeModal('goalModal');
  renderGoals();
  await logActivity(`ğŸ¯ CÃ©l hozzÃ¡adva: ${name} (${points} pont)`);
}
// =======================================================
// ===== JAVÃTOTT CÃ‰LKEZELÅ FÃœGGVÃ‰NYEK KEZDETE =====
// =======================================================

async function toggleGoal(i) { // Make async
  if (i < 0 || i >= goals.length) {
      console.error("Invalid index for toggleGoal:", i);
      return;
  }
  
  const goal = goals[i];
  
  if (goal.subGoals && goal.subGoals.length > 0) {
    console.warn("toggleGoal called on a goal with sub-goals. This shouldn't happen.");
    return; 
  }
  
  // Csak a teljesÃ­tÃ©s Ã©rdekel (amikor 'done' false-rÃ³l true-ra vÃ¡lt)
  if (!goal.done) { 
    goal.done = true;
    totalPoints += goal.points;
    animatePoints(totalPoints);

    if (goal.isRecurring) {
      // --- ISMÃ‰TLÅDÅ CÃ‰L TELJESÃTVE ---
      goal.lastCompleted = new Date().toISOString();
	  addPointsLogEntry(goal.points, `âœ… IsmÃ©tlÅ‘dÅ‘ cÃ©l: ${goal.name}`);
      await logActivity(`âœ… IsmÃ©tlÅ‘dÅ‘ cÃ©l archivÃ¡lva: ${goal.name} (+${goal.points} pont)`);
      
      // ÃthelyezÃ©s az archÃ­vumba
      const goalToArchive = goals.splice(i, 1)[0];
      archivedGoals.unshift(goalToArchive);
      
      // ListÃ¡k ÃºjrarajzolÃ¡sa
      renderGoals();
      if (document.getElementById('archiveModal').style.display === 'flex') {
        renderArchivedGoals();
      }
    } else {
      // --- NEM ISMÃ‰TLÅDÅ CÃ‰L TELJESÃTVE ---
	  addPointsLogEntry(goal.points, `âœ… CÃ©l teljesÃ­tve: ${goal.name}`);
      await logActivity(`âœ… CÃ©l teljesÃ­tve: ${goal.name} (+${goal.points} pont)`);
      renderGoals(); // Csak a cÃ©l listÃ¡t rajzoljuk Ãºjra (Ã¡thÃºzÃ¡shoz)
    }
    
    await saveDataToFirestore(); 

  } else { 
    // --- TELJESÃTÃ‰S VISSZAVONÃSA (Csak nem ismÃ©tlÅ‘dÅ‘ cÃ©loknÃ¡l lehetsÃ©ges) ---
    if (!goal.isRecurring) {
      goal.done = false;
      totalPoints -= goal.points;
      animatePoints(totalPoints);
	  addPointsLogEntry(-goal.points, `âŒ CÃ©l visszavonva: ${goal.name}`);
      await logActivity(`âŒ CÃ©l visszavonva: ${goal.name} (-${goal.points} pont)`);
      await saveDataToFirestore(); 
      renderGoals();
    }
  }
}

// ===== ÃšJ FUNKCIÃ“: ALCÃ‰L KIPIPÃLÃSA =====
async function toggleSubGoal(goalIndex, subGoalIndex) {
  const goal = goals[goalIndex];
  if (!goal || !goal.subGoals || !goal.subGoals[subGoalIndex]) {
    console.error("Invalid sub-goal toggle.", goalIndex, subGoalIndex);
    return;
  }
  
  const wasMainGoalDone = goal.done;
  
  // 1. AlcÃ©l Ã¡llapotÃ¡nak vÃ¡ltÃ¡sa
  goal.subGoals[subGoalIndex].done = !goal.subGoals[subGoalIndex].done;
  
  // 2. EllenÅ‘rzÃ©s, hogy az Ã¶sszes alcÃ©l kÃ©sz van-e
  const allDone = goal.subGoals.length > 0 && goal.subGoals.every(sg => sg.done);
  
  // 3. FÅ‘ cÃ©l Ã¡llapotÃ¡nak Ã©s pontoknak frissÃ­tÃ©se
  if (allDone && !wasMainGoalDone) {
    // === Ã‰PP MOST LETT KÃ‰SZ ===
    goal.done = true;
    totalPoints += goal.points;
    animatePoints(totalPoints);

    if (goal.isRecurring) {
      // --- ISMÃ‰TLÅDÅ CÃ‰L TELJESÃTVE ---
      goal.lastCompleted = new Date().toISOString();
	  addPointsLogEntry(goal.points, `âœ… IsmÃ©tlÅ‘dÅ‘ cÃ©l: ${goal.name}`);
      await logActivity(`âœ… IsmÃ©tlÅ‘dÅ‘ cÃ©l archivÃ¡lva: ${goal.name} (+${goal.points} pont)`);
      
      // ÃthelyezÃ©s az archÃ­vumba
      const goalToArchive = goals.splice(goalIndex, 1)[0];
      archivedGoals.unshift(goalToArchive);
      
      if (document.getElementById('archiveModal').style.display === 'flex') {
        renderArchivedGoals();
      }
    } else {
      // --- NEM ISMÃ‰TLÅDÅ CÃ‰L TELJESÃTVE ---
	  addPointsLogEntry(goal.points, `âœ… CÃ©l (alcÃ©lokkal): ${goal.name}`);
      await logActivity(`âœ… CÃ©l teljesÃ­tve: ${goal.name} (+${goal.points} pont)`);
    }
    
    await saveDataToFirestore();
    
  } else if (!allDone && wasMainGoalDone) {
    // === Ã‰PP MOST LETT VISSZAVONVA ===
    goal.done = false;
    totalPoints -= goal.points;
    animatePoints(totalPoints);
    
    if (goal.isRecurring) {
      goal.lastCompleted = null;
    }
    addPointsLogEntry(-goal.points, `âŒ CÃ©l (alcÃ©lokkal): ${goal.name}`);
    await logActivity(`âŒ CÃ©l visszavonva: ${goal.name} (-${goal.points} pont)`);
    await saveDataToFirestore();

  } else {
    // A fÅ‘ cÃ©l Ã¡llapota nem vÃ¡ltozott, csak az alcÃ©lÃ©
    await saveDataToFirestore();
  }
  
  // 4. FÅ‘ cÃ©l lista Ãºjra-rajzolÃ¡sa
  renderGoals();
}

// =======================================================
// ===== JAVÃTOTT CÃ‰LKEZELÅ FÃœGGVÃ‰NYEK VÃ‰GE =====
// =======================================================
  
function editGoal(i) {
  editTarget = { type: 'goal', index: i };
  document.getElementById("editTitle").textContent = "ğŸ¯ CÃ©l szerkesztÃ©se";
  
  document.getElementById("editLabel1").textContent = "CÃ©l neve";
  document.getElementById("editInput1").value = goals[i].name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont Ã©rtÃ©k";
  document.getElementById("editInput2").value = goals[i].points;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";
  
  document.getElementById("editLabel3").textContent = "KategÃ³ria (opcionÃ¡lis)";
  document.getElementById("editInput3").value = goals[i].category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editInput3").style.display = "block";
  
  // ÃšJ: AlcÃ©lok betÃ¶ltÃ©se a szerkesztÅ‘be
  const subGoalsText = (goals[i].subGoals || [])
    .map(sg => sg.text)
    .join('\n');
  document.getElementById("editLabelSubGoals").style.display = "block";
  document.getElementById("editInputSubGoals").value = subGoalsText;
  document.getElementById("editInputSubGoals").style.display = "block";

  // ÃšJ: IsmÃ©tlÅ‘dÃ©s mezÅ‘k betÃ¶ltÃ©se
  const isRecurring = goals[i].isRecurring || false;
  document.getElementById("editRecurringFields").style.display = "block";
  document.getElementById("editIsRecurringInput").checked = isRecurring;
  document.getElementById("editRecurrenceOptions").style.display = isRecurring ? "block" : "none";
  document.getElementById("editRecurrenceSelect").value = goals[i].recurrence || "daily";

  // MÃ¡s mezÅ‘k elrejtÃ©se
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";

  openModal('editModal');
}

async function deleteGoal(i) { // Make async
  if (i < 0 || i >= goals.length) {
      console.error("Invalid index for deleteGoal:", i);
      return;
  }
  const goalToDelete = goals[i]; 


  goals.splice(i, 1);
  renderGoals();
  await logActivity(`ğŸ—‘ï¸ CÃ©l tÃ¶rÃ¶lve: ${goalToDelete ? goalToDelete.name : 'ismeretlen cÃ©l'}`);
}


function renderGoals() {
  const list = document.getElementById("goalList");
  list.innerHTML = "";

  const categorized = {};
  const uncategorized = [];

  goals.forEach((goal, i) => {
    const item = { ...goal, originalIndex: i };

    if (item.category) {
      if (!categorized[item.category]) {
        categorized[item.category] = [];
      }
      categorized[item.category].push(item);
    } else {
      uncategorized.push(item);
    }
  });

  const renderItem = (g, i) => {
    const div = document.createElement("div");
    div.className = "goal-item" + (g.done ? " completed" : "");
    
    // ===== ALCÃ‰L LOGIKA KEZDETE =====
    let subGoalsHTML = "";
    let hasSubGoals = g.subGoals && g.subGoals.length > 0;
    
    if (hasSubGoals) {
      subGoalsHTML = '<div class="subgoal-list">';
      g.subGoals.forEach((sg, subIndex) => {
        subGoalsHTML += `
          <div>
            <input type="checkbox" onchange="toggleSubGoal(${i}, ${subIndex})" ${sg.done ? 'checked' : ''}>
            <span class="${sg.done ? 'subgoal-done' : ''}">${sg.text}</span>
          </div>
        `;
      });
      subGoalsHTML += '</div>';
    }
    // ===== ALCÃ‰L LOGIKA VÃ‰GE =====
    
    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${g.name} ${g.isRecurring ? 'ğŸ”„' : ''}</div>
        ${subGoalsHTML}
      </div>
      <div class="item-points">
        ${g.points} pont
      </div>
      <div class="item-actions">
	<button class="archive-btn" title="ArchivÃ¡lÃ¡s" onclick="archiveGoal(${i})">ğŸ“¥</button>
        <button onclick="editGoal(${i})" title="SzerkesztÃ©s">âœï¸</button>
        <button onclick="deleteGoal(${i})" title="TÃ¶rlÃ©s">ğŸ—‘ï¸</button>
        ${!hasSubGoals ? (
Â  Â  Â  Â  Â  g.done 
Â  Â  Â  Â  Â  Â  ? `<button onclick="toggleGoal(${i})" title="VisszavonÃ¡s">âŒ</button>`
Â  Â  Â  Â  Â  Â  : `<button onclick="toggleGoal(${i})" title="TeljesÃ­t">âœ…</button>`
Â  Â  Â  Â  )
Â  Â  Â  Â  Â  : ''
Â  Â  Â  Â  }
      </div>
    `;
    list.appendChild(div);
  };

  const categoryNames = Object.keys(categorized).sort();
  categoryNames.forEach(categoryName => {
    const title = document.createElement("h3");
    title.className = "category-title";
    title.textContent = categoryName;
    list.appendChild(title);

    categorized[categoryName].forEach(item => {
      renderItem(item, item.originalIndex);
    });
  });

  if (uncategorized.length > 0) {
    if (categoryNames.length > 0) {
      const title = document.createElement("h3");
      title.className = "category-title";
      title.textContent = "EgyÃ©b";
      list.appendChild(title);
    }
    uncategorized.forEach(item => {
      renderItem(item, item.originalIndex);
    });
  }
}

// =======================================================
// ===== ARCHÃVUM FUNKCIÃ“K =====
// =======================================================
function openArchiveModal() {
  renderArchivedGoals();
  openModal('archiveModal');
}

async function archiveGoal(index) {
  const goalToArchive = goals.splice(index, 1)[0];
  
  if (goalToArchive) {
    archivedGoals.unshift(goalToArchive);
    renderGoals();
    await logActivity(`ğŸ“¥ CÃ©l archivÃ¡lva: ${goalToArchive.name}`); 
  }
}

function renderArchivedGoals() {
  const list = document.getElementById("archivedGoalList");
  list.innerHTML = "";

  if (archivedGoals.length === 0) {
    list.innerHTML = "<p style='text-align: center; padding: 10px;'>Nincsenek archivÃ¡lt cÃ©lok.</p>";
    return;
  }

  archivedGoals.forEach((goal, index) => {
    const div = document.createElement("div");
    // Ha ismÃ©tlÅ‘dÅ‘, de mÃ©g nem jÃ¡rt le (azaz 'done'), akkor is Ã¡thÃºzzuk
    div.className = "goal-item completed"; 
    
    // Gomb az ismÃ©tlÅ‘dÃ©s kikapcsolÃ¡sÃ¡hoz (lila szÃ­nnel)
    let recurringBtn = "";
    if (goal.isRecurring) {
      recurringBtn = `<button style="color: #8e24aa;" title="IsmÃ©tlÅ‘dÃ©s kikapcsolÃ¡sa" onclick="toggleRecurrenceInArchive(${index})">ğŸ”„</button>`;
    }

    div.innerHTML = `
      <div class="item-name">
         <div class="item-name-main">${goal.name} ${goal.isRecurring ? 'ğŸ”„' : ''}</div>
      </div>
      <div class="item-points">
        ${goal.points} pont
      </div>
      <div class="item-actions">
        ${recurringBtn} <button class="reactivate-btn" title="VisszaÃ¡llÃ­tÃ¡s" onclick="reactivateGoal(${index})">â™»ï¸</button>
        <button class="delete-btn" title="VÃ©gleges tÃ¶rlÃ©s" onclick="deleteArchivedGoal(${index})">ğŸ—‘ï¸</button>
      </div>
    `;
    list.appendChild(div);
  });
}

async function reactivateGoal(index) {
  const goalToReactivate = archivedGoals.splice(index, 1)[0];
  
  if (goalToReactivate) {
    goalToReactivate.done = false;
    
    // AlcÃ©lok "kipipÃ¡latlanÃ­tÃ¡sa"
    if (goalToReactivate.subGoals && goalToReactivate.subGoals.length > 0) {
      goalToReactivate.subGoals.forEach(sg => {
        sg.done = false;
      });
    }
    
    // BIZTONSÃGI LÃ‰PÃ‰S: TÃ¶rÃ¶ljÃ¼k a legutÃ³bbi teljesÃ­tÃ©st,
    // hogy a manuÃ¡lisan visszaÃ¡llÃ­tott cÃ©l biztosan aktÃ­v maradjon.
    if (goalToReactivate.isRecurring) {
        goalToReactivate.lastCompleted = null;
    }
    
    goals.push(goalToReactivate);
    
    renderGoals();
    renderArchivedGoals(); // Ezt kell futtatni, mert az archÃ­vum lista is vÃ¡ltozott
    await logActivity(`â™»ï¸ CÃ©l visszaÃ¡llÃ­tva: ${goalToReactivate.name}`);
  }
}

async function deleteArchivedGoal(index) {
  if (confirm("Biztosan vÃ©gleg tÃ¶rlÃ¶d ezt az archivÃ¡lt cÃ©lt? Ez nem vonhatÃ³ vissza.")) {
    const deletedGoal = archivedGoals.splice(index, 1)[0];
    
    if (deletedGoal) {
      if (deletedGoal.points > 0) {
          totalPoints -= deletedGoal.points;
          animatePoints(totalPoints);
      }
      renderArchivedGoals();
	  addPointsLogEntry(-deletedGoal.points, `ğŸ—‘ï¸ ArchivÃ¡lt cÃ©l tÃ¶rÃ¶lve: ${deletedGoal.name}`);
      await logActivity(`ğŸ—‘ï¸ ArchivÃ¡lt cÃ©l tÃ¶rÃ¶lve: ${deletedGoal.name} (-${deletedGoal.points} pont)`);
    }
  }
}

// ===== ÃšJ FUNKCIÃ“: IsmÃ©tlÅ‘dÃ©s kikapcsolÃ¡sa az archÃ­vumban =====
async function toggleRecurrenceInArchive(index) {
  if (index < 0 || index >= archivedGoals.length) return;
  
  const goal = archivedGoals[index];
  
  if (!confirm(`Biztosan kikapcsolod az ismÃ©tlÅ‘dÃ©st ennÃ©l a cÃ©lnÃ©l: "${goal.name}"? EttÅ‘l kezdve nem fog automatikusan Ãºjra megjelenni.`)) {
    return;
  }
  
  // TÃ¶rÃ¶ljÃ¼k az ismÃ©tlÅ‘dÃ©shez kapcsolÃ³dÃ³ tulajdonsÃ¡gokat
  delete goal.isRecurring;
  delete goal.recurrence;
  delete goal.lastCompleted;
  
  // Ãšjrarajzoljuk az archÃ­vumot, hogy a gomb eltÅ±njÃ¶n
  renderArchivedGoals();
  await logActivity(`ğŸ”„ IsmÃ©tlÅ‘dÃ©s kikapcsolva: ${goal.name}`);
  // A logActivity mÃ¡r magÃ¡ban foglalja a saveDataToFirestore() hÃ­vÃ¡st
}
// =======================================================


// =======================================================
// ===== JUTALMAK (REFACTORED) =====
// =======================================================
async function saveReward() { // Make async
  const name = document.getElementById("rewardNameInput").value.trim();
  const cost = parseInt(document.getElementById("rewardCostInput").value);
  if (!name || isNaN(cost) || cost <= 0) return alert("Ã‰rvÃ©nytelen nÃ©v vagy pontszÃ¡m!");

  rewards.push({ name, cost });
  document.getElementById("rewardNameInput").value = "";
  document.getElementById("rewardCostInput").value = "";
  closeModal('rewardModal');
  renderRewards();
  await logActivity(`ğŸ Jutalom hozzÃ¡adva: ${name} (${cost} pont)`);
}

async function claimReward(i) { // Make async
  if (totalPoints >= rewards[i].cost) {
    if (confirm(`Biztosan kivÃ¡ltod ezt: "${rewards[i].name}" (${rewards[i].cost} pontÃ©rt)?`)) {
      totalPoints -= rewards[i].cost;
      animatePoints(totalPoints);
      renderRewards();
	  addPointsLogEntry(-rewards[i].cost, `ğŸ‰ Jutalom kivÃ¡ltva: ${rewards[i].name}`);
      await logActivity(`ğŸ‰ Jutalom kivÃ¡ltva: ${rewards[i].name} (-${rewards[i].cost} pont)`);
    }
  } else {
    alert("Nincs elÃ©g pontod!");
  }
}

function editReward(i) {
  editTarget = { type: 'reward', index: i };
  document.getElementById("editTitle").textContent = "ğŸ Jutalom szerkesztÃ©se";

  document.getElementById("editLabel1").textContent = "Jutalom neve";
  document.getElementById("editInput1").value = rewards[i].name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont Ã¡ra";
  document.getElementById("editInput2").value = rewards[i].cost;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";

  document.getElementById("editLabel3").style.display = "none";
  document.getElementById("editInput3").style.display = "none";
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";

  openModal('editModal');
}

async function deleteReward(i) { // Make async
  const deletedName = rewards[i].name;
  rewards.splice(i, 1);
  renderRewards();
  await logActivity(`ğŸ—‘ï¸ Jutalom tÃ¶rÃ¶lve: ${deletedName}`);
}

function renderRewards() {
  const list = document.getElementById("rewardList");
  list.innerHTML = "";
  rewards.forEach((r, i) => {
    const div = document.createElement("div");
    div.className = "reward-item";

    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${r.name}</div>
      </div>
      <div class="item-points">
        ${r.cost} pont
      </div>
      <div class="item-actions">
        <button onclick="editReward(${i})">âœï¸</button>
        <button onclick="deleteReward(${i})">ğŸ—‘ï¸</button>
        <button onclick="claimReward(${i})">ğŸ‰</button>
      </div>
    `;
    list.appendChild(div);
  });
}

// =======================================================
// ===== ÃšJ Ã‰TKEZÃ‰S FUNKCIÃ“K =====
// =======================================================

// A modal cÃ­mkÃ©inek frissÃ­tÃ©se a tÃ­pusvÃ¡lasztÃ³ alapjÃ¡n
function updateMealModalLabels() {
  const type = document.getElementById("mealTypeSelect").value;
  const kcalLabel = document.getElementById("mealKcalLabel");
  const proteinLabel = document.getElementById("mealProteinLabel");
  
  if (type === 'unit') {
    kcalLabel.textContent = "KalÃ³ria (kcal/darab)";
    proteinLabel.textContent = "FehÃ©rje (g/darab)";
  } else { // weight
    kcalLabel.textContent = "KalÃ³ria (kcal/100g)";
    proteinLabel.textContent = "FehÃ©rje (g/100g)";
  }
}

// Ãšj Ã©tel mentÃ©se
async function saveMeal() {
  const name = document.getElementById("mealNameInput").value.trim();
  const type = document.getElementById("mealTypeSelect").value;
  const kcal = parseFloat(document.getElementById("mealKcalInput").value);
  const protein = parseFloat(document.getElementById("mealProteinInput").value);
  
  if (!name) return alert("Az Ã©telnek nevet kell adni!");
  if (isNaN(kcal) || kcal < 0) return alert("Ã‰rvÃ©nytelen kalÃ³ria Ã©rtÃ©k!");
  if (isNaN(protein) || protein < 0) return alert("Ã‰rvÃ©nytelen fehÃ©rje Ã©rtÃ©k!");
  
  const meal = { name, type, kcal, protein };
  
  meals.push(meal);
  
  document.getElementById("mealNameInput").value = "";
  document.getElementById("mealTypeSelect").value = "unit";
  document.getElementById("mealKcalInput").value = "";
  document.getElementById("mealProteinInput").value = "";
  
  closeModal('mealModal');
  renderMeals();
  await logActivity(`ğŸ½ï¸ Ãšj Ã©tel mentve: ${name}`);
}

// Ã‰telek listÃ¡jÃ¡nak kirajzolÃ¡sa
function renderMeals() {
    const list = document.getElementById("mealList");
    list.innerHTML = "";
    
    if (meals.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding: 10px;'>MÃ©g nincsenek mentett Ã©teleid. Adj hozzÃ¡ egyet!</p>";
        return;
    }
    
    meals.forEach((meal, i) => {
        const div = document.createElement("div");
        div.className = "food-item"; // Ãšj CSS osztÃ¡ly
        
        // --- ÃšJ: Progress bar szÃ¡mÃ­tÃ¡sok ---
        const maxCal = 1000;
        const maxProt = 100;
        
        let calPercent = (meal.kcal / maxCal) * 100;
        let protPercent = (meal.protein / maxProt) * 100;
        
        if (calPercent > 100) calPercent = 100;
        if (protPercent > 100) protPercent = 100;
        if (calPercent < 0) calPercent = 0;
        if (protPercent < 0) protPercent = 0;

        // --- VÃ‰GE: Progress bar szÃ¡mÃ­tÃ¡sok ---

        let detailsText = "";
        if (meal.type === 'unit') {
            detailsText = `<span>${meal.kcal} kcal/db</span><span>${meal.protein}g prot./db</span>`;
        } else {
            detailsText = `<span>${meal.kcal} kcal/100g</span><span>${meal.protein}g prot./100g</span>`;
        }
        
        // --- ÃšJ: HTML a progress barokhoz ---
        const progressHTML = `
        <div class="meal-progress-container">
            <div class="meal-progress-wrapper">
                <span class="meal-progress-label">KalÃ³ria:</span>
                <div class="meal-progress-bar-bg">
                    <div class="meal-progress-bar-fill" style="width: ${calPercent}%;"></div>
                </div>
            </div>
            <div class="meal-progress-wrapper">
                <span class="meal-progress-label">Protein:</span>
                <div class="meal-progress-bar-bg">
                    <div class="meal-progress-bar-fill protein" style="width: ${protPercent}%;"></div>
                </div>
            </div>
        </div>
        `;
        // --- VÃ‰GE: Progress bar HTML ---
        
        div.innerHTML = `
        <div class="item-name">
            <div class="item-name-main">${meal.name}</div>
            ${progressHTML}
        </div>
        <div class="item-details">
            ${detailsText}
        </div>
        <div class="item-actions">
            <button onclick="editMeal(${i})" title="SzerkesztÃ©s">âœï¸</button>
            <button onclick="deleteMeal(${i})" title="TÃ¶rlÃ©s">ğŸ—‘ï¸</button>
            <button onclick="openConsumeModal(${i})" title="FogyasztÃ¡s">ğŸ½ï¸</button>
        </div>
        `;
        list.appendChild(div);
    });
}

// Ã‰tel szerkesztÃ©se (megnyitja a szerkesztÅ‘ modalt)
function editMeal(i) {
  editTarget = { type: 'meal', index: i };
  const meal = meals[i];
  
  document.getElementById("editTitle").textContent = "ğŸ½ï¸ Ã‰tel szerkesztÃ©se";

  // Alap mezÅ‘k (Ã¡tnevezve)
  document.getElementById("editLabel1").textContent = "Ã‰tel neve";
  document.getElementById("editInput1").value = meal.name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  // ElrejtjÃ¼k a tÃ¶bbi alap mezÅ‘t
  document.getElementById("editLabel2").style.display = "none";
  document.getElementById("editInput2").style.display = "none";
  document.getElementById("editLabel3").style.display = "none";
  document.getElementById("editInput3").style.display = "none";
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  
  // MegjelenÃ­tjÃ¼k az Ã©tel-specifikus mezÅ‘ket
  document.getElementById("editMealFields").style.display = "block";
  document.getElementById("editMealType").value = meal.type;
  document.getElementById("editMealKcal").value = meal.kcal;
  document.getElementById("editMealProtein").value = meal.protein;

  openModal('editModal');
}

// Ã‰tel tÃ¶rlÃ©se
async function deleteMeal(i) {
  if (confirm(`Biztosan tÃ¶rlÃ¶d ezt az Ã©telt: "${meals[i].name}"?`)) {
    const deletedName = meals[i].name;
    meals.splice(i, 1);
    renderMeals();
    await logActivity(`ğŸ—‘ï¸ Ã‰tel tÃ¶rÃ¶lve: ${deletedName}`);
  }
}

// FogyasztÃ¡s ablak megnyitÃ¡sa
function openConsumeModal(i) {
  editTarget = { type: 'consume', index: i };
  const meal = meals[i];
  
  document.getElementById("consumeMealTitle").textContent = meal.name;
  
  const amountLabel = document.getElementById("consumeAmountLabel");
  const amountInput = document.getElementById("consumeAmountInput");
  
  if (meal.type === 'unit') {
    amountLabel.textContent = "MennyisÃ©g (Darab)";
    amountInput.placeholder = "pl. 2";
    document.getElementById("consumeMealDetails").textContent = `${meal.kcal} kcal, ${meal.protein}g protein / darab`;
  } else {
    amountLabel.textContent = "MennyisÃ©g (Gramm)";
    amountInput.placeholder = "pl. 150";
    document.getElementById("consumeMealDetails").textContent = `${meal.kcal} kcal, ${meal.protein}g protein / 100g`;
  }
  
  amountInput.value = "";
  openModal('consumeModal');
}

// FogyasztÃ¡s megerÅ‘sÃ­tÃ©se
async function confirmConsume() {
  const amount = parseFloat(document.getElementById("consumeAmountInput").value);
  if (!amount || amount <= 0) return alert("Ã‰rvÃ©nytelen mennyisÃ©g!");
  
  const meal = meals[editTarget.index];
  
  let totalKcal = 0;
  let totalProtein = 0;
  let unitLabel = "";
  
  if (meal.type === 'unit') {
    totalKcal = meal.kcal * amount;
    totalProtein = meal.protein * amount;
    unitLabel = "db";
  } else { // weight
    totalKcal = (meal.kcal / 100) * amount;
    totalProtein = (meal.protein / 100) * amount;
    unitLabel = "g";
  }
  
  // Ãšj tranzakciÃ³ lÃ©trehozÃ¡sa
  const transaction = {
    id: Date.now(),
    type: 'meal',
    name: meal.name,
    amount: amount,
    unit: unitLabel,
    totalKcal: totalKcal,
    totalProtein: totalProtein,
    date: new Date()
  };
  transactions.push(transaction);
  
  // Azonnali frissÃ­tÃ©s
  dailyProgress.calories += totalKcal;
  dailyProgress.protein += totalProtein;
  
  updateAllSummaries();
  updateHistory();
  await logActivity(`ğŸ½ï¸ Fogyasztva: ${amount} ${unitLabel} ${meal.name} (+${totalKcal.toFixed(0)} kcal, +${totalProtein.toFixed(0)}g prot.)`);
  
  closeModal('consumeModal');
}


// =======================================================
// ===== KIBÅVÃTETT SZERKESZTÃ‰S FUNKCIÃ“ (REFACTORED) =====
// =======================================================
async function confirmEdit() { // Make async
  const v1 = document.getElementById("editInput1").value; // CÃ­m / NÃ©v

  if (!editTarget) return;

  if (editTarget.type === 'goal') {
    const v2 = parseInt(document.getElementById("editInput2").value); // Pont
    const v3 = document.getElementById("editInput3").value.trim(); // KategÃ³ria

    if (!v1) return alert("A cÃ©lnak nevet kell adni!");
    if (isNaN(v2) || v2 < 0) return alert("Ã‰rvÃ©nytelen pontszÃ¡m! Adj meg 0-t vagy nagyobbat.");

if(goals[editTarget.index].done) {
Â  Â  Â  Â  let diff = v2 - goals[editTarget.index].points;
        if (diff !== 0) {
Â  Â  Â  Â    totalPoints += diff;
          addPointsLogEntry(diff, `âœï¸ PontÃ©rtÃ©k mÃ³dosÃ­tva: ${goals[editTarget.index].name}`);
Â  Â  Â  Â    animatePoints(totalPoints);
        }
Â  Â  }
    goals[editTarget.index].name = v1;
    goals[editTarget.index].points = v2;
    goals[editTarget.index].category = v3;
    
    // ÃšJ: AlcÃ©lok frissÃ­tÃ©se
    const newSubGoalsText = document.getElementById("editInputSubGoals").value;
    const oldSubGoals = goals[editTarget.index].subGoals || [];
    let newSubGoals = [];

    if (newSubGoalsText.trim() !== "") {
      newSubGoals = newSubGoalsText.split('\n')
        .map(text => text.trim())
        .filter(text => text.length > 0)
        .map(text => {
          // MegÅ‘rizzÃ¼k a 'done' stÃ¡tuszt, ha a szÃ¶veg ugyanaz
          const existing = oldSubGoals.find(sg => sg.text === text);
          return existing ? existing : { text: text, done: false };
        });
    }
    
    goals[editTarget.index].subGoals = newSubGoals;
    
    // ÃšJ: IsmÃ©tlÅ‘dÃ©s frissÃ­tÃ©se
    const isRecurring = document.getElementById("editIsRecurringInput").checked;
    if (isRecurring) {
      goals[editTarget.index].isRecurring = true;
      goals[editTarget.index].recurrence = document.getElementById("editRecurrenceSelect").value;
      // a lastCompleted Ã©rtÃ©ket nem bÃ¡ntjuk, megmarad, amÃ­g nem teljesÃ­ti Ãºjra
    } else {
      // Ha kivettÃ¼k az ismÃ©tlÅ‘dÃ©st, tÃ¶rÃ¶ljÃ¼k a tulajdonsÃ¡gokat
      delete goals[editTarget.index].isRecurring;
      delete goals[editTarget.index].recurrence;
      delete goals[editTarget.index].lastCompleted;
    }
    
    // ÃšJ: Ãllapot ÃºjraszÃ¡molÃ¡sa szerkesztÃ©s utÃ¡n
    const goal = goals[editTarget.index];
    const wasMainGoalDone = goal.done;
    const allDone = newSubGoals.length > 0 && newSubGoals.every(sg => sg.done);

    if (allDone && !wasMainGoalDone) {
      goal.done = true;
      // ÃšJ: DÃ¡tum beÃ¡llÃ­tÃ¡sa, ha ismÃ©tlÅ‘dÅ‘
      if (goal.isRecurring) goal.lastCompleted = new Date().toISOString();
      totalPoints += goal.points;
      animatePoints(totalPoints);
    } else if (!allDone && wasMainGoalDone) {
      goal.done = false;
      // ÃšJ: DÃ¡tum tÃ¶rlÃ©se, ha ismÃ©tlÅ‘dÅ‘
      if (goal.isRecurring) goal.lastCompleted = null;
      totalPoints -= goal.points;
      animatePoints(totalPoints);
    }
    
    renderGoals();
    await logActivity(`âœï¸ CÃ©l szerkesztve: ${v1}`);
  }
  else if (editTarget.type === 'reward') {
    const v2 = parseInt(document.getElementById("editInput2").value); // Ãr

    if (!v1) return alert("A jutalomnak nevet kell adni!");
    if (isNaN(v2) || v2 <= 0) return alert("Ã‰rvÃ©nytelen pont Ã¡r! Nagyobbnak kell lennie 0-nÃ¡l.");

    rewards[editTarget.index].name = v1;
    rewards[editTarget.index].cost = v2;
    renderRewards();
    await logActivity(`âœï¸ Jutalom szerkesztve: ${v1}`);
  }
  else if (editTarget.type === 'note') {
Â  Â  const v3 = document.getElementById("editInput3").value.trim(); // KategÃ³ria olvasÃ¡sa
Â  Â  const vText = document.getElementById("editInputText").value.trim();
Â  Â  if (!v1 || !vText) return alert("A cÃ­m Ã©s a szÃ¶veg nem lehet Ã¼res!");

Â  Â  notes[editTarget.index].title = v1;
Â  Â  notes[editTarget.index].category = v3 || null; // KategÃ³ria mentÃ©se
Â  Â  notes[editTarget.index].text = vText;
Â  Â  notes[editTarget.index].date = new Date(); // DÃ¡tum frissÃ­tÃ©se
Â  Â  renderNotes(); // ÃšjrarajzolÃ¡s (hogy a kategÃ³ria frissÃ¼ljÃ¶n)
Â  Â  await logActivity(`âœï¸ Jegyzet szerkesztve: ${v1}`);
Â  }
  else if (editTarget.type === 'workout') {
    const vText = document.getElementById("editInputText").value.trim();
    workouts[editTarget.index].note = vText;
    await logActivity(`âœï¸ EdzÃ©sjegyzet mentve: ${workouts[editTarget.index].date}`);
  }
  // ÃšJ: Ã‰TEL SZERKESZTÃ‰SÃ‰NEK MENTÃ‰SE
  else if (editTarget.type === 'meal') {
    const name = v1;
    const type = document.getElementById("editMealType").value;
    const kcal = parseFloat(document.getElementById("editMealKcal").value);
    const protein = parseFloat(document.getElementById("editMealProtein").value);

    if (!name) return alert("Az Ã©telnek nevet kell adni!");
    if (isNaN(kcal) || kcal < 0) return alert("Ã‰rvÃ©nytelen kalÃ³ria Ã©rtÃ©k!");
    if (isNaN(protein) || protein < 0) return alert("Ã‰rvÃ©nytelen fehÃ©rje Ã©rtÃ©k!");
    
    meals[editTarget.index] = { name, type, kcal, protein };
    renderMeals();
    await logActivity(`âœï¸ Ã‰tel szerkesztve: ${name}`);
  }

  closeModal('editModal');
  // VisszaÃ¡llÃ­tjuk az editModal mezÅ‘it alaphelyzetbe
  document.getElementById("editLabel1").style.display = "block";
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  // ÃšJ: IsmÃ©tlÅ‘dÃ©s mezÅ‘ elrejtÃ©se
  document.getElementById("editRecurringFields").style.display = "none";
}

// ===== NAPLÃ“ (REFACTORED) =====
async function logActivity(text) { // Make async
  const time = new Date();
  const entry = { time, text };
  
  if (!Array.isArray(logs)) {
    console.error("Logs is not an array, resetting.");
    logs = [];
  }

  logs.unshift(entry);
  if (logs.length > 100) logs.pop();
  renderLogs();
  
  await saveDataToFirestore();
}

function renderLogs() {
  const logDiv = document.getElementById("activityLog");
  logDiv.innerHTML = "";
  logs.forEach((l, i) => {
    let displayTime = "...";
    if (l.time) {
      if (typeof l.time.toDate === 'function') {
        displayTime = l.time.toDate().toLocaleString();
      } else {
        displayTime = new Date(l.time).toLocaleString();
      }
    }

    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `
      <span>${l.text}</span>
      <small>${displayTime}</small>
      <button style="background:none;color:#c00" onclick="deleteLog(${i})">ğŸ—‘ï¸</button>
    `;
    logDiv.appendChild(div);
  });
}

async function deleteLog(i) { // Make async
  logs.splice(i, 1);
  renderLogs();
  await saveDataToFirestore();
}

async function clearAllLogs() { // Make async
  if (confirm("Biztos tÃ¶rlÃ¶d az Ã¶sszes naplÃ³bejegyzÃ©st?")) {
    logs = [];
    renderLogs();
    await saveDataToFirestore();
  }
}

// =======================================================
// ===== ÃšJ PONT TÃ–RTÃ‰NET FUNKCIÃ“K =====
// =======================================================

/**
 * LÃ©trehoz egy bejegyzÃ©st a pontnaplÃ³ban.
 * Ezt a fÃ¼ggvÃ©nyt NEM kell await-elni, Ã©s NEM ment magÃ¡tÃ³l.
 */
function addPointsLogEntry(amount, reason) {
  if (amount === 0) return; // 0 pontos vÃ¡ltozÃ¡st nem naplÃ³zunk

  const entry = {
    id: Date.now() + Math.random(), // Egyedi ID a tÃ¶rlÃ©shez
    time: new Date(),
    amount: amount,
    reason: reason
  };
  pointsLog.unshift(entry);
  if (pointsLog.length > 100) pointsLog.pop(); // LimitÃ¡ljuk a naplÃ³t
}

/**
 * Kirajzolja a ponttÃ¶rtÃ©net listÃ¡jÃ¡t.
 */
function renderPointsLog() {
  const logDiv = document.getElementById("pointsHistoryList");
  if (!logDiv) return; // Ha nincs meg a div, ne fusson
  
  logDiv.innerHTML = "";
  
  if (pointsLog.length === 0) {
    logDiv.innerHTML = "<p style='text-align: center; padding: 10px;'>MÃ©g nincsenek pontbejegyzÃ©sek.</p>";
    return;
  }
  
  pointsLog.forEach((entry) => {
    let displayTime = "...";
    if (entry.time) {
      if (typeof entry.time.toDate === 'function') {
        displayTime = entry.time.toDate().toLocaleString();
      } else {
        displayTime = new Date(entry.time).toLocaleString();
      }
    }
    
    const amountColor = entry.amount > 0 ? '#00796b' : '#c00'; // ZÃ¶ld vagy piros
    const amountSign = entry.amount > 0 ? '+' : '';

    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `
      <span>
        <strong style="color: ${amountColor};">
          ${amountSign}${entry.amount} pont
        </strong>
        - ${entry.reason}
      </span>
      <small>${displayTime}</small>
      <button style="background:none;color:#c00" onclick="deletePointsLogEntry(${entry.id})">ğŸ—‘ï¸</button>
    `;
    logDiv.appendChild(div);
  });
}

/**
 * TÃ¶rÃ¶l egy pontbejegyzÃ©st Ã©s visszavonja a pontszÃ¡mot.
 */
async function deletePointsLogEntry(id) {
  const index = pointsLog.findIndex(e => e.id === id);
  if (index === -1) {
    console.error("Nem talÃ¡lhatÃ³ a pontbejegyzÃ©s:", id);
    return;
  }
  
  const entry = pointsLog.splice(index, 1)[0];
  
  if (entry && entry.amount) {
    // VISSZAVONJUK A PONTOKAT
    totalPoints -= entry.amount;
    animatePoints(totalPoints);
    
    // FrissÃ­tjÃ¼k a nÃ©zetet Ã©s mentÃ¼nk
    renderPointsLog();
    // SpeciÃ¡lis naplÃ³zÃ¡s magÃ¡rÃ³l a tÃ¶rlÃ©srÅ‘l (de ez nem kerÃ¼l a pontnaplÃ³ba)
    await logActivity(`ğŸ—‘ï¸ PontnaplÃ³ tÃ¶rÃ¶lve: ${entry.reason} (${-entry.amount} pont)`);
    // a logActivity mÃ¡r ment, de a biztonsÃ¡g kedvÃ©Ã©rt a totalPoints-ot is mentjÃ¼k
    await saveDataToFirestore(); 
  }
}

// =======================================================
// ===== GRAFIKON (REFACTORED) =====
// =======================================================
function updateChart() {
  const ctx = document.getElementById("progressChart");
  if (!ctx) return;

  const weightEntries = transactions.filter(t => t.type === 'weight');
  const weights = weightEntries.map(e => e.value);
  const labels = weightEntries.map(e => {
    if (e.date) {
      if (typeof e.date.toDate === 'function') {
        return e.date.toDate().toLocaleDateString();
      } else {
        return new Date(e.date).toLocaleDateString();
      }
    }
    return "?";
  });

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "SÃºly (kg)",
        data: weights,
        borderWidth: 3,
        borderColor: "#00796b",
        tension: 0.3,
        spanGaps: true
      }]
    },
    options: {
      scales: { y: { beginAtZero: false } }
    }
  });
}

// ===== NAPI MOTIVÃCIÃ“ =====
function loadMotivation() {
  const tateTips = [
    "Ne vÃ¡rj kedvre â€“ csak a gyengÃ©k vÃ¡rnak rÃ¡. Tedd, amit kell.",
    "Ha a tested tiltakozik, az elmÃ©d parancsoljon neki.",
    "A fegyelem legyÅ‘zi a lustasÃ¡got minden nap.",
    "Minden korty vÃ­z egy lÃ©pÃ©s az uralkodÃ¡s felÃ©.",
    "A fÃ©rfi, aki nem kontrollÃ¡lja az Ã©tvÃ¡gyÃ¡t, nem uralja az Ã©letÃ©t."
  ];
  const day = new Date().getDate();
  document.getElementById("motivationBar").innerText = `Tipp: â€${tateTips[day % tateTips.length]}â€`;
}

// ===== HALADÃS TÃ–RTÃ‰NET =====
function updateHistory() {
  const div = document.getElementById("historyList");
  div.innerHTML = "";

  if (transactions.length === 0) {
    div.innerHTML = "<p>MÃ©g nincsenek adatbejegyzÃ©sek.</p>";
    return;
  }

  transactions.slice().reverse().forEach((t, i) => {
    const originalIndex = transactions.length - 1 - i;
    const item = document.createElement("div");
    item.className = "log-entry";

    let text = "";
    if (t.type === 'weight') {
      text = `âš–ï¸ SÃºly: <b>${t.value} kg</b>`;
    } else if (t.type === 'water') {
      text = `ğŸ’§ VÃ­z: <b>${t.value} L</b>`;
    } else if (t.type === 'calories') {
      text = `ğŸ”¥ KalÃ³ria: <b>${t.value} kcal</b>`;
    } else if (t.type === 'protein') { // ÃšJ
      text = `ğŸ¥© Protein: <b>${t.value} g</b>`;
    } else if (t.type === 'meal') { // ÃšJ
      text = `ğŸ½ï¸ Ã‰tkezÃ©s: <b>${t.name}</b> (${t.amount} ${t.unit}) - <b>${t.totalKcal.toFixed(0)} kcal</b>, <b>${t.totalProtein.toFixed(0)}g</b> protein`;
    }
    
    let displayDate = "...";
    if (t.date) {
      if (typeof t.date.toDate === 'function') {
        displayDate = t.date.toDate().toLocaleString();
      } else {
        displayDate = new Date(t.date).toLocaleString();
      }
    }

    item.innerHTML = `
      <span>
        <b>${displayDate}</b> â€” ${text}
      </span>
      <button style="background:none;color:#c00" onclick="deleteTransaction(${originalIndex})">ğŸ—‘ï¸</button>
    `;
    div.appendChild(item);
  });
}


// =======================================================
// ===== EXPORT / IMPORT / RESET (REFACTORED) =====
// =======================================================
function exportData() {
  const allData = {
    goals, rewards, notes, transactions, logs, totalPoints,
    workouts,
    meals,
    reminders, // ÃšJ
    archivedGoals,
    goalWeight: goalWeightSetting,
    goalWater: goalWaterSetting,
    goalCalories: goalCaloriesSetting,
    goalProtein: goalProteinSetting 
  };
  const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `FitGarden_Backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  logActivity("ğŸ’¾ Adatok exportÃ¡lva");
}

async function importData(event) { // Make async
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async e => { // Make async
    try {
      const data = JSON.parse(e.target.result);
      goals = data.goals || [];
      rewards = data.rewards || [];
      notes = data.notes || [];
      transactions = data.transactions || [];
      logs = data.logs || [];
      workouts = data.workouts || [];
      meals = data.meals || []; 
      reminders = data.reminders || []; // ÃšJ
      archivedGoals = data.archivedGoals || [];
      totalPoints = data.totalPoints || 0;
      
      goalWeightSetting = data.goalWeight || "";
      goalWaterSetting = data.goalWater || "";
      goalCaloriesSetting = data.goalCalories || "";
      goalProteinSetting = data.goalProtein || ""; 
      
      await saveDataToFirestore();
      
      renderAll();
      logActivity("ğŸ“‚ Adatok importÃ¡lva");
      alert("Sikeres importÃ¡lÃ¡s! Minden adat frissÃ­tve âœ…");
    } catch {
      alert("âŒ Hiba: a fÃ¡jl nem megfelelÅ‘ formÃ¡tumÃº!");
    }
  };
  reader.readAsText(file);
}

async function resetAll() { // Make async
  if (confirm("Biztosan tÃ¶rÃ¶lni szeretnÃ©l MINDENT? Ez vÃ©gleges!")) {
    goals = [];
    rewards = [];
    notes = [];
    transactions = [];
    logs = [];
    workouts = [];
    meals = []; 
    reminders = []; // ÃšJ
    archivedGoals = [];
    totalPoints = 0;
    goalWeightSetting = "";
    goalWaterSetting = "";
    goalCaloriesSetting = "";
    goalProteinSetting = ""; 
    
    renderAll();
    await logActivity("âš ï¸ Teljes rendszer reset");
    alert("FitGarden ÃºjraindÃ­tva, minden tÃ¶rÃ¶lve âœ…");
  }
}

function renderAll() {
  calculateDailyProgress();
  
  document.getElementById("totalPointsDisplay").textContent = totalPoints;
  
  renderGoals();
  renderRewards();
  renderNotes();
  renderLogs();
  renderPointsLog(); // ÃšJ PONTNAPLÃ“ RENDERELÃ‰SE
Â  renderReminders(); // ÃšJ
  
  updateAllSummaries();
  updateHistory();
  updateCompactSummaries();
  
  if(document.getElementById('workouts').classList.contains('active')) {
    renderWorkouts();
  }
  if(document.getElementById('meals').classList.contains('active')) {
    renderMeals();
  }
  // Nincs szÃ¼ksÃ©g kÃ¼lÃ¶n renderReminders() hÃ­vÃ¡sra itt,
  // mert a showTab() mÃ¡r kezeli, amikor odalÃ©pÃ¼nk.
}

// =======================================================
// ===== ÃšJ EMLÃ‰KEZTETÅ FUNKCIÃ“K =====
// =======================================================

/**
 * EllenÅ‘rzi az Ã©rtesÃ­tÃ©si engedÃ©lyt, Ã©s kÃ©ri, ha mÃ©g nincs beÃ¡llÃ­tva.
 */
function checkNotificationPermission() {
  // EllenÅ‘rizzÃ¼k, hogy a bÃ¶ngÃ©szÅ‘ tÃ¡mogatja-e az Ã©rtesÃ­tÃ©seket
  if (!('Notification' in window)) {
    console.warn("Ez a bÃ¶ngÃ©szÅ‘ nem tÃ¡mogatja az asztali Ã©rtesÃ­tÃ©seket.");
    return;
  }

  // KÃ©rjÃ¼nk engedÃ©lyt, ha mÃ©g nincs 'granted' (engedÃ©lyezve) vagy 'denied' (letiltva)
  if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        console.log('Ã‰rtesÃ­tÃ©si engedÃ©ly megadva.');
        new Notification('FitGarden', { body: 'Sikeresen engedÃ©lyezted az Ã©rtesÃ­tÃ©seket!', icon: 'ğŸ””' });
      } else {
        console.log('Ã‰rtesÃ­tÃ©si engedÃ©ly elutasÃ­tva.');
      }
    });
  }
}

/**
 * HozzÃ¡ad egy Ãºj emlÃ©keztetÅ‘t a listÃ¡hoz.
 */
async function addReminder() {
  const textInput = document.getElementById("reminderTextInput");
  const timeInput = document.getElementById("reminderTimeInput");
  
  const text = textInput.value.trim();
  const time = timeInput.value;

  if (!text || !time) {
    alert("KÃ©rlek adj meg egy szÃ¶veget Ã©s egy idÅ‘pontot!");
    return;
  }

  const reminderTime = new Date(time);
  if (reminderTime <= new Date()) {
    alert("Az emlÃ©keztetÅ‘ idÅ‘pontjÃ¡nak a jÃ¶vÅ‘ben kell lennie!");
    return;
  }

  reminders.push({
    id: Date.now(),
    text: text,
    time: reminderTime.toISOString(), // ISO stringkÃ©nt tÃ¡roljuk
    triggered: false // MÃ©g nem lett aktivÃ¡lva
  });

  textInput.value = "";
  timeInput.value = "";

  renderReminders();
  await saveDataToFirestore();
}

/**
 * TÃ¶rÃ¶l egy emlÃ©keztetÅ‘t az indexe alapjÃ¡n.
 */
async function deleteReminder(id) {
  if (!confirm("Biztosan tÃ¶rlÃ¶d ezt az emlÃ©keztetÅ‘t?")) {
    return;
  }
  
  reminders = reminders.filter(r => r.id !== id);
  
  renderReminders();
  await saveDataToFirestore();
}

/**
 * Kirajzolja az aktÃ­v emlÃ©keztetÅ‘k listÃ¡jÃ¡t.
 */
function renderReminders() {
  const list = document.getElementById("reminderList");
  if (!list) return; // Ha a fÃ¼l mÃ©g nem aktÃ­v, ne csinÃ¡ljon semmit
  list.innerHTML = "";

  // Csak azokat mutatjuk, amik mÃ©g nem sÃ¼ltek el
  const pendingReminders = reminders
    .filter(r => !r.triggered)
    .sort((a, b) => new Date(a.time) - new Date(b.time)); // IdÅ‘rendben

  if (pendingReminders.length === 0) {
    list.innerHTML = "<p>Nincsenek aktÃ­v emlÃ©keztetÅ‘k.</p>";
    return;
  }

  pendingReminders.forEach(r => {
    const div = document.createElement("div");
    div.className = "log-entry"; // ÃšjrahasznosÃ­tjuk a log stÃ­lusÃ¡t
    
    const displayTime = new Date(r.time).toLocaleString(); // FelhasznÃ¡lÃ³barÃ¡t dÃ¡tum

    div.innerHTML = `
        <span>ğŸ”” <b>${r.text}</b></span>
        <small>${displayTime}</small>
        <button style="background:none;color:#c00" onclick="deleteReminder(${r.id})">ğŸ—‘ï¸</button>
    `;
    list.appendChild(div);
  });
}

/**
 * ElindÃ­tja az idÅ‘zÃ­tÅ‘t, ami rendszeresen ellenÅ‘rzi az emlÃ©keztetÅ‘ket.
 */
function startReminderEngine() {
  // Ha mÃ¡r fut, ne indÃ­tsuk Ãºjra
  if (reminderCheckInterval) {
    clearInterval(reminderCheckInterval);
  }

  // 30 mÃ¡sodpercenkÃ©nt ellenÅ‘rizzÃ¼k, van-e teendÅ‘
  reminderCheckInterval = setInterval(checkReminders, 30000); 
  
  // IndÃ­tÃ¡skor azonnal lefuttatjuk, hogy az esetleg lekÃ©sett emlÃ©keztetÅ‘k megjelenjenek
  checkReminders();
}

/**
 * EllenÅ‘rzi az emlÃ©keztetÅ‘ket, Ã©s aktivÃ¡lja azokat, amiknek lejÃ¡rt az ideje.
 */
function checkReminders() {
  const now = new Date();
  let needsSave = false; // Csak akkor mentÃ¼nk, ha vÃ¡ltozÃ¡s tÃ¶rtÃ©nt

  reminders.forEach(r => {
    if (!r.triggered && new Date(r.time) <= now) {
      // Itt az idÅ‘!
      showReminderNotification(r);
      r.triggered = true;
      needsSave = true;
    }
  });

  if (needsSave) {
    // FrissÃ­tjÃ¼k a listÃ¡t (hogy eltÅ±njenek a kisÃ¼ltek) Ã©s mentÃ¼nk
    // Csak akkor renderelÃ¼nk, ha Ã©pp az a fÃ¼l van nyitva
    if (document.getElementById('reminders').classList.contains('active')) {
        renderReminders();
    }
    saveDataToFirestore();
  }
}

/**
 * MegjelenÃ­ti a bÃ¶ngÃ©szÅ‘ Ã©rtesÃ­tÃ©st.
 */
function showReminderNotification(reminder) {
  if (Notification.permission === 'granted') {
    // JelenÃ­tsÃ¼k meg az Ã©rtesÃ­tÃ©st
    new Notification('FitGarden EmlÃ©keztetÅ‘', {
      body: reminder.text,
      icon: 'https://img.icons8.com/color/96/leaf.png' // Egy egyszerÅ± levÃ©l ikon
    });
  } else {
    // Ha valamiÃ©rt nincs engedÃ©ly (pl. visszavonta), csak a konzolra Ã­runk.
    console.warn(`EmlÃ©keztetÅ‘ elsÃ¼tve (de nincs engedÃ©ly): ${reminder.text}`);
  }
}

// =======================================================

</script>

</body>
</html>
