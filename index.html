<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FitGarden 2.0 â€“ Fejedelem Edition ğŸ’ªğŸŒ¿</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ”¥</text></svg>">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
      margin: 0;
      padding: 0;
      color: #222;
      overflow-x: hidden;
    }

    #motivationBar {
      background: #004d40;
      color: white;
      padding: 8px;
      text-align: center;
      font-style: italic;
      font-size: 0.95em;
      letter-spacing: 0.3px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    main {
      max-width: 1200px;
      margin: 5px auto;
      padding: 1px;
    }

    .card {
      background: white;
      border-radius: 18px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 6px;
      margin-bottom: 5px;
    }

    h2 {
      color: #00796b;
      margin-bottom: 5px;
	  font-size: large;
    }

    button {
      background: #00796b;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 8px 15px;
      font-size: 0.95em;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #004d40;
    }

    .icon-box {
      display: flex;
      justify-content: space-around;
      align-items: stretch;
      gap: 15px;
      flex-wrap: wrap;
    }

    .icon-card {
      flex: 1;
      min-width: 280px;
      background: #e8f5e9;
      border-radius: 12px;
      text-align: center;
      padding: 20px;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .icon-card i {
      font-size: 2em;
      color: #00796b;
      display: block;
    }

    .icon-card span {
      display: block;
      margin-top: 5px;
      font-weight: bold;
      font-size: 1.1em;
    }

    .edit-btn {
      position: absolute;
      top: 8px;
      right: 10px;
      background: none;
      color: #00796b;
      border: none;
      font-size: 1.1em;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }

    #tabs {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
      gap: 8px;
    }

    .tab-btn {
      background: #dcedc8;
      color: black;
      padding: 10px 15px;
      /* Kicsit csÃ¶kkentettem a paddingot */
      border-radius: 10px;
      margin: 0;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);

      /* ÃšJ RÃ‰SZEK INNENTÅL */
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      /* TÃ¡volsÃ¡g az ikon Ã©s a szÃ¶veg kÃ¶zÃ¶tt */
      flex-grow: 1;
      /* NÃ¶vekedhessen */
      flex-shrink: 1;
      /* Zsugorodjon */
      flex-basis: 120px;
      /* Egy alapÃ©rtelmezett kiindulÃ³ szÃ©lessÃ©g */
      box-sizing: border-box;
      /* Ez biztosÃ­tja, hogy a padding ne rontsa el a mÃ©retezÃ©st */
    }

    .tab-btn.active {
      background: #00796b;
      color: white;
      font-weight: bold;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* EZT A BLOKKOT MÃSOLD BE */
    .tab-icon {
      font-size: 1.1em;
      line-height: 1;
      /* MegakadÃ¡lyozza a felesleges magassÃ¡got */
    }

    .tab-text {
      white-space: nowrap;
      /* MegakadÃ¡lyozza, hogy a szÃ¶veg tÃ¶rjÃ¶n */
    }
    /* ================================================== */
    /* ================================================== */
    /* ===== CÃ‰L/JUTALOM ELRENDEZÃ‰S ===== */
    /* ================================================== */
    .flex-container {
      display: flex;
      gap: 25px;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .flex-container>.card {
      flex: 1;
      min-width: 300px;
    }
	/* ================================================== */
    /* ===== ÃšJ PRIORITÃS CÃ‰L STÃLUSOK (PIROS) ===== */
    /* ================================================== */
    .goal-item.priority .item-name {
      background: #ffebee; /* VilÃ¡gos piros */
      color: #c62828; /* SÃ¶tÃ©t piros szÃ¶veg */
    }
    .goal-item.priority .item-points {
      background: #ffcdd2; /* KÃ¶zepes piros */
      border-left: 1px solid #ef9a9a;
      border-right: 1px solid #ef9a9a;
      color: #b71c1c;
    }
    .goal-item.priority .item-actions {
      background: #ffebee; /* VilÃ¡gos piros */
    }
    /* A kiemelt alcÃ©lok cÃ­me is legyen piros */
    .goal-item.priority .subgoal-header {
        color: #c62828;
        border-bottom: 1px solid #ffcdd2;
    }

    /* ================================================== */
    /* ================================================== */
    /* ===== KÃRTYA FEJLÃ‰C (CÃM + GOMB/PONTOK) STÃLUS ===== */
    /* ================================================== */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h2 {
      margin-bottom: 8px;
    }

    /* ÃšJ STÃLUS A FEJLÃ‰C ARCHÃV GOMBJÃHOZ */
    .card-header .card-header-add-btn {
      background: #00796b;
      /* VilÃ¡gosabb zÃ¶ld, mint az archÃ­v gomb */
      font-size: 0.9em;
      padding: 6px 12px;
      font-weight: bold;
    }

    .card-header .new-note-btn-left {
      margin-right: auto;
      /* Ez tolja el a gombot balra, amennyire csak lehet */

    }

    .card-header .card-header-add-btn:hover {
      background: #004d40;
      /* SÃ¶tÃ©tebb zÃ¶ld hover-re */
    }

    /* ================================================== */

    /* ================================================== */
    /* ===== PONTSZÃMLÃLÃ“ (JUTALMAK FEJLÃ‰C) ===== */
    /* ================================================== */
    .header-points-display {
      display: flex;
      align-items: center;
      font-weight: bold;
    }

    .header-points-display .points-icon {
      font-size: 1.3em;
      margin-right: 8px;
      color: #00796b;
      /* TÃ©ma zÃ¶ld */
      line-height: 1;
    }

    .header-points-display .points-number {
      color: #004d40;
      /* SÃ¶tÃ©t zÃ¶ld */
      font-size: 1.4em;
      /* Kiemelt szÃ¡m */
      line-height: 1;
    }

    .header-points-display .points-label {
      color: #00796b;
      /* TÃ©ma zÃ¶ld */
      margin-left: 5px;
      font-size: 1.1em;
      line-height: 1;
    }

    /* ================================================== */

    /* ================================================== */
    /* ===== ÃšJ GOMB STÃLUS (KÃRTYA ALJÃN) ===== */
    /* ================================================== */
    .new-item-button {
      width: 100%;
      /* Teljes szÃ©lessÃ©g */
      padding: 12px;
      /* Nagyobb, kÃ©nyelmesebb gomb */
      font-size: 1em;
      font-weight: bold;
      margin-top: 15px;
      /* TÃ¡volsÃ¡g a listÃ¡tÃ³l */
    }

    /* ================================================== */


    /* ================================================== */
    /* ===== CÃ‰L, JUTALOM, Ã‰TEL SÃV STÃLUS ===== */
    /* ================================================== */
    .goal-item,
    .reward-item,
    .food-item {
      background: transparent;
      border-radius: 10px;
      padding: 0;
      margin-bottom: 8px;
      display: flex;
      overflow: hidden;
      align-items: stretch;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .completed {
      text-decoration: line-through;
      opacity: 0.7;
    }

    .item-name {
      flex: 1;
      padding: 7px 15px;
      background: #e8f5e9;
      /* VilÃ¡gos zÃ¶ld */
      display: flex;
      flex-direction: column;
      /* MÃ“DOSÃTVA */
      align-items: flex-start;
      /* MÃ“DOSÃTVA */
    }

    .item-points {
      flex-shrink: 0;
      align-items: center;
      justify-content: center;
      width: 78px;
      padding: 2px;
      background: #dcedc8;
      /* Ãrnyalattal sÃ¶tÃ©tebb zÃ¶ld */
      text-align: center;
      font-weight: bold;
      border-left: 1px solid #c8e6c9;
      border-right: 1px solid #c8e6c9;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ÃšJ STÃLUS AZ Ã‰TEL KÃRTYÃHOZ */
    .food-item .item-details {
      flex-shrink: 0;
      width: 120px;
      padding: 1px;
      background: #dcedc8;
      text-align: center;
      font-weight: bold;
      border-left: 1px solid #c8e6c9;
      border-right: 1px solid #c8e6c9;
      font-size: 0.9em;
      line-height: 1.3;
    }

    .food-item .item-details span {
      display: block;
    }

    /* ================================================== */

    .item-actions {
      flex-shrink: 0;
      padding: 7px 10px;
      background: #e8f5e9;
      /* VilÃ¡gos zÃ¶ld */
      display: flex;
      gap: 5px;
      justify-content: center;
      align-items: center;
    }

    .item-actions button {
      background: transparent;
      color: #00796b;
      font-size: 1.1em;
      cursor: pointer;
      padding: 1px;
    }

    /* ÃšJ STÃLUSOK AZ ARCHIVÃLÃSHOZ */
    .item-actions button.archive-btn {
      color: #004d40;
      /* SÃ¶tÃ©tzÃ¶ld az archivÃ¡lÃ¡shoz */
    }

    /* StÃ­lus az archivÃ¡lt elemek gombjaihoz */
    #archivedGoalList .item-actions button.reactivate-btn {
      color: #00796b;
      /* ZÃ¶ld */
    }

    #archivedGoalList .item-actions button.delete-btn {
      color: #c00;
      /* Piros */
    }


    .category-title {
      margin-bottom: 5px;
      color: #004d40;
      border-bottom: 2px solid #b2dfdb;
      padding-bottom: 4px;
      font-size: 1.1em;
    }

    #goalList .category-title:first-of-type {
      margin-top: 10px;
    }

    /* ================================================== */
    /* ===== ÃšJ ALCÃ‰L (SUB-GOAL) STÃLUSOK ===== */
    /* ================================================== */
    .subgoal-list {
      margin-top: 10px;
      padding-left: 1px;
      font-size: 0.9em;
      text-align: left;
      width: 100%;
      /* KitÃ¶lti a .item-name szÃ©lessÃ©gÃ©t */
    }

    .subgoal-header {
      font-size: 1.1em;
      font-weight: bold;
      color: #004d40;
      /* SÃ¶tÃ©t zÃ¶ld, mint a kategÃ³ria cÃ­mek */
      margin-top: 15px;
      margin-bottom: 5px;
      padding-bottom: 2px;
      border-bottom: 1px solid #dcedc8;
      /* Finom vonal alatta */
    }

    .subgoal-list .subgoal-header:first-child {
      margin-top: 5px;
      /* Kisebb margÃ³, ha ez az elsÅ‘ elem */
    }

    .subgoal-separator {
      border: none;
      border-top: 2px dashed #b2dfdb;
      /* Szaggatott vonal a tÃ©ma szÃ­nÃ©vel */
      margin: 10px 0;
    }

    .subgoal-list div {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      text-decoration: none;
      /* Ne hÃºzza Ã¡t az alcÃ©l szÃ¶vegÃ©t */
    }

    .subgoal-list input[type="checkbox"] {
      width: auto;
      margin: 0 10px 0 0;
    }

    .subgoal-list span.subgoal-done {
      text-decoration: line-through;
      opacity: 0.7;
    }

    /* Amikor a FÅ cÃ©l kÃ©sz, a FÅ cÃ­m Ã¡thÃºzva */
    .goal-item.completed .item-name-main {
      text-decoration: line-through;
    }

    /* De a sub-goal lista soha (csak a belsÅ‘ span) */
    .goal-item.completed .subgoal-list {
      text-decoration: none;
    }

    /* ================================================== */


    .log {
      background: #f8f8f8;
      border-radius: 10px;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
    }

    .log-entry {
      border-bottom: 1px solid #ddd;
      padding: 6px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .log-entry span {
      flex: 1;
      padding-right: 10px;
    }

    .log-entry small {
      color: #777;
      font-size: 0.85em;
      margin-left: 10px;
    }

    .log-entry button {
      flex-shrink: 0;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
	
	#editModal {
      z-index: 2000 !important;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
    }

    .modal-content h3 {
      margin-top: 0;
      color: #00796b;
      text-align: center;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 6px;
      margin-top: 2px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1em;
      box-sizing: border-box;
      background-color: white;
      /* Select hÃ¡tÃ©rszÃ­n */
    }

    /* ================================================== */
    /* ===== GRAFIKON MODAL STÃLUSOK ===== */
    /* ================================================== */
    #chartModalContent {
      max-width: 90%;
      width: 800px;
    }

    #progressChart {
      width: 100%;
      height: 400px;
    }

    /* ================================================== */


    /* ====== KÃ–VETÃ‰S STÃLUSOK ====== */
    .icon-card .content-wrapper {
      margin-top: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }

    .progress-summary {
      font-size: 0.9em;
      font-weight: bold;
      color: #004d40;
      margin-top: 10px;
      margin-bottom: 10px;
      height: 1.2em;
    }

    .input-group {
      display: flex;
      margin-top: 10px;
      gap: 5px;
    }

    .input-group input {
      flex: 1;
      width: 60%;
      margin: 0;
      font-size: 0.9em;
      text-align: center;
    }

    .input-group button {
      flex-shrink: 0;
      font-size: 0.85em;
      padding: 8px 10px;
    }

    .progress-bar-container {
      background: #c8e6c9;
      border-radius: 10px;
      height: 12px;
      width: 100%;
      margin-top: 10px;
      overflow: hidden;
      border: 1px solid #a5d6a7;
    }

    .progress-bar {
      background: #00796b;
      height: 100%;
      width: 0%;
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    /* ÃšJ: A PROTEIN SÃV SZÃNE */
    #proteinProgressBar {
      background: #8e24aa;
      /* Lila */
    }

    /* ====== ANIMÃCIÃ“K ====== */
    .fade-in {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.6s ease forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    button,
    .tab-btn {
      transition: transform 0.15s ease, background-color 0.3s;
    }

    button:hover,
    .tab-btn:hover {
      transform: scale(1.03);
    }

    /* ====== EXPORT / RESET PANEL ====== */
    #controlPanel {
      text-align: center;
      margin-top: 25px;
    }

    #controlPanel button {
      background: #004d40;
      margin: 5px;
    }

    #controlPanel input[type="file"] {
      display: none;
    }


    /* ================================================== */
    /* ===== ÃšJ JEGYZET STÃLUSOK ===== */
    /* ================================================== */
    #noteViewModal .modal-content {
      background: #f1f8e9;
      max-width: 600px;
    }

    #noteViewText {
      background: #ffffff;
      border-radius: 8px;
      padding: 15px;
      min-height: 100px;
      max-height: 60vh;
      overflow-y: auto;
      white-space: pre-wrap;
      border: 1px solid #dcedc8;
    }

    .note-summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #e8f5e9;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .note-summary-title {
      flex: 1;
      font-weight: bold;
      font-size: 1.1em;
      color: #004d40;
      cursor: pointer;
      margin-right: 10px;
    }

    .note-summary-date {
      font-size: 0.85em;
      color: #555;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .note-summary-actions button {
      background: transparent;
      color: #00796b;
      font-size: 1.1em;
      padding: 5px;
    }

    #editInputText {
      height: 150px;
      resize: vertical;
      font-family: 'Segoe UI', sans-serif;
    }

    /* ================================================== */
    /* ===== ÃšJ KOMPAKT FÅOLDALI CÃ‰LOK STÃLUS ===== */
    /* ================================================== */
    #compactGoalsContainer {
      display: grid;
      /* JAVÃTÃS: ÃtÃ¡llÃ¡s Grid-re */
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto;
      /* AlapÃ©rtelmezett: 4 adat oszlop + 1 gomb oszlop */
      background: white;
      border-radius: 18px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 12px 15px;
      margin-bottom: 5px;
      align-items: center;
      /* JAVÃTÃS: FÃ¼ggÅ‘legesen kÃ¶zÃ©pre igazÃ­tjuk az egÃ©szet */
      gap: 12px;
      /* flex-wrap tÃ¶rÃ¶lve */
    }

    .compact-goal-item {
      min-width: 0;
      /* Ez marad, hogy a szÃ¶veg levÃ¡gÃ³dhasson (...) */
      text-align: left;
    }

    .compact-goal-item .label {
      font-size: 0.85em;
      color: #00796b;
      display: block;
      font-weight: bold;
      white-space: nowrap;
    }

    .compact-goal-item .value {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ÃšJ: FelsÅ‘ szÃ¶veg (pl. 0.7/2.0 L) */
    .compact-goal-item .value-top {
      font-size: 1.0em;
      color: #333;
      /* KevÃ©sbÃ© hangsÃºlyos */
      font-weight: 500;
      margin-top: 2px;
    }

    /* ÃšJ: AlsÃ³ szÃ¶veg (pl. MÃ©g 1.3 L) */
    .compact-goal-item .value-bottom {
      font-size: 0.9em;
      color: #004d40;
      font-weight: bold;
      margin-top: 3px;
    }

    /* A SÃºly felsÅ‘ sora mÃ¡skÃ©pp nÃ©z ki */
    .compact-goal-item .value-weight-top {
      font-size: 0.9em;
      color: #333;
      font-weight: 500;
    }


    #compactBtnWrapper {
      display: flex;
      gap: 8px;
      /* margin-left: auto; TÃ–RÃ–LVE */
      /* flex-shrink: 0; TÃ–RÃ–LVE */
      align-self: center;
    }

    #quickAddBtn,
    #compactEditBtn,
    #compactChartBtn {
      flex-shrink: 0;
      background: #004d40;
      padding: 10px 12px;
      font-size: 1.2em;
      line-height: 1;
      border-radius: 12px;
    }

    #compactEditBtn,
    #compactChartBtn {
      background: #00796b;
      font-size: 1.1em;
      padding: 11px 12px;
    }

    .compact-progress-bar-container {
      background: #c8e6c9;
      border-radius: 10px;
      height: 10px;
      width: 100%;
      margin-top: 4px;
      /* KÃ¶zelebb a felsÅ‘ szÃ¶veghez */
      overflow: hidden;
      border: 1px solid #a5d6a7;
    }

    .compact-progress-bar {
      background: #00796b;
      height: 100%;
      width: 0%;
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    /* Protein sÃ¡v szÃ­ne */
    #compactProteinBar,
    #compactWeightBar {
      /* SÃºly is lila lesz */
      background: #8e24aa;
	#compactFatBar {
      background: #f57f17; 
    }
    }

    /* ÃšJ: ReszponzÃ­v tÃ¶rÃ©spont telefonra */
    @media (max-width: 800px) {
      #compactGoalsContainer {
        grid-template-columns: 1fr 1fr;
        /* 2 oszlopos elrendezÃ©s */
        gap: 15px;
        /* Nagyobb tÃ©rkÃ¶z mobilon */
        align-items: flex-end;
        /* VisszaÃ¡llÃ­tjuk alulra igazÃ­tÃ¡sra */
      }

      #compactBtnWrapper {
        /* A gombok Ã¡tnyÃºlnak mindkÃ©t oszlopon */
        justify-content: center;
        /* KÃ¶zÃ©pre igazÃ­tja a gombokat a soron belÃ¼l */
      }
    }

    /* ================================================== */
    /* ===== ÃšJ EDZÃ‰S STÃLUSOK (NAPTÃR TÃ–RÃ–LVE) ===== */
    /* ================================================== */
    .workout-adder {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .workout-adder input[type="date"] {
      flex: 1;
      /* A dÃ¡tumvÃ¡lasztÃ³ tÃ¶ltse ki a helyet */
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 1em;
    }

    .workout-adder button {
      flex-shrink: 0;
      /* A gomb ne zsugorodjon */
      padding: 10px 15px;
      font-weight: bold;
    }

    .workout-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #e8f5e9;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .workout-item span {
      font-weight: bold;
      font-size: 1.1em;
      color: #004d40;
      cursor: pointer;
      /* HOZZÃADVA */
      flex: 1;
      /* HOZZÃADVA */
      margin-right: 10px;
      /* HOZZÃADVA */
    }

    .workout-item button {
      background: transparent;
      color: #c00;
      /* VÃ¶rÃ¶s a tÃ¶rlÃ©shez */
      font-size: 1.2em;
    }

    /* EZT A GOMBOT ADJUK HOZZÃ A SZERKESZTÃ‰SHEZ */
    .workout-item button.edit-note-btn {
      color: #00796b;
      /* TÃ©ma zÃ¶ld */
      font-size: 1.1em;
    }

    /* ================================================== */
    /* ===== ÃšJ Ã‰TEL PROGRESS BAR STÃLUSOK ===== */
    /* ================================================== */
    .meal-progress-container {
      margin-top: 0px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .meal-progress-wrapper {
      display: flex;
      align-items: center;
      font-size: 0.85em;
    }

    .meal-progress-label {
      width: 65px;
      /* SzÃ©lesebb a "KalÃ³ria:" miatt */
      font-weight: bold;
      color: #333;
      flex-shrink: 0;
    }

    .meal-progress-bar-bg {
      background: #e0e0e0;
      border-radius: 5px;
      height: 10px;
      width: 100%;
      overflow: hidden;
    }

    .meal-progress-bar-fill {
      background: #ff9800;
      /* KalÃ³ria - narancs */
      height: 100%;
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    .meal-progress-bar-fill.protein {
      background: #8e24aa;
      /* Protein - lila */
    }
/* ================================================== */
    /* ===== ÃšJ KIEMELT EMLÃ‰KEZTETÅ STÃLUS ===== */
    /* ================================================== */
    #highlightContainer {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 5px;
    }

    .highlight-box {
      background: #ffebee; /* VilÃ¡gos piros hÃ¡ttÃ©r */
      border: 2px solid #e57373; /* SÃ¶tÃ©tebb piros keret */
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(200, 0, 0, 0.1);
    }

    .highlight-box h3 {
      margin: 0 0 8px 0;
      color: #c62828; /* SÃ¶tÃ©t piros cÃ­m */
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.2em;
    }

    .highlight-box p {
      margin: 0;
      color: #444;
      font-size: 1em;
      font-weight: 500;
    }

    .highlight-box .highlight-time {
      font-size: 0.9em;
      font-weight: bold;
      color: #c62828;
    }
    /* ================================================== */
    /* ================================================== */
    /* ===== Ã‰TEL SÃV ELRENDEZÃ‰S MÃ“DOSÃTÃSA ===== */
    /* ================================================== */

    /* FelÃ¼lÃ­rjuk az alap sÃ¡v stÃ­lust, hogy ne flex legyen, hanem blokk */
    .food-item {
      display: block;
      background: #e8f5e9;
      /* A teljes sÃ¡v hÃ¡ttere */
      padding: 0;
      border-radius: 10px;
      /* Ez mÃ¡r megvolt, de biztosÃ­tjuk */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      /* Ez is megvolt */
      margin-bottom: 8px;
      /* Ez is megvolt */
      overflow: hidden;
      /* Ez is megvolt */
    }

    /* Ez az Ãºj div, ami az elsÅ‘ sort (nÃ©v, adatok, gombok) tartalmazza */
    .food-item-row1 {
      display: flex;
      /* Ennek kell flex-nek lennie, hogy a gyerekek egy sorban legyenek */
      align-items: stretch;
    }

    /* FelÃ¼lÃ­rjuk az .item-name stÃ­lusÃ¡t CSAK az Ã©teleknÃ©l,
       hogy ne oszlopban, hanem sorban rendezze a tartalmÃ¡t (a nevet) */
    .food-item .item-name {
      flex-direction: row;
      align-items: center;
    }

    /* A progress bar kontÃ©nernek adunk egy kis belsÅ‘ teret (padding),
       hogy szÃ©pen igazodjon a felette lÃ©vÅ‘ tartalomhoz */
    .food-item .meal-progress-container {
      padding: 2px 5px;
      border-top: 1px solid #dcedc8;
      /* Finom elvÃ¡lasztÃ³ vonal */
    }

    /* ================================================== */
    /* ================================================== */
    /* ================================================== */
	@media (max-width: 845px) {
Â  Â  Â  #tabs {
Â  Â  Â  Â  gap: 6px;
Â  Â  Â  Â  /* Kisebb rÃ©s a gombok kÃ¶zÃ¶tt mobilon */
Â  Â  Â  }

Â  Â  Â  .tab-btn {
Â  Â  Â  Â  /* 33.3% - (rÃ©s / 3) -> Ez kÃ©nyszerÃ­ti a 3 gombot egy sorba */
Â  Â  Â  Â  flex-basis: 31%;
Â  Â  Â  Â  padding: 10px 5px;
Â  Â  Â  Â  /* Kisebb padding, hogy elfÃ©rjen */
Â  Â  Â  }
Â  Â  }

Â  Â  @media (max-width: 420px) {
Â  Â  Â  .tab-text {
Â  Â  Â  Â  display: none;
Â  Â  Â  Â  /* KÃ©rÃ©sednek megfelelÅ‘en a szÃ¶veg elrejtÃ©se */
Â  Â  Â  }

Â  Â  Â  .tab-btn {
Â  Â  Â  Â  flex-basis: 30%;
Â  Â  Â  Â  /* Maradhat a 3/sor elrendezÃ©s */
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  /* Egyenletesebb padding */
Â  Â  Â  Â  gap: 0;
Â  Â  Â  }
Â  Â  Â  .tab-icon {
Â  Â  Â  Â  font-size: 1.3em;
Â  Â  Â  Â  /* Ikon picit nagyobb, mert egyedÃ¼l van */
Â  Â  Â  }
Â  Â  }
	@media (max-width: 845px) {
		.modal {
			/* A hÃ¡ttÃ©r igazÃ­tÃ¡sa a tetejÃ©re, hogy gÃ¶rgethetÅ‘ legyen */
			align-items: flex-start;
			padding-top: 20px;
			overflow-y: auto; /* A sÃ¶tÃ©t hÃ¡ttÃ©r gÃ¶rgetÃ©se */
		}

		.modal-content {
			/* A fehÃ©r doboz kap egy maximÃ¡lis magassÃ¡got Ã©s belsÅ‘ gÃ¶rgÅ‘sÃ¡vot */
			max-height: 90vh; /* Max a kÃ©pernyÅ‘ magassÃ¡gÃ¡nak 90%-a */
			overflow-y: auto; /* Csak a fehÃ©r doboz gÃ¶rgessen, ha a tartalma tÃºl nagy */
		}
	}
  </style>
</head>

<body>

  <div id="loginContainer" style="padding: 20px; max-width: 400px; margin: 40px auto; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
    <h2 style="color: #00796b; text-align: center;">FitGarden 2.0</h2>
    <h3 style="text-align: center;">BelÃ©pÃ©s / RegisztrÃ¡ciÃ³</h3>
    <label>Email</label>
    <input type="email" id="loginEmail" placeholder="email@cim.com">
    <label>JelszÃ³</label>
    <input type="password" id="loginPassword" placeholder="min. 6 karakter">
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button onclick="handleLogin()" style="flex: 1;">BelÃ©pÃ©s</button>
      <button onclick="handleSignUp()" style="flex: 1; background: #004d40;">RegisztrÃ¡ciÃ³</button>
    </div>
    <p id="loginError" style="color: red; text-align: center; margin-top: 10px;"></p>
  </div>

  <div id="appContainer" style="display: none;">

    <div id="motivationBar">Tipp: â€A lustasÃ¡g a gyengÃ©k vallÃ¡sa. TÃ¶rj ki belÅ‘le.â€</div>

    <main>
      <div id="tabs">
        <div class="tab-btn active" onclick="showTab('main')">
          <span class="tab-icon">ğŸ </span>
          <span class="tab-text">FÅ‘oldal</span>
        </div>
        <div class="tab-btn" onclick="showTab('notes')">
          <span class="tab-icon">ğŸ“</span>
          <span class="tab-text">Jegyzetek</span>
        </div>
        <div class="tab-btn" onclick="showTab('reminders')">
          <span class="tab-icon">ğŸ””</span>
          <span class="tab-text">EmlÃ©keztetÅ‘k</span>
        </div>
        <div class="tab-btn" onclick="showTab('meals')">
          <span class="tab-icon">ğŸ—</span>
          <span class="tab-text">Ã‰tkezÃ©s</span>
        </div>
        <div class="tab-btn" onclick="showTab('history')">
          <span class="tab-icon">ğŸ“ˆ</span>
          <span class="tab-text">HaladÃ¡s</span>
        </div>
        <div class="tab-btn" onclick="showTab('workouts')">
          <span class="tab-icon">ğŸ‹ï¸â€â™‚ï¸</span>
          <span class="tab-text">EdzÃ©sek</span>
        </div>
      </div>
      <div id="compactGoalsContainer">

        <div class="compact-goal-item">
          <span class="label">SÃºly âš–ï¸</span>
          <span class="value value-top" id="compactWeightTop">--/-- kg</span>
          <div class="compact-progress-bar-container">
            <div class="compact-progress-bar" id="compactWeightBar"></div>
          </div>
          <span class="value value-bottom" id="compactWeightBottom">MÃ©g...</span>
        </div>

        <div class="compact-goal-item">
          <span class="label">VÃ­z ğŸ’§</span>
          <span class="value value-top" id="compactWaterTop">--/-- L</span>
          <div class="compact-progress-bar-container">
            <div class="compact-progress-bar" id="compactWaterBar"></div>
          </div>
          <span class="value value-bottom" id="compactWaterBottom">MÃ©g...</span>
        </div>

        <div class="compact-goal-item">
          <span class="label">KalÃ³ria ğŸ”¥</span>
          <span class="value value-top" id="compactCalTop">--/-- kcal</span>
          <div class="compact-progress-bar-container">
            <div class="compact-progress-bar" id="compactCalBar"></div>
          </div>
          <span class="value value-bottom" id="compactCalBottom">MÃ©g...</span>
        </div>

        <div class="compact-goal-item">
          <span class="label">Protein ğŸ¥©</span>
          <span class="value value-top" id="compactProteinTop">--/-- g</span>
          <div class="compact-progress-bar-container">
            <div class="compact-progress-bar" id="compactProteinBar"></div>
          </div>
          <span class="value value-bottom" id="compactProteinBottom">MÃ©g...</span>
        </div>
		
		<div class="compact-goal-item">
          <span class="label">ZsÃ­r ğŸ¥‘</span>
          <span class="value value-top" id="compactFatTop">--/-- g</span>
          <div class="compact-progress-bar-container">
            <div class="compact-progress-bar" id="compactFatBar"></div>
          </div>
          <span class="value value-bottom" id="compactFatBottom">MÃ©g...</span>
        </div>

        <div id="compactBtnWrapper">
          <button id="compactChartBtn" onclick="openChartModal()" title="SÃºly Grafikon">ğŸ“ˆ</button>
          <button id="compactEditBtn" onclick="editGoals()" title="CÃ©lok BeÃ¡llÃ­tÃ¡sa">âœï¸</button>
          <button id="quickAddBtn" onclick="openQuickAddModal()" title="Gyors BejegyzÃ©s">+</button>
        </div>
      </div>
      <div id="main" class="tab-content active">
		<div id="highlightContainer"></div>
        <div class="flex-container">
          <div class="card">
            <div class="card-header">
              <h2>âœ… CÃ©lok</h2>
              <button class="archive-header-btn" onclick="openArchiveModal()">ğŸ“¥ ArchÃ­vÃ¡lt / IdÅ‘zÃ­tett</button>
            </div>
            <div id="goalList"></div>
            <button onclick="openModal('goalModal')" class="new-item-button">+ Ãšj cÃ©l</button>
          </div>
          <div class="card">
            <div class="card-header">
              <h2>ğŸ Jutalmak</h2>
              <div class="header-points-display">
                <span class="points-icon">ğŸ’</span>
                <span id="totalPointsDisplay" class="points-number">0</span>
                <span class="points-label"> pont</span>
              </div>
            </div>
            <div id="rewardList"></div>
            <button onclick="openModal('rewardModal')" class="new-item-button">+ Ãšj jutalom</button>
          </div>
        </div>
      </div>
      <div id="notes" class="tab-content">
        <div class="card">
          <div class="card-header">
            <button onclick="openAddNoteModal()" class="card-header-add-btn new-note-btn-left">+ Ãšj jegyzet</button>
          </div>
          <div id="notesList"></div>
        </div>
      </div>
      <div id="reminders" class="tab-content">
        <div class="card">
          <h2>ğŸ”” Ãšj emlÃ©keztetÅ‘</h2>
          <p>Kapj Ã©rtesÃ­tÃ©st a bÃ¶ngÃ©szÅ‘dtÅ‘l a megadott idÅ‘pontban. A funkciÃ³ hasznÃ¡latÃ¡hoz engedÃ©lyezned kell az Ã©rtesÃ­tÃ©seket, ha a bÃ¶ngÃ©szÅ‘ rÃ¡kÃ©rdez.</p>

          <label for="reminderTextInput">EmlÃ©keztetÅ‘ szÃ¶vege</label>
          <input type="text" id="reminderTextInput" placeholder="pl. Idd meg a vizet!">

          <label for="reminderTimeInput">IdÅ‘pont</label>
		  <label for="reminderTimeInput">IdÅ‘pont</label>
          <input type="datetime-local" id="reminderTimeInput">

          <div style="margin-top: 15px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
            <label for="reminderHighlightCheck" style="display:inline; margin-right: 10px; cursor: pointer;">KiemelÃ©s a fÅ‘oldalon?(ettÅ‘l a naptÃ³l lÃ¡tszik)</label>
            <input type="checkbox" id="reminderHighlightCheck" style="width: auto; margin: 0; transform: scale(1.3);">
            <input type="date" id="reminderHighlightDateInput" style="margin-top: 5px;">
          </div>
          <button onclick="addReminder()" style="margin-top: 10px;">ğŸ’¾ EmlÃ©keztetÅ‘ MentÃ©se</button>
        </div>
        <div class="card">
          <h2>AktÃ­v emlÃ©keztetÅ‘k</h2>
          <div id="reminderList" class="log" style="max-height: 400px; overflow-y: auto;">
            <p>Nincsenek aktÃ­v emlÃ©keztetÅ‘k.</p>
          </div>
        </div>
      </div>
      <div id="meals" class="tab-content">

        <div class="card">
          <h2>Mentett Ã©telek</h2>
          <input type="text" id="mealSearchInput" placeholder="ğŸ” Ã‰tel keresÃ©se..." oninput="renderMeals()" style="margin-bottom: 0px;">
          <div id="mealList">
          </div>
          <button onclick="openMealModal()" class="new-item-button">+ Ãšj Ã©tel hozzÃ¡adÃ¡sa</button>
        </div>
      </div>

      <div id="history" class="tab-content">
        <div class="card">
          <h2>ğŸ“… Adat TÃ¶rtÃ©net (SÃºly, VÃ­z, KalÃ³ria, Protein)</h2>
          <div id="historyList" class="log"></div>
        </div>

        <div class="card">
          <h2>ğŸ’ Pont TÃ¶rtÃ©net</h2>
          <div id="pointsHistoryList" class="log"></div>
        </div>
        <div class="card">
          <h2>ğŸ“œ NaplÃ³</h2>
          <div class="log" id="activityLog"></div>
          <button style="margin-top:10px" onclick="clearAllLogs()">ğŸ§¹ NaplÃ³ tÃ¶rlÃ©se</button>
        </div>

        <div class="card fade-in" id="controlPanel">
          <h2>ğŸ§  Fejedelem Kontrollpanel</h2>
          <p>AdatmentÃ©s, visszaÃ¡llÃ­tÃ¡s Ã©s teljes reset</p>
          <button onclick="exportData()">ğŸ’¾ ExportÃ¡lÃ¡s</button>
          <button onclick="document.getElementById('importFile').click()">ğŸ“‚ ImportÃ¡lÃ¡s</button>
          <input type="file" id="importFile" accept=".json" onchange="importData(event)">
          <button style="background:#b71c1c" onclick="resetAll()">âš ï¸ Teljes reset</button>
          <button onclick="handleLogout()" style="background:#555">ğŸšª KijelentkezÃ©s</button>
        </div>
      </div>

      <div id="workouts" class="tab-content">
        <div class="card">
          <h2>ğŸ“… EdzÃ©s rÃ¶gzÃ­tÃ©se</h2>
          <p>VÃ¡laszd ki a napot, Ã©s rÃ¶gzÃ­tsd az edzÃ©st.</p>
          <div class="workout-adder">
            <input type="date" id="workoutDateInput">
            <button onclick="addWorkout()">ğŸ‹ï¸â€â™‚ï¸ EdzÃ©s rÃ¶gzÃ­tÃ©se</button>
          </div>

          <h2 style="margin-top: 25px;">RÃ¶gzÃ­tett edzÃ©sek</h2>
          <div id="workoutList">
          </div>
        </div>
      </div>

    </main>
    <div class="modal" id="noteViewModal">
      <div class="modal-content">
        <h3 id="noteViewTitle">Jegyzet cÃ­me</h3>
        <div id="noteViewText">
          Jegyzet tartalma...
        </div>
        <div style="text-align:center;margin-top:15px;">
          <button style="background:#ccc;color:black;" onclick="closeModal('noteViewModal')">BezÃ¡rÃ¡s</button>
        </div>
      </div>
    </div>

    <div class="modal" id="chartModal">
      <div class="modal-content" id="chartModalContent">
        <h3>ğŸ“ˆ SÃºly Grafikon</h3>
        <canvas id="progressChart"></canvas>
        <div style="text-align:center;margin-top:15px;">
          <button style="background:#ccc;color:black;" onclick="closeModal('chartModal')">BezÃ¡rÃ¡s</button>
        </div>
      </div>
    </div>
    <div class="modal" id="noteModal">
      <div class="modal-content">
        <h3>ğŸ“ Ãšj jegyzet</h3>
        <label for="noteTitleInput">CÃ­m</label>
        <input id="noteTitleInput" type="text" placeholder="Jegyzet cÃ­me...">

        <label for="noteCategoryInput">KategÃ³ria (opcionÃ¡lis)</label>
        <input id="noteCategoryInput" type="text" placeholder="pl. EdzÃ©sterv, BevÃ¡sÃ¡rlÃ¡s..." list="noteCategoryDatalist">
        <datalist id="noteCategoryDatalist"></datalist>

        <label for="noteTextInput">SzÃ¶veg</label>
        <textarea id="noteTextInput" rows="6" placeholder="Ãrj ide valamit..."></textarea>

        <div style="text-align:center;margin-top:15px;">
          <button onclick="saveNote()">âœ… MentÃ©s</button>
          <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('noteModal')">MÃ©gse</button>
        </div>
      </div>
    </div>
    <div class="modal" id="goalSetupModal">
      <div class="modal-content">
        <h3>ğŸ¯ CÃ©lok beÃ¡llÃ­tÃ¡sa</h3>
        <label>IdeÃ¡lis sÃºly (kg)</label>
        <input id="goalWeightInput" type="number" placeholder="pl. 75">
        <label>Napi vÃ­z cÃ©l (liter)</label>
        <input id="goalWaterInput" type="number" step="0.1" placeholder="pl. 2.5">
        <label>Napi kalÃ³ria cÃ©l (kcal)</label>
        <input id="goalCalInput" type="number" placeholder="pl. 2200">
        <label>Napi protein cÃ©l (gramm)</label>
        <input id="goalProteinInput" type="number" placeholder="pl. 120">
		<label>Napi zsÃ­r cÃ©l (gramm)</label>
        <input id="goalFatInput" type="number" placeholder="pl. 60">

        <div style="text-align:center;margin-top:15px;">
          <button onclick="saveGoalSettings()">ğŸ’¾ MentÃ©s</button>
          <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('goalSetupModal')">MÃ©gse</button>
        </div>
      </div>
    </div>

    <div class="modal" id="goalModal">
      <div class="modal-content">
        <h3>ğŸ¯ Ãšj cÃ©l</h3>
        <label>CÃ©l neve</label>
        <input id="goalNameInput" type="text" placeholder="pl. 10.000 lÃ©pÃ©s">
        <label>Pont Ã©rtÃ©k</label>
        <input id="goalPointsInput" type="number" placeholder="pl. 10 (0 is lehet)">
        <label>KategÃ³ria (opcionÃ¡lis)</label>
        <input id="goalCategoryInput" type="text" placeholder="pl. ValÃ³sÃ¡g (vÃ¡lassz vagy Ã­rj be Ãºjat)" list="categoryDatalist">
        <datalist id="categoryDatalist">
        </datalist>

        <label>AlcÃ©lok (opcionÃ¡lis, minden sor egy alcÃ©l)</label>
        <textarea id="goalSubGoalsInput" rows="5" placeholder="&#10;Jel nÃ©lkÃ¼li sorok automatikusan pipÃ¡lhatÃ³k.&#10;FormÃ¡zÃ¡si jelek az alcÃ©lokhoz::&#10;# â†’ CÃ­msor (csak szÃ¶veg, nem pipÃ¡lhatÃ³)&#10;--- â†’ ElvÃ¡lasztÃ³, rÃ©szek szÃ©tvÃ¡lasztÃ¡sÃ¡ra"></textarea>
        <div style="margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
          <label for="goalStartDateInput" style="margin-bottom: 5px;">MegjelenÃ©s dÃ¡tuma (opcionÃ¡lis)</label>
          <input type="date" id="goalStartDateInput" style="margin-bottom: 0;">
        </div>

                <div style="margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <label for="goalIsPriorityInput" style="margin: 0; cursor: pointer; font-weight: bold; color: #c62828;">Fontos cÃ©l? (KiemelÃ©s)</label>
            <input type="checkbox" id="goalIsPriorityInput" style="width: auto; margin: 0; transform: scale(1.3);">
          </div>
        </div>

                <div style="margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
          
                    <div style="display: flex; align-items: center; justify-content: space-between;">
            <label for="goalIsRecurringInput" style="margin: 0; cursor: pointer;">IsmÃ©tlÅ‘dÅ‘ cÃ©l?</label>
            <input type="checkbox" id="goalIsRecurringInput" onchange="document.getElementById('goalRecurrenceOptions').style.display = this.checked ? 'block' : 'none'" style="width: auto; margin: 0; transform: scale(1.3);">
          </div>

                    <div id="goalRecurrenceOptions" style="display: none; margin-top: 10px;">
				
				<div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
					<label style="margin: 0;">Minden</label>
					<input type="number" id="goalRecurrenceInterval" value="1" style="width: 60px; margin: 0;">
					<select id="goalRecurrenceFrequency" style="flex: 1; margin: 0;">
						<option value="daily">Nap</option>
						<option value="weekly">HÃ©t</option>
						<option value="monthly">HÃ³nap</option>
						<option value="yearly">Ã‰v</option>
					</select>
				</div>
				
				<div style="margin-top: 10px; margin-bottom: 15px;">
					<label for="goalRecurrenceStartDateInput" style="margin-bottom: 5px;">IsmÃ©tlÅ‘dÃ©s kezdete (opcionÃ¡lis)</label>
					<input type="date" id="goalRecurrenceStartDateInput" style="margin: 0; width: 100%;">
				</div>
				
				<label style="margin-top: 10px; margin-bottom: 5px;">BefejezÃ©s</label>
				<div style="padding-left: 15px;">
					<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
						<input type="radio" name="goalEndCondition" id="goalEndNever" value="never" checked style="width: auto; margin: 0;">
						<label for="goalEndNever" style="margin: 0; width: 100%;">Soha</label>
					</div>
					
					<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
						<input type="radio" name="goalEndCondition" id="goalEndCount" value="count" style="width: auto; margin: 0;">
						<label for="goalEndCount" style="margin: 0; width: 100%;">Ennyi utÃ¡n:</label>
						<input type="number" id="goalEndCountInput" value="5" style="width: 60px; margin: 0;">
						<span style="flex-shrink: 0;">elÅ‘fordulÃ¡s</span>
					</div>

					<div style="display: flex; align-items: center; gap: 10px;">
						<input type="radio" name="goalEndCondition" id="goalEndDate" value="date" style="width: auto; margin: 0;">
						<label for="goalEndDate" style="margin: 0;">Ekkor:</label>
						<input type="date" id="goalEndDateInput" style="width: 100%; margin: 0;">
					</div>
				</div>

          </div>         </div>
        <div style="text-align:center;margin-top:15px;">
          <button onclick="saveGoal()">âœ… MentÃ©s</button>
          <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('goalModal')">MÃ©gse</button>
        </div>
      </div>
    </div>

    <div class="modal" id="rewardModal">
      <div class="modal-content">
        <h3>ğŸ Ãšj jutalom</h3>
        <label>Jutalom neve</label>
        <input id="rewardNameInput" type="text" placeholder="pl. PihenÅ‘nap">
        <label>Pont Ã¡ra</label>
        <input id="rewardCostInput" type="number" placeholder="pl. 20">
        <div style="text-align:center;margin-top:15px;">
          <button onclick="saveReward()">âœ… MentÃ©s</button>
          <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('rewardModal')">MÃ©gse</button>
        </div>
      </div>
    </div>

    <div class="modal" id="editModal" style="z-index: 2000;">
      <div class="modal-content">
        <h3 id="editTitle">âœï¸ SzerkesztÃ©s</h3>

        <label id="editLabel1"></label>
        <input id="editInput1" type="text">

        <label id="editLabel2"></label>
        <input id="editInput2" type="number">

        <label id="editLabel3" style="display:none;"></label>
        <input id="editInput3" type="text" style="display:none;">
        <label id="editLabelSubGoals" style="display:none;">AlcÃ©lok (minden sor egy alcÃ©l)</label>
        <textarea id="editInputSubGoals" rows="5" style="display:none;"></textarea>

        <label id="editLabelText" style="display:none;">SzÃ¶veg</label>
        <textarea id="editInputText" style="display:none;"></textarea>
		
        <div id="editPriorityField" style="display: none; margin-top: 10px; padding: 5px; background: #f1f8e9; border-radius: 8px;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <label for="editIsPriorityInput" style="margin: 0; cursor: pointer; font-weight: bold; color: #c62828;">Fontos cÃ©l? (KiemelÃ©s)</label>
            <input type="checkbox" id="editIsPriorityInput" style="width: auto; margin: 0; transform: scale(1.3);">
          </div>
        </div>
        <div id="editStartDateField" style="display: none; margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
          <label for="editStartDateInput" style="margin-bottom: 5px;">MegjelenÃ©s dÃ¡tuma (opcionÃ¡lis)</label>
          <input type="date" id="editStartDateInput" style="margin-bottom: 0;"> 
		  </div>
        
        <div id="editRecurringFields" style="display: none; margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <label for="editIsRecurringInput" style="margin: 0; cursor: pointer;">IsmÃ©tlÅ‘dÅ‘ cÃ©l?</label>
            <input type="checkbox" id="editIsRecurringInput" onchange="document.getElementById('editRecurrenceOptions').style.display = this.checked ? 'block' : 'none'" style="width: auto; margin: 0; transform: scale(1.3);">
          </div>
          
          <div id="editRecurrenceOptions" style="display: none; margin-top: 10px;">
				
				<div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
					<label style="margin: 0;">Minden</label>
					<input type="number" id="editRecurrenceInterval" value="1" style="width: 60px; margin: 0;">
					<select id="editRecurrenceFrequency" style="flex: 1; margin: 0;">
						<option value="daily">Nap</option>
						<option value="weekly">HÃ©t</option>
						<option value="monthly">HÃ³nap</option>
						<option value="yearly">Ã‰v</option>
					</select>
				</div>

				<div style="margin-top: 10px; margin-bottom: 15px;">
					<label for="editRecurrenceStartDateInput" style="margin-bottom: 5px;">IsmÃ©tlÅ‘dÃ©s kezdete (opcionÃ¡lis)</label>
					<input type="date" id="editRecurrenceStartDateInput" style="margin: 0; width: 100%;">
				</div>
				<label>IsmÃ©tlÅ‘dÃ©s befejezÃ©s:</label>
				<div style="padding-left: 15px;">
					<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
						<input type="radio" name="editEndCondition" id="editEndNever" value="never" checked style="width: auto; margin: 0;">
						<label for="editEndNever" style="margin: 0; width: 100%;">Soha</label>
					</div>
					
					<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
						<input type="radio" name="editEndCondition" id="editEndCount" value="count" style="width: auto; margin: 0;">
						<label for="editEndCount" style="margin: 0; width: 100%;">Ennyi utÃ¡n:</label>
						<input type="number" id="editEndCountInput" value="5" style="width: 60px; margin: 0;">
						<span style="flex-shrink: 0;">elÅ‘fordulÃ¡s</span>
					</div>

					<div style="display: flex; align-items: center; gap: 10px;">
						<input type="radio" name="editEndCondition" id="editEndDate" value="date" style="width: auto; margin: 0;">
						<label for="editEndDate" style="margin: 0;">Ekkor:</label>
						<input type="date" id="editEndDateInput" style="width: 100%; margin: 0;">
					</div>
				</div>
			</div>
        </div>
        <div id="editMealFields" style="display: none;">
          <label for="editMealType">TÃ­pus</label>
          <select id="editMealType">
            <option value="unit">Darab alapÃº</option>
            <option value="weight">SÃºly alapÃº (100g)</option>
          </select>
          <label for="editMealKcal">KalÃ³ria (kcal)</label>
          <input id="editMealKcal" type="number" placeholder="pl. 150">
          <label for="editMealProtein">FehÃ©rje (g)</label>
          <input id="editMealProtein" type="number" placeholder="pl. 12">
		  <label for="editMealFat">ZsÃ­r (g)</label>
          <input id="editMealFat" type="number" placeholder="pl. 8">
        </div>

        <div style="text-align:center;margin-top:15px;">
          <button onclick="confirmEdit()">ğŸ’¾ MentÃ©s</button>
          <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('editModal')">MÃ©gse</button>
        </div>
      </div>
    </div>

    <div class="modal" id="archiveModal">
      <div class="modal-content" style="max-width: 600px;">
        <h3>ğŸ“¥ ArchivÃ¡lt vagy idÅ‘zÃ­tett cÃ©lok</h3>
        <div id="archivedGoalList" style="max-height: 400px; overflow-y: auto;">
        </div>
        <div style="text-align:center;margin-top:15px;">
          <button style="background:#ccc;color:black;" onclick="closeModal('archiveModal')">BezÃ¡rÃ¡s</button>
        </div>
      </div>
    </div>

    <div class="modal" id="mealModal">
      <div class="modal-content">
        <h3>Ãšj Ã©tel hozzÃ¡adÃ¡sa</h3>
        <label for="mealNameInput">Ã‰tel neve</label>
        <input id="mealNameInput" type="text" placeholder="pl. FÅ‘tt tojÃ¡s">

        <label for="mealCategoryInput">KategÃ³ria (opcionÃ¡lis)</label>
        <input id="mealCategoryInput" type="text" placeholder="pl. HÃºsok, ZÃ¶ldsÃ©gek..." list="mealCategoryDatalist">
        <datalist id="mealCategoryDatalist"></datalist>

        <label for="mealTypeSelect">SzÃ¡molÃ¡s tÃ­pusa</label>
        <select id="mealTypeSelect" onchange="updateMealModalLabels()">
          <option value="unit">Darab alapÃº</option>
          <option value="weight">SÃºly alapÃº (100g)</option>
        </select>

        <label id="mealKcalLabel" for="mealKcalInput">KalÃ³ria (kcal/darab)</label>
        <input id="mealKcalInput" type="number" placeholder="pl. 78">

        <label id="mealProteinLabel" for="mealProteinInput">FehÃ©rje (g/darab)</label>
        <input id="mealProteinInput" type="number" placeholder="pl. 6">
		<label id="mealFatLabel" for="mealFatInput">ZsÃ­r (g/darab)</label>
        <input id="mealFatInput" type="number" placeholder="pl. 4">
        <label for="mealNoteInput">Jegyzet (opcionÃ¡lis)</label>
        <textarea id="mealNoteInput" rows="4" placeholder="Recept, elkÃ©szÃ­tÃ©si javaslat, link..."></textarea>
        <div style="text-align:center;margin-top:15px;">
          <button onclick="saveMeal()">âœ… MentÃ©s</button>
          <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('mealModal')">MÃ©gse</button>
        </div>
      </div>
    </div>

    <div class="modal" id="consumeModal">
      <div class="modal-content">
        <h3 id="consumeMealTitle">Ã‰tel fogyasztÃ¡sa</h3>
        <p style="text-align: center; font-weight: bold;" id="consumeMealDetails"></p>

        <label id="consumeAmountLabel" for="consumeAmountInput">MennyisÃ©g (Darab)</label>
        <input id="consumeAmountInput" type="number" placeholder="pl. 2">

        <div style="text-align:center;margin-top:15px;">
          <button onclick="confirmConsume()">ğŸ½ï¸ FogyasztÃ¡s</button>
          <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('consumeModal')">MÃ©gse</button>
        </div>
      </div>
    </div>

    <div class="modal" id="quickAddModal">
      <div class="modal-content">
        <h3>âš¡ Gyors BejegyzÃ©s</h3>
        <p style="text-align: center; margin-top: -10px; margin-bottom: 15px;">Add meg a mai napi adatokat.</p>

        <label>Jelenlegi sÃºly (kg) - FelÃ¼lÃ­rja a mait</label>
        <input id="quickWeightInput" type="number" placeholder="pl. 75.5">

        <label>VÃ­z hozzÃ¡adÃ¡sa (Liter)</label>
        <input id="quickWaterInput" type="number" step="0.1" placeholder="pl. 0.5">

        <label>KalÃ³ria hozzÃ¡adÃ¡sa (kcal)</label>
        <input id="quickCalInput" type="number" placeholder="pl. 500">

        <label>Protein hozzÃ¡adÃ¡sa (gramm)</label>
        <input id="quickProteinInput" type="number" placeholder="pl. 30">
		
		<label>ZsÃ­r hozzÃ¡adÃ¡sa (gramm)</label>
        <input id="quickFatInput" type="number" placeholder="pl. 15">

        <div style="text-align:center;margin-top:15px;">
          <button onclick="saveQuickAdd()">ğŸ’¾ MentÃ©s Ã©s BezÃ¡rÃ¡s</button>
          <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('quickAddModal')">MÃ©gse</button>
        </div>
      </div>
    </div>


  </div>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

  <script>
    // Your web app's Firebase configuration
	const firebaseConfig = {
      apiKey: "AIzaSyCZJLWZFJFEFWQqZYmAcZjgqoc88FDfPwQ",
      authDomain: "habit-tracker-32c11.firebaseapp.com",
      databaseURL: "https://habit-tracker-32c11-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "habit-tracker-32c11",
      storageBucket: "habit-tracker-32c11.appspot.com",
      messagingSenderId: "637775270587",
      appId: "1:637775270587:web:11b31d9f64510d81c20f9e",
      measurementId: "G-SS9TX286CF"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Create global variables to access Firebase services
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null; // This will be set on login

    console.log("Firebase is connected!");
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // =======================================================
    // ===== ÃšJ FUNKCIÃ“: JEGYZET KATEGÃ“RIA LISTA LÃ‰TREHOZÃSA =====
    // =======================================================
    function populateNoteCategoryDatalist() {
      const datalist = document.getElementById('noteCategoryDatalist');
      if (!datalist) return;

      datalist.innerHTML = ""; // TÃ¶rÃ¶ljÃ¼k a rÃ©gi opciÃ³kat

      // Ã–sszegyÅ±jtjÃ¼k a meglÃ©vÅ‘ kategÃ³riÃ¡kat (csak egyedi Ã©rtÃ©kek)
      const existingCategories = new Set(
        notes
        .map(note => note.category)
        .filter(category => category) // Csak a lÃ©tezÅ‘ kategÃ³riÃ¡k
      );

      // HozzÃ¡adjuk Å‘ket a listÃ¡hoz
      existingCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        datalist.appendChild(option);
      });
    }

    function populateMealCategoryDatalist() {
      const datalist = document.getElementById('mealCategoryDatalist');
      if (!datalist) return;
      datalist.innerHTML = ""; // TÃ¶rÃ¶ljÃ¼k a rÃ©gi opciÃ³kat
      const existingCategories = new Set(
        meals
        .map(meal => meal.category)
        .filter(category => category) // Csak a lÃ©tezÅ‘ kategÃ³riÃ¡k
      );
      existingCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        datalist.appendChild(option);
      });
    }
    // ======= POPUP VEZÃ‰RLÃ‰S =======
function openModal(id) {
      document.getElementById(id).style.display = 'flex';
      // HOZZÃADVA: KategÃ³ria lista feltÃ¶ltÃ©se, amikor a cÃ©l modalt nyitjuk meg
      if (id === 'goalModal') {
        populateCategoryDatalist();
        // TÃ¶rÃ¶ljÃ¼k a rÃ©gi alcÃ©l bevitelt
        document.getElementById("goalSubGoalsInput").value = "";
        // ÃšJ: IsmÃ©tlÅ‘dÃ©s alaphelyzetbe Ã¡llÃ­tÃ¡sa
        document.getElementById("goalIsRecurringInput").checked = false;
        document.getElementById("goalRecurrenceOptions").style.display = "none";
        document.getElementById("goalRecurrenceFrequency").value = "daily";
		document.getElementById("goalIsPriorityInput").checked = false; // ÃšJ
        document.getElementById("goalStartDateInput").value = ""; // EZ AZ ÃšJ SOR
      }
    }
    // ÃšJ: Az Ã©tel modal megnyitÃ¡sa (alaphelyzetbe Ã¡llÃ­tÃ¡s)
    function openMealModal() {
      // Ez biztosÃ­tja, hogy szerkesztÃ©s helyett "Ãºj" mÃ³dban nyÃ­ljon meg
      editTarget = null;

      document.getElementById('mealModal').querySelector('h3').textContent = "Ãšj Ã©tel hozzÃ¡adÃ¡sa";
      document.getElementById("mealNameInput").value = "";
      document.getElementById("mealCategoryInput").value = ""; // <- HOZZÃADVA
      document.getElementById("mealTypeSelect").value = "unit";
      document.getElementById("mealKcalInput").value = "";
      document.getElementById("mealProteinInput").value = "";
      updateMealModalLabels(); // CÃ­mkÃ©k frissÃ­tÃ©se
      populateMealCategoryDatalist(); // <- HOZZÃADVA

      openModal('mealModal');
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
      // BiztosÃ­tjuk, hogy a szerkesztÃ©s mezÅ‘i elrejtsenek, amikor bezÃ¡rjuk
      if (id === 'editModal') {
        document.getElementById("editLabel1").style.display = "block";
        document.getElementById("editInput1").style.display = "block";
        document.getElementById("editLabel2").style.display = "block";
        document.getElementById("editInput2").style.display = "block";
        document.getElementById("editLabel3").style.display = "block";
        document.getElementById("editInput3").style.display = "block";
        document.getElementById("editLabelText").style.display = "none";
        document.getElementById("editInputText").style.display = "none";
        document.getElementById("editMealFields").style.display = "none";
        // AlcÃ©l mezÅ‘ elrejtÃ©se
        document.getElementById("editLabelSubGoals").style.display = "none";
        document.getElementById("editInputSubGoals").style.display = "none";
        // ÃšJ: IsmÃ©tlÅ‘dÅ‘ mezÅ‘k elrejtÃ©se
        // ÃšJ: IsmÃ©tlÅ‘dÅ‘ mezÅ‘k elrejtÃ©se
        document.getElementById("editRecurringFields").style.display = "none";
        // IDÅZÃTÃ‰S MEZÅ ELREJTÃ‰SE (KEZDETE)
        document.getElementById("editStartDateField").style.display = "none";
        document.getElementById("editStartDateInput").value = "";
        // IDÅZÃTÃ‰S MEZÅ ELREJTÃ‰SE (VÃ‰GE)
		document.getElementById("editPriorityField").style.display = "none"; // ÃšJ
		// ÃšJ: IsmÃ©tlÅ‘dÅ‘ mezÅ‘k elrejtÃ©se
        document.getElementById("editRecurringFields").style.display = "none";
        
        // ===== INNEN ILLESZD BE A 4 SORT =====
        // TÃ­pusok visszaÃ¡llÃ­tÃ¡sa az emlÃ©keztetÅ‘ szerkesztÃ©s utÃ¡n
        document.getElementById("editInput2").type = "number";
        document.getElementById("editInput3").type = "text";
        document.getElementById("editIsRecurringInput").onchange = function() { document.getElementById('editRecurrenceOptions').style.display = this.checked ? 'block' : 'none' };
      }
    }

    function editGoals() {
      // Refactored to use global vars instead of localStorage
      document.getElementById("goalWeightInput").value = goalWeightSetting || "";
      document.getElementById("goalWaterInput").value = goalWaterSetting || "";
      document.getElementById("goalCalInput").value = goalCaloriesSetting || "";
      document.getElementById("goalProteinInput").value = goalProteinSetting || ""; // HOZZÃADVA
      openModal('goalSetupModal');
    }

    // =======================================================
    // ===== ÃšJ GYORS BEJEGYZÃ‰S FUNKCIÃ“K =====
    // =======================================================
    function openQuickAddModal() {
      // KitÃ¶rli a rÃ©gi beviteli Ã©rtÃ©keket
      document.getElementById("quickWeightInput").value = "";
      document.getElementById("quickWaterInput").value = "";
      document.getElementById("quickCalInput").value = "";
      document.getElementById("quickProteinInput").value = "";
	  document.getElementById("quickFatInput").value = "";

      // BetÃ¶lti a jelenlegi sÃºlyt, ha van -> EZ A RÃ‰SZ EL LETT TÃVOLÃTVA
      // if (dailyProgress.lastWeight > 0) {
      //  document.getElementById("quickWeightInput").value = dailyProgress.lastWeight;
      // }

      openModal('quickAddModal');
    }
    async function saveQuickAdd() {
      const weight = parseFloat(document.getElementById("quickWeightInput").value);
      const water = parseFloat(document.getElementById("quickWaterInput").value);
      const calories = parseFloat(document.getElementById("quickCalInput").value);
      const protein = parseFloat(document.getElementById("quickProteinInput").value);
	  const fat = parseFloat(document.getElementById("quickFatInput").value);

      // SÃºly rÃ¶gzÃ­tÃ©se
      if (weight && weight > 0) {
        const transaction = {
          id: Date.now(),
          type: 'weight',
          value: weight,
          date: new Date()
        };
        transactions.push(transaction);
        // A dailyProgress.lastWeight-et a calculateDailyProgress() frissÃ­ti
        await logActivity(`âš–ï¸ SÃºly rÃ¶gzÃ­tve: ${weight}kg`);
      }

      // VÃ­z hozzÃ¡adÃ¡sa
      if (water && water > 0) {
        const transaction = {
          id: Date.now(),
          type: 'water',
          value: water,
          date: new Date()
        };
        transactions.push(transaction);
        await logActivity(`ğŸ’§ VÃ­z hozzÃ¡adva: ${water}L`);
      }

      // KalÃ³ria hozzÃ¡adÃ¡sa
      if (calories && calories > 0) {
        const transaction = {
          id: Date.now(),
          type: 'calories',
          value: calories,
          date: new Date()
        };
        transactions.push(transaction);
        await logActivity(`ğŸ”¥ KalÃ³ria hozzÃ¡adva: ${calories}kcal`);
      }

      // Protein hozzÃ¡adÃ¡sa
      if (protein && protein > 0) {
        const transaction = {
          id: Date.now(),
          type: 'protein',
          value: protein,
          date: new Date()
        };
        transactions.push(transaction);
        await logActivity(`ğŸ¥© Protein hozzÃ¡adva: ${protein}g`);
      }
	  // ZsÃ­r hozzÃ¡adÃ¡sa
      if (fat && fat > 0) {
        const transaction = {
          id: Date.now(),
          type: 'fat',
          value: fat,
          date: new Date()
        };
        transactions.push(transaction);
        await logActivity(`ğŸ¥‘ ZsÃ­r hozzÃ¡adva: ${fat}g`);
      }

      closeModal('quickAddModal');

      // FrissÃ­tjÃ¼k az Ã¶sszes nÃ©zetet
      calculateDailyProgress(); // Ez ÃºjraszÃ¡molja a dailyProgress-t
      updateAllSummaries(); // Ez frissÃ­ti a kompakt sÃ¡vot
      updateHistory();
      if (document.getElementById('chartModal').style.display === 'flex') {
        updateChart();
      }
    }
// =======================================================
    // ===== ÃšJ KIEMELT EMLÃ‰KEZTETÅK RENDERELÃ‰SE =====
    // =======================================================
    function renderHighlights() {
      const container = document.getElementById("highlightContainer");
      // Csak akkor fuss, ha a fÅ‘oldali container lÃ©tezik (tehÃ¡t a FÅ‘oldal fÃ¼lÃ¶n vagyunk)
      if (!container) return; 

      container.innerHTML = "";
      const now = new Date();

      const highlightsToShow = reminders.filter(r => 
        r.highlight &&             // 1. KÃ©rve van a kiemelÃ©s
        !r.triggered &&            // 2. MÃ©g nem jÃ¡rt le az emlÃ©keztetÅ‘
        new Date(r.highlightDate) <= now // 3. ElÃ©rkezett a kiemelÃ©s kezdÅ‘ dÃ¡tuma
      );

      // RendezÃ©s, hogy a legkorÃ¡bbi legyen felÃ¼l
      highlightsToShow.sort((a, b) => new Date(a.time) - new Date(b.time));

      highlightsToShow.forEach(r => {
        const div = document.createElement("div");
        div.className = "highlight-box fade-in"; // HasznÃ¡ljuk a fade-in animÃ¡ciÃ³t

        const reminderTime = new Date(r.time);
        // DÃ¡tum formÃ¡zÃ¡sa (pl. "2025. 11. 27. 17:00")
        const displayTime = reminderTime.toLocaleString('hu-HU', { 
          year: 'numeric', 
          month: 'numeric', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        // VisszaszÃ¡mlÃ¡lÃ³ logika
        const diffMs = reminderTime - now;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        
        let countdownText = "";
        if (diffDays > 0) {
          countdownText = ` (mÃ©g ${diffDays} nap, ${diffHours} Ã³ra)`;
        } else if (diffHours > 0) {
          countdownText = ` (mÃ©g ${diffHours} Ã³ra)`;
        } else {
          countdownText = " (most esedÃ©kes!)";
        }

        div.innerHTML = `
          <h3>
            <span>ğŸ”” Kiemelt EmlÃ©keztetÅ‘</span>
            <span class="highlight-time">${displayTime}${countdownText}</span>
          </h3>
          <p>${r.text}</p>
        `;
        container.appendChild(div);
      });
    }
    // ===== ÃšJ FUNKCIÃ“: Kompakt nÃ©zet frissÃ­tÃ©se =====
    function updateCompactSummaries() {
      // CÃ©lbeÃ¡llÃ­tÃ¡sok
      const gw = parseFloat(goalWeightSetting); // CÃ©l sÃºly
      const gwat = parseFloat(goalWaterSetting); // CÃ©l vÃ­z
      const gcal = parseFloat(goalCaloriesSetting); // CÃ©l kalÃ³ria
      const gprot = parseFloat(goalProteinSetting); // CÃ©l protein
	  const gfat = parseFloat(goalFatSetting); // CÃ©l zsÃ­r

      // Napi haladÃ¡s
      const dp = dailyProgress;

      // SÃºly logikÃ¡hoz: megkeressÃ¼k az elsÅ‘ sÃºlybejegyzÃ©st. Ez lesz az "Ãºt" kiindulÃ³pontja.
      let startWeight = dp.lastWeight; // AlapÃ©rtelmezett, ha nincs mÃ¡s
      const firstWeightEntry = transactions.find(t => t.type === 'weight');
      if (firstWeightEntry) {
        startWeight = firstWeightEntry.value;
      }

      // FelsÅ‘ szÃ¶veges elemek
      const compactWeightTop = document.getElementById("compactWeightTop");
      const compactWaterTop = document.getElementById("compactWaterTop");
      const compactCalTop = document.getElementById("compactCalTop");
      const compactProteinTop = document.getElementById("compactProteinTop");
	  const compactFatTop = document.getElementById("compactFatTop");

      // AlsÃ³ "MÃ©g X" elemek
      const compactWeightBottom = document.getElementById("compactWeightBottom");
      const compactWaterBottom = document.getElementById("compactWaterBottom");
      const compactCalBottom = document.getElementById("compactCalBottom");
      const compactProteinBottom = document.getElementById("compactProteinBottom");
	  const compactFatBottom = document.getElementById("compactFatBottom");

      // HaladÃ³sÃ¡v elemek
      const compactWeightBar = document.getElementById("compactWeightBar");
      const compactWaterBar = document.getElementById("compactWaterBar");
      const compactCalBar = document.getElementById("compactCalBar");
      const compactProteinBar = document.getElementById("compactProteinBar");
	  const compactFatBar = document.getElementById("compactFatBar");

      // Ha nem a fÅ‘oldalon vagyunk, ne fusson le
      if (!compactWeightTop) return;

      // --- SÃºly (JAVÃTOTT logika) ---
      if (gw && dp.lastWeight > 0 && startWeight > 0) {
        const goalDiff = gw - dp.lastWeight; // Mennyi van hÃ¡tra a cÃ©lig (pl. 69.5 - 76.8 = -7.3)

        // A teljes utazÃ¡s abszolÃºt Ã©rtÃ©ke (kezdÅ‘ sÃºlytÃ³l a cÃ©lig)
        const totalJourneyAbs = Math.abs(startWeight - gw);
        // A mÃ¡r megtett Ãºt abszolÃºt Ã©rtÃ©ke (kezdÅ‘ sÃºlytÃ³l a jelenlegiig)
        const journeyDoneAbs = Math.abs(startWeight - dp.lastWeight);

        let perc_weight = 0;
        if (totalJourneyAbs === 0) {
          // Ha a cÃ©l a kezdÅ‘ sÃºly, Ã©s elÃ©rtÃ¼k, 100%
          perc_weight = (dp.lastWeight === gw) ? 100 : 0;
        } else {
          perc_weight = (journeyDoneAbs / totalJourneyAbs) * 100;
        }

        if (perc_weight > 100) perc_weight = 100; // Ne menjen 100% fÃ¶lÃ©
        if (perc_weight < 0) perc_weight = 0;

        compactWeightTop.textContent = `${dp.lastWeight.toFixed(1)} kg / CÃ©l: ${gw} kg`;

        // JAVÃTOTT RÃ‰SZ: Csak akkor Ã­rja, hogy "CÃ©l elÃ©rve", ha a kÃ¼lÃ¶nbsÃ©g 0.
        if (goalDiff.toFixed(1) == 0) { // KerekÃ­tve nÃ©zzÃ¼k
          compactWeightBottom.textContent = "CÃ©l elÃ©rve! ğŸ‰";
          perc_weight = 100; // Biztos, ami biztos
        } else {
          // A "MÃ©g" szÃ¶veg elÅ‘jelÃ©nek formÃ¡zÃ¡sa
          const diffSign = goalDiff > 0 ? '+' : '';
          compactWeightBottom.textContent = `MÃ©g ${diffSign}${goalDiff.toFixed(1)} kg`;
        }

        compactWeightBar.style.width = perc_weight + '%';
      } else {
        compactWeightTop.textContent = `${dp.lastWeight > 0 ? dp.lastWeight : '--'} kg / CÃ©l: ${gw ? gw : '--'} kg`;
        compactWeightBottom.textContent = "Nincs sÃºlycÃ©l";
        compactWeightBar.style.width = '0%';
      }

      // --- VÃ­z (Marad a helyes logika) ---
      if (gwat) {
        const rem_water = gwat - dp.water;
        let perc_water = (dp.water / gwat) * 100;
        if (perc_water > 100) perc_water = 100;
        if (perc_water < 0) perc_water = 0;

        compactWaterTop.textContent = `${dp.water.toFixed(1)} / ${gwat.toFixed(1)} L`;
        compactWaterBottom.textContent = rem_water > 0 ? `MÃ©g ${rem_water.toFixed(1)} L` : `CÃ©l teljesÃ­tve!`;
        compactWaterBar.style.width = perc_water + '%';
      } else {
        compactWaterTop.textContent = `${dp.water.toFixed(1)} L`;
        compactWaterBottom.textContent = "Nincs vÃ­zcÃ©l";
        compactWaterBar.style.width = '0%';
      }

      // --- KalÃ³ria (Marad a helyes logika) ---
      if (gcal) {
        const rem_cal = gcal - dp.calories;
        let perc_cal = (dp.calories / gcal) * 100;
        if (perc_cal > 100) perc_cal = 100;
        if (perc_cal < 0) perc_cal = 0;

        compactCalTop.textContent = `${dp.calories.toFixed(0)} / ${gcal.toFixed(0)} kcal`;
        compactCalBottom.textContent = rem_cal > 0 ? `MÃ©g ${rem_cal.toFixed(0)} kcal` : `CÃ©l elÃ©rve!`;
        compactCalBar.style.width = perc_cal + '%';
      } else {
        compactCalTop.textContent = `${dp.calories.toFixed(0)} kcal`;
        compactCalBottom.textContent = "Nincs kalÃ³riacÃ©l";
        compactCalBar.style.width = '0%';
      }

      // --- Protein (Marad a helyes logika) ---
      if (gprot) {
        const rem_prot = gprot - dp.protein;
        let perc_prot = (dp.protein / gprot) * 100;
        if (perc_prot > 100) perc_prot = 100;
        if (perc_prot < 0) perc_prot = 0;

        compactProteinTop.textContent = `${dp.protein.toFixed(0)} / ${gprot.toFixed(0)} g`;
        compactProteinBottom.textContent = rem_prot > 0 ? `MÃ©g ${rem_prot.toFixed(0)} g` : `CÃ©l teljesÃ­tve!`;
        compactProteinBar.style.width = perc_prot + '%';
      } else {
        compactProteinTop.textContent = `${dp.protein.toFixed(0)} g`;
        compactProteinBottom.textContent = "Nincs proteincÃ©l";
        compactProteinBar.style.width = '0%';
      }
	  // --- ZsÃ­r (ÃšJ BLOKK) ---
      if (gfat) {
        const rem_fat = gfat - dp.fat;
        let perc_fat = (dp.fat / gfat) * 100;
        if (perc_fat > 100) perc_fat = 100;
        if (perc_fat < 0) perc_fat = 0;

        compactFatTop.textContent = `${dp.fat.toFixed(0)} / ${gfat.toFixed(0)} g`;
        compactFatBottom.textContent = rem_fat > 0 ? `MÃ©g ${rem_fat.toFixed(0)} g` : `CÃ©l teljesÃ­tve!`;
        compactFatBar.style.width = perc_fat + '%';
      } else {
        compactFatTop.textContent = `${dp.fat.toFixed(0)} g`;
        compactFatBottom.textContent = "Nincs zsÃ­rcÃ©l";
        compactFatBar.style.width = '0%';
      }
    }
    // =======================================================
    // ===== ALL APP LOGIC (NOW FIREBASE ENABLED) =====
    // =======================================================
    // =======================================================
    // ===== GLOBÃLIS VÃLTOZÃ“K (REFACTORED) =====
    // =======================================================
    // These are now initialized as empty.
    // They will be filled by loadDataFromFirestore()
    let goals = [];
    let rewards = [];
    let notes = [];
    let logs = [];
    let workouts = [];
    let meals = [];
    let reminders = []; // ÃšJ EMLÃ‰KEZTETÅ TÃ–MB
    let totalPoints = 0;
    let transactions = [];
    let archivedGoals = [];
    let pointsLog = []; // ÃšJ PONT TÃ–RTÃ‰NET TÃ–MB

    // App settings
    let goalWeightSetting = "";
    let goalWaterSetting = "";
    let goalCaloriesSetting = "";
    let goalProteinSetting = ""; // ÃšJ
	let goalFatSetting = ""; // ÃšJ ZSÃR

    // Other global vars
    let chart;
    let editTarget = null;
    let dailyProgress = {
      water: 0,
      calories: 0,
      protein: 0,
	  fat: 0,
      lastWeight: 0,
      date: ""
    }; // 'protein' HOZZÃADVA
    let reminderCheckInterval = null; // ÃšJ EMLÃ‰KEZTETÅ IDÅZÃTÅ
	// SegÃ©dfÃ¼ggvÃ©ny: ISO stringet (amit tÃ¡rolunk) alakÃ­t "datetime-local" formÃ¡tumra
    function toLocalISOString(isoString) {
      if (!isoString) return "";
      const date = new Date(isoString);
      const y = date.getFullYear();
      const m = (date.getMonth() + 1).toString().padStart(2, '0');
      const d = date.getDate().toString().padStart(2, '0');
      const h = date.getHours().toString().padStart(2, '0');
      const min = date.getMinutes().toString().padStart(2, '0');
      return `${y}-${m}-${d}T${h}:${min}`;
    }

    // SegÃ©dfÃ¼ggvÃ©ny: ISO stringet (amit tÃ¡rolunk) alakÃ­t "date" (YYYY-MM-DD) formÃ¡tumra
    function toDateInputString(isoString) {
      if (!isoString) return "";
      const date = new Date(isoString);
      const y = date.getFullYear();
      const m = (date.getMonth() + 1).toString().padStart(2, '0');
      const d = date.getDate().toString().padStart(2, '0');
      return `${y}-${m}-${d}`;
    }


    // =======================================================
    // ===== ÃšJ FUNKCIÃ“: KATEGÃ“RIA LISTA LÃ‰TREHOZÃSA =====
    // =======================================================
    function populateCategoryDatalist() {
      const datalist = document.getElementById('categoryDatalist');
      if (!datalist) return;

      datalist.innerHTML = ""; // TÃ¶rÃ¶ljÃ¼k a rÃ©gi opciÃ³kat

      // Ã–sszegyÅ±jtjÃ¼k a meglÃ©vÅ‘ kategÃ³riÃ¡kat (csak egyedi Ã©rtÃ©kek)
      const existingCategories = new Set(
        goals
        .map(goal => goal.category)
        .filter(category => category) // Csak a lÃ©tezÅ‘ kategÃ³riÃ¡k
      );

      // HozzÃ¡adjuk az archivÃ¡lt cÃ©lok kategÃ³riÃ¡it is
      archivedGoals
        .map(goal => goal.category)
        .filter(category => category)
        .forEach(category => existingCategories.add(category));

      // HozzÃ¡adjuk Å‘ket a listÃ¡hoz
      existingCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        datalist.appendChild(option);
      });
    }
    // =======================================================


    // =======================================================
    // ===== AUTHENTICATION (NEW FUNCTIONS) =====
    // =======================================================
    function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPassword').value;
      document.getElementById('loginError').innerText = "";

      auth.signInWithEmailAndPassword(email, pass)
        .then((userCredential) => {
          // Sign-in successful, onAuthStateChanged will handle the rest
          console.log("User logged in:", userCredential.user.uid);
        })
        .catch((error) => {
          document.getElementById('loginError').innerText = "Hiba: " + error.message;
        });
    }

    function handleSignUp() {
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPassword').value;
      document.getElementById('loginError').innerText = "";

      auth.createUserWithEmailAndPassword(email, pass)
        .then((userCredential) => {
          // Sign-up successful, onAuthStateChanged will handle the rest
          console.log("User created:", userCredential.user.uid);
        })
        .catch((error) => {
          document.getElementById('loginError').innerText = "Hiba: " + error.message;
        });
    }

    function handleLogout() {
      auth.signOut();
    }

    // =======================================================
    // ===== DATA SYNC (NEW FUNCTIONS) =====
    // =======================================================

    // A function to get all data from Firestore
    async function loadDataFromFirestore() {
      if (!currentUser) return; // Safety check
      console.log("Loading data from Firestore...");
      const docRef = db.collection('users').doc(currentUser.uid);

      try {
        const doc = await docRef.get();
        if (doc.exists) {
          // Document exists, load the data into our global variables
          const data = doc.data();
          goals = data.goals || [];
          rewards = data.rewards || [];
          notes = data.notes || [];
          logs = Array.isArray(data.logs) ? data.logs : [];
          workouts = data.workouts || [];
          meals = data.meals || [];
          reminders = data.reminders || []; // ÃšJ
          archivedGoals = data.archivedGoals || [];
          totalPoints = data.totalPoints || 0;
          transactions = Array.isArray(data.transactions) ? data.transactions : [];
          pointsLog = data.pointsLog || []; // PONTNAPLÃ“ BETÃ–LTÃ‰SE
          // Also load the settings
          goalWeightSetting = data.goalWeight || "";
          goalWaterSetting = data.goalWater || "";
          goalCaloriesSetting = data.goalCalories || "";
          goalProteinSetting = data.goalProtein || "";
		  goalFatSetting = data.goalFat || "";

          // ===== EDZÃ‰S ADAT MIGRÃCIÃ“ (ÃšJ) =====
          if (workouts.length > 0 && typeof workouts[0] === 'string') {
            console.log("Migrating workouts data structure...");
            workouts = workouts.map(dateStr => ({
              date: dateStr,
              note: ""
            }));
          }
          // ===== MIGRÃCIÃ“ VÃ‰GE =====

          console.log("Data loaded successfully.");
        } else {
          console.log("No data found for this user, starting fresh.");
        }
      } catch (error) {
        console.error("Error loading data:", error);
        alert("Hiba tÃ¶rtÃ©nt az adatok betÃ¶ltÃ©se kÃ¶zben.");
      }
    }

    // A function to save all data to Firestore
    async function saveDataToFirestore() {
      if (!currentUser) return; // Safety check

      console.log("Saving data to Firestore...");
      const docRef = db.collection('users').doc(currentUser.uid);

      const dataToSave = {
        goals,
        rewards,
        notes,
        logs,
        workouts,
        meals,
        reminders, // ÃšJ
        archivedGoals,
        totalPoints,
        transactions,
        pointsLog, // PONTNAPLÃ“ MENTÃ‰SE
        goalWeight: goalWeightSetting,
        goalWater: goalWaterSetting,
        goalCalories: goalCaloriesSetting,
        goalProtein: goalProteinSetting,
		goalFat: goalFatSetting,
      };

      try {
        await docRef.set(dataToSave);
        console.log("Data saved successfully.");
      } catch (error) {
        console.error("Error saving data:", error);
      }
    }

    // =======================================================
    // ===== APP INITIALIZATION (REFACTORED) =====
    // =======================================================

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // === USER IS LOGGED IN ===
        currentUser = user;
        console.log("Auth state changed: Logged in as", user.uid);

        document.getElementById('appContainer').style.display = 'block';
        document.getElementById('loginContainer').style.display = 'none';

        await loadDataFromFirestore();
        await checkRecurringGoals(); // ÃšJ: IsmÃ©tlÅ‘dÅ‘ cÃ©lok ellenÅ‘rzÃ©se
		await checkRecurringGoals(); // Ez ellenÅ‘rzi a *teljesÃ­tett* ismÃ©tlÅ‘dÅ‘ket
        await checkPendingGoals(); // EZ AZ ÃšJ SOR (ellenÅ‘rzi a vÃ¡rakozÃ³kat)
        calculateDailyProgress();
        calculateDailyProgress();
        loadMotivation();
        renderAll();

        startReminderEngine(); // ÃšJ EMLÃ‰KEZTETÅ MOTOR INDÃTÃSA
		} else {
        // === USER IS LOGGED OUT ===
        currentUser = null;
        console.log("Auth state changed: Logged out");

        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';

        // Clear all local data
        goals = [];
        rewards = [];
        notes = [];
        logs = [];
        workouts = [];
        meals = [];
        reminders = []; // ÃšJ
        archivedGoals = [];
        totalPoints = 0;
        pointsLog = []; // PONTNAPLÃ“ NULLÃZÃSA
        transactions = [];
        goalWeightSetting = "";
        goalWaterSetting = "";
        goalCaloriesSetting = "";
        goalProteinSetting = "";
      }
    });


    // =======================================================
    // ===== PONTSZÃMLÃLÃ“ ANIMÃCIÃ“ =====
    // =======================================================
    function animatePoints(newValue) {
      const displayElement = document.getElementById("totalPointsDisplay");
      if (!displayElement) return;

      let startValue = parseInt(displayElement.textContent);
      if (isNaN(startValue)) {
        startValue = 0;
      }
      if (startValue === newValue) return;

      const duration = 750;
      const range = newValue - startValue;
      let startTime = null;

      function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        const currentValue = Math.floor(startValue + range * progress);

        displayElement.textContent = currentValue;

        if (progress < 1) {
          window.requestAnimationFrame(step);
        } else {
          displayElement.textContent = newValue;
        }
      }
      window.requestAnimationFrame(step);
    }


    // =======================================================
    // ===== GRAFIKON MODAL FUNKCIÃ“ =====
    // =======================================================
    function openChartModal() {
      openModal('chartModal');
      setTimeout(updateChart, 100);
    }

    // =======================================================
    // ===== ADATKEZELÅ FÃœGGVÃ‰NYEK =====
    // =======================================================

    function calculateDailyProgress() {
      const today = new Date().toISOString().slice(0, 10);
      // 'protein' HOZZÃADVA
      dailyProgress = {
        water: 0,
        calories: 0,
        protein: 0,
		fat: 0,
        lastWeight: 0,
        date: today
      };

      let lastWeightEntry = null;

      if (!Array.isArray(transactions)) {
        console.error("Transactions is not an array!", transactions);
        transactions = [];
        return;
      }

      for (const t of transactions) {
        if (t.type === 'weight' && t.value > 0) {
          lastWeightEntry = t;
        }

        try {
          let entryDate;
          if (t.date && typeof t.date.toDate === 'function') {
            entryDate = t.date.toDate();
          } else {
            entryDate = new Date(t.date);
          }

          if (!entryDate || isNaN(entryDate.getTime())) {
            console.warn("Invalid date object encountered:", t.date);
            continue;
          }

          if (entryDate.toISOString().slice(0, 10) === today) {
            if (t.type === 'water') {
              dailyProgress.water += t.value;
            } else if (t.type === 'protein') { // ÃšJ
              dailyProgress.protein += t.value;
            } else if (t.type === 'fat') { // ÃšJ ZSÃR
              dailyProgress.fat += t.value;
            } else if (t.type === 'meal') { // ÃšJ
              dailyProgress.calories += t.totalKcal;
              dailyProgress.protein += t.totalProtein;
              dailyProgress.fat += t.totalFat || 0; // || 0 a rÃ©gi adatok miatt
            }
          }
        } catch (e) {
          console.error("DÃ¡tumfeldolgozÃ¡si hiba a calculateDailyProgress-ben:", e, t.date);
        }
      }

      if (lastWeightEntry) {
        dailyProgress.lastWeight = lastWeightEntry.value;
      }
    }

    // =======================================================
    // ===== MÃ“DOSÃTOTT TAB KEZELÃ‰S =====
    // =======================================================
    function showTab(id) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
	  if (id === 'main') {
        renderHighlights();
      }
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

      if (event && event.target) {
        // ---- ITT A JAVÃTÃS ----
        // BiztosÃ­tjuk, hogy a .tab-btn kapja meg az 'active' osztÃ¡lyt,
        // mÃ©g akkor is, ha a benne lÃ©vÅ‘ ikonra (span) kattintott a felhasznÃ¡lÃ³.
        event.target.closest('.tab-btn').classList.add('active');
        // ---- JAVÃTÃS VÃ‰GE ----
      } else {
        // Ez a vÃ©szmegoldÃ¡s, ha az 'event' valamiÃ©rt nem elÃ©rhetÅ‘
        document.querySelector(`.tab-btn[onclick="showTab('${id}')"]`).classList.add('active');
      }

      document.getElementById(id).classList.add('active');

      if (id === 'workouts') {
        renderWorkouts();
      }
      // ÃšJ: Ã‰tkezÃ©s fÃ¼l renderelÃ©se
      if (id === 'meals') {
        renderMeals();
      }
	  // ============ IDE ILLESZD BE ============
      // JAVÃTÃS: Jegyzetek fÃ¼l renderelÃ©se
      if (id === 'notes') {
        renderNotes();
      }
      // ==========================================

      // ÃšJ: EmlÃ©keztetÅ‘ fÃ¼l renderelÃ©se Ã©s engedÃ©lykÃ©rÃ©s
      if (id === 'reminders') {
        checkNotificationPermission(); // RÃ¡kÃ©rdez az engedÃ©lyre
		document.getElementById("reminderHighlightDateInput").value = toDateInputString(new Date());
        renderReminders();
      }

      // ÃšJ: HaladÃ¡s fÃ¼l naplÃ³inak frissÃ­tÃ©se
      if (id === 'history') {
        renderLogs();
        renderPointsLog();
      }

      // ===== ÃšJ KOMPAKT SÃV MEGJELENÃTÃ‰SI LOGIKA =====
      const compactGoalsBar = document.getElementById('compactGoalsContainer');
      if (compactGoalsBar) {
        if (id === 'main' || id === 'meals') {
          // A kompakt sÃ¡v megjelenÃ­tÃ©se a FÅ‘oldalon Ã©s az Ã‰tkezÃ©s fÃ¼lÃ¶n.
          // A CSS-ed 'display: grid'-et hasznÃ¡l, ezÃ©rt azt Ã¡llÃ­tjuk be.
          compactGoalsBar.style.display = 'grid';
        } else {
          // Minden mÃ¡s fÃ¼lÃ¶n elrejtjÃ¼k.
          compactGoalsBar.style.display = 'none';
        }
      }
      // ===== MÃ“DOSÃTOTT LOGIKA VÃ‰GE =====
    }
    // =======================================================
    // ===== EDZÃ‰S FUNKCIÃ“K (REFACTORED) =====
    // =======================================================
    async function addWorkout() { // Make async
      const dateInput = document.getElementById("workoutDateInput");
      const selectedDate = dateInput.value;

      if (!selectedDate) {
        alert("KÃ©rlek vÃ¡lassz ki egy dÃ¡tumot!");
        return;
      }

      if (workouts.find(w => w.date === selectedDate)) {
        alert("Ehhez a naphoz mÃ¡r rÃ¶gzÃ­tettÃ©l edzÃ©st!");
        return;
      }

      workouts.push({
        date: selectedDate,
        note: ""
      });
      await saveWorkouts();
      logActivity(`ğŸ‹ï¸â€â™‚ï¸ EdzÃ©s rÃ¶gzÃ­tve: ${selectedDate}`);
      renderWorkouts();

      dateInput.value = "";
    }

    function renderWorkouts() {
      const list = document.getElementById("workoutList");
      if (!list) return;

      workouts.sort((a, b) => b.date.localeCompare(a.date));
      list.innerHTML = "";

      if (workouts.length === 0) {
        list.innerHTML = "<p>MÃ©g nincsenek rÃ¶gzÃ­tett edzÃ©seid.</p>";
        return;
      }

      workouts.forEach((workout, index) => {
        const div = document.createElement("div");
        div.className = "workout-item";
        div.innerHTML = `
          <span onclick="openWorkoutNoteModal(${index})">ğŸ‹ï¸â€â™‚ï¸ ${workout.date}</span>
          <div>
            <button class="edit-note-btn" onclick="editWorkout(${index})">âœï¸</button>
            <button onclick="deleteWorkout(${index})">ğŸ—‘ï¸</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    async function deleteWorkout(index) {
      if (!confirm(`Biztosan tÃ¶rlÃ¶d az edzÃ©st errÅ‘l a naprÃ³l: ${workouts[index].date}?`)) {
        return;
      }

      const deletedWorkout = workouts.splice(index, 1)[0];
      if (deletedWorkout) {
        await saveWorkouts();
        logActivity(`ğŸ—‘ï¸ EdzÃ©s tÃ¶rÃ¶lve: ${deletedWorkout.date}`);
        renderWorkouts();
      }
    }

    async function saveWorkouts() {
      await saveDataToFirestore();
    }
	function editReminder(id) {
      const index = reminders.findIndex(r => r.id === id);
      if (index === -1) return;
      const reminder = reminders[index];

      editTarget = {
        type: 'reminder',
        index: index
      };

      document.getElementById("editTitle").textContent = "ğŸ”” EmlÃ©keztetÅ‘ szerkesztÃ©se";

      // 1. SzÃ¶veg
      document.getElementById("editLabel1").textContent = "EmlÃ©keztetÅ‘ szÃ¶vege";
      document.getElementById("editInput1").value = reminder.text;
      document.getElementById("editInput1").style.display = "block";
      document.getElementById("editLabel1").style.display = "block";
	  document.getElementById("editPriorityField").style.display = "none";

      // 2. IdÅ‘pont (TÃ­pus Ã¡tÃ¡llÃ­tÃ¡sa 'datetime-local'-ra)
      document.getElementById("editLabel2").textContent = "IdÅ‘pont";
      const timeInput = document.getElementById("editInput2");
      timeInput.type = "datetime-local"; // TÃ­pus mÃ³dosÃ­tÃ¡sa
      timeInput.value = toLocalISOString(reminder.time);
      timeInput.style.display = "block";
      document.getElementById("editLabel2").style.display = "block";

      // 3. KiemelÃ©s Checkbox (az 'editRecurringFields' ÃºjrahasznosÃ­tÃ¡sÃ¡val)
      const recurringFields = document.getElementById("editRecurringFields");
      recurringFields.style.display = "block";
      recurringFields.querySelector('label[for="editIsRecurringInput"]').textContent = "KiemelÃ©s a fÅ‘oldalon?";
      const highlightCheck = document.getElementById("editIsRecurringInput");
      highlightCheck.checked = reminder.highlight;

      // ElrejtjÃ¼k az ismÃ©tlÅ‘dÃ©s legÃ¶rdÃ¼lÅ‘t, mert az nem kell
      const recurrenceOptions = document.getElementById("editRecurrenceOptions");
      recurrenceOptions.style.display = "none";

      // 4. KiemelÃ©s DÃ¡tuma (az 'editInput3' ÃºjrahasznosÃ­tÃ¡sÃ¡val)
      document.getElementById("editLabel3").textContent = "KiemelÃ©s kezdete";
      const dateInput = document.getElementById("editInput3");
      dateInput.type = "date"; // TÃ­pus mÃ³dosÃ­tÃ¡sa
      dateInput.value = toDateInputString(reminder.highlightDate || new Date());
      // JAVÃTVA: Ha van mentett dÃ¡tum, azt, ha nincs, a mait tÃ¶lti be

      // 5. Checkbox esemÃ©nykezelÅ‘ felÃ¼lÃ­rÃ¡sa
      highlightCheck.onchange = function() {
        // ElrejtjÃ¼k az ismÃ©tlÅ‘dÃ©s opciÃ³t (ami itt nem kell)
        document.getElementById("editRecurrenceOptions").style.display = "none";
        // Mutatjuk/elrejtjÃ¼k a dÃ¡tumvÃ¡lasztÃ³t
        const showDate = this.checked;
        document.getElementById("editLabel3").style.display = showDate ? "block" : "none";
        document.getElementById("editInput3").style.display = showDate ? "block" : "none";
      };

      // DÃ¡tum mezÅ‘ alapÃ©rtelmezett lÃ¡thatÃ³sÃ¡ga
      if (reminder.highlight) {
        document.getElementById("editLabel3").style.display = "block";
        dateInput.style.display = "block";
      } else {
        document.getElementById("editLabel3").style.display = "none";
        dateInput.style.display = "none";
      }

      // 6. Felesleges mezÅ‘k elrejtÃ©se
      document.getElementById("editLabelSubGoals").style.display = "none";
      document.getElementById("editInputSubGoals").style.display = "none";
      document.getElementById("editLabelText").style.display = "none";
      document.getElementById("editInputText").style.display = "none";
      document.getElementById("editMealFields").style.display = "none";

      openModal('editModal');
    }
    function editWorkout(index) {
      editTarget = {
        type: 'workout',
        index: index
      };

      const workoutDate = workouts[index].date;
      document.getElementById("editTitle").textContent = `ğŸ‹ï¸â€â™‚ï¸ EdzÃ©sjegyzet (${workoutDate})`;

      document.getElementById("editLabel1").style.display = "none";
      document.getElementById("editInput1").style.display = "none";
      document.getElementById("editLabel2").style.display = "none";
      document.getElementById("editInput2").style.display = "none";
      document.getElementById("editLabel3").style.display = "none";
      document.getElementById("editInput3").style.display = "none";
      document.getElementById("editMealFields").style.display = "none";
      document.getElementById("editLabelSubGoals").style.display = "none";
      document.getElementById("editInputSubGoals").style.display = "none";

      document.getElementById("editLabelText").textContent = "Jegyzet";
      document.getElementById("editLabelText").style.display = "block";
      document.getElementById("editInputText").value = parseStructuredArrayToText(workouts[index].note);
      document.getElementById("editInputText").style.display = "block";
	  document.getElementById("editPriorityField").style.display = "none";

      openModal('editModal');
    }
    // =======================================================


    // ===== CÃ‰LBEÃLLÃTÃS (REFACTORED) =====
    // =======================================================
	// =======================================================
// ===== ÃšJ FUNKCIÃ“: ISMÃ‰TLÅDÅ CÃ‰LOK LOGIKÃJA =====
// =======================================================

/**
 * EllenÅ‘rzi, hogy egy adott dÃ¡tum (utolsÃ³ teljesÃ­tÃ©s) Ã©s
 * gyakorisÃ¡g alapjÃ¡n vissza kell-e Ã¡llÃ­tani egy cÃ©lt a mai napon.
 */
// =======================================================
// ===== ÃšJ, KOMPLEX ISMÃ‰TLÅDÃ‰SI LOGIKA =====
// =======================================================

/**
 * KiszÃ¡mÃ­tja a kÃ¶vetkezÅ‘ esedÃ©kessÃ©gi dÃ¡tumot a megadott szabÃ¡lyok alapjÃ¡n.
 * @param {string} lastCompletedISO - Az utolsÃ³ teljesÃ­tÃ©s ISO dÃ¡tuma.
 * @param {object} recurrence - A { frequency, interval } objektum.
 * @returns {Date} A kÃ¶vetkezÅ‘ esedÃ©kessÃ©gi dÃ¡tum (Ã©jfÃ©lre Ã¡llÃ­tva).
 */
function getNextDueDate(lastCompletedISO, recurrence) {
    const lastDate = new Date(lastCompletedISO);
    lastDate.setHours(0, 0, 0, 0); // NormalizÃ¡lÃ¡s

    const interval = recurrence.interval || 1;
    const frequency = recurrence.frequency || 'daily';
    
    switch (frequency) {
        case 'daily':
            lastDate.setDate(lastDate.getDate() + interval);
            break;
        case 'weekly':
            lastDate.setDate(lastDate.getDate() + (interval * 7));
            break;
        case 'monthly':
            lastDate.setMonth(lastDate.getMonth() + interval);
            break;
        case 'yearly':
            lastDate.setFullYear(lastDate.getFullYear() + interval);
            break;
        default:
             lastDate.setDate(lastDate.getDate() + 1); // AlapÃ©rtelmezett: naponta
            break;
    }
    return lastDate;
}

/**
 * VÃ©gigmegy az archivÃ¡lt cÃ©lokon, ellenÅ‘rzi az ismÃ©tlÅ‘dÃ©si Ã©s
 * lejÃ¡rati feltÃ©teleket, Ã©s szÃ¼ksÃ©g esetÃ©n ÃºjraaktivÃ¡lja a cÃ©lokat.
 * Kezeli a rÃ©gi (string) Ã©s az Ãºj (objektum) ismÃ©tlÅ‘dÃ©si adatokat is.
 */
async function checkRecurringGoals() {
  let goalsWereReset = false;
  let goalsWereExpired = false;
  const today = new Date();
  today.setHours(0, 0, 0, 0); // Ma Ã©jfÃ©l

  // VisszafelÃ© iterÃ¡lunk, mert mÃ³dosÃ­thatjuk a tÃ¶mbÃ¶t (splice)
  for (let i = archivedGoals.length - 1; i >= 0; i--) {
    const goal = archivedGoals[i];

    // Csak azokat nÃ©zzÃ¼k, amik:
    // 1. IsmÃ©tlÅ‘dÅ‘ek
    // 2. TeljesÃ­tve lettek (done: true)
    // 3. Van rÃ¶gzÃ­tett utolsÃ³ teljesÃ­tÃ©si idejÃ¼k
    if (goal.isRecurring && goal.done && goal.lastCompleted) {
      
      let recurrenceData = goal.recurrence;
      
      // --- VisszafelÃ© kompatibilitÃ¡s: RÃ©gi string adatok Ã¡talakÃ­tÃ¡sa ---
      if (typeof recurrenceData === 'string') {
        const oldRecurrence = recurrenceData;
        recurrenceData = {
            frequency: 'daily',
            interval: 1,
            endCondition: 'never',
            currentCount: 0
        };
        if (oldRecurrence === 'weekly') {
            recurrenceData.frequency = 'weekly';
        } else if (oldRecurrence === 'monthly') {
            recurrenceData.frequency = 'monthly';
        } else if (oldRecurrence.endsWith('days')) {
            recurrenceData.interval = parseInt(oldRecurrence) || 1;
        }
        // FrissÃ­tjÃ¼k a cÃ©l objektumot az Ãºj struktÃºrÃ¡val
        goal.recurrence = recurrenceData;
      }
      // --- KompatibilitÃ¡s vÃ©ge ---

      if (!recurrenceData) continue; // Ha nincs Ã©rvÃ©nyes adat, hagyjuk

      let goalExpired = false;
      const todayISO = toDateInputString(today.toISOString());

      // 1. LEJÃRATI FELTÃ‰TELEK ELLENÅRZÃ‰SE
      if (recurrenceData.endCondition === 'count') {
          if (recurrenceData.currentCount >= recurrenceData.endCount) {
              goalExpired = true;
          }
      } else if (recurrenceData.endCondition === 'date') {
          if (recurrenceData.endDate && todayISO > recurrenceData.endDate) {
               goalExpired = true;
          }
      }

      if (goalExpired) {
          // A cÃ©l vÃ©gleg lejÃ¡rt. Kikapcsoljuk az ismÃ©tlÅ‘dÃ©st.
          console.log(`IsmÃ©tlÅ‘dÅ‘ cÃ©l vÃ©gleg lejÃ¡rt: ${goal.name}`);
          goal.isRecurring = false;
          goalsWereExpired = true;
          continue; // Hagyjuk az archÃ­vumban, de mÃ¡r nem ismÃ©tlÅ‘dik
      }

      // 2. ÃšJRAAKTIVÃLÃS ELLENÅRZÃ‰SE
      const nextDueDate = getNextDueDate(goal.lastCompleted, recurrenceData);
      
      if (today.getTime() >= nextDueDate.getTime()) {
        console.log(`IsmÃ©tlÅ‘dÅ‘ cÃ©l reaktivÃ¡lÃ¡sa: ${goal.name}`);

        // 1. CÃ©l Ã¡llapotÃ¡nak visszaÃ¡llÃ­tÃ¡sa
        goal.done = false;
        goal.lastCompleted = null;
		goal.startDate = null; 

        // 2. AlcÃ©lok Ã¡llapotÃ¡nak visszaÃ¡llÃ­tÃ¡sa
        if (goal.subGoals && goal.subGoals.length > 0) {
          goal.subGoals.forEach(sg => {
            if (sg.type === 'task') { // Csak a pipÃ¡lhatÃ³kat
              sg.done = false;
            }
          });
        }

        // 3. ÃthelyezÃ©s az archÃ­vumbÃ³l a fÅ‘ cÃ©lok listÃ¡jÃ¡ra
        const goalToReactivate = archivedGoals.splice(i, 1)[0];
        goals.push(goalToReactivate);

        goalsWereReset = true;
      }
    }
  }

  if (goalsWereReset || goalsWereExpired) {
    console.log("IsmÃ©tlÅ‘dÅ‘ cÃ©lok frissÃ­tve, mentÃ©s Ã©s renderelÃ©s...");
    renderGoals();
    if (document.getElementById('archiveModal').style.display === 'flex') {
      renderArchivedGoals();
    }
    await saveDataToFirestore();
  }
}
// EZ EGY TELJESEN ÃšJ FÃœGGVÃ‰NY
/**
 * VÃ©gigmegy az archivÃ¡lt cÃ©lokon, Ã©s aktivÃ¡lja azokat,
 * amelyeknek a kezdÅ‘ dÃ¡tuma eljÃ¶tt.
 */
async function checkPendingGoals() {
  let goalsWereActivated = false;
  const todayISO = toDateInputString(new Date().toISOString());

  // VisszafelÃ© iterÃ¡lunk, mert mÃ³dosÃ­tjuk a tÃ¶mbÃ¶t (splice)
  for (let i = archivedGoals.length - 1; i >= 0; i--) {
    const goal = archivedGoals[i];
    
    // A cÃ©l akkor aktivÃ¡lÃ³dik, ha NINCS 'done: true' Ã¡llapota (azaz nem teljesÃ­tett)
    if (!goal.done) {
        // ===== MÃ“DOSÃTOTT LOGIKA KEZDETE =====
        
        // 1. EllenÅ‘rizzÃ¼k a "MegjelenÃ©s dÃ¡tumÃ¡t"
        const startDate = goal.startDate;
        // Akkor OK, ha nincs megadva, VAGY ha a mai nap, vagy korÃ¡bbi
        const isStartDateOK = !startDate || startDate <= todayISO;

        // 2. EllenÅ‘rizzÃ¼k az "IsmÃ©tlÅ‘dÃ©s kezdetÃ©t" (csak ha ismÃ©tlÅ‘dÅ‘)
        let isRecurrenceDateOK = true; // AlapbÃ³l igaz
        if (goal.isRecurring && goal.recurrence && goal.recurrence.recurrenceStartDate) {
            if (goal.recurrence.recurrenceStartDate > todayISO) {
                isRecurrenceDateOK = false; // MÃ©g nem jÃ¶tt el az ideje
            }
        }

        // 3. DÃ¶ntÃ©s: A cÃ©l akkor aktivÃ¡lÃ³dik, ha MINDKÃ‰T feltÃ©tel teljesÃ¼l
        if (isStartDateOK && isRecurrenceDateOK) {
          console.log(`IdÅ‘zÃ­tett cÃ©l aktivÃ¡lÃ¡sa: ${goal.name}`);
    
          // ÃthelyezzÃ¼k az archÃ­vumbÃ³l az aktÃ­v cÃ©lok listÃ¡jÃ¡ra
          const goalToActivate = archivedGoals.splice(i, 1)[0];
          goals.push(goalToActivate);
    
          goalsWereActivated = true;
        }
        // ===== MÃ“DOSÃTOTT LOGIKA VÃ‰GE =====
    }
  }

  if (goalsWereActivated) {
    console.log("IdÅ‘zÃ­tett cÃ©lok frissÃ­tve, mentÃ©s Ã©s renderelÃ©s...");
    renderGoals();
    if (document.getElementById('archiveModal').style.display === 'flex') {
      renderArchivedGoals();
    }
    await saveDataToFirestore();
  }
}
// =======================================================
async function saveGoalSettings() { // Make async
  const gw = parseFloat(document.getElementById("goalWeightInput").value) || null;
  const gwat = parseFloat(document.getElementById("goalWaterInput").value) || null;
  const gcal = parseFloat(document.getElementById("goalCalInput").value) || null;
  const gprot = parseFloat(document.getElementById("goalProteinInput").value) || null; // ÃšJ
  const gfat = parseFloat(document.getElementById("goalFatInput").value) || null; // ÃšJ ZSÃR

  // Save to global variables
  goalWeightSetting = gw ? gw.toString() : "";
  goalWaterSetting = gwat ? gwat.toString() : "";
  goalCaloriesSetting = gcal ? gcal.toString() : "";
  goalProteinSetting = gprot ? gprot.toString() : ""; // ÃšJ
  goalFatSetting = gfat ? gfat.toString() : ""; // ÃšJ ZSÃR

  updateAllSummaries(); // Ez frissÃ­ti a nagy kÃ¡rtyÃ¡t
  // logActivity will call saveDataToFirestore
  await logActivity(`ğŸ¯ CÃ©lok beÃ¡llÃ­tva: ${gw || "-"}kg, ${gwat || "-"}L, ${gcal || "-"}kcal, ${gprot || "-"}g protein, ${gfat || "-"}g zsÃ­r`);
  closeModal('goalSetupModal');

  // ITT A JAVÃTÃS:
  // BiztosÃ­tjuk, hogy a kompakt sÃ¡v is frissÃ¼ljÃ¶n
  updateCompactSummaries();
}

function updateAllSummaries() {
  // Ez a fÃ¼ggvÃ©ny korÃ¡bban a rÃ©gi, nagy kÃ¡rtyÃ¡kat frissÃ­tette.
  // Mivel azok tÃ¶rÃ¶lve lettek, a tartalmÃ¡t kiÃ¼rÃ­tettÃ¼k,
  // de a kompakt sÃ¡v frissÃ­tÃ©sÃ©t itt hagyjuk,
  // hogy a program tÃ¶bbi rÃ©sze (pl. saveQuickAdd) zÃ¶kkenÅ‘mentesen mÅ±kÃ¶djÃ¶n.

  // FrissÃ­tjÃ¼k a kompakt nÃ©zetet
  updateCompactSummaries();
}


// =======================================================
// ===== ADATBEVITEL Ã‰S TÃ–RLÃ‰S (REFACTORED) =====
// =======================================================

async function deleteTransaction(index) { // Make async
  if (!confirm("Biztosan tÃ¶rlÃ¶d ezt a bejegyzÃ©st?")) {
    return;
  }

  const entry = transactions.splice(index, 1)[0];
  await logActivity(`ğŸ—‘ï¸ BejegyzÃ©s tÃ¶rÃ¶lve: ${entry.type} (${entry.value || entry.name})`);

  // ÃšjraszÃ¡moljuk az egÃ©szet
  calculateDailyProgress();
  updateAllSummaries();
  updateHistory();
  if (document.getElementById('chartModal').style.display === 'flex') {
    updateChart();
  }
}


// =======================================================
// ===== JEGYZETEK FUNKCIÃ“K (REFACTORED) =====
// =======================================================
// ÃšJ: Megnyitja a jegyzet hozzÃ¡adÃ¡sa modÃ¡lt
function openAddNoteModal() {
  // TÃ¶rÃ¶ljÃ¼k a modÃ¡l tartalmÃ¡t
  document.getElementById("noteTitleInput").value = "";
  document.getElementById("noteCategoryInput").value = "";
  document.getElementById("noteTextInput").value = "";

  // FeltÃ¶ltjÃ¼k a kategÃ³ria javaslatokat
  populateNoteCategoryDatalist();

  openModal('noteModal');
}

// MÃ“DOSÃTVA: MentÃ©s a modÃ¡lbÃ³l
async function saveNote() {
  const title = document.getElementById("noteTitleInput").value.trim();
  const category = document.getElementById("noteCategoryInput").value.trim();
  // MÃ“DOSÃTÃS: A szÃ¶veget egyenesen a formÃ¡zÃ³ funkciÃ³ba kÃ¼ldjÃ¼k
  const textArray = parseTextToStructuredArray(document.getElementById("noteTextInput").value);

  if (!title) return alert("KÃ©rlek adj meg egy cÃ­met!");
  // MÃ“DOSÃTÃS: Azt nÃ©zzÃ¼k, hogy a tÃ¶mb Ã¼res-e
  if (textArray.length === 0) return alert("KÃ©rlek adj meg szÃ¶veget is!");

  const note = {
    title,
    category: category || null, // Menti a kategÃ³riÃ¡t, vagy null-t ha Ã¼res
    text: textArray, // MÃ“DOSÃTÃS: A tÃ¶mbÃ¶t mentjÃ¼k
    date: new Date()
  };
  notes.unshift(note); // Az elejÃ©re szÃºrja be

  closeModal('noteModal');
  renderNotes(); // ÃšjrarajzolÃ¡s
  await logActivity(`ğŸ“ Jegyzet hozzÃ¡adva: ${title}`);
}

// TELJESEN ÃšJ RENDERNOTES FÃœGGVÃ‰NY (KATEGÃ“RIÃKKAL)
function renderNotes() {
  // JAVÃTÃS: Ez a 7 sor hiÃ¡nyzott. DefiniÃ¡lja a tÃ¡rolÃ³t Ã©s kezeli az Ã¼res listÃ¡t.
  const container = document.getElementById("notesList");
  if (!container) return; // BiztonsÃ¡gi ellenÅ‘rzÃ©s
  container.innerHTML = "";
  if (notes.length === 0) {
    container.innerHTML = "<p style='text-align:center; padding: 10px;'>MÃ©g nincsenek mentett jegyzeteid.</p>";
    return;
  }

  // 1. CsoportosÃ­tÃ¡s
  const categorized = {};
  const uncategorized = [];

  notes.forEach((note, i) => {
    // Fontos, hogy megÅ‘rizzÃ¼k az eredeti indexet a tÃ¶rlÃ©shez/szerkesztÃ©shez
    const item = { ...note,
      originalIndex: i
    };

    if (item.category) {
      if (!categorized[item.category]) {
        categorized[item.category] = [];
      }
      categorized[item.category].push(item);
    } else {
      uncategorized.push(item);
    }
  });

  // 2. MegjelenÃ­tÅ‘ segÃ©dfÃ¼ggvÃ©ny
  const renderItem = (n, index) => {
    let displayDate = "...";
    if (n.date) {
      if (typeof n.date.toDate === 'function') {
        displayDate = n.date.toDate().toLocaleString().split(',')[0];
      } else {
        displayDate = new Date(n.date).toLocaleString().split(',')[0];
      }
    }

    const div = document.createElement("div");
    div.className = "note-summary-item";
    div.innerHTML = `
      <div>
        <span class="note-summary-title" onclick="openNoteModal(${index})">${n.title}</span>
        <span class="note-summary-date">${displayDate}</span>
      </div>
      <div class="note-summary-actions">
        <button onclick='editNote(${index})'>âœï¸</button>
        <button onclick='deleteNote(${index})'>ğŸ—‘ï¸</button>
      </div>`;
    container.appendChild(div);
  };

  // 3. KategÃ³riÃ¡k kirajzolÃ¡sa (ABC sorrendben)
  const categoryNames = Object.keys(categorized).sort();
  categoryNames.forEach(categoryName => {
    const title = document.createElement("h3");
    title.className = "category-title"; // ÃšjrahasznosÃ­tjuk a CÃ©loknÃ¡l lÃ©vÅ‘ stÃ­lust
    title.textContent = categoryName;
    container.appendChild(title);

    categorized[categoryName].forEach(item => {
      renderItem(item, item.originalIndex); // Az eredeti indexet adjuk Ã¡t!
    });
  });

  // 4. KategÃ³ria nÃ©lkÃ¼liek kirajzolÃ¡sa
  if (uncategorized.length > 0) {
    if (categoryNames.length > 0) { // Csak akkor Ã­rjuk ki, hogy "EgyÃ©b", ha mÃ¡r voltak kategÃ³riÃ¡k
      const title = document.createElement("h3");
      title.className = "category-title";
      title.textContent = "EgyÃ©b";
      container.appendChild(title);
    }
    uncategorized.forEach(item => {
      renderItem(item, item.originalIndex); // Az eredeti indexet adjuk Ã¡t!
    });
  }
}

async function deleteNote(i) { // Make async
  if (!confirm(`Biztosan tÃ¶rlÃ¶d ezt a jegyzetet: "${notes[i].title}"?`)) {
    return;
  }
  const deletedTitle = notes[i].title;
  notes.splice(i, 1);
  renderNotes();
  await logActivity(`ğŸ—‘ï¸ Jegyzet tÃ¶rÃ¶lve: ${deletedTitle}`);
}

function openNoteModal(i) {
  const note = notes[i];
  document.getElementById("noteViewTitle").textContent = note.title;
  document.getElementById("noteViewText").innerHTML = renderStructuredArrayToHTML(note.text);
  openModal('noteViewModal');
}

// ===== ÃšJ FUNKCIÃ“ AZ Ã‰TEL JEGYZETHEZ =====
function openWorkoutNoteModal(index) {
  const workout = workouts[index];
  document.getElementById("noteViewTitle").textContent = `EdzÃ©sjegyzet: ${workout.date}`;
  // A 'renderStructuredArrayToHTML' hasznÃ¡lata a formÃ¡zÃ¡shoz
  document.getElementById("noteViewText").innerHTML = renderStructuredArrayToHTML(workout.note || "Ehhez az edzÃ©shez nem tartozik jegyzet.");
  openModal('noteViewModal');
}

// ===== INNENTÅL ILLESZD BE AZ ÃšJ FÃœGGVÃ‰NYT =====
function openMealNoteModal(index) {
  const meal = meals[index];
  document.getElementById("noteViewTitle").textContent = `Jegyzet: ${meal.name}`;
  // HasznÃ¡ljuk ugyanazt a renderelÅ‘t, mint a JegyzeteknÃ©l
  document.getElementById("noteViewText").innerHTML = renderStructuredArrayToHTML(meal.note);
  openModal('noteViewModal');
}

function editNote(i) {
  editTarget = {
    type: 'note',
    index: i
  };

  document.getElementById("editTitle").textContent = "ğŸ“ Jegyzet szerkesztÃ©se";
  document.getElementById("editLabel1").textContent = "CÃ­m";
  document.getElementById("editInput1").value = notes[i].title;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  // ÃšJ: KategÃ³ria mezÅ‘ betÃ¶ltÃ©se
  document.getElementById("editLabel3").textContent = "KategÃ³ria";
  document.getElementById("editInput3").value = notes[i].category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";

  document.getElementById("editLabelText").style.display = "block";
  document.getElementById("editInputText").value = parseStructuredArrayToText(notes[i].text);
  document.getElementById("editInputText").style.display = "block";

  // ElrejtjÃ¼k a felesleges mezÅ‘ket
  document.getElementById("editLabel2").style.display = "none";
  document.getElementById("editInput2").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  document.getElementById("editRecurringFields").style.display = "none"; // Ezt is rejtsÃ¼k el
  document.getElementById("editPriorityField").style.display = "none";

  openModal('editModal');
}
// =======================================================


// =======================================================
// ===== CÃ‰LOK (REFACTORED) =====
// =======================================================
async function saveGoal() { // Make async
  const name = document.getElementById("goalNameInput").value.trim();
  const points = parseInt(document.getElementById("goalPointsInput").value);
  const category = document.getElementById("goalCategoryInput").value.trim();

  if (!name) return alert("A cÃ©lnak nevet kell adni!");
  if (isNaN(points) || points < 0) return alert("Ã‰rvÃ©nytelen pontszÃ¡m! Adj meg 0-t vagy nagyobbat.");

  // ===== MÃ“DOSÃTOTT ALCÃ‰L FELDOLGOZÃS KEZDETE =====
  const subGoalsText = document.getElementById("goalSubGoalsInput").value;
  let subGoals = [];
  if (subGoalsText.trim() !== "") {
    subGoals = subGoalsText.split('\n')
      .map(text => text.trim())
      .filter(text => text.length > 0)
      .map(rawText => {
        // TÃ­pus meghatÃ¡rozÃ¡sa
        if (rawText.startsWith('#')) {
          return {
            type: 'header',
            text: rawText.substring(1).trim()
          };
        } else if (rawText === '---') {
          return {
            type: 'separator',
            text: '---'
          };
        } else {
          return {
            type: 'task',
            text: rawText,
            done: false
          };
        }
      });
  }
  // ===== MÃ“DOSÃTOTT ALCÃ‰L FELDOLGOZÃS VÃ‰GE =====

  // ÃšJ: IsmÃ©tlÅ‘dÃ©s beolvasÃ¡sa
  const isRecurring = document.getElementById("goalIsRecurringInput").checked;
  const isPriority = document.getElementById("goalIsPriorityInput").checked; // ÃšJ
  const startDate = document.getElementById("goalStartDateInput").value; // EZ AZ ÃšJ SOR
  const recurrenceStartDate = document.getElementById("goalRecurrenceStartDateInput").value || null;

  const newGoal = {
    name,
    points,
    done: false,
    category: category,
    subGoals: subGoals,
	isPriority: isPriority,
    startDate: startDate || null // EZ AZ ÃšJ SOR
  };

if (isRecurring) {
    newGoal.isRecurring = true;
    
    // 1. Beolvassuk az intervallumot Ã©s a frekvenciÃ¡t
    const frequency = document.getElementById("goalRecurrenceFrequency").value;
    const interval = parseInt(document.getElementById("goalRecurrenceInterval").value) || 1;
    
    // 2. Beolvassuk a befejezÃ©si feltÃ©telt
    const endCondition = document.querySelector('input[name="goalEndCondition"]:checked').value;
    const endCount = parseInt(document.getElementById("goalEndCountInput").value) || 5;
    const endDate = document.getElementById("goalEndDateInput").value || null;

    // 3. Ã–sszeÃ¡llÃ­tjuk az Ãºj recurrence objektumot
    newGoal.recurrence = {
      frequency: frequency, // 'daily', 'weekly', 'monthly', 'yearly'
      interval: interval,
      
      recurrenceStartDate: recurrenceStartDate, // HasznÃ¡ljuk a korÃ¡bban beolvasott vÃ¡ltozÃ³t
      
      endCondition: endCondition, // 'never', 'count', 'date'
      endDate: (endCondition === 'date' && endDate) ? endDate : null,
      endCount: (endCondition === 'count') ? endCount : null,
      
      currentCount: 0 // A szÃ¡mlÃ¡lÃ³ nullÃ¡rÃ³l indul
    };
    
    newGoal.lastCompleted = null; // Kezdetben nincs teljesÃ­tve
  }

  // ÃšJ, MÃ“DOSÃTOTT RÃ‰SZ
  const todayISO = toDateInputString(new Date().toISOString());
  let logMessage = "";

  // ===== MÃ“DOSÃTOTT ARCHIVÃLÃSI LOGIKA =====
  // A cÃ©l akkor kerÃ¼l archivÃ¡lÃ¡sra, ha:
  // 1. A 'MegjelenÃ©s dÃ¡tuma' a jÃ¶vÅ‘ben van.
  // VAGY
  // 2. IsmÃ©tlÅ‘dÅ‘ Ã‰S az 'IsmÃ©tlÅ‘dÃ©s kezdete' a jÃ¶vÅ‘ben van.
  const isPendingOnStartDate = newGoal.startDate && newGoal.startDate > todayISO;
  const isPendingOnRecurrenceDate = newGoal.isRecurring && newGoal.recurrence.recurrenceStartDate && newGoal.recurrence.recurrenceStartDate > todayISO;


  if (isPendingOnStartDate || isPendingOnRecurrenceDate) {
    // JÃ¶vÅ‘beli cÃ©l: Az archÃ­vumba tesszÃ¼k
    archivedGoals.unshift(newGoal); // unshift, hogy elÃ¶l legyen az archÃ­vumban
    logMessage = `ğŸ“¥ CÃ©l idÅ‘zÃ­tve az archÃ­vumba: ${name}`;
  } else {
    // Azonnali cÃ©l: A normÃ¡l listÃ¡ba tesszÃ¼k
    goals.push(newGoal);
    logMessage = `ğŸ¯ CÃ©l hozzÃ¡adva: ${name} (${points} pont)`;
  }

  document.getElementById("goalNameInput").value = "";
  document.getElementById("goalPointsInput").value = "";
  document.getElementById("goalCategoryInput").value = "";
  document.getElementById("goalSubGoalsInput").value = ""; 
  document.getElementById("goalIsPriorityInput").checked = false;
  document.getElementById("goalStartDateInput").value = ""; 

  closeModal('goalModal');
  renderGoals(); // A renderGoals frissÃ­ti a fÅ‘ listÃ¡t
  // Ha az archÃ­vum nyitva van, azt is frissÃ­thetjÃ¼k (opcionÃ¡lis, de jÃ³ gyakorlat)
  if (document.getElementById('archiveModal').style.display === 'flex') {
    renderArchivedGoals();
  }
  await logActivity(logMessage);
}
// =======================================================
// ===== JAVÃTOTT CÃ‰LKEZELÅ FÃœGGVÃ‰NYEK KEZDETE =====
// =======================================================

async function toggleGoal(i) { // Make async
  if (i < 0 || i >= goals.length) {
    console.error("Invalid index for toggleGoal:", i);
    return;
  }

  const goal = goals[i];

  if (goal.subGoals && goal.subGoals.length > 0) {
    console.warn("toggleGoal called on a goal with sub-goals. This shouldn't happen.");
    return;
  }

  // Csak a teljesÃ­tÃ©s Ã©rdekel (amikor 'done' false-rÃ³l true-ra vÃ¡lt)
  if (!goal.done) {
    goal.done = true;
    totalPoints += goal.points;
    animatePoints(totalPoints);

    if (goal.isRecurring) {
      // --- ISMÃ‰TLÅDÅ CÃ‰L TELJESÃTVE ---
      goal.lastCompleted = new Date().toISOString();

      let logMessage = `âœ… IsmÃ©tlÅ‘dÅ‘ cÃ©l archivÃ¡lva: ${goal.name}`;
      const recurrence = goal.recurrence;

      if (recurrence && typeof recurrence === 'object') {
        // NÃ¶veljÃ¼k a belsÅ‘ szÃ¡mlÃ¡lÃ³t
        recurrence.currentCount = (recurrence.currentCount || 0) + 1;

        // EllenÅ‘rizzÃ¼k, hogy ezzel lejÃ¡rt-e
        if (recurrence.endCondition === 'count' && recurrence.currentCount >= recurrence.endCount) {
          goal.isRecurring = false; // LejÃ¡rt, ne aktivÃ¡lja Ãºjra
          logMessage = `âœ… IsmÃ©tlÅ‘dÅ‘ cÃ©l VÃ‰GLEGESEN teljesÃ­tve: ${goal.name}`;
          console.log(`IsmÃ©tlÅ‘dÃ©s (darabszÃ¡m) vÃ©get Ã©rt: ${goal.name}`);
        }
        // DÃ¡tum alapÃº lejÃ¡rattal itt nem kell foglalkozni, azt a checkRecurringGoals kezeli
      }
      
      addPointsLogEntry(goal.points, `âœ… IsmÃ©tlÅ‘dÅ‘ cÃ©l: ${goal.name}`);
      await logActivity(`${logMessage} (+${goal.points} pont)`);

      // ÃthelyezÃ©s az archÃ­vumba
      const goalToArchive = goals.splice(i, 1)[0];
      archivedGoals.unshift(goalToArchive);

      // ListÃ¡k ÃºjrarajzolÃ¡sa
      renderGoals();
      if (document.getElementById('archiveModal').style.display === 'flex') {
        renderArchivedGoals();
      }
    } else {
      // --- NEM ISMÃ‰TLÅDÅ CÃ‰L TELJESÃTVE ---
      addPointsLogEntry(goal.points, `âœ… CÃ©l teljesÃ­tve: ${goal.name}`);
      await logActivity(`âœ… CÃ©l teljesÃ­tve: ${goal.name} (+${goal.points} pont)`);
      renderGoals(); // Csak a cÃ©l listÃ¡t rajzoljuk Ãºjra (Ã¡thÃºzÃ¡shoz)
    }

    await saveDataToFirestore();

  } else {
    // --- TELJESÃTÃ‰S VISSZAVONÃSA (Csak nem ismÃ©tlÅ‘dÅ‘ cÃ©loknÃ¡l lehetsÃ©ges) ---
    if (!goal.isRecurring) {
      goal.done = false;
      totalPoints -= goal.points;
      animatePoints(totalPoints);
      addPointsLogEntry(-goal.points, `âŒ CÃ©l visszavonva: ${goal.name}`);
      await logActivity(`âŒ CÃ©l visszavonva: ${goal.name} (-${goal.points} pont)`);
      await saveDataToFirestore();
      renderGoals();
    }
  }
}

// ===== ÃšJ FUNKCIÃ“: ALCÃ‰L KIPIPÃLÃSA =====
async function toggleSubGoal(goalIndex, subGoalIndex) {
  const goal = goals[goalIndex];
  if (!goal || !goal.subGoals || !goal.subGoals[subGoalIndex]) {
    console.error("Invalid sub-goal toggle.", goalIndex, subGoalIndex);
    return;
  }

  // ===== ÃšJ BIZTONSÃGI ELLENÅRZÃ‰S =====
  // Csak 'task' tÃ­pust (vagy rÃ©gitÃ­pusÃº 'undefined'-et) engedÃ¼nk pipÃ¡lni
  const subGoal = goal.subGoals[subGoalIndex];
  const sgType = subGoal.type || 'task'; // AlapÃ©rtelmezett a 'task' a rÃ©gi adatok miatt

  if (sgType !== 'task') {
    console.warn("Nem 'task' tÃ­pusÃº alcÃ©l pipÃ¡lÃ¡sa kÃ­sÃ©rlet megakadÃ¡lyozva.");
    return; // MegÃ¡llÃ­tjuk a futÃ¡st
  }
  // ===== VÃ‰GE =====

  const wasMainGoalDone = goal.done;

  // 1. AlcÃ©l Ã¡llapotÃ¡nak vÃ¡ltÃ¡sa
  subGoal.done = !subGoal.done;

  // 2. EllenÅ‘rzÃ©s, hogy az Ã¶sszes 'task' tÃ­pusÃº alcÃ©l kÃ©sz van-e
  // Csak a 'task' tÃ­pusÃºakat vesszÃ¼k szÃ¡mÃ­tÃ¡sba!
  const taskSubGoals = goal.subGoals.filter(sg => (sg.type || 'task') === 'task');
  const allDone = taskSubGoals.length > 0 && taskSubGoals.every(sg => sg.done);

  // 3. FÅ‘ cÃ©l Ã¡llapotÃ¡nak Ã©s pontoknak frissÃ­tÃ©se
  if (allDone && !wasMainGoalDone) {
    // === Ã‰PP MOST LETT KÃ‰SZ ===
    goal.done = true;
    totalPoints += goal.points;
    animatePoints(totalPoints);

    if (goal.isRecurring) {
      // --- ISMÃ‰TLÅDÅ CÃ‰L TELJESÃTVE ---
      goal.lastCompleted = new Date().toISOString();

      let logMessage = `âœ… IsmÃ©tlÅ‘dÅ‘ cÃ©l archivÃ¡lva: ${goal.name}`;
      const recurrence = goal.recurrence;

      if (recurrence && typeof recurrence === 'object') {
        // NÃ¶veljÃ¼k a belsÅ‘ szÃ¡mlÃ¡lÃ³t
        recurrence.currentCount = (recurrence.currentCount || 0) + 1;

        // EllenÅ‘rizzÃ¼k, hogy ezzel lejÃ¡rt-e
        if (recurrence.endCondition === 'count' && recurrence.currentCount >= recurrence.endCount) {
          goal.isRecurring = false; // LejÃ¡rt, ne aktivÃ¡lja Ãºjra
          logMessage = `âœ… IsmÃ©tlÅ‘dÅ‘ cÃ©l VÃ‰GLEGESEN teljesÃ­tve: ${goal.name}`;
          console.log(`IsmÃ©tlÅ‘dÃ©s (darabszÃ¡m) vÃ©get Ã©rt: ${goal.name}`);
        }
      }
      
      addPointsLogEntry(goal.points, `âœ… IsmÃ©tlÅ‘dÅ‘ cÃ©l: ${goal.name}`);
      await logActivity(`${logMessage} (+${goal.points} pont)`);

      // ÃthelyezÃ©s az archÃ­vumba
      const goalToArchive = goals.splice(goalIndex, 1)[0];
      archivedGoals.unshift(goalToArchive);

      if (document.getElementById('archiveModal').style.display === 'flex') {
        renderArchivedGoals();
      }
    } else {
      // --- NEM ISMÃ‰TLÅDÅ CÃ‰L TELJESÃTVE ---
      addPointsLogEntry(goal.points, `âœ… CÃ©l (alcÃ©lokkal): ${goal.name}`);
      await logActivity(`âœ… CÃ©l teljesÃ­tve: ${goal.name} (+${goal.points} pont)`);
    }

    await saveDataToFirestore();

  } else if (!allDone && wasMainGoalDone) {
    // === Ã‰PP MOST LETT VISSZAVONVA ===
    goal.done = false;
    totalPoints -= goal.points;
    animatePoints(totalPoints);

    if (goal.isRecurring) {
      goal.lastCompleted = null;
    }
    addPointsLogEntry(-goal.points, `âŒ CÃ©l (alcÃ©lokkal): ${goal.name}`);
    await logActivity(`âŒ CÃ©l visszavonva: ${goal.name} (-${goal.points} pont)`);
    await saveDataToFirestore();

  } else {
    // A fÅ‘ cÃ©l Ã¡llapota nem vÃ¡ltozott, csak az alcÃ©lÃ©
    await saveDataToFirestore();
  }

  // 4. FÅ‘ cÃ©l lista Ãºjra-rajzolÃ¡sa
  renderGoals();
}
// =======================================================
// ===== JAVÃTOTT CÃ‰LKEZELÅ FÃœGGVÃ‰NYEK VÃ‰GE =====
// =======================================================

function editGoal(i) {
  editTarget = {
    type: 'goal',
    index: i
  };
  document.getElementById("editTitle").textContent = "ğŸ¯ CÃ©l szerkesztÃ©se";

  document.getElementById("editLabel1").textContent = "CÃ©l neve";
  document.getElementById("editInput1").value = goals[i].name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont Ã©rtÃ©k";
  document.getElementById("editInput2").value = goals[i].points;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";

  document.getElementById("editLabel3").textContent = "KategÃ³ria (opcionÃ¡lis)";
  document.getElementById("editInput3").value = goals[i].category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";

  // ÃšJ: AlcÃ©lok betÃ¶ltÃ©se a szerkesztÅ‘be
  const subGoalsText = (goals[i].subGoals || [])
    .map(sg => {
      // MÃ“DOSÃTVA: VisszaalakÃ­tjuk a Markdown szintaxist a szerkesztÅ‘hÃ¶z
      const sgType = sg.type || 'task';
      if (sgType === 'header') {
        return `# ${sg.text}`;
      } else if (sgType === 'separator') {
        return '---';
      }
      return sg.text; // 'task'
    })
    .join('\n');

  document.getElementById("editLabelSubGoals").style.display = "block";
  document.getElementById("editInputSubGoals").value = subGoalsText;
  document.getElementById("editInputSubGoals").style.display = "block";

  // ÃšJ: IsmÃ©tlÅ‘dÃ©s mezÅ‘k betÃ¶ltÃ©se
  // ===== ÃšJ, BÅVÃTETT ISMÃ‰TLÅDÃ‰S BETÃ–LTÃ‰SE =====
  const isRecurring = goals[i].isRecurring || false;
  document.getElementById("editRecurringFields").style.display = "block";
  document.getElementById("editIsRecurringInput").checked = isRecurring;
  document.getElementById("editRecurrenceOptions").style.display = isRecurring ? "block" : "none";

  const recurrence = goals[i].recurrence;

  // Alaphelyzetbe Ã¡llÃ­tÃ¡s (ha nincs mentett adat)
  document.getElementById("editRecurrenceInterval").value = 1;
  document.getElementById("editRecurrenceFrequency").value = "daily";
  document.getElementById("editEndNever").checked = true;
  document.getElementById("editEndCountInput").value = 5;
  document.getElementById("editEndDateInput").value = "";

  if (recurrence) {
    if (typeof recurrence === 'object') {
      // --- ÃšJ, OBJEKTUM ALAPÃš ADAT BETÃ–LTÃ‰SE ---
      document.getElementById("editRecurrenceInterval").value = recurrence.interval || 1;
      document.getElementById("editRecurrenceFrequency").value = recurrence.frequency || "daily";
      
      // BefejezÃ©si feltÃ©tel beÃ¡llÃ­tÃ¡sa
      const endCondition = recurrence.endCondition || 'never';
      document.getElementById(`editEnd${endCondition.charAt(0).toUpperCase() + endCondition.slice(1)}`).checked = true;

      if (endCondition === 'count') {
        document.getElementById("editEndCountInput").value = recurrence.endCount || 5;
      } else if (endCondition === 'date') {
        document.getElementById("editEndDateInput").value = recurrence.endDate || "";
      }
      
    } else if (typeof recurrence === 'string') {
      // --- RÃ‰GI, STRING ALAPÃš ADAT KEZELÃ‰SE (VISSZAALAKÃTÃS) ---
      // Ez a rÃ©sz kezeli a rÃ©gi mentÃ©seket, pl. "weekly" vagy "2days"
      document.getElementById("editEndNever").checked = true; // A rÃ©giek sosem Ã©rtek vÃ©get
      
      if (recurrence === 'daily') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      } else if (recurrence === 'weekly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "weekly";
      } else if (recurrence === 'monthly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "monthly";
      } else if (recurrence.endsWith('days')) {
        // pl. "2days"
        document.getElementById("editRecurrenceInterval").value = parseInt(recurrence) || 2;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      }
    }
  }
  // ===== ISMÃ‰TLÅDÃ‰S BETÃ–LTÃ‰S VÃ‰GE =====
  // IsmÃ©tlÅ‘dÃ©s kezdÅ‘ dÃ¡tumÃ¡nak betÃ¶ltÃ©se
  const recStartDate = (recurrence && recurrence.recurrenceStartDate) ? recurrence.recurrenceStartDate : "";
  document.getElementById("editRecurrenceStartDateInput").value = toDateInputString(recStartDate);
  // ================================================
  const isPriority = goals[i].isPriority || false;
  document.getElementById("editPriorityField").style.display = "block";
  document.getElementById("editIsPriorityInput").checked = isPriority;
  // IDÅZÃTÃ‰S MEZÅ BETÃ–LTÃ‰SE (KEZDETE)
  const startDateField = document.getElementById("editStartDateField");
  const startDateInput = document.getElementById("editStartDateInput");
  startDateField.style.display = "block";
  // Csak akkor tÃ¶ltjÃ¼k be, ha van mentett dÃ¡tum
  if (goals[i].startDate) {
    startDateInput.value = toDateInputString(goals[i].startDate);
  } else {
    startDateInput.value = "";
  }
  // IDÅZÃTÃ‰S MEZÅ BETÃ–LTÃ‰SE (VÃ‰GE)

  // MÃ¡s mezÅ‘k elrejtÃ©se
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";

  openModal('editModal');
}

async function deleteGoal(i) { // Make async
  if (i < 0 || i >= goals.length) {
    console.error("Invalid index for deleteGoal:", i);
    return;
  }
  const goalToDelete = goals[i];


  goals.splice(i, 1);
  renderGoals();
  await logActivity(`ğŸ—‘ï¸ CÃ©l tÃ¶rÃ¶lve: ${goalToDelete ? goalToDelete.name : 'ismeretlen cÃ©l'}`);
}
function renderGoals() {
  const list = document.getElementById("goalList");
  list.innerHTML = "";

  // === MÃ“DOSÃTÃS KEZDETE: DÃ¡tum alapÃº szÅ±rÃ©s ===
  const today = new Date();
  today.setHours(0, 0, 0, 0); // DÃ¡tum normalizÃ¡lÃ¡sa Ã©jfÃ©lre a tiszta Ã¶sszehasonlÃ­tÃ¡sÃ©rt

  const visibleGoals = goals
    .map((goal, i) => ({ ...goal,
      originalIndex: i
    }))
    .filter(g => {
      if (g.startDate) {
        // Az input type="date" YYYY-MM-DD formÃ¡tumÃº stringet ad
        const startDateISO = g.startDate; // YYYY-MM-DD
        const todayISO = toDateInputString(today.toISOString()); // <--- EZ A JAVÃTÃS
        
        // Csak akkor jelenÃ­tjÃ¼k meg, ha a start dÃ¡tum ma van, vagy korÃ¡bban volt
        return startDateISO <= todayISO;
      }
      return true; // Ha nincs startDate, mindig lÃ¡tszik
    });
  // === MÃ“DOSÃTÃS VÃ‰GE ===

  // ===== ÃšJ SZÃ‰TVÃLOGATÃSI LOGIKA =====
  const priorityGoals = [];
  const categorized = {};
  const uncategorized = [];

  // MÃ“DOSÃTÃS: A 'goals' helyett a 'visibleGoals' tÃ¶mbÃ¶t hasznÃ¡ljuk
  visibleGoals.forEach((item) => {
    if (item.isPriority) {
      priorityGoals.push(item);
    } else if (item.category) {
      if (!categorized[item.category]) {
        categorized[item.category] = [];
      }
      categorized[item.category].push(item);
    } else {
      uncategorized.push(item);
    }
  });
  // ===== LOGIKA VÃ‰GE =====

  const renderItem = (g, i) => { // 'i' itt mÃ¡r az originalIndex lesz
    const div = document.createElement("div");
    
    // ===== ÃšJ OSZTÃLY HOZZÃADÃSA =====
    let classList = "goal-item";
    if (g.done) classList += " completed";
    if (g.isPriority) classList += " priority"; // EZ AZ ÃšJ SOR
    div.className = classList;
    // ===== VÃ‰GE =====

    // ===== MÃ“DOSÃTOTT ALCÃ‰L LOGIKA KEZDETE =====
    let subGoalsHTML = "";
    let hasSubGoals = g.subGoals && g.subGoals.length > 0;
    let hasTasks = false; 

    if (hasSubGoals) {
      subGoalsHTML = '<div class="subgoal-list">';
      g.subGoals.forEach((sg, subIndex) => {
        const sgType = sg.type || 'task';
        switch (sgType) {
          case 'header':
            subGoalsHTML += `<h4 class="subgoal-header">${sg.text}</h4>`;
            break;
          case 'separator':
            subGoalsHTML += `<hr class="subgoal-separator">`;
            break;
          case 'task':
          default:
            hasTasks = true; 
            subGoalsHTML += `
              <div>
                <input type="checkbox" onchange="toggleSubGoal(${i}, ${subIndex})" ${sg.done ? 'checked' : ''}>
                <span class="${sg.done ? 'subgoal-done' : ''}">${sg.text}</span>
              </div>
            `;
            break;
        }
      });
      subGoalsHTML += '</div>';
    }
    // ===== MÃ“DOSÃTOTT ALCÃ‰L LOGIKA VÃ‰GE =====

    // ===== ÃšJ IKON HOZZÃADÃSA A NÃ‰VHEZ =====
    const priorityIcon = g.isPriority ? 'ğŸ“Œ ' : ''; // TÅ± ikon
    const recurringIcon = g.isRecurring ? ' ğŸ”„' : ''; // IsmÃ©tlÅ‘dÅ‘ ikon

    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${priorityIcon}${g.name}${recurringIcon}</div>
        ${subGoalsHTML}
      </div>
      <div class="item-points">
        ${g.points} pont
      </div>
      <div class="item-actions">
      <button class="archive-btn" title="ArchivÃ¡lt/IdÅ‘zÃ­tett" onclick="archiveGoal(${i})">ğŸ“¥</button>
        <button onclick="editGoal(${i})" title="SzerkesztÃ©s">âœï¸</button>
        <button onclick="deleteGoal(${i})" title="TÃ¶rlÃ©s">ğŸ—‘ï¸</button>
        ${!hasTasks ? ( 
          g.done ?
          `<button onclick="toggleGoal(${i})" title="VisszavonÃ¡s">âŒ</button>` :
          `<button onclick="toggleGoal(${i})" title="TeljesÃ­t">âœ…</button>`
        ) :
        ''
      }
      </div>
    `;
    list.appendChild(div);
  };

  // ===== ÃšJ RENDERELÃ‰SI SORREND =====

  // 1. PrioritÃ¡sos cÃ©lok renderelÃ©se
  if (priorityGoals.length > 0) {
    const title = document.createElement("h3");
    title.className = "category-title";
    title.textContent = "ğŸ“Œ Fontos CÃ©lok";
    title.style.color = "#c62828"; // Piros cÃ­m
    title.style.borderColor = "#e57373"; // Piros vonal
    list.appendChild(title);
    
    priorityGoals.forEach(item => {
      renderItem(item, item.originalIndex); // MÃ“DOSÃTVA: az 'originalIndex'-et adjuk Ã¡t
    });
  }

  // 2. KategÃ³riÃ¡k kirajzolÃ¡sa (ABC sorrendben)
  const categoryNames = Object.keys(categorized).sort();
  categoryNames.forEach(categoryName => {
    const title = document.createElement("h3");
    title.className = "category-title";
    title.textContent = categoryName;
    list.appendChild(title);

    categorized[categoryName].forEach(item => {
      renderItem(item, item.originalIndex); // MÃ“DOSÃTVA: az 'originalIndex'-et adjuk Ã¡t
    });
  });

  // 3. KategÃ³ria nÃ©lkÃ¼liek kirajzolÃ¡sa
  if (uncategorized.length > 0) {
    // Csak akkor kell "EgyÃ©b" cÃ­m, ha volt mÃ¡r prioritÃ¡sos VAGY kategorizÃ¡lt
    if (categoryNames.length > 0 || priorityGoals.length > 0) { 
      const title = document.createElement("h3");
      title.className = "category-title";
      title.textContent = "EgyÃ©b";
      list.appendChild(title);
    }
    uncategorized.forEach(item => {
      renderItem(item, item.originalIndex); // MÃ“DOSÃTVA: az 'originalIndex'-et adjuk Ã¡t
    });
  }
  // ===== SORREND VÃ‰GE =====
}
// =======================================================
// ===== ARCHÃVUM FUNKCIÃ“K =====
// =======================================================
function openArchiveModal() {
  renderArchivedGoals();
  openModal('archiveModal');
}

async function archiveGoal(index) {
  const goalToArchive = goals.splice(index, 1)[0];

  if (goalToArchive) {
    archivedGoals.unshift(goalToArchive);
    renderGoals();
    await logActivity(`ğŸ“¥ CÃ©l archivÃ¡lva: ${goalToArchive.name}`);
  }
}

function renderArchivedGoals() {
  const list = document.getElementById("archivedGoalList");
  list.innerHTML = "";

  if (archivedGoals.length === 0) {
    list.innerHTML = "<p style='text-align: center; padding: 10px;'>Nincsenek archivÃ¡lt cÃ©lok.</p>";
    return;
  }

  archivedGoals.forEach((goal, index) => {
    // ÃšJ, MÃ“DOSÃTOTT RÃ‰SZ
    const div = document.createElement("div");
    
    // EllenÅ‘rizzÃ¼k, hogy a cÃ©l vÃ¡rakozÃ³ (pending) vagy mÃ¡r teljesÃ­tett (done)
    const todayISO = toDateInputString(new Date().toISOString());

    // === JAVÃTOTT STÃTUSZ LOGIKA KEZDETE ===

    // 1. ÃltalÃ¡nos "MegjelenÃ©s dÃ¡tuma" (nem ismÃ©tlÅ‘dÅ‘, vagy ismÃ©tlÅ‘dÅ‘ de a fÅ‘ dÃ¡tumot hasznÃ¡lva)
    const isPendingOnStartDate = goal.startDate && goal.startDate > todayISO && !goal.done;
    
    // 2. Kifejezetten "IsmÃ©tlÅ‘dÃ©s kezdete" dÃ¡tumra vÃ¡r
    const isPendingOnRecurrence = goal.isRecurring && !goal.done && goal.recurrence && goal.recurrence.recurrenceStartDate && goal.recurrence.recurrenceStartDate > todayISO;
    
    // 3. MÃ¡r teljesÃ­tett, Ã©s a kÃ¶vetkezÅ‘ ismÃ©tlÅ‘dÃ©sre vÃ¡r
    const isCompletedRecurring = goal.isRecurring && goal.done && goal.lastCompleted && goal.recurrence && typeof goal.recurrence === 'object';
    
    // === LOGIKA VÃ‰GE ===

    // Csak akkor hÃºzzuk Ã¡t, ha 'done' (teljesÃ­tett)
    div.className = goal.done ? "goal-item completed" : "goal-item";

    // Gomb az ismÃ©tlÅ‘dÃ©s kikapcsolÃ¡sÃ¡hoz (lila szÃ­nnel)
    let recurringBtn = "";
    if (goal.isRecurring) {
      recurringBtn = `<button style="color: #8e24aa;" title="IsmÃ©tlÅ‘dÃ©s kikapcsolÃ¡sa" onclick="toggleRecurrenceInArchive(${index})">ğŸ”„</button>`;
    }

    // NÃ©v Ã©s VÃ¡rakozÃ¡si dÃ¡tum / ÃšjraaktivÃ¡lÃ¡s dÃ¡tumÃ¡nak Ã¶sszeÃ¡llÃ­tÃ¡sa
        // NÃ©v Ã©s VÃ¡rakozÃ¡si dÃ¡tum / ÃšjraaktivÃ¡lÃ¡s dÃ¡tumÃ¡nak Ã¶sszeÃ¡llÃ­tÃ¡sa
        let goalNameHTML = `<div class="item-name-main">${goal.name} ${goal.isRecurring ? 'ğŸ”„' : ''}</div>`;
        let statusTextHTML = ""; // KÃ¼lÃ¶n vÃ¡ltozÃ³ a stÃ¡tuszszÃ¶vegnek

        if (isPendingOnStartDate) {
          // JÃ–VÅBEN INDULÃ“ (ÃLTALÃNOS DÃTUM)
          let displayDate = goal.startDate;
          try {
            displayDate = new Date(goal.startDate.split('-')[0], goal.startDate.split('-')[1] - 1, goal.startDate.split('-')[2]).toLocaleDateString('hu-HU');
          } catch(e) {}
          statusTextHTML = `<small style="font-weight:bold; color:#004d40;">(Indul: ${displayDate})</small>`;
        
        } else if (isPendingOnRecurrence) { 
          // JÃ–VÅBEN INDULÃ“ (ISMÃ‰TLÅDÃ‰S DÃTUMA) - EZ AZ ÃšJ BLOKK
          let displayDate = goal.recurrence.recurrenceStartDate;
           try {
            displayDate = new Date(displayDate.split('-')[0], displayDate.split('-')[1] - 1, displayDate.split('-')[2]).toLocaleDateString('hu-HU');
          } catch(e) {}
          statusTextHTML = `<small style="font-weight:bold; color:#004d40;">(IsmÃ©tlÅ‘dÃ©s indul: ${displayDate})</small>`;

        } else if (isCompletedRecurring) {
          // TELJESÃTETT, ÃšJRAAKTIVÃLÃSRA VÃRÃ“ CÃ‰L
          const recurrence = goal.recurrence;
          const nextDate = getNextDueDate(goal.lastCompleted, recurrence);
          const displayDate = nextDate.toLocaleDateString('hu-HU');
          
          let remainingText = "";
          if (recurrence.endCondition === 'count') {
            const remaining = (recurrence.endCount || 0) - (recurrence.currentCount || 0);
            remainingText = `(mÃ©g ${remaining} alkalom)`;
          } else if (recurrence.endCondition === 'date') {
            const endDate = new Date(recurrence.endDate).toLocaleDateString('hu-HU');
            remainingText = `(${endDate}-ig)`;
          } else {
            remainingText = "(nincs korlÃ¡t)";
        }
          
          statusTextHTML = `<small style="font-weight:bold; color:#004d40;">(AktÃ­v: ${displayDate} ${remainingText})</small>`;
        }

    div.innerHTML = `
      <div class="item-name">
         ${goalNameHTML}
		 ${statusTextHTML}
      </div>
      <div class="item-points">
        ${goal.points} pont
      </div>
      <div class="item-actions">
        ${recurringBtn} <button class="reactivate-btn" title="VisszaÃ¡llÃ­tÃ¡s" onclick="reactivateGoal(${index})">â™»ï¸</button>
		<button style="color:#00796b" title="SzerkesztÃ©s" onclick="editArchivedGoal(${index})">âœï¸</button>
        <button class="delete-btn" title="VÃ©gleges tÃ¶rlÃ©s" onclick="deleteArchivedGoal(${index})">ğŸ—‘ï¸</button>
      </div>
    `;
    list.appendChild(div);
  });
}

async function reactivateGoal(index) {
  const goalToReactivate = archivedGoals.splice(index, 1)[0];

  if (goalToReactivate) {
    goalToReactivate.done = false;
	goalToReactivate.startDate = null; // EZ AZ ÃšJ SOR

    // AlcÃ©lok "kipipÃ¡latlanÃ­tÃ¡sa"
    if (goalToReactivate.subGoals && goalToReactivate.subGoals.length > 0) {
      goalToReactivate.subGoals.forEach(sg => {
        sg.done = false;
      });
    }

    // BIZTONSÃGI LÃ‰PÃ‰S: TÃ¶rÃ¶ljÃ¼k a legutÃ³bbi teljesÃ­tÃ©st,
    // hogy a manuÃ¡lisan visszaÃ¡llÃ­tott cÃ©l biztosan aktÃ­v maradjon.
    if (goalToReactivate.isRecurring) {
      goalToReactivate.lastCompleted = null;
    }

    goals.push(goalToReactivate);

    renderGoals();
    renderArchivedGoals(); // Ezt kell futtatni, mert az archÃ­vum lista is vÃ¡ltozott
    await logActivity(`â™»ï¸ CÃ©l visszaÃ¡llÃ­tva: ${goalToReactivate.name}`);
  }
}

async function deleteArchivedGoal(index) {
  if (confirm("Biztosan vÃ©gleg tÃ¶rlÃ¶d ezt az archivÃ¡lt cÃ©lt? Ez nem vonhatÃ³ vissza.")) {
    const deletedGoal = archivedGoals.splice(index, 1)[0];

    if (deletedGoal) {
      if (deletedGoal.points > 0) {
        totalPoints -= deletedGoal.points;
        animatePoints(totalPoints);
      }
      renderArchivedGoals();
      addPointsLogEntry(-deletedGoal.points, `ğŸ—‘ï¸ ArchivÃ¡lt cÃ©l tÃ¶rÃ¶lve: ${deletedGoal.name}`);
      await logActivity(`ğŸ—‘ï¸ ArchivÃ¡lt cÃ©l tÃ¶rÃ¶lve: ${deletedGoal.name} (-${deletedGoal.points} pont)`);
    }
  }
}
// =======================================================
// ===== ÃšJ FUNKCIÃ“: ARCHIVÃLT CÃ‰L SZERKESZTÃ‰SE =====
// =======================================================
function editArchivedGoal(index) {
  const goal = archivedGoals[index]; // Az archivÃ¡lt tÃ¶mbbÅ‘l vesszÃ¼k

  editTarget = {
    type: 'archivedGoal', // Ãšj tÃ­pus, hogy a mentÃ©s tudja, mit kell tenni
    index: index
  };
  document.getElementById("editTitle").textContent = "ğŸ¯ ArchivÃ¡lt cÃ©l szerkesztÃ©se";

  // --- InnentÅ‘l a kÃ³d azonos az editGoal funkciÃ³val,
  // de a 'goal' vÃ¡ltozÃ³t hasznÃ¡lja 'goals[i]' helyett ---

  document.getElementById("editLabel1").textContent = "CÃ©l neve";
  document.getElementById("editInput1").value = goal.name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont Ã©rtÃ©k";
  document.getElementById("editInput2").value = goal.points;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";

  document.getElementById("editLabel3").textContent = "KategÃ³ria (opcionÃ¡lis)";
  document.getElementById("editInput3").value = goal.category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";

  const subGoalsText = (goal.subGoals || [])
    .map(sg => {
      const sgType = sg.type || 'task';
      if (sgType === 'header') {
        return `# ${sg.text}`;
      } else if (sgType === 'separator') {
        return '---';
      }
      return sg.text;
    })
    .join('\n');

  document.getElementById("editLabelSubGoals").style.display = "block";
  document.getElementById("editInputSubGoals").value = subGoalsText;
  document.getElementById("editInputSubGoals").style.display = "block";

  const isRecurring = goal.isRecurring || false;
  document.getElementById("editRecurringFields").style.display = "block";
  document.getElementById("editIsRecurringInput").checked = isRecurring;
  document.getElementById("editRecurrenceOptions").style.display = isRecurring ? "block" : "none";

  const recurrence = goal.recurrence;

  document.getElementById("editRecurrenceInterval").value = 1;
  document.getElementById("editRecurrenceFrequency").value = "daily";
  document.getElementById("editEndNever").checked = true;
  document.getElementById("editEndCountInput").value = 5;
  document.getElementById("editEndDateInput").value = "";

  if (recurrence) {
    if (typeof recurrence === 'object') {
      document.getElementById("editRecurrenceInterval").value = recurrence.interval || 1;
      document.getElementById("editRecurrenceFrequency").value = recurrence.frequency || "daily";
      const endCondition = recurrence.endCondition || 'never';
      document.getElementById(`editEnd${endCondition.charAt(0).toUpperCase() + endCondition.slice(1)}`).checked = true;
      if (endCondition === 'count') {
        document.getElementById("editEndCountInput").value = recurrence.endCount || 5;
      } else if (endCondition === 'date') {
        document.getElementById("editEndDateInput").value = recurrence.endDate || "";
      }
      
    } else if (typeof recurrence === 'string') {
      document.getElementById("editEndNever").checked = true;
      if (recurrence === 'daily') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      } else if (recurrence === 'weekly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "weekly";
      } else if (recurrence === 'monthly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "monthly";
      } else if (recurrence.endsWith('days')) {
        document.getElementById("editRecurrenceInterval").value = parseInt(recurrence) || 2;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      }
    }
  }
  
  const recStartDate = (recurrence && recurrence.recurrenceStartDate) ? recurrence.recurrenceStartDate : "";
  document.getElementById("editRecurrenceStartDateInput").value = toDateInputString(recStartDate);
  
  const isPriority = goal.isPriority || false;
  document.getElementById("editPriorityField").style.display = "block";
  document.getElementById("editIsPriorityInput").checked = isPriority;
  
  const startDateField = document.getElementById("editStartDateField");
  const startDateInput = document.getElementById("editStartDateInput");
  startDateField.style.display = "block";
  if (goal.startDate) {
    startDateInput.value = toDateInputString(goal.startDate);
  } else {
    startDateInput.value = "";
  }

  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";

  openModal('editModal');
}
// =======================================================
// ===== ÃšJ FUNKCIÃ“: ARCHIVÃLT CÃ‰L SZERKESZTÃ‰SE =====
// =======================================================
function editArchivedGoal(index) {
  const goal = archivedGoals[index]; // Az archivÃ¡lt tÃ¶mbbÅ‘l vesszÃ¼k

  editTarget = {
    type: 'archivedGoal', // Ãšj tÃ­pus, hogy a mentÃ©s tudja, mit kell tenni
    index: index
  };
  document.getElementById("editTitle").textContent = "ğŸ¯ ArchivÃ¡lt cÃ©l szerkesztÃ©se";

  // --- InnentÅ‘l a kÃ³d azonos az editGoal funkciÃ³val,
  // de a 'goal' vÃ¡ltozÃ³t hasznÃ¡lja 'goals[i]' helyett ---

  document.getElementById("editLabel1").textContent = "CÃ©l neve";
  document.getElementById("editInput1").value = goal.name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont Ã©rtÃ©k";
  document.getElementById("editInput2").value = goal.points;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";

  document.getElementById("editLabel3").textContent = "KategÃ³ria (opcionÃ¡lis)";
  document.getElementById("editInput3").value = goal.category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";

  const subGoalsText = (goal.subGoals || [])
    .map(sg => {
      const sgType = sg.type || 'task';
      if (sgType === 'header') {
        return `# ${sg.text}`;
      } else if (sgType === 'separator') {
        return '---';
      }
      return sg.text;
    })
    .join('\n');

  document.getElementById("editLabelSubGoals").style.display = "block";
  document.getElementById("editInputSubGoals").value = subGoalsText;
  document.getElementById("editInputSubGoals").style.display = "block";

  const isRecurring = goal.isRecurring || false;
  document.getElementById("editRecurringFields").style.display = "block";
  document.getElementById("editIsRecurringInput").checked = isRecurring;
  document.getElementById("editRecurrenceOptions").style.display = isRecurring ? "block" : "none";

  const recurrence = goal.recurrence;

  document.getElementById("editRecurrenceInterval").value = 1;
  document.getElementById("editRecurrenceFrequency").value = "daily";
  document.getElementById("editEndNever").checked = true;
  document.getElementById("editEndCountInput").value = 5;
  document.getElementById("editEndDateInput").value = "";

  if (recurrence) {
    if (typeof recurrence === 'object') {
      document.getElementById("editRecurrenceInterval").value = recurrence.interval || 1;
      document.getElementById("editRecurrenceFrequency").value = recurrence.frequency || "daily";
      const endCondition = recurrence.endCondition || 'never';
      document.getElementById(`editEnd${endCondition.charAt(0).toUpperCase() + endCondition.slice(1)}`).checked = true;
      if (endCondition === 'count') {
        document.getElementById("editEndCountInput").value = recurrence.endCount || 5;
      } else if (endCondition === 'date') {
        document.getElementById("editEndDateInput").value = recurrence.endDate || "";
      }
      
    } else if (typeof recurrence === 'string') {
      document.getElementById("editEndNever").checked = true;
      if (recurrence === 'daily') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      } else if (recurrence === 'weekly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "weekly";
      } else if (recurrence === 'monthly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "monthly";
      } else if (recurrence.endsWith('days')) {
        document.getElementById("editRecurrenceInterval").value = parseInt(recurrence) || 2;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      }
    }
  }
  
  const recStartDate = (recurrence && recurrence.recurrenceStartDate) ? recurrence.recurrenceStartDate : "";
  document.getElementById("editRecurrenceStartDateInput").value = toDateInputString(recStartDate);
  
  const isPriority = goal.isPriority || false;
  document.getElementById("editPriorityField").style.display = "block";
  document.getElementById("editIsPriorityInput").checked = isPriority;
  
  const startDateField = document.getElementById("editStartDateField");
  const startDateInput = document.getElementById("editStartDateInput");
  startDateField.style.display = "block";
  if (goal.startDate) {
    startDateInput.value = toDateInputString(goal.startDate);
  } else {
    startDateInput.value = "";
  }

  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";

  openModal('editModal');
}
// ===== ÃšJ FUNKCIÃ“: IsmÃ©tlÅ‘dÃ©s kikapcsolÃ¡sa az archÃ­vumban =====
async function toggleRecurrenceInArchive(index) {
  if (index < 0 || index >= archivedGoals.length) return;

  const goal = archivedGoals[index];

  if (!confirm(`Biztosan kikapcsolod az ismÃ©tlÅ‘dÃ©st ennÃ©l a cÃ©lnÃ©l: "${goal.name}"? EttÅ‘l kezdve nem fog automatikusan Ãºjra megjelenni.`)) {
    return;
  }

  // TÃ¶rÃ¶ljÃ¼k az ismÃ©tlÅ‘dÃ©shez kapcsolÃ³dÃ³ tulajdonsÃ¡gokat
  delete goal.isRecurring;
  delete goal.recurrence;
  delete goal.lastCompleted;

  // Ãšjrarajzoljuk az archÃ­vumot, hogy a gomb eltÅ±njÃ¶n
  renderArchivedGoals();
  await logActivity(`ğŸ”„ IsmÃ©tlÅ‘dÃ©s kikapcsolva: ${goal.name}`);
  // A logActivity mÃ¡r magÃ¡ban foglalja a saveDataToFirestore() hÃ­vÃ¡st
}
// =======================================================
// ===== ÃšJ SZÃ–VEGFORMÃZÃ“ SEGÃ‰DFÃœGGVÃ‰NYEK =====
// =======================================================

/**
 * SzÃ¶vegtÃ¶mbbÃ© alakÃ­tja a sima szÃ¶veget (# Ã©s --- alapjÃ¡n).
 * HasonlÃ³ a saveGoal-ban lÃ©vÅ‘hÃ¶z, de 'task' helyett 'paragraph'-t hasznÃ¡l.
 */
function parseTextToStructuredArray(text) {
    if (!text || text.trim() === "") return [];

    return text.split('\n')
        .map(text => text.trim())
        .filter(text => text.length > 0)
        .map(rawText => {
            if (rawText.startsWith('#')) {
                return { type: 'header', text: rawText.substring(1).trim() };
            } else if (rawText === '---') {
                return { type: 'separator', text: '---' };
            } else {
                return { type: 'paragraph', text: rawText }; // CÃ©loknÃ¡l 'task', itt 'paragraph'
            }
        });
}

/**
 * VisszaalakÃ­tja a szÃ¶vegtÃ¶mbÃ¶t sima szÃ¶veggÃ© a textarea-ba.
 * Kezeli a rÃ©gi, sima string adatokat is.
 */
function parseStructuredArrayToText(arrayOrString) {
    if (!arrayOrString) return "";
    // RÃ©gi adatok kezelÃ©se (ha mÃ©g sima string)
    if (typeof arrayOrString === 'string') return arrayOrString;

    // Ãšj, tÃ¶mb alapÃº adatok visszaalakÃ­tÃ¡sa
    return arrayOrString.map(item => {
        const type = item.type || 'paragraph'; // AlapÃ©rtelmezett
        if (type === 'header') {
            return `# ${item.text}`;
        } else if (type === 'separator') {
            return '---';
        }
        return item.text; // 'paragraph'
    }).join('\n');
}

/**
 * HTML-t generÃ¡l a szÃ¶vegtÃ¶mbbÅ‘l a 'noteViewModal' szÃ¡mÃ¡ra.
 * Kezeli a rÃ©gi, sima string adatokat is.
 */
function renderStructuredArrayToHTML(arrayOrString) {
    if (!arrayOrString || (Array.isArray(arrayOrString) && arrayOrString.length === 0)) {
         return "<p style='color: #777; font-style: italic;'>Nincs jegyzet...</p>";
    }
    
    // RÃ©gi adatok kezelÃ©se (ha mÃ©g sima string)
    if (typeof arrayOrString === 'string') {
        // Alap cserÃ©k: sortÃ¶rÃ©sek (<br>) Ã©s linkek (ha vannak)
        return arrayOrString
            .replace(/</g, "&lt;").replace(/>/g, "&gt;") // XSS vÃ©delem
            .replace(/\n/g, "<br>")
            .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    }

    // Ãšj, tÃ¶mb alapÃº adatok renderelÃ©se
    let html = "";
    arrayOrString.forEach(item => {
        const type = item.type || 'paragraph';
        const text = item.text.replace(/</g, "&lt;").replace(/>/g, "&gt;"); // XSS vÃ©delem

        switch (type) {
            case 'header':
                // ÃšjrahasznosÃ­tjuk a cÃ©lok alcÃ­m stÃ­lusÃ¡t
                html += `<h4 class="subgoal-header">${text}</h4>`;
                break;
            case 'separator':
                // ÃšjrahasznosÃ­tjuk a cÃ©lok elvÃ¡lasztÃ³ stÃ­lusÃ¡t
                html += `<hr class="subgoal-separator">`;
                break;
            case 'paragraph':
            default:
                 // Linkek felismerÃ©se a paragrafusokban
                const linkedText = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
                html += `<p style="margin-bottom: 8px;">${linkedText}</p>`;
                break;
        }
    });
    return html;
}
// =======================================================
// =======================================================


// =======================================================
// ===== JUTALMAK (REFACTORED) =====
// =======================================================
async function saveReward() { // Make async
  const name = document.getElementById("rewardNameInput").value.trim();
  const cost = parseInt(document.getElementById("rewardCostInput").value);
  if (!name || isNaN(cost) || cost < 0) return alert("Ã‰rvÃ©nytelen nÃ©v vagy pontszÃ¡m! (0 vagy nagyobb lehet)");

  rewards.push({
    name,
    cost
  });
  document.getElementById("rewardNameInput").value = "";
  document.getElementById("rewardCostInput").value = "";
  closeModal('rewardModal');
  renderRewards();
  await logActivity(`ğŸ Jutalom hozzÃ¡adva: ${name} (${cost} pont)`);
}

async function claimReward(i) { // Make async
  if (totalPoints >= rewards[i].cost) {
    if (confirm(`Biztosan kivÃ¡ltod ezt: "${rewards[i].name}" (${rewards[i].cost} pontÃ©rt)?`)) {
      totalPoints -= rewards[i].cost;
      animatePoints(totalPoints);
      renderRewards();
      addPointsLogEntry(-rewards[i].cost, `ğŸ‰ Jutalom kivÃ¡ltva: ${rewards[i].name}`);
      await logActivity(`ğŸ‰ Jutalom kivÃ¡ltva: ${rewards[i].name} (-${rewards[i].cost} pont)`);
    }
  } else {
    alert("Nincs elÃ©g pontod!");
  }
}

function editReward(i) {
  editTarget = {
    type: 'reward',
    index: i
  };
  document.getElementById("editTitle").textContent = "ğŸ Jutalom szerkesztÃ©se";

  document.getElementById("editLabel1").textContent = "Jutalom neve";
  document.getElementById("editInput1").value = rewards[i].name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont Ã¡ra";
  document.getElementById("editInput2").value = rewards[i].cost;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";

  document.getElementById("editLabel3").style.display = "none";
  document.getElementById("editInput3").style.display = "none";
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  document.getElementById("editPriorityField").style.display = "none";

  openModal('editModal');
}

async function deleteReward(i) { // Make async
  const deletedName = rewards[i].name;
  rewards.splice(i, 1);
  renderRewards();
  await logActivity(`ğŸ—‘ï¸ Jutalom tÃ¶rÃ¶lve: ${deletedName}`);
}

function renderRewards() {
  const list = document.getElementById("rewardList");
  list.innerHTML = "";
  rewards.forEach((r, i) => {
    const div = document.createElement("div");
    div.className = "reward-item";

    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${r.name}</div>
      </div>
      <div class="item-points">
        ${r.cost} pont
      </div>
      <div class="item-actions">
        <button onclick="editReward(${i})">âœï¸</button>
        <button onclick="deleteReward(${i})">ğŸ—‘ï¸</button>
        <button onclick="claimReward(${i})">ğŸ‰</button>
      </div>
    `;
    list.appendChild(div);
  });
}

// =======================================================
// ===== ÃšJ Ã‰TKEZÃ‰S FUNKCIÃ“K =====
// =======================================================

// A modal cÃ­mkÃ©inek frissÃ­tÃ©se a tÃ­pusvÃ¡lasztÃ³ alapjÃ¡n
function updateMealModalLabels() {
  const type = document.getElementById("mealTypeSelect").value;
  const kcalLabel = document.getElementById("mealKcalLabel");
  const proteinLabel = document.getElementById("mealProteinLabel");
  const fatLabel = document.getElementById("mealFatLabel");

  if (type === 'unit') {
    kcalLabel.textContent = "KalÃ³ria (kcal/darab)";
    proteinLabel.textContent = "FehÃ©rje (g/darab)";
	fatLabel.textContent = "ZsÃ­r (g/darab)";
  } else { // weight
    kcalLabel.textContent = "KalÃ³ria (kcal/100g)";
    proteinLabel.textContent = "FehÃ©rje (g/100g)";
	fatLabel.textContent = "ZsÃ­r (g/100g)";
  }
}

// Ãšj Ã©tel mentÃ©se
async function saveMeal() {
  const name = document.getElementById("mealNameInput").value.trim();
  const category = document.getElementById("mealCategoryInput").value.trim();
  const type = document.getElementById("mealTypeSelect").value;
  const kcal = parseFloat(document.getElementById("mealKcalInput").value);
  const protein = parseFloat(document.getElementById("mealProteinInput").value);
  const fat = parseFloat(document.getElementById("mealFatInput").value);
  // MÃ“DOSÃTÃS: A szÃ¶veget egyenesen a formÃ¡zÃ³ funkciÃ³ba kÃ¼ldjÃ¼k
  const noteArray = parseTextToStructuredArray(document.getElementById("mealNoteInput").value);

  if (!name) return alert("Az Ã©telnek nevet kell adni!");
  if (isNaN(kcal) || kcal < 0) return alert("Ã‰rvÃ©nytelen kalÃ³ria Ã©rtÃ©k!");
  if (isNaN(protein) || protein < 0) return alert("Ã‰rvÃ©nytelen fehÃ©rje Ã©rtÃ©k!");
  if (isNaN(fat) || fat < 0) return alert("Ã‰rvÃ©nytelen zsÃ­r Ã©rtÃ©k!");

  const meal = {
    name,
    category: category || null,
    type,
    kcal,
    protein,
	fat,
    note: noteArray // MÃ“DOSÃTÃS: A tÃ¶mbÃ¶t mentjÃ¼k
  };

  meals.push(meal);

  document.getElementById("mealNameInput").value = "";
  document.getElementById("mealCategoryInput").value = "";
  document.getElementById("mealTypeSelect").value = "unit";
  document.getElementById("mealKcalInput").value = "";
  document.getElementById("mealProteinInput").value = "";
  document.getElementById("mealFatInput").value = "";
  document.getElementById("mealFatInput").value = "";
  document.getElementById("mealNoteInput").value = ""; // <-- ÃšJ SOR

  closeModal('mealModal');
  renderMeals();
  await logActivity(`ğŸ½ï¸ Ãšj Ã©tel mentve: ${name}`);
}
// Ã‰telek listÃ¡jÃ¡nak kirajzolÃ¡sa
function renderMeals() {
  const list = document.getElementById("mealList");
  if (!list) return;
  list.innerHTML = "";

  // ===== KERESÃ‰SI LOGIKA =====
  const searchInput = document.getElementById("mealSearchInput");
  let searchTerm = "";
  if (searchInput) {
    searchTerm = searchInput.value.toLowerCase().trim();
  }

  // 1. LÃ‰PÃ‰S: SzÅ±rÃ©s Ã©s az eredeti index hozzÃ¡adÃ¡sa
  const mealsToRender = meals
    .map((meal, index) => ({ ...meal,
      originalIndex: index
    })) // HozzÃ¡adjuk az eredeti indexet
    .filter(mealWithIndex =>
      mealWithIndex.name.toLowerCase().includes(searchTerm)
    );
  // ===== KERESÃ‰SI LOGIKA VÃ‰GE =====

  // 2. LÃ‰PÃ‰S: Ãœres lista ellenÅ‘rzÃ©se a SZÅ°RT tÃ¶mb alapjÃ¡n
  if (mealsToRender.length === 0) {
    if (meals.length === 0) {
      // Ha az eredeti lista is Ã¼res
      list.innerHTML = "<p style='text-align:center; padding: 10px;'>MÃ©g nincsenek mentett Ã©teleid. Adj hozzÃ¡ egyet!</p>";
    } else {
      // Ha van Ã©tel, de a keresÃ©s nem talÃ¡lt semmit
      list.innerHTML = "<p style='text-align:center; padding: 10px;'>Nincs a keresÃ©snek megfelelÅ‘ talÃ¡lat.</p>";
    }
    return;
  }

  // ===== KATEGORIZÃLÃS KEZDETE =====
  const categorized = {};
  const uncategorized = [];

  // 3. LÃ‰PÃ‰S: IterÃ¡lÃ¡s a SZÅ°RT tÃ¶mbÃ¶n ('mealsToRender')
  mealsToRender.forEach((item) => { // 'item' mÃ¡r tartalmazza az originalIndex-et
    if (item.category) {
      if (!categorized[item.category]) {
        categorized[item.category] = [];
      }
      categorized[item.category].push(item);
    } else {
      uncategorized.push(item);
    }
  });
  // ===== KATEGORIZÃLÃS VÃ‰GE =====
  // --- SegÃ©dfÃ¼ggvÃ©ny egy Ã©tel kirajzolÃ¡sÃ¡hoz ---
  const renderItem = (meal, i) => {
    const div = document.createElement("div");
    div.className = "food-item";

    const maxCal = 1000;
    const maxProt = 100;

    let calPercent = (meal.kcal / maxCal) * 100;
    let protPercent = (meal.protein / maxProt) * 100;

    if (calPercent > 100) calPercent = 100;
    if (protPercent > 100) protPercent = 100;
    if (calPercent < 0) calPercent = 0;
    if (protPercent < 0) protPercent = 0;

    let detailsText = "";
    if (meal.type === 'unit') {
      detailsText = `<span>${meal.kcal} kcal/db</span><span>${meal.protein}g prot./db</span>`;
    } else {
      detailsText = `<span>${meal.kcal} kcal/100g</span><span>${meal.protein}g prot./100g</span>`;
    }

    const progressHTML = `
    <div class="meal-progress-container">
        <div class="meal-progress-wrapper">
            <span class="meal-progress-label">KalÃ³ria:</span>
            <div class="meal-progress-bar-bg">
                <div class="meal-progress-bar-fill" style="width: ${calPercent}%;"></div>
            </div>
        </div>
        <div class="meal-progress-wrapper">
            <span class="meal-progress-label">Protein:</span>
            <div class="meal-progress-bar-bg">
                <div class="meal-progress-bar-fill protein" style="width: ${protPercent}%;"></div>
            </div>
        </div>
    </div>
    `;

    // === VÃ‰GLEGES JAVÃTÃS KEZDETE ===
    // 1. JAVÃTÃS: Helyesen ellenÅ‘rizzÃ¼k, hogy a 'meal.note' tÃ¶mb nem Ã¼res-e
    const hasNote = (Array.isArray(meal.note) && meal.note.length > 0) || 
                (typeof meal.note === 'string' && meal.note.trim() !== "");
    // 2. JAVÃTÃS: Az ikont szÃ³kÃ¶z nÃ©lkÃ¼l definiÃ¡ljuk
    const noteIcon = hasNote ? 'ğŸ—’ï¸' : '';
    const noteTitle = hasNote ? 'Kattints a jegyzet megtekintÃ©sÃ©hez' : '';
    const noteOnClick = hasNote ? `onclick="openMealNoteModal(${i})"` : '';
    const noteStyle = hasNote ? 'cursor: pointer; text-decoration: underline; text-decoration-style: dotted;' : '';
    // === JAVÃTÃS VÃ‰GE ===

    div.innerHTML = `
    <div class="food-item-row1">
        <div class="item-name">
            <div class="item-name-main" ${noteOnClick} style="${noteStyle}" title="${noteTitle}">${meal.name}${hasNote ? ' ' : ''}${noteIcon}</div>
        </div>
        <div class="item-details">
            ${detailsText}
        </div>
        <div class="item-actions">
            <button onclick="editMeal(${i})" title="SzerkesztÃ©s">âœï¸</button>
            <button onclick="deleteMeal(${i})" title="TÃ¶rlÃ©s">ğŸ—‘ï¸</button>
            <button onclick="openConsumeModal(${i})" title="FogyasztÃ¡s">ğŸ½ï¸</button>
        </div>
    </div>
    ${progressHTML}
    `;
    list.appendChild(div);
  };
  // --- SegÃ©dfÃ¼ggvÃ©ny vÃ©ge ---

  // ===== KATEGÃ“RIÃK KIRAJZOLÃSA =====
  const categoryNames = Object.keys(categorized).sort();
  categoryNames.forEach(categoryName => {
    const title = document.createElement("h3");
    title.className = "category-title";
    title.textContent = categoryName;
    list.appendChild(title);

    categorized[categoryName].forEach(item => {
      renderItem(item, item.originalIndex); // 4. LÃ‰PÃ‰S: Az eredeti indexet adjuk Ã¡t
    });
  });

  // ===== KATEGÃ“RIA NÃ‰LKÃœLIEK KIRAJZOLÃSA =====
  if (uncategorized.length > 0) {
    if (categoryNames.length > 0) {
      const title = document.createElement("h3");
      title.className = "category-title";
      title.textContent = "EgyÃ©b";
      list.appendChild(title);
    }
    uncategorized.forEach(item => {
      renderItem(item, item.originalIndex); // 4. LÃ‰PÃ‰S: Az eredeti indexet adjuk Ã¡t
    });
  }
}
// Ã‰tel szerkesztÃ©se (megnyitja a szerkesztÅ‘ modalt)
function editMeal(i) {
  editTarget = {
    type: 'meal',
    index: i
  };
  const meal = meals[i];

  document.getElementById("editTitle").textContent = "ğŸ½ï¸ Ã‰tel szerkesztÃ©se";

  // Alap mezÅ‘k (Ã¡tnevezve)
  document.getElementById("editLabel1").textContent = "Ã‰tel neve";
  document.getElementById("editInput1").value = meal.name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  // ElrejtjÃ¼k a felesleges 'points' mezÅ‘t
  document.getElementById("editLabel2").style.display = "none";
  document.getElementById("editInput2").style.display = "none";

  // HasznÃ¡ljuk a 'v3' mezÅ‘t a kategÃ³riÃ¡nak
  document.getElementById("editLabel3").textContent = "KategÃ³ria";
  document.getElementById("editInput3").value = meal.category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";

  // ElrejtjÃ¼k a tÃ¶bbit (kivÃ©ve a jegyzetet)
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  document.getElementById("editRecurringFields").style.display = "none";

  // ===== MÃ“DOSÃTÃS ITT =====
  // MegjelenÃ­tjÃ¼k a Jegyzet mezÅ‘t (ezt hasznÃ¡lja a notes Ã©s workout is)
  document.getElementById("editLabelText").textContent = "Jegyzet (opcionÃ¡lis)";
  document.getElementById("editLabelText").style.display = "block";
  document.getElementById("editInputText").value = parseStructuredArrayToText(meal.note);
  document.getElementById("editInputText").style.display = "block";
  // ===== MÃ“DOSÃTÃS VÃ‰GE =====

  // MegjelenÃ­tjÃ¼k az Ã©tel-specifikus mezÅ‘ket
  document.getElementById("editMealFields").style.display = "block";
  document.getElementById("editMealType").value = meal.type;
  document.getElementById("editMealKcal").value = meal.kcal;
  document.getElementById("editMealProtein").value = meal.protein;
  document.getElementById("editMealFat").value = meal.fat || 0;
  document.getElementById("editPriorityField").style.display = "none";

  openModal('editModal');
}

// Ã‰tel tÃ¶rlÃ©se
async function deleteMeal(i) {
  if (confirm(`Biztosan tÃ¶rlÃ¶d ezt az Ã©telt: "${meals[i].name}"?`)) {
    const deletedName = meals[i].name;
    meals.splice(i, 1);
    renderMeals();
    await logActivity(`ğŸ—‘ï¸ Ã‰tel tÃ¶rÃ¶lve: ${deletedName}`);
  }
}

// FogyasztÃ¡s ablak megnyitÃ¡sa
function openConsumeModal(i) {
  editTarget = {
    type: 'consume',
    index: i
  };
  const meal = meals[i];

  document.getElementById("consumeMealTitle").textContent = meal.name;

  const amountLabel = document.getElementById("consumeAmountLabel");
  const amountInput = document.getElementById("consumeAmountInput");

  if (meal.type === 'unit') {
    amountLabel.textContent = "MennyisÃ©g (Darab)";
    amountInput.placeholder = "pl. 2";
    document.getElementById("consumeMealDetails").textContent = `${meal.kcal} kcal, ${meal.protein}g protein / darab`;
  } else {
    amountLabel.textContent = "MennyisÃ©g (Gramm)";
    amountInput.placeholder = "pl. 150";
    document.getElementById("consumeMealDetails").textContent = `${meal.kcal} kcal, ${meal.protein}g protein / 100g`;
  }

  amountInput.value = "";
  openModal('consumeModal');
}

// FogyasztÃ¡s megerÅ‘sÃ­tÃ©se
async function confirmConsume() {
  const amount = parseFloat(document.getElementById("consumeAmountInput").value);
  if (!amount || amount <= 0) return alert("Ã‰rvÃ©nytelen mennyisÃ©g!");

  const meal = meals[editTarget.index];

  let totalKcal = 0;
  let totalProtein = 0;
  let totalFat = 0;
  let unitLabel = "";

  if (meal.type === 'unit') {
    totalKcal = meal.kcal * amount;
    totalProtein = meal.protein * amount;
	totalFat = (meal.fat || 0) * amount;
    unitLabel = "db";
  } else { // weight
    totalKcal = (meal.kcal / 100) * amount;
    totalProtein = (meal.protein / 100) * amount;
	totalFat = ((meal.fat || 0) / 100) * amount;
    unitLabel = "g";
  }

  // Ãšj tranzakciÃ³ lÃ©trehozÃ¡sa
  const transaction = {
    id: Date.now(),
    type: 'meal',
    name: meal.name,
    amount: amount,
    unit: unitLabel,
    totalKcal: totalKcal,
    totalProtein: totalProtein,
	totalFat: totalFat,
    date: new Date()
  };
  transactions.push(transaction);

  // Azonnali frissÃ­tÃ©s
  dailyProgress.calories += totalKcal;
  dailyProgress.protein += totalProtein;
  dailyProgress.fat += totalFat;

  updateAllSummaries();
  updateHistory();
  await logActivity(`ğŸ½ï¸ Fogyasztva: ${amount} ${unitLabel} ${meal.name} (+${totalKcal.toFixed(0)} kcal, +${totalProtein.toFixed(0)}g prot., +${totalFat.toFixed(0)}g zsÃ­r)`);

  closeModal('consumeModal');
}
// =======================================================
// ===== KIBÅVÃTETT SZERKESZTÃ‰S FUNKCIÃ“ (REFACTORED) =====
// =======================================================
async function confirmEdit() { // Make async
  const v1 = document.getElementById("editInput1").value; // CÃ­m / NÃ©v

  if (!editTarget) return;

  if (editTarget.type === 'goal') {
    const v2 = parseInt(document.getElementById("editInput2").value); // Pont
    const v3 = document.getElementById("editInput3").value.trim(); // KategÃ³ria

    if (!v1) return alert("A cÃ©lnak nevet kell adni!");
    if (isNaN(v2) || v2 < 0) return alert("Ã‰rvÃ©nytelen pontszÃ¡m! Adj meg 0-t vagy nagyobbat.");

    if (goals[editTarget.index].done) {
      let diff = v2 - goals[editTarget.index].points;
      if (diff !== 0) {
        totalPoints += diff;
        addPointsLogEntry(diff, `âœï¸ PontÃ©rtÃ©k mÃ³dosÃ­tva: ${goals[editTarget.index].name}`);
        animatePoints(totalPoints);
      }
    }
    goals[editTarget.index].name = v1;
    goals[editTarget.index].points = v2;
    goals[editTarget.index].category = v3;
	goals[editTarget.index].startDate = document.getElementById("editStartDateInput").value || null; // EZ AZ ÃšJ SOR

    // ===== MÃ“DOSÃTOTT ALCÃ‰L FELDOLGOZÃS KEZDETE (JAVÃTOTT LOGIKÃVAL) =====
    const newSubGoalsText = document.getElementById("editInputSubGoals").value;

    // LÃ©trehozunk egy MÃSOLATOT a rÃ©gi alcÃ©lokbÃ³l, amibÅ‘l "elfogyaszthatjuk" az elemeket
    const availableOldSubGoals = [...(goals[editTarget.index].subGoals || [])];
    let newSubGoals = [];

    if (newSubGoalsText.trim() !== "") {
      newSubGoals = newSubGoalsText.split('\n')
        .map(text => text.trim())
        .filter(text => text.length > 0)
        .map(rawText => {
          // 1. ElÅ‘szÃ¶r meghatÃ¡rozzuk az ÃšJ elem tÃ­pusÃ¡t Ã©s tiszta szÃ¶vegÃ©t
          let newItem;
          if (rawText.startsWith('#')) {
            newItem = {
              type: 'header',
              text: rawText.substring(1).trim()
            };
          } else if (rawText === '---') {
            newItem = {
              type: 'separator',
              text: '---'
            };
          } else {
            newItem = {
              type: 'task',
              text: rawText,
              done: false
            };
          }

          // 2. MegkeressÃ¼k az ELSÅ elÃ©rhetÅ‘, AZONOS TÃPUSÃš Ã‰S SZÃ–VEGÅ° rÃ©gi alcÃ©lt
          const existingIndex = availableOldSubGoals.findIndex(
            sg => (sg.type || 'task') === (newItem.type || 'task') && sg.text === newItem.text
          );

          if (existingIndex > -1) {
            // Ha talÃ¡ltunk...
            // 1. KivesszÃ¼k az "elfogyasztott" elemet a mÃ¡solat tÃ¶mbbÅ‘l
            const existing = availableOldSubGoals.splice(existingIndex, 1)[0];
            // 2. Visszaadjuk a rÃ©gi, "done" Ã¡llapotot is tartalmazÃ³ objektumot
            return existing;
          } else {
            // Ha nem talÃ¡ltunk, ez egy Ãºj alcÃ©l
            return newItem;
          }
        });
    }
    // ===== MÃ“DOSÃTOTT ALCÃ‰L FELDOLGOZÃS VÃ‰GE =====

    goals[editTarget.index].subGoals = newSubGoals;
    
	// ÃšJ: PrioritÃ¡s frissÃ­tÃ©se (EZ A HELYES HELY)
    const isPriority = document.getElementById("editIsPriorityInput").checked;
    goals[editTarget.index].isPriority = isPriority;
    
    // ===== ÃšJ, BÅVÃTETT ISMÃ‰TLÅDÃ‰S MENTÃ‰SE =====
    const isRecurring = document.getElementById("editIsRecurringInput").checked;
    if (isRecurring) {
      goals[editTarget.index].isRecurring = true;
      
      // 1. Beolvassuk az intervallumot Ã©s a frekvenciÃ¡t
      const frequency = document.getElementById("editRecurrenceFrequency").value;
      const interval = parseInt(document.getElementById("editRecurrenceInterval").value) || 1;
      
      // 2. Beolvassuk a befejezÃ©si feltÃ©telt
      const endCondition = document.querySelector('input[name="editEndCondition"]:checked').value;
      const endCount = parseInt(document.getElementById("editEndCountInput").value) || 5;
      const endDate = document.getElementById("editEndDateInput").value || null;
      const recurrenceStartDate = document.getElementById("editRecurrenceStartDateInput").value || null; // <-- ÃšJ SOR

      // 3. Ã–sszeÃ¡llÃ­tjuk az Ãºj recurrence objektumot
      // Megtartjuk a 'currentCount'-ot, ha mÃ¡r lÃ©tezett, kÃ¼lÃ¶nben 0-rÃ³l indul
      const currentCount = (goals[editTarget.index].recurrence && typeof goals[editTarget.index].recurrence === 'object') 
        ? (goals[editTarget.index].recurrence.currentCount || 0) 
        : 0;
      
      goals[editTarget.index].recurrence = {
        frequency: frequency,
        interval: interval,
      	recurrenceStartDate: recurrenceStartDate, // <-- ÃšJ SOR
        endCondition: endCondition,
        endDate: (endCondition === 'date' && endDate) ? endDate : null,
        endCount: (endCondition === 'count') ? endCount : null,
        currentCount: currentCount
      };
      
      // lastCompleted-et nem bÃ¡ntjuk, az a teljesÃ­tÃ©skor frissÃ¼l
      
    } else {
      // Ha a felhasznÃ¡lÃ³ KIKAPCSOLTA az ismÃ©tlÅ‘dÃ©st
      delete goals[editTarget.index].isRecurring;
      delete goals[editTarget.index].recurrence;
      delete goals[editTarget.index].lastCompleted;
    }
    // ===== ISMÃ‰TLÅDÃ‰S MENTÃ‰SÃ‰NEK VÃ‰GE =====

    // ÃšJ: Ãllapot ÃºjraszÃ¡molÃ¡sa szerkesztÃ©s utÃ¡n
    const goal = goals[editTarget.index];
    const wasMainGoalDone = goal.done;

    // MÃ“DOSÃTVA: Csak a 'task' tÃ­pusÃº alcÃ©lokat szÃ¡moljuk
    const taskSubGoals = newSubGoals.filter(sg => (sg.type || 'task') === 'task');
    const allDone = taskSubGoals.length > 0 && taskSubGoals.every(sg => sg.done);

    if (allDone && !wasMainGoalDone) {
      goal.done = true;
      if (goal.isRecurring) goal.lastCompleted = new Date().toISOString();
      totalPoints += goal.points;
      animatePoints(totalPoints);
    } else if (!allDone && wasMainGoalDone) {
      goal.done = false;
      if (goal.isRecurring) goal.lastCompleted = null;
      totalPoints -= goal.points;
      animatePoints(totalPoints);
    }
	// ILLESZD BE EZT A BLOKKOT a confirmEdit 'goal' Ã¡gÃ¡ba, a renderGoals() hÃ­vÃ¡s elÃ©:

    // EllenÅ‘rzÃ©s: Ãt kell-e helyezni a cÃ©lt az archÃ­vumba idÅ‘zÃ­tÃ©s miatt?
    const editedGoal = goals[editTarget.index];
    const todayISO = toDateInputString(new Date().toISOString());

    // ===== MÃ“DOSÃTOTT ARCHIVÃLÃSI LOGIKA =====
    const isPendingOnStartDate = editedGoal.startDate && editedGoal.startDate > todayISO;
    const isPendingOnRecurrenceDate = editedGoal.isRecurring && editedGoal.recurrence.recurrenceStartDate && editedGoal.recurrence.recurrenceStartDate > todayISO;

    if (editedGoal && (isPendingOnStartDate || isPendingOnRecurrenceDate)) {
      console.log(`CÃ©l Ã¡thelyezÃ©se az archÃ­vumba (idÅ‘zÃ­tÃ©s): ${editedGoal.name}`);
      const goalToArchive = goals.splice(editTarget.index, 1)[0];
      archivedGoals.unshift(goalToArchive);
      
      // Mivel Ã¡thelyeztÃ¼k, az archÃ­vum nÃ©zetet is frissÃ­teni kell, ha nyitva van
      if (document.getElementById('archiveModal').style.display === 'flex') {
        renderArchivedGoals();
      }
    }

    renderGoals();
    await logActivity(`âœï¸ CÃ©l szerkesztve: ${v1}`);
  } else if (editTarget.type === 'reward') {	
    const v2 = parseInt(document.getElementById("editInput2").value); // Ãr
	renderGoals();
    await logActivity(`âœï¸ CÃ©l szerkesztve: ${v1}`);

  // === EZT ILLESZD BE IDE: ===
  } else if (editTarget.type === 'archivedGoal') {
    const v2 = parseInt(document.getElementById("editInput2").value); // Pont
    const v3 = document.getElementById("editInput3").value.trim(); // KategÃ³ria

    if (!v1) return alert("A cÃ©lnak nevet kell adni!");
    if (isNaN(v2) || v2 < 0) return alert("Ã‰rvÃ©nytelen pontszÃ¡m!");

    const goalToEdit = archivedGoals[editTarget.index];

    if (goalToEdit.done) {
      let diff = v2 - goalToEdit.points;
      if (diff !== 0) {
        totalPoints += diff;
        addPointsLogEntry(diff, `âœï¸ (ArchÃ­v) PontÃ©rtÃ©k mÃ³dosÃ­tva: ${goalToEdit.name}`);
        animatePoints(totalPoints);
      }
    }
    goalToEdit.name = v1;
    goalToEdit.points = v2;
    goalToEdit.category = v3;
    goalToEdit.startDate = document.getElementById("editStartDateInput").value || null;
    goalToEdit.isPriority = document.getElementById("editIsPriorityInput").checked;

    // AlcÃ©lok mentÃ©se
    const newSubGoalsText = document.getElementById("editInputSubGoals").value;
    const availableOldSubGoals = [...(goalToEdit.subGoals || [])];
    let newSubGoals = [];
    if (newSubGoalsText.trim() !== "") {
      newSubGoals = newSubGoalsText.split('\n').map(text => text.trim()).filter(t => t.length > 0).map(rawText => {
         let newItem;
         if (rawText.startsWith('#')) newItem = { type: 'header', text: rawText.substring(1).trim() };
         else if (rawText === '---') newItem = { type: 'separator', text: '---' };
         else newItem = { type: 'task', text: rawText, done: false };
         
         const existingIndex = availableOldSubGoals.findIndex(sg => (sg.type || 'task') === (newItem.type || 'task') && sg.text === newItem.text);
         if (existingIndex > -1) return availableOldSubGoals.splice(existingIndex, 1)[0];
         else return newItem;
      });
    }
    goalToEdit.subGoals = newSubGoals;

    // IsmÃ©tlÅ‘dÃ©s mentÃ©se
    const isRecurring = document.getElementById("editIsRecurringInput").checked;
    if (isRecurring) {
      goalToEdit.isRecurring = true;
      const frequency = document.getElementById("editRecurrenceFrequency").value;
      const interval = parseInt(document.getElementById("editRecurrenceInterval").value) || 1;
      const endCondition = document.querySelector('input[name="editEndCondition"]:checked').value;
      const endCount = parseInt(document.getElementById("editEndCountInput").value) || 5;
      const endDate = document.getElementById("editEndDateInput").value || null;
      const recurrenceStartDate = document.getElementById("editRecurrenceStartDateInput").value || null;
      
      const currentCount = (goalToEdit.recurrence && typeof goalToEdit.recurrence === 'object') ? (goalToEdit.recurrence.currentCount || 0) : 0;
      
      goalToEdit.recurrence = {
        frequency, interval, recurrenceStartDate, endCondition,
        endDate: (endCondition === 'date' && endDate) ? endDate : null,
        endCount: (endCondition === 'count') ? endCount : null,
        currentCount
      };
    } else {
      delete goalToEdit.isRecurring;
      delete goalToEdit.recurrence;
      delete goalToEdit.lastCompleted;
    }

    renderArchivedGoals();
    await logActivity(`âœï¸ ArchivÃ¡lt cÃ©l szerkesztve: ${v1}`);
  } else if (editTarget.type === 'reward') {
    const v2 = parseInt(document.getElementById("editInput2").value); // Ãr
    if (!v1) return alert("A jutalomnak nevet kell adni!");
    if (isNaN(v2) || v2 < 0) return alert("Ã‰rvÃ©nytelen pont Ã¡r! A 0 vagy nagyobb Ã©rtÃ©k megengedett.");

    rewards[editTarget.index].name = v1;
    rewards[editTarget.index].cost = v2;
    renderRewards();
    await logActivity(`âœï¸ Jutalom szerkesztve: ${v1}`);
  } else if (editTarget.type === 'note') {
    const v3 = document.getElementById("editInput3").value.trim(); // KategÃ³ria olvasÃ¡sa
    // MÃ“DOSÃTÃS: A szÃ¶veget egyenesen a formÃ¡zÃ³ funkciÃ³ba kÃ¼ldjÃ¼k
    const vTextArray = parseTextToStructuredArray(document.getElementById("editInputText").value);
    if (!v1) return alert("A cÃ­m nem lehet Ã¼res!");
    if (vTextArray.length === 0) return alert("A szÃ¶veg nem lehet Ã¼res!");

    notes[editTarget.index].title = v1;
    notes[editTarget.index].category = v3 || null; // KategÃ³ria mentÃ©se
    notes[editTarget.index].text = vTextArray; // MÃ“DOSÃTÃS: A tÃ¶mbÃ¶t mentjÃ¼k
    notes[editTarget.index].date = new Date(); // DÃ¡tum frissÃ­tÃ©se
    renderNotes(); // ÃšjrarajzolÃ¡s (hogy a kategÃ³ria frissÃ¼ljÃ¶n)
    await logActivity(`âœï¸ Jegyzet szerkesztve: ${v1}`);
  } else if (editTarget.type === 'workout') {
    const vTextArray = parseTextToStructuredArray(document.getElementById("editInputText").value);
    workouts[editTarget.index].note = vTextArray; // MÃ“DOSÃTÃS: A tÃ¶mbÃ¶t mentjÃ¼k
    await logActivity(`âœï¸ EdzÃ©sjegyzet mentve: ${workouts[editTarget.index].date}`);
  }
// ÃšJ: Ã‰TEL SZERKESZTÃ‰SÃ‰NEK MENTÃ‰SE
  else if (editTarget.type === 'meal') {
    const name = v1;
    const category = document.getElementById("editInput3").value.trim();
    const type = document.getElementById("editMealType").value;
    const kcal = parseFloat(document.getElementById("editMealKcal").value);
    const protein = parseFloat(document.getElementById("editMealProtein").value);
	const fat = parseFloat(document.getElementById("editMealFat").value);
    // MÃ“DOSÃTÃS: A szÃ¶veget egyenesen a formÃ¡zÃ³ funkciÃ³ba kÃ¼ldjÃ¼k
    const noteArray = parseTextToStructuredArray(document.getElementById("editInputText").value);

    if (!name) return alert("Az Ã©telnek nevet kell adni!");
    if (isNaN(kcal) || kcal < 0) return alert("Ã‰rvÃ©nytelen kalÃ³ria Ã©rtÃ©k!");
    if (isNaN(protein) || protein < 0) return alert("Ã‰rvÃ©nytelen fehÃ©rje Ã©rtÃ©k!");
	if (isNaN(fat) || fat < 0) return alert("Ã‰rvÃ©nytelen zsÃ­r Ã©rtÃ©k!");

    meals[editTarget.index] = {
      name,
      category: category || null,
      type,
      kcal,
      protein,
	  fat,
      note: noteArray // MÃ“DOSÃTÃS: A tÃ¶mbÃ¶t mentjÃ¼k
    };
    renderMeals();
    await logActivity(`âœï¸ Ã‰tel szerkesztve: ${name}`);
  }
  else if (editTarget.type === 'reminder') {
    const text = document.getElementById("editInput1").value.trim();
    const time = document.getElementById("editInput2").value; // 'datetime-local' string
    const highlight = document.getElementById("editIsRecurringInput").checked;
    const highlightDate = document.getElementById("editInput3").value; // 'date' string

    if (!text || !time) {
      return alert("A szÃ¶veg Ã©s az idÅ‘pont nem lehet Ã¼res!");
    }

    const reminderTime = new Date(time);

    if (highlight && !highlightDate) {
      return alert("Ha kiemelÃ©st kÃ©rsz, meg kell adnod a kiemelÃ©s kezdÅ‘ dÃ¡tumÃ¡t!");
    }

    if (highlight && new Date(highlightDate) > reminderTime) {
      return alert("A kiemelÃ©s kezdete nem lehet kÃ©sÅ‘bb, mint az emlÃ©keztetÅ‘ idÅ‘pontja!");
    }

    // Objektum frissÃ­tÃ©se a tÃ¶mbben
    const reminder = reminders[editTarget.index];
    reminder.text = text;
    reminder.time = reminderTime.toISOString();
    reminder.highlight = highlight;
    reminder.highlightDate = highlight ? new Date(highlightDate).toISOString() : null;
    
    // VisszaÃ¡llÃ­tjuk 'triggered' Ã¡llapotra, hogy Ãºjra elsÃ¼lhessen
    reminder.triggered = false; 

    renderAll(); // Ãšjrarajzol mindent (emlÃ©keztetÅ‘ lista, fÅ‘oldali kiemelÃ©s)
    await logActivity(`âœï¸ EmlÃ©keztetÅ‘ szerkesztve: ${text}`);
   }
  closeModal('editModal');
  // VisszaÃ¡llÃ­tjuk az editModal mezÅ‘it alaphelyzetbe
  document.getElementById("editLabel1").style.display = "block";
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  document.getElementById("editRecurringFields").style.display = "none";
  document.getElementById("editRecurringFields").style.display = "none";
  document.getElementById("editPriorityField").style.display = "none"; // <-- EZT A SORT ADJ HOZZÃ
}

// ===== NAPLÃ“ (REFACTORED) =====
async function logActivity(text) { // Make async
  const time = new Date();
  const entry = {
    time,
    text
  };

  if (!Array.isArray(logs)) {
    console.error("Logs is not an array, resetting.");
    logs = [];
  }

  logs.unshift(entry);
  if (logs.length > 100) logs.pop();
  renderLogs();

  await saveDataToFirestore();
}

function renderLogs() {
  const logDiv = document.getElementById("activityLog");
  logDiv.innerHTML = "";
  logs.forEach((l, i) => {
    let displayTime = "...";
    if (l.time) {
      if (typeof l.time.toDate === 'function') {
        displayTime = l.time.toDate().toLocaleString();
      } else {
        displayTime = new Date(l.time).toLocaleString();
      }
    }

    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `
      <span>${l.text}</span>
      <small>${displayTime}</small>
      <button style="background:none;color:#c00" onclick="deleteLog(${i})">ğŸ—‘ï¸</button>
    `;
    logDiv.appendChild(div);
  });
}

async function deleteLog(i) { // Make async
  logs.splice(i, 1);
  renderLogs();
  await saveDataToFirestore();
}

async function clearAllLogs() { // Make async
  if (confirm("Biztos tÃ¶rlÃ¶d az Ã¶sszes naplÃ³bejegyzÃ©st?")) {
    logs = [];
    renderLogs();
    await saveDataToFirestore();
  }
}

// =======================================================
// ===== ÃšJ PONT TÃ–RTÃ‰NET FUNKCIÃ“K =====
// =======================================================

/**
 * LÃ©trehoz egy bejegyzÃ©st a pontnaplÃ³ban.
 * Ezt a fÃ¼ggvÃ©nyt NEM kell await-elni, Ã©s NEM ment magÃ¡tÃ³l.
 */
function addPointsLogEntry(amount, reason) {
  if (amount === 0) return; // 0 pontos vÃ¡ltozÃ¡st nem naplÃ³zunk

  const entry = {
    id: Date.now() + Math.random(), // Egyedi ID a tÃ¶rlÃ©shez
    time: new Date(),
    amount: amount,
    reason: reason
  };
  pointsLog.unshift(entry);
  if (pointsLog.length > 100) pointsLog.pop(); // LimitÃ¡ljuk a naplÃ³t
}

/**
 * Kirajzolja a ponttÃ¶rtÃ©net listÃ¡jÃ¡t.
 */
function renderPointsLog() {
  const logDiv = document.getElementById("pointsHistoryList");
  if (!logDiv) return; // Ha nincs meg a div, ne fusson

  logDiv.innerHTML = "";

  if (pointsLog.length === 0) {
    logDiv.innerHTML = "<p style='text-align: center; padding: 10px;'>MÃ©g nincsenek pontbejegyzÃ©sek.</p>";
    return;
  }

  pointsLog.forEach((entry) => {
    let displayTime = "...";
    if (entry.time) {
      if (typeof entry.time.toDate === 'function') {
        displayTime = entry.time.toDate().toLocaleString();
      } else {
        displayTime = new Date(entry.time).toLocaleString();
      }
    }

    const amountColor = entry.amount > 0 ? '#00796b' : '#c00'; // ZÃ¶ld vagy piros
    const amountSign = entry.amount > 0 ? '+' : '';

    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `
      <span>
        <strong style="color: ${amountColor};">
          ${amountSign}${entry.amount} pont
        </strong>
        - ${entry.reason}
      </span>
      <small>${displayTime}</small>
      <button style="background:none;color:#c00" onclick="deletePointsLogEntry(${entry.id})">ğŸ—‘ï¸</button>
    `;
    logDiv.appendChild(div);
  });
}

/**
 * TÃ¶rÃ¶l egy pontbejegyzÃ©st Ã©s visszavonja a pontszÃ¡mot.
 */
async function deletePointsLogEntry(id) {
  const index = pointsLog.findIndex(e => e.id === id);
  if (index === -1) {
    console.error("Nem talÃ¡lhatÃ³ a pontbejegyzÃ©s:", id);
    return;
  }

  const entry = pointsLog.splice(index, 1)[0];

  if (entry && entry.amount) {
    // VISSZAVONJUK A PONTOKAT
    totalPoints -= entry.amount;
    animatePoints(totalPoints);

    // FrissÃ­tjÃ¼k a nÃ©zetet Ã©s mentÃ¼nk
    renderPointsLog();
    // SpeciÃ¡lis naplÃ³zÃ¡s magÃ¡rÃ³l a tÃ¶rlÃ©srÅ‘l (de ez nem kerÃ¼l a pontnaplÃ³ba)
    await logActivity(`ğŸ—‘ï¸ PontnaplÃ³ tÃ¶rÃ¶lve: ${entry.reason} (${-entry.amount} pont)`);
    // a logActivity mÃ¡r ment, de a biztonsÃ¡g kedvÃ©Ã©rt a totalPoints-ot is mentjÃ¼k
    await saveDataToFirestore();
  }
}

// =======================================================
// ===== GRAFIKON (REFACTORED) =====
// =======================================================
function updateChart() {
  const ctx = document.getElementById("progressChart");
  if (!ctx) return;

  const weightEntries = transactions.filter(t => t.type === 'weight');
  const weights = weightEntries.map(e => e.value);
  const labels = weightEntries.map(e => {
    if (e.date) {
      if (typeof e.date.toDate === 'function') {
        return e.date.toDate().toLocaleDateString();
      } else {
        return new Date(e.date).toLocaleDateString();
      }
    }
    return "?";
  });

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "SÃºly (kg)",
        data: weights,
        borderWidth: 3,
        borderColor: "#00796b",
        tension: 0.3,
        spanGaps: true
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: false
        }
      }
    }
  });
}

// ===== NAPI MOTIVÃCIÃ“ =====
function loadMotivation() {
  const tateTips = [
    "Ne vÃ¡rj kedvre â€“ csak a gyengÃ©k vÃ¡rnak rÃ¡. Tedd, amit kell.",
    "Ha a tested tiltakozik, az elmÃ©d parancsoljon neki.",
    "A fegyelem legyÅ‘zi a lustasÃ¡got minden nap.",
    "Minden korty vÃ­z egy lÃ©pÃ©s az uralkodÃ¡s felÃ©.",
    "A fÃ©rfi, aki nem kontrollÃ¡lja az Ã©tvÃ¡gyÃ¡t, nem uralja az Ã©letÃ©t."
  ];
  const day = new Date().getDate();
  document.getElementById("motivationBar").innerText = `Tipp: â€${tateTips[day % tateTips.length]}â€`;
}

// ===== HALADÃS TÃ–RTÃ‰NET =====
function updateHistory() {
  const div = document.getElementById("historyList");
  div.innerHTML = "";

  if (transactions.length === 0) {
    div.innerHTML = "<p>MÃ©g nincsenek adatbejegyzÃ©sek.</p>";
    return;
  }

  transactions.slice().reverse().forEach((t, i) => {
    const originalIndex = transactions.length - 1 - i;
    const item = document.createElement("div");
    item.className = "log-entry";

    let text = "";
    if (t.type === 'weight') {
      text = `âš–ï¸ SÃºly: <b>${t.value} kg</b>`;
    } else if (t.type === 'water') {
      text = `ğŸ’§ VÃ­z: <b>${t.value} L</b>`;
    } else if (t.type === 'calories') {
      text = `ğŸ”¥ KalÃ³ria: <b>${t.value} kcal</b>`;
    } else if (t.type === 'protein') { // ÃšJ
      text = `ğŸ¥© Protein: <b>${t.value} g</b>`;
    } else if (t.type === 'fat') { // ÃšJ ZSÃR
      text = `ğŸ¥‘ ZsÃ­r: <b>${t.value} g</b>`;
    } else if (t.type === 'meal') { // ÃšJ
      text = `ğŸ½ï¸ Ã‰tkezÃ©s: <b>${t.name}</b> (${t.amount} ${t.unit}) - <b>${t.totalKcal.toFixed(0)} kcal</b>, <b>${t.totalProtein.toFixed(0)}g</b> protein, <b>${(t.totalFat || 0).toFixed(0)}g</b> zsÃ­r`;
    }

    let displayDate = "...";
    if (t.date) {
      if (typeof t.date.toDate === 'function') {
        displayDate = t.date.toDate().toLocaleString();
      } else {
        displayDate = new Date(t.date).toLocaleString();
      }
    }

    item.innerHTML = `
      <span>
        <b>${displayDate}</b> â€” ${text}
      </span>
      <button style="background:none;color:#c00" onclick="deleteTransaction(${originalIndex})">ğŸ—‘ï¸</button>
    `;
    div.appendChild(item);
  });
}


// =======================================================
// ===== EXPORT / IMPORT / RESET (REFACTORED) =====
// =======================================================
function exportData() {
  const allData = {
    goals,
    rewards,
    notes,
    transactions,
    logs,
    totalPoints,
    workouts,
    meals,
    reminders, // ÃšJ
    archivedGoals,
    goalWeight: goalWeightSetting,
    goalWater: goalWaterSetting,
    goalCalories: goalCaloriesSetting,
    goalProtein: goalProteinSetting,
	goalFat: goalFatSetting,
  };
  const blob = new Blob([JSON.stringify(allData, null, 2)], {
    type: "application/json"
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `FitGarden_Backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  logActivity("ğŸ’¾ Adatok exportÃ¡lva");
}

async function importData(event) { // Make async
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async e => { // Make async
    try {
      const data = JSON.parse(e.target.result);
      goals = data.goals || [];
      rewards = data.rewards || [];
      notes = data.notes || [];
      transactions = data.transactions || [];
      logs = data.logs || [];
      workouts = data.workouts || [];
      meals = data.meals || [];
      reminders = data.reminders || []; // ÃšJ
      archivedGoals = data.archivedGoals || [];
      totalPoints = data.totalPoints || 0;

      goalWeightSetting = data.goalWeight || "";
      goalWaterSetting = data.goalWater || "";
      goalCaloriesSetting = data.goalCalories || "";
      goalProteinSetting = data.goalProtein || "";
	  goalFatSetting = data.goalFat || "";

      await saveDataToFirestore();

      renderAll();
      logActivity("ğŸ“‚ Adatok importÃ¡lva");
      alert("Sikeres importÃ¡lÃ¡s! Minden adat frissÃ­tve âœ…");
    } catch {
      alert("âŒ Hiba: a fÃ¡jl nem megfelelÅ‘ formÃ¡tumÃº!");
    }
  };
  reader.readAsText(file);
}

async function resetAll() { // Make async
  if (confirm("Biztosan tÃ¶rÃ¶lni szeretnÃ©l MINDENT? Ez vÃ©gleges!")) {
    goals = [];
    rewards = [];
    notes = [];
    transactions = [];
    logs = [];
    workouts = [];
    meals = [];
    reminders = []; // ÃšJ
    archivedGoals = [];
    totalPoints = 0;
    goalWeightSetting = "";
    goalWaterSetting = "";
    goalCaloriesSetting = "";
    goalProteinSetting = "";
	goalFatSetting = "";

    renderAll();
    await logActivity("âš ï¸ Teljes rendszer reset");
    alert("FitGarden ÃºjraindÃ­tva, minden tÃ¶rÃ¶lve âœ…");
  }
}

function renderAll() {
  calculateDailyProgress();
  renderHighlights();
  document.getElementById("totalPointsDisplay").textContent = totalPoints;

  renderGoals();
  renderRewards();
  renderNotes();
  renderLogs();
  renderPointsLog(); // ÃšJ PONTNAPLÃ“ RENDERELÃ‰SE
  renderReminders(); // ÃšJ

  updateAllSummaries();
  updateHistory();
  updateCompactSummaries();

  if (document.getElementById('workouts').classList.contains('active')) {
    renderWorkouts();
  }
  if (document.getElementById('meals').classList.contains('active')) {
    renderMeals();
  }
  // Nincs szÃ¼ksÃ©g kÃ¼lÃ¶n renderReminders() hÃ­vÃ¡sra itt,
  // mert a showTab() mÃ¡r kezeli, amikor odalÃ©pÃ¼nk.
}

// =======================================================
// ===== ÃšJ EMLÃ‰KEZTETÅ FUNKCIÃ“K =====
// =======================================================

/**
 * EllenÅ‘rzi az Ã©rtesÃ­tÃ©si engedÃ©lyt, Ã©s kÃ©ri, ha mÃ©g nincs beÃ¡llÃ­tva.
 */
function checkNotificationPermission() {
  // EllenÅ‘rizzÃ¼k, hogy a bÃ¶ngÃ©szÅ‘ tÃ¡mogatja-e az Ã©rtesÃ­tÃ©seket
  if (!('Notification' in window)) {
    console.warn("Ez a bÃ¶ngÃ©szÅ‘ nem tÃ¡mogatja az asztali Ã©rtesÃ­tÃ©seket.");
    return;
  }

  // KÃ©rjÃ¼nk engedÃ©lyt, ha mÃ©g nincs 'granted' (engedÃ©lyezve) vagy 'denied' (letiltva)
  if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        console.log('Ã‰rtesÃ­tÃ©si engedÃ©ly megadva.');
        new Notification('FitGarden', {
          body: 'Sikeresen engedÃ©lyezted az Ã©rtesÃ­tÃ©seket!',
          icon: 'ğŸ””'
        });
      } else {
        console.log('Ã‰rtesÃ­tÃ©si engedÃ©ly elutasÃ­tva.');
      }
    });
  }
}

/**
 * HozzÃ¡ad egy Ãºj emlÃ©keztetÅ‘t a listÃ¡hoz.
 */
/**
     * HozzÃ¡ad egy Ãºj emlÃ©keztetÅ‘t a listÃ¡hoz.
     */
    async function addReminder() {
      const textInput = document.getElementById("reminderTextInput");
      const timeInput = document.getElementById("reminderTimeInput");
      
      // === ÃšJ VÃLTOZÃ“K BEOLVASÃSA ===
      const highlightCheck = document.getElementById("reminderHighlightCheck");
      const highlightDateInput = document.getElementById("reminderHighlightDateInput");

      const text = textInput.value.trim();
      const time = timeInput.value;
      
      // === ÃšJ VÃLTOZÃ“K BEOLVASÃSA ===
      const highlight = highlightCheck.checked;
      const highlightDate = highlightDateInput.value;

      if (!text || !time) {
        alert("KÃ©rlek adj meg egy szÃ¶veget Ã©s egy idÅ‘pontot!");
        return;
      }

      const reminderTime = new Date(time);
      if (reminderTime <= new Date()) {
        alert("Az emlÃ©keztetÅ‘ idÅ‘pontjÃ¡nak a jÃ¶vÅ‘ben kell lennie!");
        return;
      }
      
      // === ÃšJ ELLENÅRZÃ‰S ===
      if (highlight && !highlightDate) {
        alert("Ha kiemelÃ©st kÃ©rsz, meg kell adnod a kiemelÃ©s kezdÅ‘ dÃ¡tumÃ¡t!");
        return;
      }
      
      // === ÃšJ ELLENÅRZÃ‰S ===
      if (highlight && new Date(highlightDate) > reminderTime) {
        alert("A kiemelÃ©s kezdete nem lehet kÃ©sÅ‘bb, mint az emlÃ©keztetÅ‘ idÅ‘pontja!");
        return;
      }

      reminders.push({
        id: Date.now(),
        text: text,
        time: reminderTime.toISOString(), // ISO stringkÃ©nt tÃ¡roljuk
        triggered: false, // MÃ©g nem lett aktivÃ¡lva
        // === ÃšJ ADATOK HOZZÃADÃSA ===
        highlight: highlight,
        highlightDate: highlight ? new Date(highlightDate).toISOString() : null
      });

      textInput.value = "";
      timeInput.value = "";
      // === ÃšJ MEZÅK RESETELÃ‰SE ===
      highlightCheck.checked = false;
      highlightDateInput.value = toDateInputString(new Date()); // VisszaÃ¡llÃ­tÃ¡s mai dÃ¡tumra

      // === RENDERALL HÃVÃSA ===
      // renderReminders(); helyett renderAll(), hogy a fÅ‘oldal is frissÃ¼ljÃ¶n
      renderAll(); 
      await saveDataToFirestore();
    }
/**
 * Kirajzolja az aktÃ­v emlÃ©keztetÅ‘k listÃ¡jÃ¡t.
 */
async function deleteReminder(id) {
      if (!confirm("Biztosan tÃ¶rlÃ¶d ezt az emlÃ©keztetÅ‘t?")) {
        return;
      }
    
      reminders = reminders.filter(r => r.id !== id);
    
      // FrissÃ­tÃ¼nk mindent (a fÅ‘oldalt is)
      renderAll();
      await saveDataToFirestore();
    }
	
function renderReminders() {
  const list = document.getElementById("reminderList");
  if (!list) return; // Ha a fÃ¼l mÃ©g nem aktÃ­v, ne csinÃ¡ljon semmit
  list.innerHTML = "";

  // Csak azokat mutatjuk, amik mÃ©g nem sÃ¼ltek el
  const pendingReminders = reminders
    .filter(r => !r.triggered)
    .sort((a, b) => new Date(a.time) - new Date(b.time)); // IdÅ‘rendben

  if (pendingReminders.length === 0) {
    list.innerHTML = "<p>Nincsenek aktÃ­v emlÃ©keztetÅ‘k.</p>";
    return;
  }

  pendingReminders.forEach(r => {
    const div = document.createElement("div");
    div.className = "log-entry"; // ÃšjrahasznosÃ­tjuk a log stÃ­lusÃ¡t

    const displayTime = new Date(r.time).toLocaleString(); // FelhasznÃ¡lÃ³barÃ¡t dÃ¡tum

    div.innerHTML = `
        <span>ğŸ”” <b>${r.text}</b></span>
        <small>${displayTime}</small>
        <button style="background:none;color:#00796b" onclick="editReminder(${r.id})" title="SzerkesztÃ©s">âœï¸</button>
        <button style="background:none;color:#c00" onclick="deleteReminder(${r.id})" title="TÃ¶rlÃ©s">ğŸ—‘ï¸</button>
    `;
    list.appendChild(div);
  });
}

/**
 * ElindÃ­tja az idÅ‘zÃ­tÅ‘t, ami rendszeresen ellenÅ‘rzi az emlÃ©keztetÅ‘ket.
 */
function startReminderEngine() {
  // Ha mÃ¡r fut, ne indÃ­tsuk Ãºjra
  if (reminderCheckInterval) {
    clearInterval(reminderCheckInterval);
  }

  // 30 mÃ¡sodpercenkÃ©nt ellenÅ‘rizzÃ¼k, van-e teendÅ‘
  reminderCheckInterval = setInterval(checkReminders, 30000);

  // IndÃ­tÃ¡skor azonnal lefuttatjuk, hogy az esetleg lekÃ©sett emlÃ©keztetÅ‘k megjelenjenek
  checkReminders();
}

/**
 * EllenÅ‘rzi az emlÃ©keztetÅ‘ket, Ã©s aktivÃ¡lja azokat, amiknek lejÃ¡rt az ideje.
 */
function checkReminders() {
  const now = new Date();
  let needsSave = false; // Csak akkor mentÃ¼nk, ha vÃ¡ltozÃ¡s tÃ¶rtÃ©nt

  reminders.forEach(r => {
    if (!r.triggered && new Date(r.time) <= now) {
      // Itt az idÅ‘!
      showReminderNotification(r);
      r.triggered = true;
      needsSave = true;
    }
  });

  if (needsSave) {
        // FrissÃ­tÃ¼nk mindent (hogy a fÅ‘oldali kiemelÃ©s is eltÅ±njÃ¶n)
        // Ã©s mentÃ¼nk.
        renderAll();
        saveDataToFirestore();
      }
	}
/**
 * MegjelenÃ­ti a bÃ¶ngÃ©szÅ‘ Ã©rtesÃ­tÃ©st.
 */
function showReminderNotification(reminder) {
  if (Notification.permission === 'granted') {
    // JelenÃ­tsÃ¼k meg az Ã©rtesÃ­tÃ©st
    new Notification('FitGarden EmlÃ©keztetÅ‘', {
      body: reminder.text,
      icon: 'https://img.icons8.com/color/96/leaf.png' // Egy egyszerÅ± levÃ©l ikon
    });
  } else {
    // Ha valamiÃ©rt nincs engedÃ©ly (pl. visszavonta), csak a konzolra Ã­runk.
    console.warn(`EmlÃ©keztetÅ‘ elsÃ¼tve (de nincs engedÃ©ly): ${reminder.text}`);
  }
}

// =======================================================
</script>

</body>

</html>
