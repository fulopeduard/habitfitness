<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitGarden 2.0 ‚Äì Fejedelem Edition üí™üåø</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üî•</text></svg>">
    <style>
        body {
          font-family: 'Segoe UI', sans-serif;
          margin: 0;
          padding: 0;
          color: #222;
          background: linear-gradient(
          180deg,
          #034c3f 0%,
          #222 50%,
          #034c3f 100%
        );
          overflow-x: hidden;
        }

        #motivationBar {
          background: #004d40;
          color: white;
          padding: 8px;
          text-align: center;
          font-style: italic;
          font-size: 0.95em;
          letter-spacing: 0.3px;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        main {
          max-width: 1200px;
          margin: 5px auto;
          padding: 1px;
        }

        .card {
          background: white;
          border-radius: 18px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
          padding: 6px;
          margin-bottom: 5px;
        }

        h2 {
          color: #00796b;
          margin-bottom: 5px;
          font-size: large;
        }

        button {
          background: #00796b;
          color: white;
          border: none;
          border-radius: 10px;
          padding: 8px 15px;
          font-size: 0.95em;
          cursor: pointer;
          transition: 0.3s;
        }

        button:hover {
          background: #004d40;
        }

        .icon-box {
          display: flex;
          justify-content: space-around;
          align-items: stretch;
          gap: 15px;
          flex-wrap: wrap;
        }

        .icon-card {
          flex: 1;
          min-width: 280px;
          background: #e8f5e9;
          border-radius: 12px;
          text-align: center;
          padding: 20px;
          position: relative;
          display: flex;
          flex-direction: column;
        }

        .icon-card i {
          font-size: 2em;
          color: #00796b;
          display: block;
        }

        .icon-card span {
          display: block;
          margin-top: 5px;
          font-weight: bold;
          font-size: 1.1em;
        }

        .edit-btn {
          position: absolute;
          top: 8px;
          right: 10px;
          background: none;
          color: #00796b;
          border: none;
          font-size: 1.1em;
          cursor: pointer;
        }

        .hidden {
          display: none;
        }

        #tabs {
          display: flex;
          justify-content: center;
          align-items: center;
          flex-wrap: wrap;
          margin-bottom: 10px;
          gap: 8px;
        }

        .tab-btn {
          background: #dcedc8;
          color: black;
          padding: 10px 15px;
          /* Kicsit cs√∂kkentettem a paddingot */
          border-radius: 10px;
          margin: 0;
          cursor: pointer;
          transition: 0.3s;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);

          /* √öJ R√âSZEK INNENT≈êL */
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          /* T√°vols√°g az ikon √©s a sz√∂veg k√∂z√∂tt */
          flex-grow: 1;
          /* N√∂vekedhessen */
          flex-shrink: 1;
          /* Zsugorodjon */
          flex-basis: 120px;
          /* Egy alap√©rtelmezett kiindul√≥ sz√©less√©g */
          box-sizing: border-box;
          /* Ez biztos√≠tja, hogy a padding ne rontsa el a m√©retez√©st */
        }

        .tab-btn.active {
          background: #00796b;
          color: white;
          font-weight: bold;
        }

        .tab-content {
          display: none;
        }

        .tab-content.active {
          display: block;
        }

        /* EZT A BLOKKOT M√ÅSOLD BE */
        .tab-icon {
          font-size: 1.1em;
          line-height: 1;
          /* Megakad√°lyozza a felesleges magass√°got */
        }

        .tab-text {
          white-space: nowrap;
          /* Megakad√°lyozza, hogy a sz√∂veg t√∂rj√∂n */
        }
        /* ===== RESPONSIVE F≈êMEN√ú (TAB) ST√çLUSOK ===== */
        @media (max-width: 845px) {
          #tabs {
            gap: 6px;
            /* Kisebb r√©s a gombok k√∂z√∂tt mobilon */
          }

          .tab-btn {
            /* 33.3% - (r√©s / 3) -> Ez k√©nyszer√≠ti a 3 gombot egy sorba */
            flex-basis: 31%;
            padding: 10px 5px;
            /* Kisebb padding, hogy elf√©rjen */
          }
        }

        @media (max-width: 420px) {
          .tab-text {
            display: none;
            /* K√©r√©sednek megfelel≈ëen a sz√∂veg elrejt√©se */
          }

          .tab-btn {
            flex-basis: 30%;
            /* Maradhat a 3/sor elrendez√©s */
            padding: 10px;
            /* Egyenletesebb padding */
            gap: 0;
          }

          .tab-icon {
            font-size: 1.3em;
            /* Ikon picit nagyobb, mert egyed√ºl van */
          }
        }
        /* ===== C√âL/JUTALOM ELRENDEZ√âS ===== */
        .flex-container {
          display: flex;
          gap: 25px;
          flex-wrap: wrap;
          align-items: flex-start;
        }

        .flex-container>.card {
          flex: 1;
          min-width: 300px;
        }
        /* ===== √öJ PRIORIT√ÅS C√âL ST√çLUSOK (PIROS) ===== */
        .goal-item.priority .item-name {
          background: #ffebee; /* Vil√°gos piros */
          color: #c62828; /* S√∂t√©t piros sz√∂veg */
        }
        .goal-item.priority .item-points {
          background: #ffcdd2; /* K√∂zepes piros */
          border-left: 1px solid #ef9a9a;
          border-right: 1px solid #ef9a9a;
          color: #b71c1c;
        }
        .goal-item.priority .item-actions {
          background: #ffebee; /* Vil√°gos piros */
        }
        /* A kiemelt alc√©lok c√≠me is legyen piros */
        .goal-item.priority .subgoal-header {
            color: #c62828;
            border-bottom: 1px solid #ffcdd2;
        }
        /* ===== K√ÅRTYA FEJL√âC (C√çM + GOMB/PONTOK) ST√çLUS ===== */
        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .card-header h2 {
          margin-bottom: 8px;
        }

        /* √öJ ST√çLUS A FEJL√âC ARCH√çV GOMBJ√ÅHOZ */
        .card-header .card-header-add-btn {
          background: #00796b;
          /* Vil√°gosabb z√∂ld, mint az arch√≠v gomb */
          font-size: 0.9em;
          padding: 6px 12px;
          font-weight: bold;
        }

        .card-header .new-note-btn-left {
          margin-right: auto;
          /* Ez tolja el a gombot balra, amennyire csak lehet */

        }

        .card-header .card-header-add-btn:hover {
          background: #004d40;
          /* S√∂t√©tebb z√∂ld hover-re */
        }
        /* ===== PONTSZ√ÅML√ÅL√ì (JUTALMAK FEJL√âC) ===== */
        .header-points-display {
          display: flex;
          align-items: center;
          font-weight: bold;
        }

        .header-points-display .points-icon {
          font-size: 1.3em;
          margin-right: 8px;
          color: #00796b;
          /* T√©ma z√∂ld */
          line-height: 1;
        }

        .header-points-display .points-number {
          color: #004d40;
          /* S√∂t√©t z√∂ld */
          font-size: 1.4em;
          /* Kiemelt sz√°m */
          line-height: 1;
        }
        .header-points-display .points-label {
          color: #00796b;
          /* T√©ma z√∂ld */
          margin-left: 5px;
          font-size: 1.1em;
          line-height: 1;
        }
        /* ===== √öJ GOMB ST√çLUS (K√ÅRTYA ALJ√ÅN) ===== */
        .new-item-button {
          width: 100%;
          /* Teljes sz√©less√©g */
          padding: 12px;
          /* Nagyobb, k√©nyelmesebb gomb */
          font-size: 1em;
          font-weight: bold;
          margin-top: 15px;
          /* T√°vols√°g a list√°t√≥l */
        }
        /* ===== C√âL, JUTALOM, √âTEL S√ÅV ST√çLUS ===== */
        .goal-item,
        .reward-item,
        .food-item,
        .workout-item {
          background: transparent;
          border-radius: 10px;
          padding: 0;
          margin-bottom: 8px;
          display: flex;
          overflow: hidden;
          align-items: stretch;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .completed {
          text-decoration: line-through;
          opacity: 0.7;
        }
        .item-name {
          flex: 1;
          padding: 7px 15px;
          background: #e8f5e9;
          /* Vil√°gos z√∂ld */
          display: flex;
          flex-direction: column;
          /* M√ìDOS√çTVA */
          align-items: flex-start;
          /* M√ìDOS√çTVA */
        }
        .item-points {
          flex-shrink: 0;
          align-items: center;
          justify-content: center;
          width: 78px;
          padding: 2px;
          background: #dcedc8;
          /* √Årnyalattal s√∂t√©tebb z√∂ld */
          text-align: center;
          font-weight: bold;
          border-left: 1px solid #c8e6c9;
          border-right: 1px solid #c8e6c9;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        /* √öJ ST√çLUS AZ √âTEL K√ÅRTY√ÅHOZ */
        .food-item .item-details {
          flex-shrink: 0;
          width: 120px;
          padding: 1px;
          background: #dcedc8;
          text-align: center;
          font-weight: bold;
          border-left: 1px solid #c8e6c9;
          border-right: 1px solid #c8e6c9;
          font-size: 0.9em;
          line-height: 1.3;
        }
        .food-item .item-details span {
          display: block;
        }
        .item-actions {
          flex-shrink: 0;
          padding: 7px 10px;
          background: #e8f5e9;
          /* Vil√°gos z√∂ld */
          display: flex;
          gap: 5px;
          justify-content: center;
          align-items: center;
        }
        .item-actions button {
          background: transparent;
          color: #00796b;
          font-size: 1.1em;
          cursor: pointer;
          padding: 1px;
        }
        /* √öJ ST√çLUSOK AZ ARCHIV√ÅL√ÅSHOZ */
        .item-actions button.archive-btn {
          color: #004d40;
          /* S√∂t√©tz√∂ld az archiv√°l√°shoz */
        }
        /* St√≠lus az archiv√°lt elemek gombjaihoz */
        #archivedGoalList .item-actions button.reactivate-btn {
          color: #00796b;
          /* Z√∂ld */
        }
        #archivedGoalList .item-actions button.delete-btn {
          color: #c00;
          /* Piros */
        }
        .category-title {
          margin-bottom: 5px;
          color: #004d40;
          border-bottom: 2px solid #b2dfdb;
          padding-bottom: 4px;
          font-size: 1.1em;
        }

        #goalList .category-title:first-of-type {
          margin-top: 10px;
        }
        /* ===== √öJ ALC√âL (SUB-GOAL) ST√çLUSOK ===== */
        .subgoal-list {
          margin-top: 10px;
          padding-left: 1px;
          font-size: 0.9em;
          text-align: left;
          width: 100%;
          /* Kit√∂lti a .item-name sz√©less√©g√©t */
        }
        /* ===== √öJ ALC√âL PROGRESS BAR ST√çLUS ===== */
        .subgoal-progress-container {
          width: 100%;
          height: 2px; /* K√©r√©snek megfelel≈ëen v√©kony */
          background: #c8e6c9; /* Halv√°ny h√°tt√©r, mint a kompakt s√°v√© */
          border-radius: 5px;
          overflow: hidden;
          margin-top: 2px; /* Kis t√°vols√°g a c√≠mt≈ël */
          /* A t√°vols√°got az alc√©l list√°t√≥l a .subgoal-list margin-top-ja adja */
          border: 1px solid #a5d6a7;
        }

        .subgoal-progress-fill {
          height: 100%;
          width: 0%; /* Ezt a style="" inline fel√ºl√≠rja */
          background: #00796b; /* Alap t√©ma-z√∂ld */
          border-radius: 5px;
          transition: width 0.9s ease;
        }

        /* Ha a c√©l priorit√°sos, a s√°v is legyen pirosas */
        .goal-item.priority .subgoal-progress-container {
            background: #ffcdd2;
            border-color: #ef9a9a;
        }
        .goal-item.priority .subgoal-progress-fill {
            background: #c62828; /* S√∂t√©t piros */
        }
        .subgoal-header {
          font-size: 1.1em;
          font-weight: bold;
          color: #004d40;
          /* S√∂t√©t z√∂ld, mint a kateg√≥ria c√≠mek */
          margin-top: 15px;
          margin-bottom: 5px;
          padding-bottom: 2px;
          border-bottom: 1px solid #dcedc8;
          /* Finom vonal alatta */
        }

        .subgoal-list .subgoal-header:first-child {
          margin-top: 5px;
          /* Kisebb marg√≥, ha ez az els≈ë elem */
        }

        .subgoal-separator {
          border: none;
          border-top: 2px dashed #b2dfdb;
          /* Szaggatott vonal a t√©ma sz√≠n√©vel */
          margin: 10px 0;
        }

        .subgoal-list div {
          display: flex;
          align-items: center;
          margin-bottom: 5px;
          text-decoration: none;
          /* Ne h√∫zza √°t az alc√©l sz√∂veg√©t */
        }

        .subgoal-list input[type="checkbox"] {
          width: auto;
          margin: 0 10px 0 0;
        }

        .subgoal-list span.subgoal-done {
          text-decoration: line-through;
          opacity: 0.7;
        }

        /* Amikor a F≈ê c√©l k√©sz, a F≈ê c√≠m √°th√∫zva */
        .goal-item.completed .item-name-main {
          text-decoration: line-through;
        }

        /* De a sub-goal lista soha (csak a bels≈ë span) */
        .goal-item.completed .subgoal-list {
          text-decoration: none;
        }
        .log {
          background: #f8f8f8;
          border-radius: 10px;
          padding: 10px;
          max-height: 300px;
          overflow-y: auto;
        }

        .log-entry {
          background: #e8f5e9;
          border-bottom: 1px solid #ddd;
          padding: 6px 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .log-entry span {
          flex: 1;
          padding-right: 10px;
        }

        .log-entry small {
          color: #777;
          font-size: 0.85em;
          margin-left: 10px;
        }

        .log-entry button {
          flex-shrink: 0;
        }

        .modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.4);
          display: none;
          justify-content: center;
          align-items: flex-start;
          z-index: 1000;
          padding-top: 20px;
          overflow-y: auto;
        }

        #editModal {
          z-index: 2000 !important;
        }

        .modal-content {
          background: white;
          border-radius: 15px;
          padding: 20px;
          width: 90%;
          max-width: 400px;
          max-height: 90vh;
          overflow-y: auto;
        }

        .modal-content h3 {
          margin-top: 0;
          color: #00796b;
          text-align: center;
        }

        input,
        textarea,
        select {
          width: 100%;
          padding: 6px;
          margin-top: 2px;
          margin-bottom: 10px;
          border-radius: 10px;
          border: 1px solid #ccc;
          font-size: 1em;
          box-sizing: border-box;
          background-color: white;
          /* Select h√°t√©rsz√≠n */
        }
        /* ===== GRAFIKON MODAL ST√çLUSOK ===== */
        #chartModalContent {
          max-width: 90%;
          width: 800px;
        }

        #progressChart {
          width: 100%;
          height: 400px;
        }
        /* ====== K√ñVET√âS ST√çLUSOK ====== */
        .icon-card .content-wrapper {
          margin-top: 15px;
          flex-grow: 1;
          display: flex;
          flex-direction: column;
          justify-content: flex-end;
        }
        .progress-summary {
          font-size: 0.9em;
          font-weight: bold;
          color: #004d40;
          margin-top: 10px;
          margin-bottom: 10px;
          height: 1.2em;
        }
        .input-group {
          display: flex;
          margin-top: 10px;
          gap: 5px;
        }
        .input-group input {
          flex: 1;
          width: 60%;
          margin: 0;
          font-size: 0.9em;
          text-align: center;
        }
        .input-group button {
          flex-shrink: 0;
          font-size: 0.85em;
          padding: 8px 10px;
        }
        .progress-bar-container {
          background: #c8e6c9;
          border-radius: 10px;
          height: 12px;
          width: 100%;
          margin-top: 10px;
          overflow: hidden;
          border: 1px solid #a5d6a7;
        }
        .progress-bar {
          background: #00796b;
          height: 100%;
          width: 0%;
          border-radius: 10px;
          transition: width 0.5s ease;
        }
        /* √öJ: A PROTEIN S√ÅV SZ√çNE */
        #proteinProgressBar {
          background: #8e24aa;
          /* Lila */
        }
        /* ====== ANIM√ÅCI√ìK ====== */
        .fade-in {
          opacity: 0;
          transform: translateY(10px);
          animation: fadeIn 0.6s ease forwards;
        }
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        button,
        .tab-btn {
          transition: transform 0.15s ease, background-color 0.3s;
        }

        button:hover,
        .tab-btn:hover {
          transform: scale(1.03);
        }
        /* ====== EXPORT / RESET PANEL ====== */
        #controlPanel {
          text-align: center;
          margin-top: 25px;
        }

        #controlPanel button {
          background: #004d40;
          margin: 5px;
        }

        #controlPanel input[type="file"] {
          display: none;
        }
        /* ===== √öJ JEGYZET ST√çLUSOK ===== */
        #noteViewModal .modal-content {
          background: #f1f8e9;
          max-width: 600px;
        }

        #noteViewText {
          background: #ffffff;
          border-radius: 8px;
          padding: 15px;
          min-height: 100px;
          max-height: 60vh;
          overflow-y: auto;
          white-space: pre-wrap;
          border: 1px solid #dcedc8;
        }

        .note-summary-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #e8f5e9;
          padding: 12px 15px;
          border-radius: 10px;
          margin-bottom: 8px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .note-summary-title {
          flex: 1;
          font-weight: bold;
          font-size: 1.1em;
          color: #004d40;
          cursor: pointer;
          margin-right: 10px;
        }

        .note-summary-date {
          font-size: 0.85em;
          color: #555;
          margin-right: 15px;
          flex-shrink: 0;
        }

        .note-summary-actions button {
          background: transparent;
          color: #00796b;
          font-size: 1.1em;
          padding: 5px;
        }

        #editInputText {
          height: 150px;
          resize: vertical;
          font-family: 'Segoe UI', sans-serif;
        }
        /* ===== √öJ KOMPAKT F≈êOLDALI C√âLOK ST√çLUS ===== */
        #compactGoalsContainer {
          display: grid;
          /* JAV√çT√ÅS: √Åt√°ll√°s Grid-re */
          grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto;
          /* Alap√©rtelmezett: 4 adat oszlop + 1 gomb oszlop */
          background: white;
          border-radius: 18px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
          padding: 12px 15px;
          margin-bottom: 5px;
          align-items: center;
          /* JAV√çT√ÅS: F√ºgg≈ëlegesen k√∂z√©pre igaz√≠tjuk az eg√©szet */
          gap: 12px;
          /* flex-wrap t√∂r√∂lve */
        }

        .compact-goal-item {
          min-width: 0;
          /* Ez marad, hogy a sz√∂veg lev√°g√≥dhasson (...) */
          text-align: left;
        }

        .compact-goal-item .label {
          font-size: 0.85em;
          color: #00796b;
          display: block;
          font-weight: bold;
          white-space: nowrap;
        }

        .compact-goal-item .value {
          display: block;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        /* √öJ: Fels≈ë sz√∂veg (pl. 0.7/2.0 L) */
        .compact-goal-item .value-top {
          font-size: 1.0em;
          color: #333;
          /* Kev√©sb√© hangs√∫lyos */
          font-weight: 500;
          margin-top: 2px;
        }

        /* √öJ: Als√≥ sz√∂veg (pl. M√©g 1.3 L) */
        .compact-goal-item .value-bottom {
          font-size: 0.9em;
          color: #004d40;
          font-weight: bold;
          margin-top: 3px;
        }

        /* A S√∫ly fels≈ë sora m√°sk√©pp n√©z ki */
        .compact-goal-item .value-weight-top {
          font-size: 0.9em;
          color: #333;
          font-weight: 500;
        }


        #compactBtnWrapper {
          display: flex;
          gap: 8px;
          /* margin-left: auto; T√ñR√ñLVE */
          /* flex-shrink: 0; T√ñR√ñLVE */
          align-self: center;
        }

        #quickAddBtn,
        #compactEditBtn,
        #compactChartBtn {
          flex-shrink: 0;
          background: #004d40;
          padding: 10px 12px;
          font-size: 1.2em;
          line-height: 1;
          border-radius: 12px;
        }

        #compactEditBtn,
        #compactChartBtn {
          background: #00796b;
          font-size: 1.1em;
          padding: 11px 12px;
        }

        .compact-progress-bar-container {
          background: #c8e6c9;
          border-radius: 10px;
          height: 10px;
          width: 100%;
          margin-top: 4px;
          /* K√∂zelebb a fels≈ë sz√∂veghez */
          overflow: hidden;
          border: 1px solid #a5d6a7;
        }

        .compact-progress-bar {
          background: #00796b;
          height: 100%;
          width: 0%;
          border-radius: 10px;
          transition: width 0.5s ease;
        }

        /* Protein s√°v sz√≠ne */
        #compactProteinBar,
        #compactWeightBar {
          /* S√∫ly is lila lesz */
          background: #8e24aa;
        #compactFatBar {
          background: #f57f17;
        }
        }

        /* √öJ: Reszponz√≠v t√∂r√©spont telefonra */
        @media (max-width: 800px) {
          #compactGoalsContainer {
            grid-template-columns: 1fr 1fr;
            /* 2 oszlopos elrendez√©s */
            gap: 15px;
            /* Nagyobb t√©rk√∂z mobilon */
            align-items: flex-end;
            /* Vissza√°ll√≠tjuk alulra igaz√≠t√°sra */
          }

          #compactBtnWrapper {
            /* A gombok √°tny√∫lnak mindk√©t oszlopon */
            justify-content: center;
            /* K√∂z√©pre igaz√≠tja a gombokat a soron bel√ºl */
          }
        }
        /* ===== √öJ EDZ√âS ST√çLUSOK (NAPT√ÅR T√ñR√ñLVE) ===== */
        .workout-adder {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
        }

        .workout-adder input[type="date"] {
          flex: 1;
          /* A d√°tumv√°laszt√≥ t√∂ltse ki a helyet */
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 10px;
          font-size: 1em;
        }

        .workout-adder button {
          flex-shrink: 0;
          /* A gomb ne zsugorodjon */
          padding: 10px 15px;
          font-weight: bold;
        }

        .workout-item button .item-actions .delete-btn	{
          background: transparent;
          color: #c00;
          /* V√∂r√∂s a t√∂rl√©shez */
          font-size: 1.2em;
        }

        /* ===== √öJ √âTEL PROGRESS BAR ST√çLUSOK ===== */
        .meal-progress-container {
          margin-top: 0px;
          width: 100%;
          display: flex;
          flex-direction: column;
          gap: 1px;
        }

        .meal-progress-wrapper {
          display: flex;
          align-items: center;
          font-size: 0.85em;
        }

        .meal-progress-label {
          width: 65px;
          /* Sz√©lesebb a "Kal√≥ria:" miatt */
          font-weight: bold;
          color: #333;
          flex-shrink: 0;
        }

        .meal-progress-bar-bg {
          background: #e0e0e0;
          border-radius: 5px;
          height: 10px;
          width: 100%;
          overflow: hidden;
        }

        .meal-progress-bar-fill {
          background: #ff9800;
          /* Kal√≥ria - narancs */
          height: 100%;
          border-radius: 5px;
          transition: width 0.5s ease;
        }

        .meal-progress-bar-fill.protein {
          background: #8e24aa;
          /* Protein - lila */
        }
        /* ===== √öJ KIEMELT EML√âKEZTET≈ê ST√çLUS ===== */
        #highlightContainer {
          display: flex;
          flex-direction: column;
          gap: 10px;
          margin-bottom: 5px;
        }

        .highlight-box {
          background: #ffebee; /* Vil√°gos piros h√°tt√©r */
          border: 2px solid #e57373; /* S√∂t√©tebb piros keret */
          border-radius: 12px;
          padding: 15px;
          box-shadow: 0 4px 10px rgba(200, 0, 0, 0.1);
        }

        .highlight-box h3 {
          margin: 0 0 8px 0;
          color: #c62828; /* S√∂t√©t piros c√≠m */
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 1.2em;
        }

        .highlight-box p {
          margin: 0;
          color: #444;
          font-size: 1em;
          font-weight: 500;
        }

        .highlight-box .highlight-time {
          font-size: 0.9em;
          font-weight: bold;
          color: #c62828;
        }
        /* ===== √âTEL S√ÅV ELRENDEZ√âS M√ìDOS√çT√ÅSA ===== */
        /* Fel√ºl√≠rjuk az alap s√°v st√≠lust, hogy ne flex legyen, hanem blokk */
        .food-item {
          display: block;
          background: #e8f5e9;
          /* A teljes s√°v h√°ttere */
          padding: 0;
          border-radius: 10px;
          /* Ez m√°r megvolt, de biztos√≠tjuk */
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
          /* Ez is megvolt */
          margin-bottom: 8px;
          /* Ez is megvolt */
          overflow: hidden;
          /* Ez is megvolt */
        }

        /* Ez az √∫j div, ami az els≈ë sort (n√©v, adatok, gombok) tartalmazza */
        .food-item-row1 {
          display: flex;
          /* Ennek kell flex-nek lennie, hogy a gyerekek egy sorban legyenek */
          align-items: stretch;
        }

        /* Fel√ºl√≠rjuk az .item-name st√≠lus√°t CSAK az √©telekn√©l,
           hogy ne oszlopban, hanem sorban rendezze a tartalm√°t (a nevet) */
        .food-item .item-name {
          flex-direction: row;
          align-items: center;
        }

        /* A progress bar kont√©nernek adunk egy kis bels≈ë teret (padding),
           hogy sz√©pen igazodjon a felette l√©v≈ë tartalomhoz */
        .food-item .meal-progress-container {
          padding: 2px 5px;
          border-top: 1px solid #dcedc8;
          /* Finom elv√°laszt√≥ vonal */
        }
    /* ===== FOGADALMAK ST√çLUSAI ===== */
        .vow-item {
          background: #e3f2fd; /* K√©k √°rnyalat a fogadalmaknak */
          border-left: 5px solid #2196f3;
          border-radius: 10px;
          padding: 0;
          margin-bottom: 8px;
          display: flex;
          align-items: stretch;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
          overflow: hidden;
        }

        .vow-item.completed-today {
            background: #bbdefb;
            opacity: 0.8;
        }

        .vow-item .item-name {
            background: transparent; /* Fel√ºl√≠rjuk az alap z√∂ld h√°tteret */
        }

        .vow-item .item-actions button.fail-btn {
            color: #c62828; /* S√∂t√©t piros az X gombnak */
            font-weight: bold;
        }

        /* ===== B√úNTET√âS C√âL ST√çLUSA (Extr√©m kiemel√©s) ===== */
        .goal-item.punishment {
            background: #212121; /* Majdnem fekete h√°tt√©r */
            border: 2px solid #b71c1c; /* V√©rv√∂r√∂s keret */
            color: #ffcdd2;
        }

        .goal-item.punishment .item-name {
            background: #212121;
            color: #ffcdd2;
        }

        .goal-item.punishment .item-name-main {
            color: #ff5252;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .goal-item.punishment .item-points {
            background: #b71c1c;
            color: white;
            border: none;
        }

        .goal-item.punishment .subgoal-header {
            color: #ff8a80;
            border-bottom: 1px solid #b71c1c;
        }

        .goal-item.punishment .item-actions {
            background: #424242;
        }

        /* Countdown st√≠lus a b√ºntet√©shez */
        .punishment-deadline {
            display: block;
            font-size: 0.8em;
            color: #ff8a80;
            margin-top: 2px;
        }
    </style>
</head>

<body>

<div id="loginContainer" style="padding: 20px; max-width: 400px; margin: 40px auto; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
    <h2 style="color: #00796b; text-align: center;">FitGarden 2.0</h2>
    <h3 style="text-align: center;">Bel√©p√©s / Regisztr√°ci√≥</h3>

    <label>Email</label>
    <input type="email" id="loginEmail" placeholder="email@cim.com">

    <label>Jelsz√≥</label>
    <input type="password" id="loginPassword" placeholder="min. 6 karakter">

    <div style="margin-top: 15px; margin-bottom: 15px; display: flex; align-items: flex-start; gap: 10px; font-size: 0.9em;">
        <input type="checkbox" id="privacyCheck" style="width: auto; margin-top: 3px;">
        <label for="privacyCheck" style="margin: 0; line-height: 1.4;">
            Elolvastam √©s elfogadom az <span onclick="openModal('privacyModal')" style="color: #00796b; text-decoration: underline; cursor: pointer; font-weight: bold;">Adatkezel√©si T√°j√©koztat√≥t</span>, √©s hozz√°j√°rulok eg√©szs√©g√ºgyi adataim (s√∫ly, t√°pl√°lkoz√°s) kezel√©s√©hez.
        </label>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="handleLogin()" style="flex: 1;">Bel√©p√©s</button>
        <button onclick="handleSignUp()" style="flex: 1; background: #004d40;">Regisztr√°ci√≥</button>
    </div>
    <p onclick="handlePasswordReset()" style="text-align: center; color: #00796b; cursor: pointer; margin-top: 15px; margin-bottom: 0px; font-size: 0.9em;">
        Elfelejtett jelsz√≥?
    </p>
    <p id="loginError" style="color: red; text-align: center; margin-top: 10px;"></p>
</div>

<div id="appContainer" style="display: none;">

    <div id="motivationBar">Tipp: ‚ÄûA lustas√°g a gyeng√©k vall√°sa. T√∂rj ki bel≈ële.‚Äù</div>

    <main>
        <div id="tabs">
            <div class="tab-btn active" onclick="showTab('main')">
                <span class="tab-icon">üè†</span>
                <span class="tab-text">F≈ëoldal</span>
            </div>
            <div class="tab-btn" onclick="showTab('notes')">
                <span class="tab-icon">üìù</span>
                <span class="tab-text">Jegyzetek</span>
            </div>
            <div class="tab-btn" onclick="showTab('meals')">
                <span class="tab-icon">üçó</span>
                <span class="tab-text">√âtkez√©s</span>
            </div>
            <div class="tab-btn" onclick="showTab('history')">
                <span class="tab-icon">üìà</span>
                <span class="tab-text">Halad√°s</span>
            </div>
            <div class="tab-btn" onclick="showTab('workouts')">
                <span class="tab-icon">üèãÔ∏è‚Äç‚ôÇÔ∏è</span>
                <span class="tab-text">Edz√©sek</span>
            </div>
        </div>

        <div id="compactGoalsContainer">
            <div class="compact-goal-item">
                <span class="label">S√∫ly ‚öñÔ∏è</span>
                <span class="value value-top" id="compactWeightTop">--/-- kg</span>
                <div class="compact-progress-bar-container">
                    <div class="compact-progress-bar" id="compactWeightBar"></div>
                </div>
                <span class="value value-bottom" id="compactWeightBottom">M√©g...</span>
            </div>

            <div class="compact-goal-item">
                <span class="label">V√≠z üíß</span>
                <span class="value value-top" id="compactWaterTop">--/-- L</span>
                <div class="compact-progress-bar-container">
                    <div class="compact-progress-bar" id="compactWaterBar"></div>
                </div>
                <span class="value value-bottom" id="compactWaterBottom">M√©g...</span>
            </div>

            <div class="compact-goal-item">
                <span class="label">Kal√≥ria üî•</span>
                <span class="value value-top" id="compactCalTop">--/-- kcal</span>
                <div class="compact-progress-bar-container">
                    <div class="compact-progress-bar" id="compactCalBar"></div>
                </div>
                <span class="value value-bottom" id="compactCalBottom">M√©g...</span>
            </div>

            <div class="compact-goal-item">
                <span class="label">Protein ü•©</span>
                <span class="value value-top" id="compactProteinTop">--/-- g</span>
                <div class="compact-progress-bar-container">
                    <div class="compact-progress-bar" id="compactProteinBar"></div>
                </div>
                <span class="value value-bottom" id="compactProteinBottom">M√©g...</span>
            </div>

            <div class="compact-goal-item">
                <span class="label">Zs√≠r ü•ë</span>
                <span class="value value-top" id="compactFatTop">--/-- g</span>
                <div class="compact-progress-bar-container">
                    <div class="compact-progress-bar" id="compactFatBar"></div>
                </div>
                <span class="value value-bottom" id="compactFatBottom">M√©g...</span>
            </div>

            <div id="compactBtnWrapper">
                <button id="compactChartBtn" onclick="openChartModal()" title="S√∫ly Grafikon">üìà</button>
                <button id="compactEditBtn" onclick="editGoals()" title="C√©lok Be√°ll√≠t√°sa">‚úèÔ∏è</button>
                <button id="quickAddBtn" onclick="openQuickAddModal()" title="Gyors Bejegyz√©s">+</button>
            </div>
        </div>
        <div id="main" class="tab-content active">
            <div id="highlightContainer"></div>

            <div class="flex-container">

                <div class="card" style="flex: 1.5;">
                    <div class="card-header">
                        <h2>‚úÖ C√©lok</h2>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="openArchiveModal()" class="card-header-add-btn">üì•|‚è≥</button>
                            <button onclick="openModal('goalModal')" class="card-header-add-btn">+ √öj c√©l</button>
                        </div>
                    </div>
                    <div id="goalList"></div>
                </div>

                <div class="card" style="flex: 1; display: flex; flex-direction: column; gap: 15px;">

                    <div>
                        <div class="card-header" style="margin-bottom: 5px;">
                            <h2 style="margin:0; font-size: 1.1em;">‚úã Fogadalmak</h2>
                            <button onclick="openModal('vowModal')" class="card-header-add-btn" style="font-size: 0.85em;">+ √öj</button>
                        </div>
                        <div id="vowList"></div>
                    </div>

                    <hr style="border: 0; border-top: 2px #b2dfdb; margin: 5px 0; width: 100%;">

                    <div>
                        <div class="card-header" style="margin-bottom: 5px;">
                            <h2 style="margin:0; font-size: 1.1em;">üéÅ Jutalmak</h2>
                            <div class="header-points-display">
                                <span class="points-icon">üíé</span>
                                <span id="totalPointsDisplay" class="points-number">0</span>
                                <span class="points-label"> p</span>
                            </div>
                        </div>
                        <div id="rewardList"></div>
                        <button onclick="openModal('rewardModal')" class="new-item-button" style="margin-top: 10px; padding: 8px;">+ √öj jutalom</button>
                    </div>

                    <hr style="border: 0; border-top: 2px #b2dfdb; margin: 5px 0; width: 100%;">

                    <div>
                        <div class="card-header" style="margin-bottom: 5px;">
                            <h2 style="margin:0; font-size: 1.1em;">üîî Eml√©keztet≈ëk</h2>
                            <button onclick="openModal('reminderModal')" class="card-header-add-btn" style="font-size: 0.85em;">+ √öj</button>
                        </div>
                        <div id="reminderList" class="log" style="max-height: 300px; overflow-y: auto; border: none; background: transparent; padding: 0;">
                            <p>Nincsenek akt√≠v eml√©keztet≈ëk.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

</div> <div id="notes" class="tab-content">
    <div class="card">
        <div class="card-header">
            <button onclick="openAddNoteModal()" class="card-header-add-btn new-note-btn-left">+ √öj jegyzet</button>
        </div>
        <div id="notesList"></div>
    </div>
</div>
<div id="meals" class="tab-content">

    <div class="card">
        <div class="card-header">
            <div class="card-header">
                <h2>Mentett √©telek</h2>
                <div style="display: flex; gap: 8px;">
                    <button onclick="openMealExportModal()" class="card-header-add-btn" style="background: #004d40;" title="√ñsszes √©tel export√°l√°sa sz√∂vegk√©nt">üì§ Export</button>
                    <button onclick="openMealImportModal()" class="card-header-add-btn" style="background: #004d40;" title="√âtelek import√°l√°sa sz√∂vegb≈ël">üì• Import</button>
                </div>
            </div>
        </div>
        <input type="text" id="mealSearchInput" placeholder="üîç √âtel keres√©se..." oninput="renderMeals()" style="margin-bottom: 0px;">
        <div id="mealList">
        </div>
        <button onclick="openMealModal()" class="new-item-button">+ √öj √©tel hozz√°ad√°sa</button>
    </div>
</div>

<div id="history" class="tab-content">
    <div class="card">
        <h2>üìÖ Adat T√∂rt√©net (S√∫ly, V√≠z, Kal√≥ria, Protein)</h2>
        <div id="historyList" class="log"></div>
    </div>

    <div class="card">
        <h2>üíé Pont T√∂rt√©net</h2>
        <div id="pointsHistoryList" class="log"></div>
    </div>
    <div class="card">
        <h2>üìú Napl√≥</h2>
        <div class="log" id="activityLog"></div>
        <button style="margin-top:10px" onclick="clearAllLogs()">üßπ Napl√≥ t√∂rl√©se</button>
    </div>

    <div class="card fade-in" id="controlPanel">
        <h2>üß† Fejedelem Kontrollpanel</h2>
        <p>Adatment√©s, vissza√°ll√≠t√°s √©s teljes reset</p>
        <button onclick="exportData()">üíæ Export√°l√°s</button>
        <button onclick="document.getElementById('importFile').click()">üìÇ Import√°l√°s</button>
        <input type="file" id="importFile" accept=".json" onchange="importData(event)">
        <button style="background:#b71c1c" onclick="resetAll()">‚ö†Ô∏è Teljes reset</button>
        <button onclick="handleLogout()" style="background:#555">üö™ Kijelentkez√©s</button>
    </div>
</div>

<div id="workouts" class="tab-content">
    <div class="card">
        <div class="card-header">
            <span>Edz√©sek kategori√°ja:</span>
            <select id="workoutGoalFilter" onchange="handleWorkoutFilterChange()" style="padding: 6px; border-radius: 10px; border: 1px solid #ccc; background-color: white;">
                <option value="">-- Minden akt√≠v c√©l --</option>
            </select>
        </div>
        <div id="workoutGoalList" style="margin-top: 15px;">
        </div>
        <div class="card">
            <div class="card-header">
                <h2>üèãÔ∏è‚Äç‚ôÇÔ∏è R√∂gz√≠tett edz√©sek</h2>
                <button onclick="openWorkoutModal()" class="card-header-add-btn">+ √öj edz√©s r√∂gz√≠t√©se</button>
            </div>
            <div id="workoutList">
            </div>
        </div>


    </div>

</div>

</main>
<div class="modal" id="noteViewModal">
    <div class="modal-content">
        <h3 id="noteViewTitle">Jegyzet c√≠me</h3>
        <div id="noteViewText">
            Jegyzet tartalma...
        </div>
        <div style="text-align:center;margin-top:15px;">
            <button style="background:#ccc;color:black;" onclick="closeModal('noteViewModal')">Bez√°r√°s</button>
        </div>
    </div>
</div>

<div class="modal" id="chartModal">
    <div class="modal-content" id="chartModalContent">
        <h3>üìà S√∫ly Grafikon</h3>
        <canvas id="progressChart"></canvas>
        <div style="text-align:center;margin-top:15px;">
            <button style="background:#ccc;color:black;" onclick="closeModal('chartModal')">Bez√°r√°s</button>
        </div>
    </div>
</div>
<div class="modal" id="noteModal">
    <div class="modal-content">
        <h3>üìù √öj jegyzet</h3>
        <label for="noteTitleInput">C√≠m</label>
        <input id="noteTitleInput" type="text" placeholder="Jegyzet c√≠me...">

        <label for="noteCategoryInput">Kateg√≥ria (opcion√°lis)</label>
        <input id="noteCategoryInput" type="text" placeholder="pl. Edz√©sterv, Bev√°s√°rl√°s..." list="noteCategoryDatalist">
        <datalist id="noteCategoryDatalist"></datalist>

        <label for="noteTextInput">Sz√∂veg</label>
        <textarea id="noteTextInput" rows="6" placeholder="√çrj ide valamit..."></textarea>

        <div style="text-align:center;margin-top:15px;">
            <button onclick="saveNote()">‚úÖ Ment√©s</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('noteModal')">M√©gse</button>
        </div>
    </div>
</div>
<div class="modal" id="goalSetupModal">
    <div class="modal-content">
        <h3>üéØ C√©lok be√°ll√≠t√°sa</h3>
        <label>Ide√°lis s√∫ly (kg)</label>
        <input id="goalWeightInput" type="number" placeholder="pl. 75">
        <label>Napi v√≠z c√©l (liter)</label>
        <input id="goalWaterInput" type="number" step="0.1" placeholder="pl. 2.5">
        <label>Napi kal√≥ria c√©l (kcal)</label>
        <input id="goalCalInput" type="number" placeholder="pl. 2200">
        <label>Napi protein c√©l (gramm)</label>
        <input id="goalProteinInput" type="number" placeholder="pl. 120">
        <label>Napi zs√≠r c√©l (gramm)</label>
        <input id="goalFatInput" type="number" placeholder="pl. 60">

        <div style="text-align:center;margin-top:15px;">
            <button onclick="saveGoalSettings()">üíæ Ment√©s</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('goalSetupModal')">M√©gse</button>
        </div>
    </div>
</div>
<div class="modal" id="rewardModal">
    <div class="modal-content">
        <h3>üéÅ √öj Jutalom</h3>
        <label>Jutalom neve</label>
        <input id="rewardNameInput" type="text" placeholder="pl. Egy szelet s√ºti">

        <label>√År (Pont)</label>
        <input id="rewardCostInput" type="number" placeholder="pl. 50">

        <div style="text-align:center;margin-top:15px;">
            <button onclick="saveReward()">üíæ Ment√©s</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('rewardModal')">M√©gse</button>
        </div>
    </div>
</div>
<div class="modal" id="vowModal">
    <div class="modal-content">
        <h3>‚úã √öj Fogadalom</h3>
        <label>Mit fogadsz meg? (pl. Nincs k√°v√© 12:00 ut√°n)</label>
        <input id="vowNameInput" type="text" placeholder="A fogadalom t√°rgya...">

        <label>Id≈ëtartam</label>
        <select id="vowDurationInput" style="margin-bottom: 10px;">
            <option value="weekly">Erre a h√©tre</option>
            <option value="monthly">Erre a h√≥napra</option>
        </select>

        <label>Napi jutalom (Pont)</label>
        <input id="vowPointsInput" type="number" placeholder="pl. 15">

        <div style="background: #ffebee; padding: 10px; border-radius: 8px; border: 1px solid #ef9a9a; margin-top: 10px;">
            <h4 style="margin-top:0; color: #c62828;">‚ö†Ô∏è K√∂vetkezm√©ny (Opcion√°lis)</h4>
            <label>B√ºntet√©s feladat (pl. 100 fekv≈ët√°masz)</label>
            <input id="vowPenaltyInput" type="text" placeholder="Ha megszeged...">

            <label>Levon√°s ha nem teljes√≠ted a b√ºntet√©st (Pont)</label>
            <input id="vowPenaltyPointsInput" type="number" placeholder="pl. 50">
        </div>

        <label style="margin-top: 10px;">Alc√©lok (opcion√°lis)</label>
        <textarea id="vowSubGoalsInput" rows="3" placeholder="Minden sor egy alc√©l..."></textarea>

        <div style="text-align:center;margin-top:15px;">
            <button onclick="saveVow()">‚úÖ Fogadalom T√©tel</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('vowModal')">M√©gse</button>
        </div>
    </div>
</div>

<div class="modal" id="goalModal">
    <div class="modal-content">
        <h3>üéØ √öj C√©l</h3>
        <input id="goalNameInput" type="text" placeholder="C√©l neve pl. 10.000 l√©p√©s">
        <input id="goalPointsInput" type="number" placeholder="Pont √©rt√©k pl. 10 (0 is lehet)">
        <input id="goalCategoryInput" type="text" placeholder="Kateg√≥ria (v√°lassz vagy √≠rj be √∫jat,opcion√°lis)" list="categoryDatalist">
        <datalist id="categoryDatalist">
        </datalist>
        <textarea id="goalSubGoalsInput" rows="7" placeholder="&#10;Alc√©lok (opcion√°lis, minden sor egy alc√©l)&#10;Jel n√©lk√ºli sorok automatikusan pip√°lhat√≥k.&#10;Form√°z√°si jelek az alc√©lokhoz::&#10;# ‚Üí C√≠msor (csak sz√∂veg, nem pip√°lhat√≥)&#10;--- ‚Üí Elv√°laszt√≥, r√©szek sz√©tv√°laszt√°s√°ra&#10;*** ‚Üí Opcion√°lis c√©l jel√∂l√©se"></textarea>
        <div style="margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
            <label for="goalStartDateInput" style="margin-bottom: 5px;">Megjelen√©s d√°tuma (opcion√°lis)</label>
            <input type="date" id="goalStartDateInput" style="margin-bottom: 0;">
        </div>

        <div style="margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <label for="goalIsPriorityInput" style="margin: 0; cursor: pointer; font-weight: bold; color: #c62828;">Fontos c√©l? (Kiemel√©s)</label>
                <input type="checkbox" id="goalIsPriorityInput" style="width: auto; margin: 0; transform: scale(1.3);">
            </div>
        </div>

        <div style="margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <label for="goalIsRecurringInput" style="margin: 0; cursor: pointer;">Ism√©tl≈ëd≈ë c√©l?</label>
                <input type="checkbox" id="goalIsRecurringInput" onchange="document.getElementById('goalRecurrenceOptions').style.display = this.checked ? 'block' : 'none'" style="width: auto; margin: 0; transform: scale(1.3);">
            </div>

            <div id="goalRecurrenceOptions" style="display: none; margin-top: 10px;">
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <label style="margin: 0;">Minden</label>
                    <input type="number" id="goalRecurrenceInterval" value="1" style="width: 60px; margin: 0;">
                    <select id="goalRecurrenceFrequency" style="flex: 1; margin: 0;">
                        <option value="daily">Nap</option>
                        <option value="weekly">H√©t</option>
                        <option value="monthly">H√≥nap</option>
                        <option value="yearly">√âv</option>
                    </select>
                </div>

                <div style="margin-top: 10px; margin-bottom: 15px;">
                    <label for="goalRecurrenceStartDateInput" style="margin-bottom: 5px;">Ism√©tl≈ëd√©s kezdete (opcion√°lis)</label>
                    <input type="date" id="goalRecurrenceStartDateInput" style="margin: 0; width: 100%;">
                </div>

                <label style="margin-top: 10px; margin-bottom: 5px;">Befejez√©s</label>
                <div style="padding-left: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <input type="radio" name="goalEndCondition" id="goalEndNever" value="never" checked style="width: auto; margin: 0;">
                        <label for="goalEndNever" style="margin: 0; width: 100%;">Soha</label>
                    </div>

                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <input type="radio" name="goalEndCondition" id="goalEndCount" value="count" style="width: auto; margin: 0;">
                        <label for="goalEndCount" style="margin: 0; width: 100%;">Ennyi ut√°n:</label>
                        <input type="number" id="goalEndCountInput" value="5" style="width: 60px; margin: 0;">
                        <span style="flex-shrink: 0;">el≈ëfordul√°s</span>
                    </div>

                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="goalEndCondition" id="goalEndDate" value="date" style="width: auto; margin: 0;">
                        <label for="goalEndDate" style="margin: 0;">Ekkor:</label>
                        <input type="date" id="goalEndDateInput" style="width: 100%; margin: 0;">
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align:center;margin-top:15px;">
            <button onclick="saveGoal()">‚úÖ Ment√©s</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('goalModal')">M√©gse</button>
        </div>
    </div>
</div>
<div class="modal" id="editModal" style="z-index: 2000;">
    <div class="modal-content">
        <h3 id="editTitle">‚úèÔ∏è Szerkeszt√©s</h3>

        <label id="editLabel1"></label>
        <input id="editInput1" type="text">

        <label id="editLabel2"></label>
        <input id="editInput2" type="number">

        <label id="editLabel3" style="display:none;"></label>
        <input id="editInput3" type="text" style="display:none;">
        <label id="editLabelSubGoals" style="display:none;">Alc√©lok (minden sor egy alc√©l)</label>
        <textarea id="editInputSubGoals" rows="5" style="display:none;"></textarea>

        <label id="editLabelText" style="display:none;">Sz√∂veg</label>
        <textarea id="editInputText" style="display:none;"></textarea>

        <div id="editPriorityField" style="display: none; margin-top: 10px; padding: 5px; background: #f1f8e9; border-radius: 8px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <label for="editIsPriorityInput" style="margin: 0; cursor: pointer; font-weight: bold; color: #c62828;">Fontos c√©l? (Kiemel√©s)</label>
                <input type="checkbox" id="editIsPriorityInput" style="width: auto; margin: 0; transform: scale(1.3);">
            </div>
        </div>
        <div id="editStartDateField" style="display: none; margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
            <label for="editStartDateInput" style="margin-bottom: 5px;">Megjelen√©s d√°tuma (opcion√°lis)</label>
            <input type="date" id="editStartDateInput" style="margin-bottom: 0;">
        </div>

        <div id="editRecurringFields" style="display: none; margin-top: 10px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <label for="editIsRecurringInput" style="margin: 0; cursor: pointer;">Ism√©tl≈ëd≈ë c√©l?</label>
                <input type="checkbox" id="editIsRecurringInput" onchange="document.getElementById('editRecurrenceOptions').style.display = this.checked ? 'block' : 'none'" style="width: auto; margin: 0; transform: scale(1.3);">
            </div>

            <div id="editRecurrenceOptions" style="display: none; margin-top: 10px;">

                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <label style="margin: 0;">Minden</label>
                    <input type="number" id="editRecurrenceInterval" value="1" style="width: 60px; margin: 0;">
                    <select id="editRecurrenceFrequency" style="flex: 1; margin: 0;">
                        <option value="daily">Nap</option>
                        <option value="weekly">H√©t</option>
                        <option value="monthly">H√≥nap</option>
                        <option value="yearly">√âv</option>
                    </select>
                </div>

                <div style="margin-top: 10px; margin-bottom: 15px;">
                    <label for="editRecurrenceStartDateInput" style="margin-bottom: 5px;">Ism√©tl≈ëd√©s kezdete (opcion√°lis)</label>
                    <input type="date" id="editRecurrenceStartDateInput" style="margin: 0; width: 100%;">
                </div>
                <label>Ism√©tl≈ëd√©s befejez√©s:</label>
                <div style="padding-left: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <input type="radio" name="editEndCondition" id="editEndNever" value="never" checked style="width: auto; margin: 0;">
                        <label for="editEndNever" style="margin: 0; width: 100%;">Soha</label>
                    </div>

                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <input type="radio" name="editEndCondition" id="editEndCount" value="count" style="width: auto; margin: 0;">
                        <label for="editEndCount" style="margin: 0; width: 100%;">Ennyi ut√°n:</label>
                        <input type="number" id="editEndCountInput" value="5" style="width: 60px; margin: 0;">
                        <span style="flex-shrink: 0;">el≈ëfordul√°s</span>
                    </div>

                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="editEndCondition" id="editEndDate" value="date" style="width: auto; margin: 0;">
                        <label for="editEndDate" style="margin: 0;">Ekkor:</label>
                        <input type="date" id="editEndDateInput" style="width: 100%; margin: 0;">
                    </div>
                </div>
            </div>
        </div>
        <div id="editMealFields" style="display: none;">
            <label for="editMealType">T√≠pus</label>
            <select id="editMealType">
                <option value="unit">Darab alap√∫</option>
                <option value="weight">S√∫ly alap√∫ (100g)</option>
            </select>
            <label for="editMealKcal">Kal√≥ria (kcal)</label>
            <input id="editMealKcal" type="number" placeholder="pl. 150">
            <label for="editMealProtein">Feh√©rje (g)</label>
            <input id="editMealProtein" type="number" placeholder="pl. 12">
            <label for="editMealFat">Zs√≠r (g)</label>
            <input id="editMealFat" type="number" placeholder="pl. 8">
        </div>

        <div style="text-align:center;margin-top:15px;">
            <button onclick="confirmEdit()">üíæ Ment√©s</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('editModal')">M√©gse</button>
        </div>
    </div>
</div>

<div class="modal" id="archiveModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>üì•|‚è≥ Archiv√°lt vagy id≈ëz√≠tett c√©lok</h3>
        <div id="archivedGoalList" style="max-height: 400px; overflow-y: auto;">
        </div>
        <div style="text-align:center;margin-top:15px;">
            <button style="background:#ccc;color:black;" onclick="closeModal('archiveModal')">Bez√°r√°s</button>
        </div>
    </div>
</div>

<div class="modal" id="mealModal">
    <div class="modal-content">
        <h3>√öj √©tel hozz√°ad√°sa</h3>
        <label for="mealNameInput">√âtel neve</label>
        <input id="mealNameInput" type="text" placeholder="pl. F≈ëtt toj√°s">

        <label for="mealCategoryInput">Kateg√≥ria (opcion√°lis)</label>
        <input id="mealCategoryInput" type="text" placeholder="pl. H√∫sok, Z√∂lds√©gek..." list="mealCategoryDatalist">
        <datalist id="mealCategoryDatalist"></datalist>

        <label for="mealTypeSelect">Sz√°mol√°s t√≠pusa</label>
        <select id="mealTypeSelect" onchange="updateMealModalLabels()">
            <option value="unit">Darab alap√∫</option>
            <option value="weight">S√∫ly alap√∫ (100g)</option>
        </select>

        <label id="mealKcalLabel" for="mealKcalInput">Kal√≥ria (kcal/darab)</label>
        <input id="mealKcalInput" type="number" placeholder="pl. 78">

        <label id="mealProteinLabel" for="mealProteinInput">Feh√©rje (g/darab)</label>
        <input id="mealProteinInput" type="number" placeholder="pl. 6">
        <label id="mealFatLabel" for="mealFatInput">Zs√≠r (g/darab)</label>
        <input id="mealFatInput" type="number" placeholder="pl. 4">
        <label for="mealNoteInput">Jegyzet (opcion√°lis)</label>
        <textarea id="mealNoteInput" rows="4" placeholder="Recept, elk√©sz√≠t√©si javaslat, link..."></textarea>
        <div style="text-align:center;margin-top:15px;">
            <button onclick="saveMeal()">‚úÖ Ment√©s</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('mealModal')">M√©gse</button>
        </div>
    </div>
</div>

<div class="modal" id="consumeModal">
    <div class="modal-content">
        <h3 id="consumeMealTitle">√âtel fogyaszt√°sa</h3>
        <p style="text-align: center; font-weight: bold;" id="consumeMealDetails"></p>

        <label id="consumeAmountLabel" for="consumeAmountInput">Mennyis√©g (Darab)</label>
        <input id="consumeAmountInput" type="number" placeholder="pl. 2">

        <div style="text-align:center;margin-top:15px;">
            <button onclick="confirmConsume()">üçΩÔ∏è Fogyaszt√°s</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('consumeModal')">M√©gse</button>
        </div>
    </div>
</div>

<div class="modal" id="quickAddModal">
    <div class="modal-content">
        <h3>‚ö° Gyors Bejegyz√©s</h3>
        <p style="text-align: center; margin-top: -10px; margin-bottom: 15px;">Add meg a mai napi adatokat.</p>

        <label>Jelenlegi s√∫ly (kg) - Fel√ºl√≠rja a mait</label>
        <input id="quickWeightInput" type="number" placeholder="pl. 75.5">

        <label>V√≠z hozz√°ad√°sa (Liter)</label>
        <input id="quickWaterInput" type="number" step="0.1" placeholder="pl. 0.5">

        <label>Kal√≥ria hozz√°ad√°sa (kcal)</label>
        <input id="quickCalInput" type="number" placeholder="pl. 500">

        <label>Protein hozz√°ad√°sa (gramm)</label>
        <input id="quickProteinInput" type="number" placeholder="pl. 30">

        <label>Zs√≠r hozz√°ad√°sa (gramm)</label>
        <input id="quickFatInput" type="number" placeholder="pl. 15">

        <div style="text-align:center;margin-top:15px;">
            <button onclick="saveQuickAdd()">üíæ Ment√©s √©s Bez√°r√°s</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('quickAddModal')">M√©gse</button>
        </div>
    </div>
</div>
<div class="modal" id="privacyModal" style="z-index: 3000;">
    <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
        <h3>üîí Adatkezel√©si T√°j√©koztat√≥</h3>
        <div style="text-align: left; font-size: 0.9em; line-height: 1.5; color: #333;">
            <p><strong>Utols√≥ friss√≠t√©s:</strong> 2023. [Aktu√°lis D√°tum]</p>

            <h4>1. Bevezet√©s</h4>
            <p>√údv√∂zl√ºnk a FitGarden 2.0 alkalmaz√°sban ("Szolg√°ltat√°s"). Jelen Adatkezel√©si T√°j√©koztat√≥ c√©lja, hogy r√©szletesen ismertesse, milyen adatokat gy≈±jt√ºnk, hogyan haszn√°ljuk azokat, √©s milyen jogai vannak √ñnnek ("Felhaszn√°l√≥") a GDPR (√Åltal√°nos Adatv√©delmi Rendelet) √©rtelm√©ben.</p>

            <h4>2. Az Adatkezel≈ë</h4>
            <p>A Szolg√°ltat√°s √ºzemeltet≈ëje √©s az adatok kezel≈ëje: [IDE √çRD A NEVED VAGY C√âGED NEV√âT].<br>
                Kapcsolat: [IDE √çRD AZ EMAIL C√çMEDET]</p>

            <h4>3. A kezelt adatok k√∂re</h4>
            <p>A Szolg√°ltat√°s haszn√°lata sor√°n az al√°bbi adatokat gy≈±jtj√ºk √©s t√°roljuk:</p>
            <ul>
                <li><strong>Azonos√≠t√≥ adatok:</strong> Email c√≠m, Felhaszn√°l√≥i azonos√≠t√≥ (UID).</li>
                <li><strong>Eg√©szs√©g√ºgyi √©s fitnesz adatok (K√ºl√∂nleges adat):</strong> Tests√∫ly, v√≠zfogyaszt√°s, kal√≥riabevitel, makrot√°panyagok (feh√©rje, zs√≠r), edz√©sek id≈ëpontjai √©s jegyzetei.</li>
                <li><strong>Szok√°sok √©s C√©lok:</strong> Kit≈±z√∂tt c√©lok, fogadalmak, jutalmak, elv√©gzett feladatok, szem√©lyes jegyzetek.</li>
                <li><strong>Technikai adatok:</strong> Napl√≥zott aktivit√°sok (logs), b√∂ng√©sz≈ë √©rtes√≠t√©si be√°ll√≠t√°sok.</li>
            </ul>

            <h4>4. Az adatkezel√©s c√©lja √©s jogalapja</h4>
            <p>Az adatkezel√©s els≈ëdleges c√©lja a Szolg√°ltat√°s ny√∫jt√°sa: az √ñn fejl≈ëd√©s√©nek nyomon k√∂vet√©se, statisztik√°k megjelen√≠t√©se √©s eml√©keztet≈ëk k√ºld√©se.</p>
            <p><strong>Jogalap:</strong> Az √ñn kifejezett, √∂nk√©ntes hozz√°j√°rul√°sa (GDPR 6. cikk (1) a) pont), amelyet a regisztr√°ci√≥kor a jel√∂l≈ën√©gyzet bepip√°l√°s√°val ad meg. Mivel eg√©szs√©g√ºgyi adatokat is kezel√ºnk, a hozz√°j√°rul√°s kiterjed a GDPR 9. cikk (2) a) pontj√°ra is.</p>

            <h4>5. Adatt√°rol√°s √©s Biztons√°g (Harmadik felek)</h4>
            <p>A Szolg√°ltat√°s nem rendelkezik saj√°t szerverrel, az adatok t√°rol√°sa felh≈ëalap√∫ szolg√°ltat√≥n kereszt√ºl t√∂rt√©nik:</p>
            <ul>
                <li><strong>Google Firebase (USA/EU):</strong> Az autentik√°ci√≥t (bel√©p√©s) √©s az adatb√°zist (Firestore) a Google Firebase szolg√°ltatja. A Google megfelel a nemzetk√∂zi adatbiztons√°gi szabv√°nyoknak. Az adatok titkos√≠tott form√°ban ker√ºlnek tov√°bb√≠t√°sra (HTTPS).</li>
            </ul>
            <p>Az √územeltet≈ë mindent megtesz az adatok v√©delme √©rdek√©ben, de az internetes adattov√°bb√≠t√°s nem lehet 100%-osan biztons√°gos.</p>

            <h4>6. Az √ñn jogai</h4>
            <p>√ñnt az al√°bbi jogok illetik meg:</p>
            <ul>
                <li><strong>Hozz√°f√©r√©si jog:</strong> B√°rmikor megtekintheti mentett adatait az alkalmaz√°son bel√ºl.</li>
                <li><strong>Helyesb√≠t√©s joga:</strong> Adatait b√°rmikor m√≥dos√≠thatja vagy jav√≠thatja.</li>
                <li><strong>T√∂rl√©shez val√≥ jog ("Elfeledtet√©s"):</strong> A "Teljes reset" gombbal vagy a fi√≥k t√∂rl√©s√©nek k√©r√©s√©vel v√©glegesen t√∂r√∂lheti adatait az adatb√°zisb√≥l.</li>
                <li><strong>Adathordozhat√≥s√°g:</strong> Az "Export√°l√°s" gombbal JSON form√°tumban let√∂ltheti minden t√°rolt adat√°t.</li>
            </ul>

            <h4>7. Felel≈ëss√©gkiz√°r√°s (Medical Disclaimer)</h4>
            <p style="color: #c62828; font-weight: bold;">A FitGarden 2.0 nem orvosi eszk√∂z.</p>
            <p>Az alkalmaz√°sban megjelen≈ë tippek, motiv√°ci√≥s √ºzenetek √©s sz√°m√≠t√°sok nem min≈ës√ºlnek orvosi tan√°csad√°snak, diagn√≥zisnak vagy kezel√©snek. B√°rmilyen √©trend vagy edz√©sprogram megkezd√©se el≈ëtt konzult√°ljon szakorvossal. Az √územeltet≈ë nem v√°llal felel≈ëss√©get a Szolg√°ltat√°s haszn√°lat√°b√≥l ered≈ë eg√©szs√©g√ºgyi probl√©m√°k√©rt vagy s√©r√ºl√©sek√©rt.</p>

            <h4>8. S√ºtik (Cookies) √©s Helyi t√°rol√°s</h4>
            <p>Az alkalmaz√°s a Google Firebase r√©v√©n technikai s√ºtiket √©s helyi t√°rol√≥t (Local Storage) haszn√°l a bejelentkez√©si munkamenet fenntart√°sa √©rdek√©ben.</p>

            <div style="text-align:center; margin-top: 20px;">
                <button onclick="closeModal('privacyModal')" style="background: #00796b; color: white; padding: 10px 20px;">Bez√°r√°s</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="reminderModal">

    <div class="modal-content">
        <h3>üîî √öj eml√©keztet≈ë</h3>
        <p>Kapj √©rtes√≠t√©st a b√∂ng√©sz≈ëdt≈ël a megadott id≈ëpontban. A funkci√≥ haszn√°lat√°hoz enged√©lyezned kell az √©rtes√≠t√©seket, ha a b√∂ng√©sz≈ë r√°k√©rdez.</p>
        <label for="reminderTextInput">Eml√©keztet≈ë sz√∂vege</label>
        <input type="text" id="reminderTextInput" placeholder="pl. Idd meg a vizet!">
        <label for="reminderTimeInput">Id≈ëpont</label>
        <input type="datetime-local" id="reminderTimeInput">
        <div style="margin-top: 15px; padding: 10px; background: #f1f8e9; border-radius: 8px;">
            <label for="reminderHighlightCheck" style="display:inline; margin-right: 10px; cursor: pointer;">Kiemel√©s a f≈ëoldalon?(ett≈ël a napt√≥l l√°tszik)</label>
            <input type="checkbox" id="reminderHighlightCheck" style="width: auto; margin: 0; transform: scale(1.3);">
            <input type="date" id="reminderHighlightDateInput" style="margin-top: 5px;">
        </div>
        <div style="text-align:center;margin-top:15px;">
            <button onclick="addReminder()">üíæ Eml√©keztet≈ë Ment√©se</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('reminderModal')">M√©gse</button>
        </div>
    </div>
</div>
<div class="modal" id="rewardModal">
    <div class="modal-content">
        <h3>üéÅ √öj Jutalom</h3>
        <label>Jutalom neve</label>
        <input id="rewardNameInput" type="text" placeholder="pl. Egy szelet s√ºti">

        <label>√År (Pont)</label>
        <input id="rewardCostInput" type="number" placeholder="pl. 50">

        <div style="text-align:center;margin-top:15px;">
            <button onclick="saveReward()">üíæ Ment√©s</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('rewardModal')">M√©gse</button>
        </div>
    </div>
</div>
<div class="modal" id="workoutModal">
    <div class="modal-content">
        <h3>üìÖ √öj edz√©s r√∂gz√≠t√©se</h3>
        <p style="text-align: center; margin-top: -10px; margin-bottom: 15px;">V√°laszd ki a napot.</p>

        <label for="workoutDateInput">Edz√©s napja</label>
        <input type="date" id="workoutDateInput">

        <div style="text-align:center;margin-top:15px;">
            <button onclick="addWorkout()">üèãÔ∏è‚Äç‚ôÇÔ∏è Edz√©s r√∂gz√≠t√©se</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('workoutModal')">M√©gse</button>
        </div>
    </div>
</div>
<div class="modal" id="mealImportModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>üì• √âtelek T√∂meges Import√°l√°sa</h3>
        <p>Illeszd be a sz√∂veget a megadott s√©ma alapj√°n. Az √©teleket "---" (h√°rom k√∂t≈ëjel) sorral v√°laszd el.</p>

        <label for="mealImportText">Import√°land√≥ √©telek:</label>
        <textarea id="mealImportText" rows="10" placeholder="√âtel neve: Csirkemell
Kateg√≥ria: H√∫sok
T√≠pus: weight
Kal√≥ria (kcal): 165
Feh√©rje (g) 31
Zs√≠r (g) 3.6
---
√âtel neve: F≈ëtt Toj√°s
Kateg√≥ria: Egy√©b
T√≠pus: unit
Kal√≥ria (kcal): 78
Feh√©rje (g) 6
Zs√≠r (g) 5
"></textarea>

        <div style="text-align:center;margin-top:15px;">
            <button onclick="processMealImport()">‚úÖ Import√°l√°s</button>
            <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('mealImportModal')">M√©gse</button>
        </div>
    </div>
</div>

<div class="modal" id="mealExportModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>üì§ √âtelek T√∂meges Export√°l√°sa</h3>
        <p>Az al√°bbi sz√∂veg tartalmazza az √∂sszes mentett √©teledet. M√°sold ki √©s mentsd el egy sz√∂veges f√°jlba.</p>
        <textarea id="mealExportText" rows="10" readonly style="background: #f4f4f4; color: #333; font-family: monospace;"></textarea>
        <div style="text-align:center;margin-top:15px;">
            <button style="background:#ccc;color:black;" onclick="closeModal('mealExportModal')">Bez√°r√°s</button>
        </div>
    </div>
</div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

<script>
    // Your web app's Firebase configuration
	const firebaseConfig = {
      apiKey: "AIzaSyCZJLWZFJFEFWQqZYmAcZjgqoc88FDfPwQ",
      authDomain: "habit-tracker-32c11.firebaseapp.com",
      databaseURL: "https://habit-tracker-32c11-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "habit-tracker-32c11",
      storageBucket: "habit-tracker-32c11.appspot.com",
      messagingSenderId: "637775270587",
      appId: "1:637775270587:web:11b31d9f64510d81c20f9e",
      measurementId: "G-SS9TX286CF"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Create global variables to access Firebase services
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null; // This will be set on login
	let workoutTabCategory = "Edz√©s";

    console.log("Firebase is connected!");
	loadSavedTheme();
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ===== √öJ FUNKCI√ì: JEGYZET KATEG√ìRIA LISTA L√âTREHOZ√ÅSA =====
    function populateNoteCategoryDatalist() {
      const datalist = document.getElementById('noteCategoryDatalist');
      if (!datalist) return;

      datalist.innerHTML = ""; // T√∂r√∂lj√ºk a r√©gi opci√≥kat

      // √ñsszegy≈±jtj√ºk a megl√©v≈ë kateg√≥ri√°kat (csak egyedi √©rt√©kek)
      const existingCategories = new Set(
        notes
        .map(note => note.category)
        .filter(category => category) // Csak a l√©tez≈ë kateg√≥ri√°k
      );

      // Hozz√°adjuk ≈ëket a list√°hoz
      existingCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        datalist.appendChild(option);
      });
    }

    function populateMealCategoryDatalist() {
      const datalist = document.getElementById('mealCategoryDatalist');
      if (!datalist) return;
      datalist.innerHTML = ""; // T√∂r√∂lj√ºk a r√©gi opci√≥kat
      const existingCategories = new Set(
        meals
        .map(meal => meal.category)
        .filter(category => category) // Csak a l√©tez≈ë kateg√≥ri√°k
      );
      existingCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        datalist.appendChild(option);
      });
    }
    // ======= POPUP VEZ√âRL√âS =======
function openModal(id) {
      document.getElementById(id).style.display = 'flex';
      // HOZZ√ÅADVA: Kateg√≥ria lista felt√∂lt√©se, amikor a c√©l modalt nyitjuk meg
      if (id === 'goalModal') {
        populateCategoryDatalist();
        // T√∂r√∂lj√ºk a r√©gi alc√©l bevitelt
        document.getElementById("goalSubGoalsInput").value = "";
        // √öJ: Ism√©tl≈ëd√©s alaphelyzetbe √°ll√≠t√°sa
        document.getElementById("goalIsRecurringInput").checked = false;
        document.getElementById("goalRecurrenceOptions").style.display = "none";
        document.getElementById("goalRecurrenceFrequency").value = "daily";
		document.getElementById("goalIsPriorityInput").checked = false; // √öJ
        document.getElementById("goalStartDateInput").value = ""; // EZ AZ √öJ SOR
      }
	  // === EZT A BLOKKOT ILLESZD BE IDE ===
      if (id === 'reminderModal') {
        checkNotificationPermission(); // Enged√©lyk√©r√©s
        // D√°tum mez≈ë alap√©rt√©kre √°ll√≠t√°sa
        document.getElementById("reminderHighlightDateInput").value = toDateInputString(new Date());
        // R√©gi √©rt√©kek t√∂rl√©se (biztons√°g kedv√©√©rt)
        document.getElementById("reminderTextInput").value = "";
        document.getElementById("reminderTimeInput").value = "";
        document.getElementById("reminderHighlightCheck").checked = false;
      }
    }
	// ===== √öJ FUNKCI√ì: √âTEL IMPORT MODAL MEGNYIT√ÅSA =====
function openMealImportModal() {
  // Kit√∂r√∂lj√ºk a r√©gi sz√∂veget
  document.getElementById("mealImportText").value = "";
  openModal('mealImportModal');
}

// ===== √öJ FUNKCI√ì: √âTEL IMPORT FELDOLGOZ√ÅSA =====
async function processMealImport() {
  const text = document.getElementById("mealImportText").value;
  if (text.trim() === "") {
    return alert("A sz√∂vegmez≈ë √ºres!");
  }

  // 1. A teljes sz√∂veg sz√©tv√°g√°sa "---" ment√©n
  const blocks = text.split('---');
  let successCount = 0;
  let failedCount = 0;

  // 2. V√©gigmegy√ºnk minden √©tel-blokon
  for (const block of blocks) {
    if (block.trim() === "") continue; // √úres blokkok √°tugr√°sa

    try {
      // 3. Regex (regul√°ris kifejez√©s) haszn√°lata az adatok kinyer√©s√©re
      const name = block.match(/√âtel neve\s*:(.*)/i)?.[1].trim();
      const category = block.match(/Kateg√≥ria\s*:(.*)/i)?.[1].trim(); // EZ VOLT A HI√ÅNYZ√ì SOR
      const type = block.match(/T√≠pus\s*:(.*)/i)?.[1].trim().toLowerCase();
      const kcal = block.match(/Kal√≥ria \(kcal\)\s*:(.*)/i)?.[1].trim();
      const protein = block.match(/Feh√©rje \(g\)\s*:?\s*(.*)/i)?.[1].trim();
      const fat = block.match(/Zs√≠r \(g\)\s*:?\s*(.*)/i)?.[1].trim();

      // 4. Adatellen≈ërz√©s
      if (!name || !type || !kcal || !protein || !fat) {
        throw new Error("Hi√°nyz√≥ k√∂telez≈ë mez≈ë (N√©v, T√≠pus, Kcal, Feh√©rje, Zs√≠r).");
      }

      const kcalNum = parseFloat(kcal);
      const proteinNum = parseFloat(protein);
      const fatNum = parseFloat(fat);

      if (isNaN(kcalNum) || isNaN(proteinNum) || isNaN(fatNum)) {
        throw new Error("A Kal√≥ria, Feh√©rje vagy Zs√≠r nem √©rv√©nyes sz√°m.");
      }
      if (type !== 'unit' && type !== 'weight') {
        throw new Error(`√ârv√©nytelen T√≠pus: '${type}'. Csak 'unit' vagy 'weight' lehet.`);
      }

      // 5. √öj √©tel objektum l√©trehoz√°sa
      const newMeal = {
        name: name,
        category: category || null,
        type: type,
        kcal: kcalNum,
        protein: proteinNum,
        fat: fatNum
      };

      // 6. Hozz√°ad√°s a glob√°lis 'meals' t√∂mbh√∂z
      meals.push(newMeal);
      successCount++;

    } catch (e) {
      console.error("√âtel import hiba:", e.message, "\nBlokk:", block);
      failedCount++;
    }
  }

  // 7. Visszajelz√©s √©s friss√≠t√©s
  closeModal('mealImportModal');

  if (successCount > 0) {
    renderMeals(); // Lista friss√≠t√©se
    await logActivity(`üì• ${successCount} √©tel sikeresen import√°lva.`);
  }

  alert(`Import√°l√°s befejezve!\n\nSikeres: ${successCount}\nHib√°s: ${failedCount}`);
}

// ===== √öJ FUNKCI√ì: √âTEL EXPORT MEGNYIT√ÅSA √âS GENER√ÅL√ÅSA =====
function openMealExportModal() {
  const textarea = document.getElementById("mealExportText");

  if (!meals || meals.length === 0) {
    textarea.value = "Nincsenek mentett √©telek, amiket export√°lni lehetne.";
    openModal('mealExportModal');
    return;
  }

  let exportedTextBlocks = [];

  // V√©gigmegy√ºnk az √∂sszes √©telen
  meals.forEach(meal => {
    let block = [];
    block.push(`√âtel neve: ${meal.name}`);
    block.push(`Kateg√≥ria: ${meal.category || ''}`);

    // --- INNEN T√ñR√ñLT√úK A JEGYZET SOROKAT ---

    block.push(`T√≠pus: ${meal.type}`);
    block.push(`Kal√≥ria (kcal): ${meal.kcal}`);

    // --- M√ìDOS√çTVA: Hozz√°adtuk a kett≈ëspontot a s√©ma szerint ---
    block.push(`Feh√©rje (g): ${meal.protein}`);
    block.push(`Zs√≠r (g): ${meal.fat}`);

    exportedTextBlocks.push(block.join('\n'));
  });

  // √ñsszef≈±zz√ºk a blokkokat a "---" elv√°laszt√≥val
  textarea.value = exportedTextBlocks.join('\n---\n');
  openModal('mealExportModal');
}
    // √öJ: Az √©tel modal megnyit√°sa (alaphelyzetbe √°ll√≠t√°s)
    function openMealModal() {
      // Ez biztos√≠tja, hogy szerkeszt√©s helyett "√∫j" m√≥dban ny√≠ljon meg
      editTarget = null;

      document.getElementById('mealModal').querySelector('h3').textContent = "√öj √©tel hozz√°ad√°sa";
      document.getElementById("mealNameInput").value = "";
      document.getElementById("mealCategoryInput").value = ""; // <- HOZZ√ÅADVA
      document.getElementById("mealTypeSelect").value = "unit";
      document.getElementById("mealKcalInput").value = "";
      document.getElementById("mealProteinInput").value = "";
      updateMealModalLabels(); // C√≠mk√©k friss√≠t√©se
      populateMealCategoryDatalist(); // <- HOZZ√ÅADVA

      openModal('mealModal');
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
      // Biztos√≠tjuk, hogy a szerkeszt√©s mez≈ëi elrejtsenek, amikor bez√°rjuk
      if (id === 'editModal') {
        document.getElementById("editLabel1").style.display = "block";
        document.getElementById("editInput1").style.display = "block";
        document.getElementById("editLabel2").style.display = "block";
        document.getElementById("editInput2").style.display = "block";
        document.getElementById("editLabel3").style.display = "block";
        document.getElementById("editInput3").style.display = "block";
        document.getElementById("editLabelText").style.display = "none";
        document.getElementById("editInputText").style.display = "none";
        document.getElementById("editMealFields").style.display = "none";
        // Alc√©l mez≈ë elrejt√©se
        document.getElementById("editLabelSubGoals").style.display = "none";
        document.getElementById("editInputSubGoals").style.display = "none";
        // √öJ: Ism√©tl≈ëd≈ë mez≈ëk elrejt√©se
        // √öJ: Ism√©tl≈ëd≈ë mez≈ëk elrejt√©se
        document.getElementById("editRecurringFields").style.display = "none";
        // ID≈êZ√çT√âS MEZ≈ê ELREJT√âSE (KEZDETE)
        document.getElementById("editStartDateField").style.display = "none";
        document.getElementById("editStartDateInput").value = "";
        // ID≈êZ√çT√âS MEZ≈ê ELREJT√âSE (V√âGE)
		document.getElementById("editPriorityField").style.display = "none"; // √öJ
		// √öJ: Ism√©tl≈ëd≈ë mez≈ëk elrejt√©se
        document.getElementById("editRecurringFields").style.display = "none";

        // ===== INNEN ILLESZD BE A 4 SORT =====
        // T√≠pusok vissza√°ll√≠t√°sa az eml√©keztet≈ë szerkeszt√©s ut√°n
        document.getElementById("editInput2").type = "number";
        document.getElementById("editInput3").type = "text";
        document.getElementById("editIsRecurringInput").onchange = function() { document.getElementById('editRecurrenceOptions').style.display = this.checked ? 'block' : 'none' };
      }
    }

    function editGoals() {
      // Refactored to use global vars instead of localStorage
      document.getElementById("goalWeightInput").value = goalWeightSetting || "";
      document.getElementById("goalWaterInput").value = goalWaterSetting || "";
      document.getElementById("goalCalInput").value = goalCaloriesSetting || "";
      document.getElementById("goalProteinInput").value = goalProteinSetting || ""; // HOZZ√ÅADVA
      openModal('goalSetupModal');
    }
    // ===== √öJ GYORS BEJEGYZ√âS FUNKCI√ìK =====
    function openQuickAddModal() {
      // Kit√∂rli a r√©gi beviteli √©rt√©keket
      document.getElementById("quickWeightInput").value = "";
      document.getElementById("quickWaterInput").value = "";
      document.getElementById("quickCalInput").value = "";
      document.getElementById("quickProteinInput").value = "";
	  document.getElementById("quickFatInput").value = "";

      // Bet√∂lti a jelenlegi s√∫lyt, ha van -> EZ A R√âSZ EL LETT T√ÅVOL√çTVA
      // if (dailyProgress.lastWeight > 0) {
      //  document.getElementById("quickWeightInput").value = dailyProgress.lastWeight;
      // }

      openModal('quickAddModal');
    }
    async function saveQuickAdd() {
      const weight = parseFloat(document.getElementById("quickWeightInput").value);
      const water = parseFloat(document.getElementById("quickWaterInput").value);
      const calories = parseFloat(document.getElementById("quickCalInput").value);
      const protein = parseFloat(document.getElementById("quickProteinInput").value);
	  const fat = parseFloat(document.getElementById("quickFatInput").value);

      // S√∫ly r√∂gz√≠t√©se
      if (weight && weight > 0) {
        const transaction = {
          id: Date.now(),
          type: 'weight',
          value: weight,
          date: new Date()
        };
        transactions.push(transaction);
        // A dailyProgress.lastWeight-et a calculateDailyProgress() friss√≠ti
        await logActivity(`‚öñÔ∏è S√∫ly r√∂gz√≠tve: ${weight}kg`);
      }

      // V√≠z hozz√°ad√°sa
      if (water && water > 0) {
        const transaction = {
          id: Date.now(),
          type: 'water',
          value: water,
          date: new Date()
        };
        transactions.push(transaction);
        await logActivity(`üíß V√≠z hozz√°adva: ${water}L`);
      }

      // Kal√≥ria hozz√°ad√°sa
      if (calories && calories > 0) {
        const transaction = {
          id: Date.now(),
          type: 'calories',
          value: calories,
          date: new Date()
        };
        transactions.push(transaction);
        await logActivity(`üî• Kal√≥ria hozz√°adva: ${calories}kcal`);
      }

      // Protein hozz√°ad√°sa
      if (protein && protein > 0) {
        const transaction = {
          id: Date.now(),
          type: 'protein',
          value: protein,
          date: new Date()
        };
        transactions.push(transaction);
        await logActivity(`ü•© Protein hozz√°adva: ${protein}g`);
      }
	  // Zs√≠r hozz√°ad√°sa
      if (fat && fat > 0) {
        const transaction = {
          id: Date.now(),
          type: 'fat',
          value: fat,
          date: new Date()
        };
        transactions.push(transaction);
        await logActivity(`ü•ë Zs√≠r hozz√°adva: ${fat}g`);
      }

      closeModal('quickAddModal');

      // Friss√≠tj√ºk az √∂sszes n√©zetet
      calculateDailyProgress(); // Ez √∫jrasz√°molja a dailyProgress-t
      updateAllSummaries(); // Ez friss√≠ti a kompakt s√°vot
      updateHistory();
      if (document.getElementById('chartModal').style.display === 'flex') {
        updateChart();
      }
    }
    // ===== √öJ KIEMELT EML√âKEZTET≈êK RENDEREL√âSE =====
    function renderHighlights() {
      const container = document.getElementById("highlightContainer");
      // Csak akkor fuss, ha a f≈ëoldali container l√©tezik (teh√°t a F≈ëoldal f√ºl√∂n vagyunk)
      if (!container) return;

      container.innerHTML = "";
      const now = new Date();

      const highlightsToShow = reminders.filter(r =>
        r.highlight &&             // 1. K√©rve van a kiemel√©s
        !r.triggered &&            // 2. M√©g nem j√°rt le az eml√©keztet≈ë
        new Date(r.highlightDate) <= now // 3. El√©rkezett a kiemel√©s kezd≈ë d√°tuma
      );

      // Rendez√©s, hogy a legkor√°bbi legyen fel√ºl
      highlightsToShow.sort((a, b) => new Date(a.time) - new Date(b.time));

      highlightsToShow.forEach(r => {
        const div = document.createElement("div");
        div.className = "highlight-box fade-in"; // Haszn√°ljuk a fade-in anim√°ci√≥t

        const reminderTime = new Date(r.time);
        // D√°tum form√°z√°sa (pl. "2025. 11. 27. 17:00")
        const displayTime = reminderTime.toLocaleString('hu-HU', {
          year: 'numeric',
          month: 'numeric',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Visszasz√°ml√°l√≥ logika
        const diffMs = reminderTime - now;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

        let countdownText = "";
        if (diffDays > 0) {
          countdownText = ` (m√©g ${diffDays} nap, ${diffHours} √≥ra)`;
        } else if (diffHours > 0) {
          countdownText = ` (m√©g ${diffHours} √≥ra)`;
        } else {
          countdownText = " (most esed√©kes!)";
        }

        div.innerHTML = `
          <h3>
            <span>üîî Kiemelt Eml√©keztet≈ë</span>
            <span class="highlight-time">${displayTime}${countdownText}</span>
          </h3>
          <p>${r.text}</p>
        `;
        container.appendChild(div);
      });
    }
    // ===== √öJ FUNKCI√ì: Kompakt n√©zet friss√≠t√©se =====
    function updateCompactSummaries() {
      // C√©lbe√°ll√≠t√°sok
      const gw = parseFloat(goalWeightSetting); // C√©l s√∫ly
      const gwat = parseFloat(goalWaterSetting); // C√©l v√≠z
      const gcal = parseFloat(goalCaloriesSetting); // C√©l kal√≥ria
      const gprot = parseFloat(goalProteinSetting); // C√©l protein
	  const gfat = parseFloat(goalFatSetting); // C√©l zs√≠r

      // Napi halad√°s
      const dp = dailyProgress;

      // S√∫ly logik√°hoz: megkeress√ºk az els≈ë s√∫lybejegyz√©st. Ez lesz az "√∫t" kiindul√≥pontja.
      let startWeight = dp.lastWeight; // Alap√©rtelmezett, ha nincs m√°s
      const firstWeightEntry = transactions.find(t => t.type === 'weight');
      if (firstWeightEntry) {
        startWeight = firstWeightEntry.value;
      }

      // Fels≈ë sz√∂veges elemek
      const compactWeightTop = document.getElementById("compactWeightTop");
      const compactWaterTop = document.getElementById("compactWaterTop");
      const compactCalTop = document.getElementById("compactCalTop");
      const compactProteinTop = document.getElementById("compactProteinTop");
	  const compactFatTop = document.getElementById("compactFatTop");

      // Als√≥ "M√©g X" elemek
      const compactWeightBottom = document.getElementById("compactWeightBottom");
      const compactWaterBottom = document.getElementById("compactWaterBottom");
      const compactCalBottom = document.getElementById("compactCalBottom");
      const compactProteinBottom = document.getElementById("compactProteinBottom");
	  const compactFatBottom = document.getElementById("compactFatBottom");

      // Halad√≥s√°v elemek
      const compactWeightBar = document.getElementById("compactWeightBar");
      const compactWaterBar = document.getElementById("compactWaterBar");
      const compactCalBar = document.getElementById("compactCalBar");
      const compactProteinBar = document.getElementById("compactProteinBar");
	  const compactFatBar = document.getElementById("compactFatBar");

      // Ha nem a f≈ëoldalon vagyunk, ne fusson le
      if (!compactWeightTop) return;

      // --- S√∫ly (JAV√çTOTT logika) ---
      if (gw && dp.lastWeight > 0 && startWeight > 0) {
        const goalDiff = gw - dp.lastWeight; // Mennyi van h√°tra a c√©lig (pl. 69.5 - 76.8 = -7.3)

        // A teljes utaz√°s abszol√∫t √©rt√©ke (kezd≈ë s√∫lyt√≥l a c√©lig)
        const totalJourneyAbs = Math.abs(startWeight - gw);
        // A m√°r megtett √∫t abszol√∫t √©rt√©ke (kezd≈ë s√∫lyt√≥l a jelenlegiig)
        const journeyDoneAbs = Math.abs(startWeight - dp.lastWeight);

        let perc_weight = 0;
        if (totalJourneyAbs === 0) {
          // Ha a c√©l a kezd≈ë s√∫ly, √©s el√©rt√ºk, 100%
          perc_weight = (dp.lastWeight === gw) ? 100 : 0;
        } else {
          perc_weight = (journeyDoneAbs / totalJourneyAbs) * 100;
        }

        if (perc_weight > 100) perc_weight = 100; // Ne menjen 100% f√∂l√©
        if (perc_weight < 0) perc_weight = 0;

        compactWeightTop.textContent = `${dp.lastWeight.toFixed(1)} kg / C√©l: ${gw} kg`;

        // JAV√çTOTT R√âSZ: Csak akkor √≠rja, hogy "C√©l el√©rve", ha a k√ºl√∂nbs√©g 0.
        if (goalDiff.toFixed(1) == 0) { // Kerek√≠tve n√©zz√ºk
          compactWeightBottom.textContent = "C√©l el√©rve! üéâ";
          perc_weight = 100; // Biztos, ami biztos
        } else {
          // A "M√©g" sz√∂veg el≈ëjel√©nek form√°z√°sa
          const diffSign = goalDiff > 0 ? '+' : '';
          compactWeightBottom.textContent = `M√©g ${diffSign}${goalDiff.toFixed(1)} kg`;
        }

        compactWeightBar.style.width = perc_weight + '%';
      } else {
        compactWeightTop.textContent = `${dp.lastWeight > 0 ? dp.lastWeight : '--'} kg / C√©l: ${gw ? gw : '--'} kg`;
        compactWeightBottom.textContent = "Nincs s√∫lyc√©l";
        compactWeightBar.style.width = '0%';
      }

      // --- V√≠z (Marad a helyes logika) ---
      if (gwat) {
        const rem_water = gwat - dp.water;
        let perc_water = (dp.water / gwat) * 100;
        if (perc_water > 100) perc_water = 100;
        if (perc_water < 0) perc_water = 0;

        compactWaterTop.textContent = `${dp.water.toFixed(1)} / ${gwat.toFixed(1)} L`;
        compactWaterBottom.textContent = rem_water > 0 ? `M√©g ${rem_water.toFixed(1)} L` : `C√©l teljes√≠tve!`;
        compactWaterBar.style.width = perc_water + '%';
      } else {
        compactWaterTop.textContent = `${dp.water.toFixed(1)} L`;
        compactWaterBottom.textContent = "Nincs v√≠zc√©l";
        compactWaterBar.style.width = '0%';
      }

      // --- Kal√≥ria (Marad a helyes logika) ---
      if (gcal) {
        const rem_cal = gcal - dp.calories;
        let perc_cal = (dp.calories / gcal) * 100;
        if (perc_cal > 100) perc_cal = 100;
        if (perc_cal < 0) perc_cal = 0;

        compactCalTop.textContent = `${dp.calories.toFixed(0)} / ${gcal.toFixed(0)} kcal`;
        compactCalBottom.textContent = rem_cal > 0 ? `M√©g ${rem_cal.toFixed(0)} kcal` : `C√©l el√©rve!`;
        compactCalBar.style.width = perc_cal + '%';
      } else {
        compactCalTop.textContent = `${dp.calories.toFixed(0)} kcal`;
        compactCalBottom.textContent = "Nincs kal√≥riac√©l";
        compactCalBar.style.width = '0%';
      }

      // --- Protein (Marad a helyes logika) ---
      if (gprot) {
        const rem_prot = gprot - dp.protein;
        let perc_prot = (dp.protein / gprot) * 100;
        if (perc_prot > 100) perc_prot = 100;
        if (perc_prot < 0) perc_prot = 0;

        compactProteinTop.textContent = `${dp.protein.toFixed(0)} / ${gprot.toFixed(0)} g`;
        compactProteinBottom.textContent = rem_prot > 0 ? `M√©g ${rem_prot.toFixed(0)} g` : `C√©l teljes√≠tve!`;
        compactProteinBar.style.width = perc_prot + '%';
      } else {
        compactProteinTop.textContent = `${dp.protein.toFixed(0)} g`;
        compactProteinBottom.textContent = "Nincs proteinc√©l";
        compactProteinBar.style.width = '0%';
      }
	  // --- Zs√≠r (√öJ BLOKK) ---
      if (gfat) {
        const rem_fat = gfat - dp.fat;
        let perc_fat = (dp.fat / gfat) * 100;
        if (perc_fat > 100) perc_fat = 100;
        if (perc_fat < 0) perc_fat = 0;

        compactFatTop.textContent = `${dp.fat.toFixed(0)} / ${gfat.toFixed(0)} g`;
        compactFatBottom.textContent = rem_fat > 0 ? `M√©g ${rem_fat.toFixed(0)} g` : `C√©l teljes√≠tve!`;
        compactFatBar.style.width = perc_fat + '%';
      } else {
        compactFatTop.textContent = `${dp.fat.toFixed(0)} g`;
        compactFatBottom.textContent = "Nincs zs√≠rc√©l";
        compactFatBar.style.width = '0%';
      }
    }
    // They will be filled by loadDataFromFirestore()
    let goals = [];
	let vows = [];
    let rewards = [];
    let notes = [];
    let logs = [];
    let workouts = [];
    let meals = [];
    let reminders = []; // √öJ EML√âKEZTET≈ê T√ñMB
    let totalPoints = 0;
    let transactions = [];
    let archivedGoals = [];
    let pointsLog = []; // √öJ PONT T√ñRT√âNET T√ñMB

    // App settings
    let goalWeightSetting = "";
    let goalWaterSetting = "";
    let goalCaloriesSetting = "";
    let goalProteinSetting = ""; // √öJ
	let goalFatSetting = ""; // √öJ ZS√çR

    // Other global vars
    let chart;
    let editTarget = null;
    let dailyProgress = {
      water: 0,
      calories: 0,
      protein: 0,
	  fat: 0,
      lastWeight: 0,
      date: ""
    }; // 'protein' HOZZ√ÅADVA
    let reminderCheckInterval = null; // √öJ EML√âKEZTET≈ê ID≈êZ√çT≈ê
	// Seg√©df√ºggv√©ny: ISO stringet (amit t√°rolunk) alak√≠t "datetime-local" form√°tumra
    function toLocalISOString(isoString) {
      if (!isoString) return "";
      const date = new Date(isoString);
      const y = date.getFullYear();
      const m = (date.getMonth() + 1).toString().padStart(2, '0');
      const d = date.getDate().toString().padStart(2, '0');
      const h = date.getHours().toString().padStart(2, '0');
      const min = date.getMinutes().toString().padStart(2, '0');
      return `${y}-${m}-${d}T${h}:${min}`;
    }

    // Seg√©df√ºggv√©ny: ISO stringet (amit t√°rolunk) alak√≠t "date" (YYYY-MM-DD) form√°tumra
    function toDateInputString(isoString) {
      if (!isoString) return "";
      const date = new Date(isoString);
      const y = date.getFullYear();
      const m = (date.getMonth() + 1).toString().padStart(2, '0');
      const d = date.getDate().toString().padStart(2, '0');
      return `${y}-${m}-${d}`;
    }
    // ===== √öJ FUNKCI√ì: KATEG√ìRIA LISTA L√âTREHOZ√ÅSA =====
    function populateCategoryDatalist() {
      const datalist = document.getElementById('categoryDatalist');
      if (!datalist) return;

      datalist.innerHTML = ""; // T√∂r√∂lj√ºk a r√©gi opci√≥kat

      // √ñsszegy≈±jtj√ºk a megl√©v≈ë kateg√≥ri√°kat (csak egyedi √©rt√©kek)
      const existingCategories = new Set(
        goals
        .map(goal => goal.category)
        .filter(category => category) // Csak a l√©tez≈ë kateg√≥ri√°k
      );

      // Hozz√°adjuk az archiv√°lt c√©lok kateg√≥ri√°it is
      archivedGoals
        .map(goal => goal.category)
        .filter(category => category)
        .forEach(category => existingCategories.add(category));

      // Hozz√°adjuk ≈ëket a list√°hoz
      existingCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        datalist.appendChild(option);
      });
    }
    // ===== √öJ FUNKCI√ì: EDZ√âS OLDALI KATEG√ìRIA SZ≈∞R≈ê FELT√ñLT√âSE =====
function populateWorkoutCategoryFilter() {
  const select = document.getElementById('workoutGoalFilter');
  if (!select) return;

  const currentValue = select.value; // Ments√ºk el a jelenlegi kiv√°lasztott √©rt√©ket

  select.innerHTML = '<option value="">-- Minden akt√≠v c√©l --</option>'; // Alap√©rtelmezett

  // √ñsszegy≈±jtj√ºk a megl√©v≈ë kateg√≥ri√°kat (csak egyedi √©rt√©kek)
  const existingCategories = new Set();
  goals.map(goal => goal.category).filter(category => category).forEach(category => existingCategories.add(category));
  archivedGoals.map(goal => goal.category).filter(category => category).forEach(category => existingCategories.add(category));

  // Hozz√°adjuk ≈ëket a list√°hoz
  Array.from(existingCategories).sort().forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    select.appendChild(option);
  });

  // Pr√≥b√°ljuk vissza√°ll√≠tani a kiv√°lasztott √©rt√©ket
  // Vagy keress√ºk meg a "workoutTabCategory" glob√°lis v√°ltoz√≥ban megadott kateg√≥ri√°t
  if (currentValue && existingCategories.has(currentValue)) {
    select.value = currentValue;
  } else if (workoutTabCategory && existingCategories.has(workoutTabCategory)) {
    select.value = workoutTabCategory;
  }
}

// ===== √öJ FUNKCI√ì: EDZ√âS OLDALI C√âLOK RENDEREL√âSE SZ≈∞R≈ê ALAPJ√ÅN =====
function renderWorkoutGoals() {
  const list = document.getElementById("workoutGoalList");
  const filter = document.getElementById("workoutGoalFilter");
  if (!list || !filter) return; // Ne fusson le, ha nem az Edz√©s f√ºl√∂n vagyunk

  const selectedCategory = filter.value;
  list.innerHTML = "";

  // 1. C√©lok sz≈±r√©se (csak az akt√≠v, 'goals' list√°b√≥l)
  const visibleGoals = goals
    .map((goal, i) => ({ ...goal, originalIndex: i })) // Eredeti index ment√©se
    .filter(g => {
      // D√°tum sz≈±r√©s (mint a renderGoals-ban)
      const todayISO = toDateInputString(new Date().toISOString());
      if (g.startDate && g.startDate > todayISO) {
         return false;
      }

      // Kateg√≥ria sz≈±r√©s
      if (selectedCategory === "") {
        return true; // Ha "Minden c√©l" van kiv√°lasztva, mindent mutatunk
      }
      return g.category === selectedCategory; // Csak az egyez≈ë kateg√≥ri√°t mutatjuk
    });

  if (visibleGoals.length === 0) {
    if(selectedCategory === "") {
      list.innerHTML = "<p style='text-align:center;'>Nincsenek akt√≠v c√©ljaid.</p>";
    } else {
      list.innerHTML = `<p style='text-align:center;'>Nincsenek akt√≠v c√©lok ebben a kateg√≥ri√°ban: "${selectedCategory}"</p>`;
    }
    return;
  }

  // 2. Renderel≈ë seg√©df√ºggv√©ny (EGYEZNIE KELL A F≈êOLDALIVAL)
  const renderItem = (g, i) => { // 'i' itt m√°r az originalIndex lesz
    const div = document.createElement("div");
    let classList = "goal-item";
    if (g.done) classList += " completed";
    if (g.isPriority) classList += " priority";
    if (g.isPunishment) classList += " punishment";
    div.className = classList;

    // === VISSZASZ√ÅML√ÅL√ÅS √âS LEJ√ÅRAT ELLEN≈êRZ√âS ===
    let countdownHTML = "";
    let isExpired = false;

    if (g.isPunishment && !g.done) {
        const now = Date.now();
        const deadline = g.deadline || (new Date(g.startDate).getTime() + 24 * 60 * 60 * 1000);
        const diff = deadline - now;

        if (diff > 0) {
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const colorStyle = hours < 1 ? "color: #ff5252;" : "color: #ff8a80;";
            countdownHTML = `<span class="punishment-deadline" style="${colorStyle}">‚è≥ H√°tral√©v≈ë id≈ë: ${hours}√≥ ${minutes}p</span>`;
        } else {
            isExpired = true;
            countdownHTML = `<span class="punishment-deadline" style="color: red; font-weight: bold;">‚åõ LEJ√ÅRT - FELDOLGOZ√ÅS...</span>`;
        }
    }

    // === ALC√âLOK RENDEREL√âSE ===
    let subGoalsHTML = "";
    let hasSubGoals = g.subGoals && g.subGoals.length > 0;
    let hasTasks = false;

    if (hasSubGoals) {
      subGoalsHTML = '<div class="subgoal-list">';
      // Ellen≈ërizz√ºk, van-e opcion√°lis feladat a list√°ban a sz√≠nez√©shez
      const hasOptionalTasks = g.subGoals.some(s => s.isOptional);

      g.subGoals.forEach((sg, subIndex) => {
        const sgType = sg.type || 'task';
        switch (sgType) {
          case 'header': subGoalsHTML += `<h4 class="subgoal-header">${sg.text}</h4>`; break;
          case 'separator': subGoalsHTML += `<hr class="subgoal-separator">`; break;
          case 'task': default:
            hasTasks = true;

            if (g.isPunishment && isExpired) {
                subGoalsHTML += `
                  <div style="opacity: 0.6;">
                    <span style="margin-right: 10px;">üö´</span>
                    <span style="text-decoration: line-through;">${sg.text}</span>
                  </div>`;
            } else {
                // === SZ√çNEZ√âSI LOGIKA (F≈êOLDAL MINT√ÅJ√ÅRA) ===
                let bgStyle = '';
                if (sg.isOptional) {
                    bgStyle = 'background-color: #e1f5fe;'; // K√©kes
                } else {
                    if (hasOptionalTasks) {
                        bgStyle = 'background-color: #ffebee;'; // Pirosas (ha van opcion√°lis a list√°ban)
                    } else {
                        bgStyle = 'background-color: transparent;'; // √Åtl√°tsz√≥ (ha nincs opcion√°lis)
                    }
                }

                subGoalsHTML += `
                  <div style="margin-bottom: 2px;">
                    <input type="checkbox" onchange="toggleSubGoal(${i}, ${subIndex})" ${sg.done ? 'checked' : ''}>
                    <span class="${sg.done ? 'subgoal-done' : ''}" style="${bgStyle} color: black; padding: 2px 5px; border-radius: 4px;">${sg.text}</span>
                  </div>`;
            }
            break;
        }
      });
      subGoalsHTML += '</div>';
    }

    let progressBarHTML = "";
    if (hasTasks && !(g.isPunishment && isExpired)) {
      const tasks = g.subGoals.filter(sg => (sg.type || 'task') === 'task');
      const totalTasks = tasks.length;
      const completedTasks = tasks.filter(sg => sg.done).length;
      let progressPercent = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
      progressBarHTML = `
        <div class="subgoal-progress-container">
          <div class="subgoal-progress-fill" style="width: ${progressPercent}%;"></div>
        </div>`;
    }

    // === GOMB MEGJELEN√çT√âSI LOGIKA ===
    let showCheckBtn = false;
    const tasks = (g.subGoals || []).filter(sg => (sg.type || 'task') === 'task');
    const mandatoryTasks = tasks.filter(t => !t.isOptional);

    if (tasks.length === 0) {
       showCheckBtn = true;
    } else {
       if (mandatoryTasks.every(t => t.done)) {
          showCheckBtn = true;
       }
    }
    if (g.done) showCheckBtn = true;

    const priorityIcon = g.isPriority ? 'üìå ' : '';
    const recurringIcon = g.isRecurring ? ' üîÑ' : '';

    // === PONT TARTOM√ÅNY SZ√ÅM√çT√ÅSA ===
    let pointsDisplay = `${g.points} pont`;
    if (hasTasks) {
        const tasks = g.subGoals.filter(sg => (sg.type || 'task') === 'task');
        const mandatoryCount = tasks.filter(t => !t.isOptional).length;
        const totalCount = tasks.length;
        if (mandatoryCount > 0 && totalCount > mandatoryCount) {
             const maxPoints = Math.round(g.points * (totalCount / mandatoryCount));
             pointsDisplay = `${g.points}-${maxPoints} pont`;
        }
    }

    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${priorityIcon}${g.name}${recurringIcon}</div>
        ${countdownHTML}
        ${progressBarHTML} ${subGoalsHTML}
      </div>
      <div class="item-points">
        ${pointsDisplay}
      </div>
      <div class="item-actions">
        ${(g.isPunishment && isExpired) ? '' : `<button class="archive-btn" title="Archiv√°l√°s" onclick="archiveGoal(${i})">üì•</button>`}
        ${(g.isPunishment && isExpired) ? '' : `<button onclick="editGoal(${i})" title="Szerkeszt√©s">‚úèÔ∏è</button>`}
        <button onclick="deleteGoal(${i})" title="T√∂rl√©s">üóëÔ∏è</button>
        ${showCheckBtn && !(g.isPunishment && isExpired) ? (
          g.done ?
          `<button onclick="toggleGoal(${i})" title="Visszavon√°s">‚ùå</button>` :
          `<button onclick="toggleGoal(${i})" title="Teljes√≠t">‚úÖ</button>`
        ) : '' }
      </div>
    `;
    list.appendChild(div);
  };

  // 3. C√©lok renderel√©se
  visibleGoals.forEach(item => {
    renderItem(item, item.originalIndex); // Az eredeti indexet adjuk √°t!
  });
}
// ===== √öJ KEZEL≈êF√úGGV√âNY A SZ≈∞R≈ê V√ÅLTOZ√ÅSAKOR =====
function handleWorkoutFilterChange() {
  // 1. Friss√≠tj√ºk az Edz√©s f√ºl list√°j√°t (ez sz≈±r *a* kateg√≥ri√°ra)
  renderWorkoutGoals();
  // 2. Friss√≠tj√ºk a F≈ëoldal f√ºl list√°j√°t (ez sz≈±r *ki* a kateg√≥ri√°b√≥l)
  renderGoals();
}
	// ===== AUTHENTICATION (NEW FUNCTIONS) =====
    function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPassword').value;
      const errorElement = document.getElementById('loginError');
      errorElement.innerText = "";

      auth.signInWithEmailAndPassword(email, pass)
        .then((userCredential) => {
          const user = userCredential.user;

          // ELLEN≈êRZ√âS: Visszaigazolta az emailt?
          if (user.emailVerified) {
             // IGEN -> Mehet tov√°bb (az onAuthStateChanged majd kezeli a bel√©ptet√©st)
             console.log("User logged in and verified:", user.uid);
          } else {
             // NEM -> Hiba√ºzenet √©s kijelentkeztet√©s
             auth.signOut(); // Kidobjuk
             errorElement.style.color = "red";
             errorElement.innerText = "Hiba: Az email c√≠med m√©g nincs meger≈ës√≠tve! K√©rlek ellen≈ërizd a postafi√≥kodat.";
             // Opcion√°lis: √öjrak√ºld√©s lehet≈ës√©g√©t itt lehetne felaj√°nlani, de az egyszer≈±s√©g kedv√©√©rt most csak jelezz√ºk.
          }
        })
        .catch((error) => {
          errorElement.style.color = "red";
          errorElement.innerText = "Hiba: " + error.message;
          // Magyaros√≠tott hiba√ºzenetek (opcion√°lis)
          if(error.code === 'auth/wrong-password') errorElement.innerText = "Hiba: Hib√°s jelsz√≥.";
          if(error.code === 'auth/user-not-found') errorElement.innerText = "Hiba: Nincs ilyen felhaszn√°l√≥.";
        });
    }

	function handlePasswordReset() {
    const email = document.getElementById('loginEmail').value;
    const errorElement = document.getElementById('loginError');
	errorElement.style.color = "red";
    errorElement.innerText = ""; // Kor√°bbi √ºzenetek t√∂rl√©se

    if (!email) {
      errorElement.style.color = "red"; // Itt √°ll√≠tjuk pirosra
      errorElement.innerText = "K√©rlek, add meg az e-mail c√≠medet a jelsz√≥-vissza√°ll√≠t√°shoz.";
      return;
    }

    // Firebase h√≠v√°s
    auth.sendPasswordResetEmail(email)
      .then(() => {
        // Sikeres e-mail k√ºld√©s
        errorElement.style.color = "#00796b"; // Z√∂ld sz√≠n a siker jelz√©s√©re
        errorElement.innerText = "Jelsz√≥-vissza√°ll√≠t√≥ e-mail elk√ºldve! K√©rlek, ellen≈ërizd a postafi√≥kodat.";
      })
      .catch((error) => {
        // Hiba t√∂rt√©nt
        errorElement.style.color = "red"; // Piros sz√≠n a hib√°ra
        if (error.code === 'auth/user-not-found') {
          errorElement.innerText = "Hiba: Nincs ilyen e-mail c√≠mmel regisztr√°lt felhaszn√°l√≥.";
        } else {
          errorElement.innerText = "Hiba: " + error.message;
        }
      });
  }

    function handleSignUp() {
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPassword').value;
      const privacyChecked = document.getElementById('privacyCheck').checked;
      const errorElement = document.getElementById('loginError');

      errorElement.innerText = "";

      // 1. Adatv√©delmi ellen≈ërz√©s
      if (!privacyChecked) {
        errorElement.style.color = "red";
        errorElement.innerText = "A regisztr√°ci√≥hoz el kell fogadnod az Adatkezel√©si T√°j√©koztat√≥t!";
        return;
      }

      // 2. Firebase regisztr√°ci√≥
      auth.createUserWithEmailAndPassword(email, pass)
        .then((userCredential) => {
          // SIKERES REGISZTR√ÅCI√ì -> EMAIL K√úLD√âS
          const user = userCredential.user;

          user.sendEmailVerification().then(function() {
            // Email elk√ºldve
            alert("Sikeres regisztr√°ci√≥! ‚úâÔ∏è\n\nEgy meger≈ës√≠t≈ë emailt k√ºldt√ºnk a(z) " + email + " c√≠mre.\nK√©rlek, kattints a benne l√©v≈ë linkre a fi√≥kod aktiv√°l√°s√°hoz, majd jelentkezz be √∫jra.");

            // Fontos: Azonnal kijelentkeztetj√ºk, hogy ne l√©pjen be az appba
            auth.signOut();
          }).catch(function(error) {
            // Hiba az email k√ºld√©sn√©l
            console.error("Hiba az email k√ºld√©sekor:", error);
            alert("A regisztr√°ci√≥ siker√ºlt, de a meger≈ës√≠t≈ë emailt nem tudtuk elk√ºldeni. K√©rlek, pr√≥b√°lj meg bel√©pni √©s k√©rj √∫jat.");
            auth.signOut();
          });
        })
        .catch((error) => {
          errorElement.style.color = "red";
          errorElement.innerText = "Hiba: " + error.message;
        });
    }

    function handleLogout() {
      auth.signOut();
    }
    // ===== DATA SYNC (NEW FUNCTIONS) =====
    // A function to get all data from Firestore
    async function loadDataFromFirestore() {
      if (!currentUser) return; // Safety check
      console.log("Loading data from Firestore...");
      const docRef = db.collection('users').doc(currentUser.uid);

      try {
        const doc = await docRef.get();
        if (doc.exists) {
          // Document exists, load the data into our global variables
          const data = doc.data();
          goals = data.goals || [];
		  vows = data.vows || [];
          rewards = data.rewards || [];
          notes = data.notes || [];
          logs = Array.isArray(data.logs) ? data.logs : [];
          workouts = data.workouts || [];
          meals = data.meals || [];
          reminders = data.reminders || []; // √öJ
          archivedGoals = data.archivedGoals || [];
          totalPoints = data.totalPoints || 0;
          transactions = Array.isArray(data.transactions) ? data.transactions : [];
          pointsLog = data.pointsLog || []; // PONTNAPL√ì BET√ñLT√âSE
          // Also load the settings
          goalWeightSetting = data.goalWeight || "";
          goalWaterSetting = data.goalWater || "";
          goalCaloriesSetting = data.goalCalories || "";
          goalProteinSetting = data.goalProtein || "";
		  goalFatSetting = data.goalFat || "";

          // ===== EDZ√âS ADAT MIGR√ÅCI√ì (√öJ) =====
          if (workouts.length > 0 && typeof workouts[0] === 'string') {
            console.log("Migrating workouts data structure...");
            workouts = workouts.map(dateStr => ({
              date: dateStr,
              note: ""
            }));
          }
          // ===== MIGR√ÅCI√ì V√âGE =====

          console.log("Data loaded successfully.");
        } else {
          console.log("No data found for this user, starting fresh.");
        }
      } catch (error) {
        console.error("Error loading data:", error);
        alert("Hiba t√∂rt√©nt az adatok bet√∂lt√©se k√∂zben.");
      }
    }

    // A function to save all data to Firestore
    async function saveDataToFirestore() {
      if (!currentUser) return; // Safety check

      console.log("Saving data to Firestore...");
      const docRef = db.collection('users').doc(currentUser.uid);

      const dataToSave = {
        goals,
		vows,
        rewards,
        notes,
        logs,
        workouts,
        meals,
        reminders, // √öJ
        archivedGoals,
        totalPoints,
        transactions,
        pointsLog, // PONTNAPL√ì MENT√âSE
        goalWeight: goalWeightSetting,
        goalWater: goalWaterSetting,
        goalCalories: goalCaloriesSetting,
        goalProtein: goalProteinSetting,
		goalFat: goalFatSetting,
      };

      try {
        await docRef.set(dataToSave);
        console.log("Data saved successfully.");
      } catch (error) {
        console.error("Error saving data:", error);
      }
    }
    // ===== APP INITIALIZATION (REFACTORED) =====
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // === USER IS LOGGED IN ===

        // BIZTONS√ÅGI ELLEN≈êRZ√âS: Email verifik√°ci√≥
        if (!user.emailVerified) {
            console.log("User is logged in but NOT verified. Signing out.");
            // Ha nincs meger≈ës√≠tve, nem t√∂ltj√ºk be az adatokat, hanem kil√©ptetj√ºk
            auth.signOut();
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            return; // Meg√°ll√≠tjuk a fut√°st
        }

        // Ha id√°ig eljutott, akkor verifik√°lt felhaszn√°l√≥
        currentUser = user;
        console.log("Auth state changed: Logged in as", user.uid);

        document.getElementById('appContainer').style.display = 'block';
        document.getElementById('loginContainer').style.display = 'none';

        // Innent≈ël j√∂n a r√©gi k√≥dod az adatok bet√∂lt√©s√©vel...
        await loadDataFromFirestore();
        await checkRecurringGoals();
        await checkRecurringGoals();
        await checkPendingGoals();
        calculateDailyProgress();
        calculateDailyProgress();
        loadMotivation();
        populateWorkoutCategoryFilter();

        renderAll();
        loadSavedTheme();
        startReminderEngine();
        startReminderEngine();

        startReminderEngine(); // √öJ EML√âKEZTET≈ê MOTOR IND√çT√ÅSA
		} else {
        // === USER IS LOGGED OUT ===
        currentUser = null;
        console.log("Auth state changed: Logged out");

        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';

        // Clear all local data
        goals = [];
        rewards = [];
        notes = [];
        logs = [];
        workouts = [];
        meals = [];
        reminders = []; // √öJ
        archivedGoals = [];
        totalPoints = 0;
        pointsLog = []; // PONTNAPL√ì NULL√ÅZ√ÅSA
        transactions = [];
        goalWeightSetting = "";
        goalWaterSetting = "";
        goalCaloriesSetting = "";
        goalProteinSetting = "";
      }
    });
    // ===== PONTSZ√ÅML√ÅL√ì ANIM√ÅCI√ì =====
    function animatePoints(newValue) {
      const displayElement = document.getElementById("totalPointsDisplay");
      if (!displayElement) return;

      let startValue = parseInt(displayElement.textContent);
      if (isNaN(startValue)) {
        startValue = 0;
      }
      if (startValue === newValue) return;

      const duration = 750;
      const range = newValue - startValue;
      let startTime = null;

      function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        const currentValue = Math.floor(startValue + range * progress);

        displayElement.textContent = currentValue;

        if (progress < 1) {
          window.requestAnimationFrame(step);
        } else {
          displayElement.textContent = newValue;
        }
      }
      window.requestAnimationFrame(step);
    }
    // ===== GRAFIKON MODAL FUNKCI√ì =====
    function openChartModal() {
      openModal('chartModal');
      setTimeout(updateChart, 100);
    }
    // ===== ADATKEZEL≈ê F√úGGV√âNYEK =====
    function calculateDailyProgress() {
      const today = new Date().toISOString().slice(0, 10);
      // 'protein' HOZZ√ÅADVA
      dailyProgress = {
        water: 0,
        calories: 0,
        protein: 0,
		fat: 0,
        lastWeight: 0,
        date: today
      };

      let lastWeightEntry = null;

      if (!Array.isArray(transactions)) {
        console.error("Transactions is not an array!", transactions);
        transactions = [];
        return;
      }

      for (const t of transactions) {
        if (t.type === 'weight' && t.value > 0) {
          lastWeightEntry = t;
        }

        try {
          let entryDate;
          if (t.date && typeof t.date.toDate === 'function') {
            entryDate = t.date.toDate();
          } else {
            entryDate = new Date(t.date);
          }

          if (!entryDate || isNaN(entryDate.getTime())) {
            console.warn("Invalid date object encountered:", t.date);
            continue;
          }

          if (entryDate.toISOString().slice(0, 10) === today) {
            if (t.type === 'water') {
              dailyProgress.water += t.value;
            } else if (t.type === 'protein') { // √öJ
              dailyProgress.protein += t.value;
            } else if (t.type === 'fat') { // √öJ ZS√çR
              dailyProgress.fat += t.value;
            } else if (t.type === 'meal') { // √öJ
              dailyProgress.calories += t.totalKcal;
              dailyProgress.protein += t.totalProtein;
              dailyProgress.fat += t.totalFat || 0; // || 0 a r√©gi adatok miatt
            }
          }
        } catch (e) {
          console.error("D√°tumfeldolgoz√°si hiba a calculateDailyProgress-ben:", e, t.date);
        }
      }

      if (lastWeightEntry) {
        dailyProgress.lastWeight = lastWeightEntry.value;
      }
    }
    // ===== M√ìDOS√çTOTT TAB KEZEL√âS =====
    function showTab(id) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
	  if (id === 'main') {
        renderHighlights();
        renderGoals(); // <-- EZ AZ √öJ SOR
      }
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

      if (event && event.target) {
        // ---- ITT A JAV√çT√ÅS ----
        // Biztos√≠tjuk, hogy a .tab-btn kapja meg az 'active' oszt√°lyt,
        // m√©g akkor is, ha a benne l√©v≈ë ikonra (span) kattintott a felhaszn√°l√≥.
        event.target.closest('.tab-btn').classList.add('active');
        // ---- JAV√çT√ÅS V√âGE ----
      } else {
        // Ez a v√©szmegold√°s, ha az 'event' valami√©rt nem el√©rhet≈ë
        document.querySelector(`.tab-btn[onclick="showTab('${id}')"]`).classList.add('active');
      }

      document.getElementById(id).classList.add('active');

      if (id === 'workouts') {
        renderWorkouts();
        // ===== EZ A K√âT √öJ SOR =====
        populateWorkoutCategoryFilter();
        renderWorkoutGoals();
        renderGoals(); // <-- EZ AZ √öJ SOR
        // ============================
      }
      // √öJ: √âtkez√©s f√ºl renderel√©se
      if (id === 'meals') {
        renderMeals();
      }
	  // ============ IDE ILLESZD BE ============
      // JAV√çT√ÅS: Jegyzetek f√ºl renderel√©se
      if (id === 'notes') {
        renderNotes();
      }
      // √öJ: Halad√°s f√ºl napl√≥inak friss√≠t√©se
      if (id === 'history') {
        renderLogs();
        renderPointsLog();
      }

      // ===== √öJ KOMPAKT S√ÅV MEGJELEN√çT√âSI LOGIKA =====
      const compactGoalsBar = document.getElementById('compactGoalsContainer');
      if (compactGoalsBar) {
        if (id === 'main' || id === 'meals') {
          // A kompakt s√°v megjelen√≠t√©se a F≈ëoldalon √©s az √âtkez√©s f√ºl√∂n.
          // A CSS-ed 'display: grid'-et haszn√°l, ez√©rt azt √°ll√≠tjuk be.
          compactGoalsBar.style.display = 'grid';
        } else {
          // Minden m√°s f√ºl√∂n elrejtj√ºk.
          compactGoalsBar.style.display = 'none';
        }
      }
      // ===== M√ìDOS√çTOTT LOGIKA V√âGE =====
    }
    // ===== EDZ√âS FUNKCI√ìK (REFACTORED) =====
    async function addWorkout() { // Make async
      const dateInput = document.getElementById("workoutDateInput");
      const selectedDate = dateInput.value;

      if (!selectedDate) {
        alert("K√©rlek v√°lassz ki egy d√°tumot!");
        return;
      }

      if (workouts.find(w => w.date === selectedDate)) {
        alert("Ehhez a naphoz m√°r r√∂gz√≠tett√©l edz√©st!");
        return;
      }

      workouts.push({
        date: selectedDate,
        note: ""
      });
      await saveWorkouts();
      logActivity(`üèãÔ∏è‚Äç‚ôÇÔ∏è Edz√©s r√∂gz√≠tve: ${selectedDate}`);
      renderWorkouts();
      closeModal('workoutModal');
    }
	// ===== √öJ SEG√âDF√úGGV√âNY: MAI EDZ√âS ELLEN≈êRZ√âSE =====
/**
 * Ellen≈ërzi, hogy a 'workouts' t√∂mbben van-e m√°r bejegyz√©s a mai napra.
 * @returns {boolean} Igaz, ha m√°r van r√∂gz√≠tett edz√©s, egy√©bk√©nt hamis.
 */
function isWorkoutLoggedToday() {
  const todayISO = toDateInputString(new Date());
  // .find() visszaadja az elemet (truthy) ha tal√°l, vagy undefined (falsy) ha nem.
  return workouts.find(w => w.date === todayISO);
}

// ===== √öJ SEG√âDF√úGGV√âNY: EDZ√âS R√ñGZ√çT√âSE M√ÅRA (MODAL N√âLK√úL) =====
/**
 * Programozottan hozz√°ad egy edz√©sbejegyz√©st a mai napra.
 */
async function logWorkoutForToday() {
  const todayISO = toDateInputString(new Date());

  // Dupla ellen≈ërz√©s, h√°tha id≈ëk√∂zben hozz√°adt√°k
  if (isWorkoutLoggedToday()) {
    console.warn("M√°r van edz√©s r√∂gz√≠tve a mai napra, a logWorkoutForToday() h√≠v√°s le√°llt.");
    return;
  }

  // 1. Hozz√°ad√°s a t√∂mbh√∂z
  workouts.push({
    date: todayISO,
    note: "" // √úres jegyzet, amit k√©s≈ëbb szerkeszthet
  });

  // 2. Ment√©s √©s napl√≥z√°s
  await saveWorkouts(); // Ez m√°r a saveDataToFirestore-t h√≠vja
  await logActivity(`üèãÔ∏è‚Äç‚ôÇÔ∏è Edz√©s r√∂gz√≠tve (c√©l teljes√≠t√©s√©b≈ël): ${todayISO}`);

  // 3. UI friss√≠t√©se
  renderWorkouts();
}

// ===== √öJ SEG√âDF√úGGV√âNY: R√ÅK√âRDEZ AZ EDZ√âS R√ñGZ√çT√âS√âRE =====
/**
 * Ellen≈ërzi a felt√©teleket (Edz√©s f√ºl, mai nap) √©s r√°k√©rdez a felhaszn√°l√≥n√°l.
 */
function checkAndAskForWorkoutLog() {
  // 1. Csak az edz√©s f√ºl√∂n fusson
  if (!document.getElementById('workouts').classList.contains('active')) {
    return;
  }

  // 2. Csak akkor fusson, ha ma m√©g nincs edz√©s
  if (isWorkoutLoggedToday()) {
    return;
  }

  // 3. R√°k√©rdez√©s
  // K√©sleltetj√ºk a confirm() h√≠v√°st, hogy a UI (pipa) friss√ºlhessen el≈ëtte.
  setTimeout(() => {
    if (confirm("Gratul√°lok a c√©l teljes√≠t√©s√©hez! üëã\n\nSzeretn√©d r√∂gz√≠teni ezt edz√©sk√©nt a mai napra?")) {
      // Ha igent mondott, programozottan hozz√°adjuk az edz√©st
      logWorkoutForToday();
    }
  }, 100); // 100ms k√©sleltet√©s
}

	// Bez√°rja az edz√©s hozz√°ad√≥ panelt
	function openWorkoutModal() {
  const dateInput = document.getElementById("workoutDateInput");
  if (dateInput) {
     // Be√°ll√≠tja a d√°tumot a mai napra
     // (A toDateInputString() egy megl√©v≈ë seg√©df√ºggv√©nyed)
     dateInput.value = toDateInputString(new Date());
  }
  // Megh√≠vja az √°ltal√°nos modal nyit√≥ f√ºggv√©nyt
  openModal('workoutModal');
}
    function renderWorkouts() {
      const list = document.getElementById("workoutList");
      if (!list) return;

      workouts.sort((a, b) => b.date.localeCompare(a.date));
      list.innerHTML = "";

      if (workouts.length === 0) {
        list.innerHTML = "<p>M√©g nincsenek r√∂gz√≠tett edz√©seid.</p>";
        return;
      }

      workouts.forEach((workout, index) => {
        const div = document.createElement("div");
        div.className = "workout-item";
        div.innerHTML = `
        <div class="item-name" onclick="openWorkoutNoteModal(${index})" style="cursor: pointer;" title="Jegyzet megtekint√©se">
          <div class="item-name-main">üèãÔ∏è‚Äç‚ôÇÔ∏è ${workout.date}</div>
        </div>
        <div class="item-actions">
          <button onclick="editWorkout(${index})" title="Jegyzet szerkeszt√©se">‚úèÔ∏è</button>
          <button class="delete-btn" onclick="deleteWorkout(${index})" title="T√∂rl√©s">üóëÔ∏è</button>
        </div>
        `;
        list.appendChild(div);
      });
    }
	// Ellen≈ërzi a b√ºntet√©seket: Lej√°rt-e? Ha igen, b√ºntet√©s levon√°sa √©s t√∂rl√©s!
async function checkPunishments() {
    const now = Date.now();
    let hasExpired = false;

    // Visszafel√© iter√°lunk, hogy biztons√°gosan t√∂r√∂lhess√ºnk a t√∂mbb≈ël
    for (let i = goals.length - 1; i >= 0; i--) {
        const g = goals[i];

        // Csak az akt√≠v (nem k√©sz) b√ºntet√©seket n√©z√ºnk
        if (g.isPunishment && !g.done) {
            // Ha van deadline, azt haszn√°ljuk, ha nincs (r√©gi adat), akkor startDate + 24h
            const deadline = g.deadline || (new Date(g.startDate).getTime() + 24 * 60 * 60 * 1000);

            if (now > deadline) {
                // --- ID≈ê LEJ√ÅRT ---
                console.log(`B√ºntet√©s lej√°rt: ${g.name}`);

                // 1. Pontlevon√°s (ha van be√°ll√≠tva b√ºntet≈ëpont)
                const penalty = g.penaltyPointsIfDeleted || 0;
                if (penalty > 0) {
                    totalPoints -= penalty;
                    addPointsLogEntry(-penalty, `‚åõ LEJ√ÅRT B√úNTET√âS: ${g.name}`);
                }

                // 2. Napl√≥z√°s
                await logActivity(`‚åõ B√ºntet√©s lej√°rt (nem teljes√≠tetted): ${g.name} (-${penalty} pont)`);

                // 3. T√ñRL√âS A LIST√ÅB√ìL (hogy elt≈±nj√∂n)
                goals.splice(i, 1);
                hasExpired = true;
            }
        }
    }

    // Ha t√∂rt√©nt v√°ltoz√°s (lej√°rt valami), ment√ºnk √©s friss√≠t√ºnk
    if (hasExpired) {
        animatePoints(totalPoints);
        renderGoals(); // Azonnal elt√ºnteti a fel√ºletr≈ël
        await saveDataToFirestore();
    }

    // Minden percben √∫jra kell rajzolni a list√°t a visszasz√°ml√°l√≥ friss√≠t√©se miatt,
    // de csak ha nem t√∂rt√©nt most t√∂rl√©s (mert akkor fentebb m√°r renderelt√ºnk)
    if (!hasExpired && document.getElementById("main").classList.contains("active")) {
        renderGoals();
    }
}

    async function deleteWorkout(index) {
      if (!confirm(`Biztosan t√∂rl√∂d az edz√©st err≈ël a napr√≥l: ${workouts[index].date}?`)) {
        return;
      }

      const deletedWorkout = workouts.splice(index, 1)[0];
      if (deletedWorkout) {
        await saveWorkouts();
        logActivity(`üóëÔ∏è Edz√©s t√∂r√∂lve: ${deletedWorkout.date}`);
        renderWorkouts();
      }
    }

    async function saveWorkouts() {
      await saveDataToFirestore();
    }
	function editReminder(id) {
      const index = reminders.findIndex(r => r.id === id);
      if (index === -1) return;
      const reminder = reminders[index];

      editTarget = {
        type: 'reminder',
        index: index
      };

      document.getElementById("editTitle").textContent = "üîî Eml√©keztet≈ë szerkeszt√©se";

      // 1. Sz√∂veg
      document.getElementById("editLabel1").textContent = "Eml√©keztet≈ë sz√∂vege";
      document.getElementById("editInput1").value = reminder.text;
      document.getElementById("editInput1").style.display = "block";
      document.getElementById("editLabel1").style.display = "block";
	  document.getElementById("editPriorityField").style.display = "none";

      // 2. Id≈ëpont (T√≠pus √°t√°ll√≠t√°sa 'datetime-local'-ra)
      document.getElementById("editLabel2").textContent = "Id≈ëpont";
      const timeInput = document.getElementById("editInput2");
      timeInput.type = "datetime-local"; // T√≠pus m√≥dos√≠t√°sa
      timeInput.value = toLocalISOString(reminder.time);
      timeInput.style.display = "block";
      document.getElementById("editLabel2").style.display = "block";

      // 3. Kiemel√©s Checkbox (az 'editRecurringFields' √∫jrahasznos√≠t√°s√°val)
      const recurringFields = document.getElementById("editRecurringFields");
      recurringFields.style.display = "block";
      recurringFields.querySelector('label[for="editIsRecurringInput"]').textContent = "Kiemel√©s a f≈ëoldalon?";
      const highlightCheck = document.getElementById("editIsRecurringInput");
      highlightCheck.checked = reminder.highlight;

      // Elrejtj√ºk az ism√©tl≈ëd√©s leg√∂rd√ºl≈ët, mert az nem kell
      const recurrenceOptions = document.getElementById("editRecurrenceOptions");
      recurrenceOptions.style.display = "none";

      // 4. Kiemel√©s D√°tuma (az 'editInput3' √∫jrahasznos√≠t√°s√°val)
      document.getElementById("editLabel3").textContent = "Kiemel√©s kezdete";
      const dateInput = document.getElementById("editInput3");
      dateInput.type = "date"; // T√≠pus m√≥dos√≠t√°sa
      dateInput.value = toDateInputString(reminder.highlightDate || new Date());
      // JAV√çTVA: Ha van mentett d√°tum, azt, ha nincs, a mait t√∂lti be

      // 5. Checkbox esem√©nykezel≈ë fel√ºl√≠r√°sa
      highlightCheck.onchange = function() {
        // Elrejtj√ºk az ism√©tl≈ëd√©s opci√≥t (ami itt nem kell)
        document.getElementById("editRecurrenceOptions").style.display = "none";
        // Mutatjuk/elrejtj√ºk a d√°tumv√°laszt√≥t
        const showDate = this.checked;
        document.getElementById("editLabel3").style.display = showDate ? "block" : "none";
        document.getElementById("editInput3").style.display = showDate ? "block" : "none";
      };

      // D√°tum mez≈ë alap√©rtelmezett l√°that√≥s√°ga
      if (reminder.highlight) {
        document.getElementById("editLabel3").style.display = "block";
        dateInput.style.display = "block";
      } else {
        document.getElementById("editLabel3").style.display = "none";
        dateInput.style.display = "none";
      }

      // 6. Felesleges mez≈ëk elrejt√©se
      document.getElementById("editLabelSubGoals").style.display = "none";
      document.getElementById("editInputSubGoals").style.display = "none";
      document.getElementById("editLabelText").style.display = "none";
      document.getElementById("editInputText").style.display = "none";
      document.getElementById("editMealFields").style.display = "none";

      openModal('editModal');
    }
    function editWorkout(index) {
      editTarget = {
        type: 'workout',
        index: index
      };

      const workoutDate = workouts[index].date;
      document.getElementById("editTitle").textContent = `üèãÔ∏è‚Äç‚ôÇÔ∏è Edz√©sjegyzet (${workoutDate})`;

      document.getElementById("editLabel1").style.display = "none";
      document.getElementById("editInput1").style.display = "none";
      document.getElementById("editLabel2").style.display = "none";
      document.getElementById("editInput2").style.display = "none";
      document.getElementById("editLabel3").style.display = "none";
      document.getElementById("editInput3").style.display = "none";
      document.getElementById("editMealFields").style.display = "none";
      document.getElementById("editLabelSubGoals").style.display = "none";
      document.getElementById("editInputSubGoals").style.display = "none";

      document.getElementById("editLabelText").textContent = "Jegyzet";
      document.getElementById("editLabelText").style.display = "block";
      document.getElementById("editInputText").value = parseStructuredArrayToText(workouts[index].note);
      document.getElementById("editInputText").style.display = "block";
	  document.getElementById("editPriorityField").style.display = "none";

      openModal('editModal');
    }
/**
 * Kisz√°m√≠tja a k√∂vetkez≈ë esed√©kess√©gi d√°tumot a megadott szab√°lyok alapj√°n.
 * @param {string} lastCompletedISO - Az utols√≥ teljes√≠t√©s ISO d√°tuma.
 * @param {object} recurrence - A { frequency, interval } objektum.
 * @returns {Date} A k√∂vetkez≈ë esed√©kess√©gi d√°tum (√©jf√©lre √°ll√≠tva).
 */
function getNextDueDate(lastCompletedISO, recurrence) {
    const lastDate = new Date(lastCompletedISO);
    lastDate.setHours(0, 0, 0, 0); // Normaliz√°l√°s

    const interval = recurrence.interval || 1;
    const frequency = recurrence.frequency || 'daily';

    switch (frequency) {
        case 'daily':
            lastDate.setDate(lastDate.getDate() + interval);
            break;
        case 'weekly':
            lastDate.setDate(lastDate.getDate() + (interval * 7));
            break;
        case 'monthly':
            lastDate.setMonth(lastDate.getMonth() + interval);
            break;
        case 'yearly':
            lastDate.setFullYear(lastDate.getFullYear() + interval);
            break;
        default:
             lastDate.setDate(lastDate.getDate() + 1); // Alap√©rtelmezett: naponta
            break;
    }
    return lastDate;
}

/**
 * V√©gigmegy az archiv√°lt c√©lokon, ellen≈ërzi az ism√©tl≈ëd√©si √©s
 * lej√°rati felt√©teleket, √©s sz√ºks√©g eset√©n √∫jraaktiv√°lja a c√©lokat.
 * Kezeli a r√©gi (string) √©s az √∫j (objektum) ism√©tl≈ëd√©si adatokat is.
 */
async function checkRecurringGoals() {
  let goalsWereReset = false;
  let goalsWereExpired = false;
  const today = new Date();
  today.setHours(0, 0, 0, 0); // Ma √©jf√©l

  // Visszafel√© iter√°lunk, mert m√≥dos√≠thatjuk a t√∂mb√∂t (splice)
  for (let i = archivedGoals.length - 1; i >= 0; i--) {
    const goal = archivedGoals[i];

    // Csak azokat n√©zz√ºk, amik:
    // 1. Ism√©tl≈ëd≈ëek
    // 2. Teljes√≠tve lettek (done: true)
    // 3. Van r√∂gz√≠tett utols√≥ teljes√≠t√©si idej√ºk
    if (goal.isRecurring && goal.done && goal.lastCompleted) {

      let recurrenceData = goal.recurrence;

      // --- Visszafel√© kompatibilit√°s: R√©gi string adatok √°talak√≠t√°sa ---
      if (typeof recurrenceData === 'string') {
        const oldRecurrence = recurrenceData;
        recurrenceData = {
            frequency: 'daily',
            interval: 1,
            endCondition: 'never',
            currentCount: 0
        };
        if (oldRecurrence === 'weekly') {
            recurrenceData.frequency = 'weekly';
        } else if (oldRecurrence === 'monthly') {
            recurrenceData.frequency = 'monthly';
        } else if (oldRecurrence.endsWith('days')) {
            recurrenceData.interval = parseInt(oldRecurrence) || 1;
        }
        // Friss√≠tj√ºk a c√©l objektumot az √∫j strukt√∫r√°val
        goal.recurrence = recurrenceData;
      }
      // --- Kompatibilit√°s v√©ge ---

      if (!recurrenceData) continue; // Ha nincs √©rv√©nyes adat, hagyjuk

      let goalExpired = false;
      const todayISO = toDateInputString(today.toISOString());

      // 1. LEJ√ÅRATI FELT√âTELEK ELLEN≈êRZ√âSE
      if (recurrenceData.endCondition === 'count') {
          if (recurrenceData.currentCount >= recurrenceData.endCount) {
              goalExpired = true;
          }
      } else if (recurrenceData.endCondition === 'date') {
          if (recurrenceData.endDate && todayISO > recurrenceData.endDate) {
               goalExpired = true;
          }
      }

      if (goalExpired) {
          // A c√©l v√©gleg lej√°rt. Kikapcsoljuk az ism√©tl≈ëd√©st.
          console.log(`Ism√©tl≈ëd≈ë c√©l v√©gleg lej√°rt: ${goal.name}`);
          goal.isRecurring = false;
          goalsWereExpired = true;
          continue; // Hagyjuk az arch√≠vumban, de m√°r nem ism√©tl≈ëdik
      }

      // 2. √öJRAAKTIV√ÅL√ÅS ELLEN≈êRZ√âSE
      const nextDueDate = getNextDueDate(goal.lastCompleted, recurrenceData);

      if (today.getTime() >= nextDueDate.getTime()) {
        console.log(`Ism√©tl≈ëd≈ë c√©l reaktiv√°l√°sa: ${goal.name}`);

        // 1. C√©l √°llapot√°nak vissza√°ll√≠t√°sa
        goal.done = false;
        goal.lastCompleted = null;
		goal.startDate = null;

        // 2. Alc√©lok √°llapot√°nak vissza√°ll√≠t√°sa
        if (goal.subGoals && goal.subGoals.length > 0) {
          goal.subGoals.forEach(sg => {
            if (sg.type === 'task') { // Csak a pip√°lhat√≥kat
              sg.done = false;
            }
          });
        }

        // 3. √Åthelyez√©s az arch√≠vumb√≥l a f≈ë c√©lok list√°j√°ra
        const goalToReactivate = archivedGoals.splice(i, 1)[0];
        goals.push(goalToReactivate);

        goalsWereReset = true;
      }
    }
  }

  if (goalsWereReset || goalsWereExpired) {
    console.log("Ism√©tl≈ëd≈ë c√©lok friss√≠tve, ment√©s √©s renderel√©s...");
    renderGoals();
    if (document.getElementById('archiveModal').style.display === 'flex') {
      renderArchivedGoals();
    }
    await saveDataToFirestore();
  }
}
// EZ EGY TELJESEN √öJ F√úGGV√âNY
/**
 * V√©gigmegy az archiv√°lt c√©lokon, √©s aktiv√°lja azokat,
 * amelyeknek a kezd≈ë d√°tuma elj√∂tt.
 */
async function checkPendingGoals() {
  let goalsWereActivated = false;
  const todayISO = toDateInputString(new Date().toISOString());

  // Visszafel√© iter√°lunk, mert m√≥dos√≠tjuk a t√∂mb√∂t (splice)
  for (let i = archivedGoals.length - 1; i >= 0; i--) {
    const goal = archivedGoals[i];

    // A c√©l akkor aktiv√°l√≥dik, ha NINCS 'done: true' √°llapota (azaz nem teljes√≠tett)
    if (!goal.done) {
        // ===== M√ìDOS√çTOTT LOGIKA KEZDETE =====

        // 1. Ellen≈ërizz√ºk a "Megjelen√©s d√°tum√°t"
        const startDate = goal.startDate;
        // Akkor OK, ha nincs megadva, VAGY ha a mai nap, vagy kor√°bbi
        const isStartDateOK = !startDate || startDate <= todayISO;

        // 2. Ellen≈ërizz√ºk az "Ism√©tl≈ëd√©s kezdet√©t" (csak ha ism√©tl≈ëd≈ë)
        let isRecurrenceDateOK = true; // Alapb√≥l igaz
        if (goal.isRecurring && goal.recurrence && goal.recurrence.recurrenceStartDate) {
            if (goal.recurrence.recurrenceStartDate > todayISO) {
                isRecurrenceDateOK = false; // M√©g nem j√∂tt el az ideje
            }
        }

        // 3. D√∂nt√©s: A c√©l akkor aktiv√°l√≥dik, ha MINDK√âT felt√©tel teljes√ºl
        if (isStartDateOK && isRecurrenceDateOK) {
          console.log(`Id≈ëz√≠tett c√©l aktiv√°l√°sa: ${goal.name}`);

          // √Åthelyezz√ºk az arch√≠vumb√≥l az akt√≠v c√©lok list√°j√°ra
          const goalToActivate = archivedGoals.splice(i, 1)[0];
          goals.push(goalToActivate);

          goalsWereActivated = true;
        }
        // ===== M√ìDOS√çTOTT LOGIKA V√âGE =====
    }
  }

  if (goalsWereActivated) {
    console.log("Id≈ëz√≠tett c√©lok friss√≠tve, ment√©s √©s renderel√©s...");
    renderGoals();
    if (document.getElementById('archiveModal').style.display === 'flex') {
      renderArchivedGoals();
    }
    await saveDataToFirestore();
  }
}

async function saveGoalSettings() { // Make async
  const gw = parseFloat(document.getElementById("goalWeightInput").value) || null;
  const gwat = parseFloat(document.getElementById("goalWaterInput").value) || null;
  const gcal = parseFloat(document.getElementById("goalCalInput").value) || null;
  const gprot = parseFloat(document.getElementById("goalProteinInput").value) || null; // √öJ
  const gfat = parseFloat(document.getElementById("goalFatInput").value) || null; // √öJ ZS√çR

  // Save to global variables
  goalWeightSetting = gw ? gw.toString() : "";
  goalWaterSetting = gwat ? gwat.toString() : "";
  goalCaloriesSetting = gcal ? gcal.toString() : "";
  goalProteinSetting = gprot ? gprot.toString() : ""; // √öJ
  goalFatSetting = gfat ? gfat.toString() : ""; // √öJ ZS√çR

  updateAllSummaries(); // Ez friss√≠ti a nagy k√°rty√°t
  // logActivity will call saveDataToFirestore
  await logActivity(`üéØ C√©lok be√°ll√≠tva: ${gw || "-"}kg, ${gwat || "-"}L, ${gcal || "-"}kcal, ${gprot || "-"}g protein, ${gfat || "-"}g zs√≠r`);
  closeModal('goalSetupModal');

  // ITT A JAV√çT√ÅS:
  // Biztos√≠tjuk, hogy a kompakt s√°v is friss√ºlj√∂n
  updateCompactSummaries();
}

function updateAllSummaries() {
  // Ez a f√ºggv√©ny kor√°bban a r√©gi, nagy k√°rty√°kat friss√≠tette.
  // Mivel azok t√∂r√∂lve lettek, a tartalm√°t ki√ºr√≠tett√ºk,
  // de a kompakt s√°v friss√≠t√©s√©t itt hagyjuk,
  // hogy a program t√∂bbi r√©sze (pl. saveQuickAdd) z√∂kken≈ëmentesen m≈±k√∂dj√∂n.

  // Friss√≠tj√ºk a kompakt n√©zetet
  updateCompactSummaries();
}
// ===== ADATBEVITEL √âS T√ñRL√âS (REFACTORED) =====
async function deleteTransaction(index) { // Make async
  if (!confirm("Biztosan t√∂rl√∂d ezt a bejegyz√©st?")) {
    return;
  }

  const entry = transactions.splice(index, 1)[0];
  await logActivity(`üóëÔ∏è Bejegyz√©s t√∂r√∂lve: ${entry.type} (${entry.value || entry.name})`);

  // √öjrasz√°moljuk az eg√©szet
  calculateDailyProgress();
  updateAllSummaries();
  updateHistory();
  if (document.getElementById('chartModal').style.display === 'flex') {
    updateChart();
  }
}
// ===== JEGYZETEK FUNKCI√ìK (REFACTORED) =====
// √öJ: Megnyitja a jegyzet hozz√°ad√°sa mod√°lt
function openAddNoteModal() {
  // T√∂r√∂lj√ºk a mod√°l tartalm√°t
  document.getElementById("noteTitleInput").value = "";
  document.getElementById("noteCategoryInput").value = "";
  document.getElementById("noteTextInput").value = "";

  // Felt√∂ltj√ºk a kateg√≥ria javaslatokat
  populateNoteCategoryDatalist();

  openModal('noteModal');
}

// M√ìDOS√çTVA: Ment√©s a mod√°lb√≥l
async function saveNote() {
  const title = document.getElementById("noteTitleInput").value.trim();
  const category = document.getElementById("noteCategoryInput").value.trim();
  // M√ìDOS√çT√ÅS: A sz√∂veget egyenesen a form√°z√≥ funkci√≥ba k√ºldj√ºk
  const textArray = parseTextToStructuredArray(document.getElementById("noteTextInput").value);

  if (!title) return alert("K√©rlek adj meg egy c√≠met!");
  // M√ìDOS√çT√ÅS: Azt n√©zz√ºk, hogy a t√∂mb √ºres-e
  if (textArray.length === 0) return alert("K√©rlek adj meg sz√∂veget is!");

  const note = {
    title,
    category: category || null, // Menti a kateg√≥ri√°t, vagy null-t ha √ºres
    text: textArray, // M√ìDOS√çT√ÅS: A t√∂mb√∂t mentj√ºk
    date: new Date()
  };
  notes.unshift(note); // Az elej√©re sz√∫rja be

  closeModal('noteModal');
  renderNotes(); // √öjrarajzol√°s
  await logActivity(`üìù Jegyzet hozz√°adva: ${title}`);
}

// TELJESEN √öJ RENDERNOTES F√úGGV√âNY (KATEG√ìRI√ÅKKAL)
function renderNotes() {
  // JAV√çT√ÅS: Ez a 7 sor hi√°nyzott. Defini√°lja a t√°rol√≥t √©s kezeli az √ºres list√°t.
  const container = document.getElementById("notesList");
  if (!container) return; // Biztons√°gi ellen≈ërz√©s
  container.innerHTML = "";
  if (notes.length === 0) {
    container.innerHTML = "<p style='text-align:center; padding: 10px;'>M√©g nincsenek mentett jegyzeteid.</p>";
    return;
  }

  // 1. Csoportos√≠t√°s
  const categorized = {};
  const uncategorized = [];

  notes.forEach((note, i) => {
    // Fontos, hogy meg≈ërizz√ºk az eredeti indexet a t√∂rl√©shez/szerkeszt√©shez
    const item = { ...note,
      originalIndex: i
    };

    if (item.category) {
      if (!categorized[item.category]) {
        categorized[item.category] = [];
      }
      categorized[item.category].push(item);
    } else {
      uncategorized.push(item);
    }
  });

  // 2. Megjelen√≠t≈ë seg√©df√ºggv√©ny
  const renderItem = (n, index) => {
    let displayDate = "...";
    if (n.date) {
      if (typeof n.date.toDate === 'function') {
        displayDate = n.date.toDate().toLocaleString().split(',')[0];
      } else {
        displayDate = new Date(n.date).toLocaleString().split(',')[0];
      }
    }

    const div = document.createElement("div");
    div.className = "note-summary-item";
    div.innerHTML = `
      <div>
        <span class="note-summary-title" onclick="openNoteModal(${index})">${n.title}</span>
        <span class="note-summary-date">${displayDate}</span>
      </div>
      <div class="note-summary-actions">
        <button onclick='editNote(${index})'>‚úèÔ∏è</button>
        <button onclick='deleteNote(${index})'>üóëÔ∏è</button>
      </div>`;
    container.appendChild(div);
  };

  // 3. Kateg√≥ri√°k kirajzol√°sa (ABC sorrendben)
  const categoryNames = Object.keys(categorized).sort();
  categoryNames.forEach(categoryName => {
    const title = document.createElement("h3");
    title.className = "category-title"; // √öjrahasznos√≠tjuk a C√©lokn√°l l√©v≈ë st√≠lust
    title.textContent = categoryName;
    container.appendChild(title);

    categorized[categoryName].forEach(item => {
      renderItem(item, item.originalIndex); // Az eredeti indexet adjuk √°t!
    });
  });

  // 4. Kateg√≥ria n√©lk√ºliek kirajzol√°sa
  if (uncategorized.length > 0) {
    if (categoryNames.length > 0) { // Csak akkor √≠rjuk ki, hogy "Egy√©b", ha m√°r voltak kateg√≥ri√°k
      const title = document.createElement("h3");
      title.className = "category-title";
      title.textContent = "Egy√©b";
      container.appendChild(title);
    }
    uncategorized.forEach(item => {
      renderItem(item, item.originalIndex); // Az eredeti indexet adjuk √°t!
    });
  }
}

async function deleteNote(i) { // Make async
  if (!confirm(`Biztosan t√∂rl√∂d ezt a jegyzetet: "${notes[i].title}"?`)) {
    return;
  }
  const deletedTitle = notes[i].title;
  notes.splice(i, 1);
  renderNotes();
  await logActivity(`üóëÔ∏è Jegyzet t√∂r√∂lve: ${deletedTitle}`);
}

function openNoteModal(i) {
  const note = notes[i];
  document.getElementById("noteViewTitle").textContent = note.title;
  document.getElementById("noteViewText").innerHTML = renderStructuredArrayToHTML(note.text);
  openModal('noteViewModal');
}

// ===== √öJ FUNKCI√ì AZ √âTEL JEGYZETHEZ =====
function openWorkoutNoteModal(index) {
  const workout = workouts[index];
  document.getElementById("noteViewTitle").textContent = `Edz√©sjegyzet: ${workout.date}`;
  // A 'renderStructuredArrayToHTML' haszn√°lata a form√°z√°shoz
  document.getElementById("noteViewText").innerHTML = renderStructuredArrayToHTML(workout.note || "Ehhez az edz√©shez nem tartozik jegyzet.");
  openModal('noteViewModal');
}

// ===== INNENT≈êL ILLESZD BE AZ √öJ F√úGGV√âNYT =====
function openMealNoteModal(index) {
  const meal = meals[index];
  document.getElementById("noteViewTitle").textContent = `Jegyzet: ${meal.name}`;
  // Haszn√°ljuk ugyanazt a renderel≈ët, mint a Jegyzetekn√©l
  document.getElementById("noteViewText").innerHTML = renderStructuredArrayToHTML(meal.note);
  openModal('noteViewModal');
}

function editNote(i) {
  editTarget = {
    type: 'note',
    index: i
  };

  document.getElementById("editTitle").textContent = "üìù Jegyzet szerkeszt√©se";
  document.getElementById("editLabel1").textContent = "C√≠m";
  document.getElementById("editInput1").value = notes[i].title;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  // √öJ: Kateg√≥ria mez≈ë bet√∂lt√©se
  document.getElementById("editLabel3").textContent = "Kateg√≥ria";
  document.getElementById("editInput3").value = notes[i].category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";

  document.getElementById("editLabelText").style.display = "block";
  document.getElementById("editInputText").value = parseStructuredArrayToText(notes[i].text);
  document.getElementById("editInputText").style.display = "block";

  // Elrejtj√ºk a felesleges mez≈ëket
  document.getElementById("editLabel2").style.display = "none";
  document.getElementById("editInput2").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  document.getElementById("editRecurringFields").style.display = "none"; // Ezt is rejts√ºk el
  document.getElementById("editPriorityField").style.display = "none";

  openModal('editModal');
}
// ===== C√âLOK (REFACTORED) =====
async function saveGoal() { // Make async
  const name = document.getElementById("goalNameInput").value.trim();
  const points = parseInt(document.getElementById("goalPointsInput").value);
  const category = document.getElementById("goalCategoryInput").value.trim();

  if (!name) return alert("A c√©lnak nevet kell adni!");
  if (isNaN(points) || points < 0) return alert("√ârv√©nytelen pontsz√°m! Adj meg 0-t vagy nagyobbat.");

  // ===== M√ìDOS√çTOTT ALC√âL FELDOLGOZ√ÅS (FEJEDELEM EDITION) =====
  const subGoalsText = document.getElementById("goalSubGoalsInput").value;
  let subGoals = [];
  if (subGoalsText.trim() !== "") {
    subGoals = subGoalsText.split('\n')
      .map(text => text.trim())
      .filter(text => text.length > 0)
      .map(rawText => {
        // T√≠pus meghat√°roz√°sa
        if (rawText.startsWith('#')) {
          return { type: 'header', text: rawText.substring(1).trim() };
        } else if (rawText === '---') {
          return { type: 'separator', text: '---' };
        } else if (rawText.startsWith('@')) {
          // OPCION√ÅLIS ALC√âL FELISMER√âSE (@ jel)
          return {
            type: 'task',
            text: rawText.substring(1).trim(),
            done: false,
            isOptional: true // √öJ TULAJDONS√ÅG
          };
        } else {
          return {
            type: 'task',
            text: rawText,
            done: false,
            isOptional: false // K√ñTELEZ≈ê
          };
        }
      });
  }
  // ===== M√ìDOS√çTOTT ALC√âL FELDOLGOZ√ÅS V√âGE =====

  // √öJ: Ism√©tl≈ëd√©s beolvas√°sa
  const isRecurring = document.getElementById("goalIsRecurringInput").checked;
  const isPriority = document.getElementById("goalIsPriorityInput").checked; // √öJ
  const startDate = document.getElementById("goalStartDateInput").value; // EZ AZ √öJ SOR
  const recurrenceStartDate = document.getElementById("goalRecurrenceStartDateInput").value || null;

  const newGoal = {
    name,
    points,
    done: false,
    category: category,
    subGoals: subGoals,
	isPriority: isPriority,
    startDate: startDate || null // EZ AZ √öJ SOR
  };

if (isRecurring) {
    newGoal.isRecurring = true;

    // 1. Beolvassuk az intervallumot √©s a frekvenci√°t
    const frequency = document.getElementById("goalRecurrenceFrequency").value;
    const interval = parseInt(document.getElementById("goalRecurrenceInterval").value) || 1;

    // 2. Beolvassuk a befejez√©si felt√©telt
    const endCondition = document.querySelector('input[name="goalEndCondition"]:checked').value;
    const endCount = parseInt(document.getElementById("goalEndCountInput").value) || 5;
    const endDate = document.getElementById("goalEndDateInput").value || null;

    // 3. √ñssze√°ll√≠tjuk az √∫j recurrence objektumot
    newGoal.recurrence = {
      frequency: frequency, // 'daily', 'weekly', 'monthly', 'yearly'
      interval: interval,

      recurrenceStartDate: recurrenceStartDate, // Haszn√°ljuk a kor√°bban beolvasott v√°ltoz√≥t

      endCondition: endCondition, // 'never', 'count', 'date'
      endDate: (endCondition === 'date' && endDate) ? endDate : null,
      endCount: (endCondition === 'count') ? endCount : null,

      currentCount: 0 // A sz√°ml√°l√≥ null√°r√≥l indul
    };

    newGoal.lastCompleted = null; // Kezdetben nincs teljes√≠tve
  }

  // √öJ, M√ìDOS√çTOTT R√âSZ
  const todayISO = toDateInputString(new Date().toISOString());
  let logMessage = "";

  // ===== M√ìDOS√çTOTT ARCHIV√ÅL√ÅSI LOGIKA =====
  // A c√©l akkor ker√ºl archiv√°l√°sra, ha:
  // 1. A 'Megjelen√©s d√°tuma' a j√∂v≈ëben van.
  // VAGY
  // 2. Ism√©tl≈ëd≈ë √âS az 'Ism√©tl≈ëd√©s kezdete' a j√∂v≈ëben van.
  const isPendingOnStartDate = newGoal.startDate && newGoal.startDate > todayISO;
  const isPendingOnRecurrenceDate = newGoal.isRecurring && newGoal.recurrence.recurrenceStartDate && newGoal.recurrence.recurrenceStartDate > todayISO;


  if (isPendingOnStartDate || isPendingOnRecurrenceDate) {
    // J√∂v≈ëbeli c√©l: Az arch√≠vumba tessz√ºk
    archivedGoals.unshift(newGoal); // unshift, hogy el√∂l legyen az arch√≠vumban
    logMessage = `üì• C√©l id≈ëz√≠tve az arch√≠vumba: ${name}`;
  } else {
    // Azonnali c√©l: A norm√°l list√°ba tessz√ºk
    goals.push(newGoal);
    logMessage = `üéØ C√©l hozz√°adva: ${name} (${points} pont)`;
  }
  // Edz√©s f√ºl friss√≠t√©se, ha az akt√≠v
  if (document.getElementById('workouts').classList.contains('active')) {
    populateWorkoutCategoryFilter();
    renderWorkoutGoals();
  }
  document.getElementById("goalNameInput").value = "";
  document.getElementById("goalPointsInput").value = "";
  document.getElementById("goalCategoryInput").value = "";
  document.getElementById("goalSubGoalsInput").value = "";
  document.getElementById("goalIsPriorityInput").checked = false;
  document.getElementById("goalStartDateInput").value = "";

  closeModal('goalModal');
  renderGoals(); // A renderGoals friss√≠ti a f≈ë list√°t
  // Ha az arch√≠vum nyitva van, azt is friss√≠thetj√ºk (opcion√°lis, de j√≥ gyakorlat)
  if (document.getElementById('archiveModal').style.display === 'flex') {
    renderArchivedGoals();
  }
  await logActivity(logMessage);
}
// ===== JAV√çTOTT C√âLKEZEL≈ê F√úGGV√âNYEK KEZDETE =====
async function toggleGoal(i) { // Make async
  if (i < 0 || i >= goals.length) {
    console.error("Invalid index for toggleGoal:", i);
    return;
  }

   const goal = goals[i];

  // === PONT SZ√ÅM√çT√ÅSI LOGIKA ===
  // Kisz√°moljuk, mennyi pont j√°r a "F≈ë c√©l" pip√°j√°√©rt.
  // Ez = Teljes Pont - (M√°r kiosztott opcion√°lis pontok)

  let mainCompletionPoints = goal.points;

  const tasks = (goal.subGoals || []).filter(sg => (sg.type || 'task') === 'task');
  const totalCount = tasks.length;
  const optionalCount = tasks.filter(sg => sg.isOptional).length;

  if (totalCount > 0 && goal.points > 0) {
      const pointsPerTask = Math.round(goal.points / totalCount);
      // A f≈ë c√©l teljes√≠t√©se a k√∂telez≈ëk √©rt√©k√©t adja
      // Matek: Teljes - (Egys√©g * Opcion√°lisok sz√°ma) = Ami a k√∂telez≈ëkre marad
      // √çgy a kerek√≠t√©si hib√°k sem okoznak gondot, a v√©g√∂sszeg stimmelni fog.
      mainCompletionPoints = goal.points - (pointsPerTask * optionalCount);

      // Ha negat√≠v lenne (matek hiba miatt), legyen 0
      if (mainCompletionPoints < 0) mainCompletionPoints = 0;
  }

  // Csak a teljes√≠t√©s √©rdekli a rendszert
  if (!goal.done) {
    goal.done = true;

    // Csak akkor adunk pontot, ha van mit (a k√∂telez≈ëk r√©sze)
    if (mainCompletionPoints > 0) {
        totalPoints += mainCompletionPoints;
        animatePoints(totalPoints);
    }

    if (goal.isRecurring) {
      // --- ISM√âTL≈êD≈ê C√âL TELJES√çTVE ---
      goal.lastCompleted = new Date().toISOString();

      const recurrence = goal.recurrence;
      if (recurrence && typeof recurrence === 'object') {
        recurrence.currentCount = (recurrence.currentCount || 0) + 1;
        if (recurrence.endCondition === 'count' && recurrence.currentCount >= recurrence.endCount) {
            goal.isRecurring = false;
        }
      }

      // Napl√≥z√°s
      const logPointsStr = mainCompletionPoints > 0 ? `(+${mainCompletionPoints} pont a k√∂telez≈ëk√©rt)` : `(r√©szletekben)`;
      addPointsLogEntry(mainCompletionPoints, `‚úÖ Ism√©tl≈ëd≈ë c√©l k√©sz: ${goal.name}`);
      await logActivity(`‚úÖ Ism√©tl≈ëd≈ë c√©l archiv√°lva: ${goal.name} ${logPointsStr}`);

      const goalToArchive = goals.splice(i, 1)[0];
      archivedGoals.unshift(goalToArchive);

      renderGoals();

    } else {
      // --- NEM ISM√âTL≈êD≈ê C√âL TELJES√çTVE ---
      const logPointsStr = mainCompletionPoints > 0 ? `(+${mainCompletionPoints} pont a k√∂telez≈ëk√©rt)` : `(r√©szletekben)`;
      addPointsLogEntry(mainCompletionPoints, `‚úÖ C√©l teljes√≠tve: ${goal.name}`);
      await logActivity(`‚úÖ C√©l teljes√≠tve: ${goal.name} ${logPointsStr}`);
      renderGoals();
    }
    checkAndAskForWorkoutLog();
    await saveDataToFirestore();

  } else {
    // --- TELJES√çT√âS VISSZAVON√ÅSA ---
    if (!goal.isRecurring) {
      goal.done = false;

      // Levonjuk a "F≈ë c√©l" pontjait (a k√∂telez≈ëk √©rt√©k√©t)
      // Az opcion√°lisok pip√°i maradnak, √©s a pontjuk is n√°lad marad!
      if (mainCompletionPoints > 0) {
          totalPoints -= mainCompletionPoints;
          animatePoints(totalPoints);
      }

      addPointsLogEntry(-mainCompletionPoints, `‚ùå C√©l visszavonva: ${goal.name}`);
      await logActivity(`‚ùå C√©l visszavonva: ${goal.name} (-${mainCompletionPoints} pont)`);

      await saveDataToFirestore();
      renderGoals();
    }
    // Edz√©s f√ºl friss√≠t√©se, ha az akt√≠v
    if (document.getElementById('workouts').classList.contains('active')) {
      populateWorkoutCategoryFilter();
      renderWorkoutGoals();
    }
  }
}

// ===== √öJ FUNKCI√ì: ALC√âL KIPIP√ÅL√ÅSA (JAV√çTOTT) =====
async function toggleSubGoal(goalIndex, subGoalIndex) {
  const goal = goals[goalIndex];
  if (!goal || !goal.subGoals || !goal.subGoals[subGoalIndex]) return;

  // 1. Alc√©l √°llapot√°nak v√°lt√°sa
  const subGoal = goal.subGoals[subGoalIndex];
  const isChecking = !subGoal.done; // √âppen most pip√°ljuk be, vagy vessz√ºk ki?
  subGoal.done = isChecking;

  // 2. Pontsz√°m√≠t√°si egys√©g (Unit) meghat√°roz√°sa
  // Minden feladat (ak√°r opcion√°lis, ak√°r k√∂telez≈ë) egyenl≈ë r√©sz√©t k√©pezi a pontnak
  const totalTasksCount = goal.subGoals.filter(sg => (sg.type || 'task') === 'task').length;
  let pointsPerTask = 0;
  if (totalTasksCount > 0 && goal.points > 0) {
      pointsPerTask = Math.round(goal.points / totalTasksCount);
  }

  // 3. AZONNALI PONTOZ√ÅS - CSAK OPCION√ÅLIS ALC√âLOKN√ÅL
  if (subGoal.isOptional) {
      if (isChecking) {
          // Pipa beker√ºlt -> Azonnali pont
          totalPoints += pointsPerTask;
          addPointsLogEntry(pointsPerTask, `‚úÖ Opcion√°lis extra: ${subGoal.text}`);
      } else {
          // Pipa kiker√ºlt -> Azonnali levon√°s
          totalPoints -= pointsPerTask;
          addPointsLogEntry(-pointsPerTask, `‚ùå Opcion√°lis visszavonva: ${subGoal.text}`);
      }
      animatePoints(totalPoints);
      await saveDataToFirestore();
  }

  // 4. Automatikus teljes√≠t√©s figyel√©se (A k√∂telez≈ëk alapj√°n)
  const taskSubGoals = goal.subGoals.filter(sg => (sg.type || 'task') === 'task');
  const mandatoryTasks = taskSubGoals.filter(sg => !sg.isOptional);

  // Minden k√∂telez≈ë k√©sz van?
  const allMandatoryDone = mandatoryTasks.length > 0 && mandatoryTasks.every(sg => sg.done);

  // Speci√°lis eset: Ha NINCS k√∂telez≈ë, akkor akkor van k√©sz a f≈ë c√©l, ha MINDEN opcion√°lis k√©sz
  const allTasksDone = taskSubGoals.every(sg => sg.done);
  const isPureOptionalList = (mandatoryTasks.length === 0);

  const shouldAutoComplete = (allMandatoryDone) || (isPureOptionalList && allTasksDone);

  // 5. F≈ë c√©l friss√≠t√©se
  if (shouldAutoComplete) {
    if (goal.isPunishment) {
        goals.splice(goalIndex, 1);
        await logActivity(`‚úÖ B√ºntet√©s teljes√≠tve/kiv√°ltva: ${goal.name}`);
        renderGoals();
        await saveDataToFirestore();
        return;
    }
    // Ha m√©g nincs k√©sz a f≈ë c√©l, akkor most k√©szre √°ll√≠tjuk
    else if (!goal.done) {
        // Megh√≠vjuk a toggleGoalt, ami kiosztja a MARAD√âK (k√∂telez≈ë) pontokat
        await toggleGoal(goalIndex);
    }
  } else {
    // Ha visszavontad a pip√°t egy olyan c√©lr√≥l, ami m√°r k√©sz volt
    // (pl. kivett√©l egy k√∂telez≈ët)
    if (goal.done && !goal.isPunishment) {
        // A toggleGoal visszavonja a k√∂telez≈ëk pontjait
        await toggleGoal(goalIndex);
    } else {
        // Csak ment√©s √©s friss√≠t√©s
        await saveDataToFirestore();
        renderGoals();
    }
  }
}
// ===== JAV√çTOTT C√âLKEZEL≈ê F√úGGV√âNYEK V√âGE =====
function editGoal(i) {
  editTarget = {
    type: 'goal',
    index: i
  };
  document.getElementById("editTitle").textContent = "üéØ C√©l szerkeszt√©se";

  document.getElementById("editLabel1").textContent = "C√©l neve";
  document.getElementById("editInput1").value = goals[i].name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont √©rt√©k";
  document.getElementById("editInput2").value = goals[i].points;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";

  document.getElementById("editLabel3").textContent = "Kateg√≥ria (opcion√°lis)";
  document.getElementById("editInput3").value = goals[i].category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";

  // √öJ: Alc√©lok bet√∂lt√©se a szerkeszt≈ëbe (Opcion√°lis jel vissza√°ll√≠t√°sa)
  const subGoalsText = (goals[i].subGoals || []) // editArchivedGoal-n√°l: (goal.subGoals || [])
    .map(sg => {
      const sgType = sg.type || 'task';
      if (sgType === 'header') {
        return `# ${sg.text}`;
      } else if (sgType === 'separator') {
        return '---';
      }
      // Ha opcion√°lis, tegy√ºk vissza a @-ot
      if (sg.isOptional) {
        return `@ ${sg.text}`;
      }
      return sg.text; // Sima task
    })
    .join('\n');

  document.getElementById("editLabelSubGoals").style.display = "block";
  document.getElementById("editInputSubGoals").value = subGoalsText;
  document.getElementById("editInputSubGoals").style.display = "block";

  // √öJ: Ism√©tl≈ëd√©s mez≈ëk bet√∂lt√©se
  // ===== √öJ, B≈êV√çTETT ISM√âTL≈êD√âS BET√ñLT√âSE =====
  const isRecurring = goals[i].isRecurring || false;
  document.getElementById("editRecurringFields").style.display = "block";
  document.getElementById("editIsRecurringInput").checked = isRecurring;
  document.getElementById("editRecurrenceOptions").style.display = isRecurring ? "block" : "none";

  const recurrence = goals[i].recurrence;

  // Alaphelyzetbe √°ll√≠t√°s (ha nincs mentett adat)
  document.getElementById("editRecurrenceInterval").value = 1;
  document.getElementById("editRecurrenceFrequency").value = "daily";
  document.getElementById("editEndNever").checked = true;
  document.getElementById("editEndCountInput").value = 5;
  document.getElementById("editEndDateInput").value = "";

  if (recurrence) {
    if (typeof recurrence === 'object') {
      // --- √öJ, OBJEKTUM ALAP√ö ADAT BET√ñLT√âSE ---
      document.getElementById("editRecurrenceInterval").value = recurrence.interval || 1;
      document.getElementById("editRecurrenceFrequency").value = recurrence.frequency || "daily";

      // Befejez√©si felt√©tel be√°ll√≠t√°sa
      const endCondition = recurrence.endCondition || 'never';
      document.getElementById(`editEnd${endCondition.charAt(0).toUpperCase() + endCondition.slice(1)}`).checked = true;

      if (endCondition === 'count') {
        document.getElementById("editEndCountInput").value = recurrence.endCount || 5;
      } else if (endCondition === 'date') {
        document.getElementById("editEndDateInput").value = recurrence.endDate || "";
      }

    } else if (typeof recurrence === 'string') {
      // --- R√âGI, STRING ALAP√ö ADAT KEZEL√âSE (VISSZAALAK√çT√ÅS) ---
      // Ez a r√©sz kezeli a r√©gi ment√©seket, pl. "weekly" vagy "2days"
      document.getElementById("editEndNever").checked = true; // A r√©giek sosem √©rtek v√©get

      if (recurrence === 'daily') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      } else if (recurrence === 'weekly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "weekly";
      } else if (recurrence === 'monthly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "monthly";
      } else if (recurrence.endsWith('days')) {
        // pl. "2days"
        document.getElementById("editRecurrenceInterval").value = parseInt(recurrence) || 2;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      }
    }
  }
  // ===== ISM√âTL≈êD√âS BET√ñLT√âS V√âGE =====
  // Ism√©tl≈ëd√©s kezd≈ë d√°tum√°nak bet√∂lt√©se
  const recStartDate = (recurrence && recurrence.recurrenceStartDate) ? recurrence.recurrenceStartDate : "";
  document.getElementById("editRecurrenceStartDateInput").value = toDateInputString(recStartDate);
  // ================================================
  const isPriority = goals[i].isPriority || false;
  document.getElementById("editPriorityField").style.display = "block";
  document.getElementById("editIsPriorityInput").checked = isPriority;
  // ID≈êZ√çT√âS MEZ≈ê BET√ñLT√âSE (KEZDETE)
  const startDateField = document.getElementById("editStartDateField");
  const startDateInput = document.getElementById("editStartDateInput");
  startDateField.style.display = "block";
  // Csak akkor t√∂ltj√ºk be, ha van mentett d√°tum
  if (goals[i].startDate) {
    startDateInput.value = toDateInputString(goals[i].startDate);
  } else {
    startDateInput.value = "";
  }
  // ID≈êZ√çT√âS MEZ≈ê BET√ñLT√âSE (V√âGE)

  // M√°s mez≈ëk elrejt√©se
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";

  openModal('editModal');
}

async function deleteGoal(i) { // Make async
  if (i < 0 || i >= goals.length) {
    console.error("Invalid index for deleteGoal:", i);
    return;
  }
  const goalToDelete = goals[i];

  // ELLEN≈êRZ√âS: Ha ez egy b√ºntet√©s √©s NINCS k√©sz, akkor levon√°s!
  if (goalToDelete.isPunishment && !goalToDelete.done && goalToDelete.penaltyPointsIfDeleted) {
      if(!confirm(`FIGYELEM! Ez egy b√ºntet√©s. Ha t√∂rl√∂d teljes√≠t√©s n√©lk√ºl, ${goalToDelete.penaltyPointsIfDeleted} pont levon√°sra ker√ºl! Folytatod?`)) return;

      totalPoints -= goalToDelete.penaltyPointsIfDeleted;
      animatePoints(totalPoints);
      addPointsLogEntry(-goalToDelete.penaltyPointsIfDeleted, `‚ö†Ô∏è B√ºntet√©s elker√ºlve (t√∂r√∂lve): ${goalToDelete.name}`);
  } else {
      // Hagyom√°nyos t√∂rl√©s meger≈ës√≠t√©s
      if (confirm(`Biztosan t√∂rl√∂d a c√©lt: "${goalToDelete.name}"?`) === false) return;
  }

  goals.splice(i, 1);
  renderGoals();
  // Edz√©s f√ºl friss√≠t√©se, ha az akt√≠v
  if (document.getElementById('workouts').classList.contains('active')) {
    populateWorkoutCategoryFilter();
    renderWorkoutGoals();
  }
  await logActivity(`üóëÔ∏è C√©l t√∂r√∂lve: ${goalToDelete ? goalToDelete.name : 'ismeretlen c√©l'}`);
}
function renderGoals() {
  const list = document.getElementById("goalList");
  list.innerHTML = "";

  // === √öJ KIZ√ÅR√ì SZ≈∞R√âS AZ EDZ√âS F√úL ALAPJ√ÅN ===
  let workoutCategory = "";
  const filterSelect = document.getElementById("workoutGoalFilter");
  if (filterSelect) {
    workoutCategory = filterSelect.value;
  }

  // === D√°tum alap√∫ sz≈±r√©s ===
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayISO = toDateInputString(new Date().toISOString());

  const visibleGoals = goals
    .map((goal, i) => ({ ...goal, originalIndex: i }))
    .filter(g => {
      // Ha az Edz√©s f√ºl√∂n sz≈±r√ºnk kateg√≥ri√°ra, itt ne jelenjen meg
      if (workoutCategory !== "" && g.category === workoutCategory) return false;

      if (g.startDate) {
         return g.startDate <= todayISO;
      }
      return true;
    });

  // ===== SZ√âTV√ÅLOGAT√ÅSI LOGIKA =====
  const punishmentGoals = [];
  const priorityGoals = [];
  const categorized = {};
  const uncategorized = [];

  visibleGoals.forEach((item) => {
    if (item.isPunishment) {
        punishmentGoals.push(item);
    } else if (item.isPriority) {
      priorityGoals.push(item);
    } else if (item.category) {
      if (!categorized[item.category]) categorized[item.category] = [];
      categorized[item.category].push(item);
    } else {
      uncategorized.push(item);
    }
  });

  const renderItem = (g, i) => {
    const div = document.createElement("div");
    let classList = "goal-item";
    if (g.done) classList += " completed";
    if (g.isPriority) classList += " priority";
    if (g.isPunishment) classList += " punishment";
    div.className = classList;

    // === VISSZASZ√ÅML√ÅL√ÅS √âS LEJ√ÅRAT ELLEN≈êRZ√âS ===
    let countdownHTML = "";
    let isExpired = false; // Seg√©dv√°ltoz√≥: lej√°rt-e a b√ºntet√©s?

    if (g.isPunishment && !g.done) {
        const now = Date.now();
        // Ha nincs deadline (r√©gi adat), akkor a startDate-b≈ël sz√°molunk + 24h-t
        const deadline = g.deadline || (new Date(g.startDate).getTime() + 24 * 60 * 60 * 1000);
        const diff = deadline - now;

        if (diff > 0) {
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            // Ha kevesebb mint 1 √≥ra, piros legyen
            const colorStyle = hours < 1 ? "color: #ff5252;" : "color: #ff8a80;";
            countdownHTML = `<span class="punishment-deadline" style="${colorStyle}">‚è≥ H√°tral√©v≈ë id≈ë: ${hours}√≥ ${minutes}p</span>`;
        } else {
            isExpired = true; // IGEN, LEJ√ÅRT!
            countdownHTML = `<span class="punishment-deadline" style="color: red; font-weight: bold;">‚åõ LEJ√ÅRT - FELDOLGOZ√ÅS...</span>`;
        }
    }
    // ===========================================

    let subGoalsHTML = "";
    let hasSubGoals = g.subGoals && g.subGoals.length > 0;
    let hasTasks = false;

    if (hasSubGoals) {
      subGoalsHTML = '<div class="subgoal-list">';
      g.subGoals.forEach((sg, subIndex) => {
        const sgType = sg.type || 'task';
        switch (sgType) {
          case 'header': subGoalsHTML += `<h4 class="subgoal-header">${sg.text}</h4>`; break;
          case 'separator': subGoalsHTML += `<hr class="subgoal-separator">`; break;
          case 'task': default:
            hasTasks = true;
            // ITT A V√ÅLTOZTAT√ÅS: Ha lej√°rt (isExpired), nem renderel√ºnk checkboxot, csak sz√∂veget!
            if (g.isPunishment && isExpired) {
                subGoalsHTML += `
                  <div style="opacity: 0.6;">
                    <span style="margin-right: 10px;">üö´</span>
                    <span style="text-decoration: line-through;">${sg.text}</span>
                  </div>
                `;
            } else {
                // === √öJ: Highlightok (H√°tt√©rsz√≠nek) ===
                // K√∂telez≈ë (f≈ë): Pirosas (#ffebee), Opcion√°lis: K√©kes (#e1f5fe)
                // Bet≈±sz√≠n: Fekete marad, padding √©s lekerek√≠t√©s a sz√©p megjelen√©s√©rt
                const bgStyle = sg.isOptional ? 'background-color: #e1f5fe;' : 'background-color: #ffebee;';

                subGoalsHTML += `
                  <div style="margin-bottom: 2px;">
                    <input type="checkbox" onchange="toggleSubGoal(${i}, ${subIndex})" ${sg.done ? 'checked' : ''}>
                    <span class="${sg.done ? 'subgoal-done' : ''}" style="${bgStyle} color: black; padding: 2px 5px; border-radius: 4px;">${sg.text}</span>
                  </div>
                `;
            }
            break;
        }
      });
      subGoalsHTML += '</div>';
    }

    let progressBarHTML = "";
    if (hasTasks && !(g.isPunishment && isExpired)) { // Ne mutassuk a s√°vot, ha lej√°rt
      const tasks = g.subGoals.filter(sg => (sg.type || 'task') === 'task');
      const totalTasks = tasks.length;
      const completedTasks = tasks.filter(sg => sg.done).length;
      let progressPercent = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
      progressBarHTML = `<div class="subgoal-progress-container"><div class="subgoal-progress-fill" style="width: ${progressPercent}%;"></div></div>`;
    }

	// === √öJ GOMB LOGIKA: K√∂telez≈ëk k√©szenl√©te eset√©n gomb megjelen√≠t√©se ===
    let showCheckBtn = false;
    const tasks = (g.subGoals || []).filter(sg => (sg.type || 'task') === 'task');
    const mandatoryTasks = tasks.filter(t => !t.isOptional);

    if (tasks.length === 0) {
       showCheckBtn = true; // Nincs alc√©l, kell a gomb
    } else {
       // Ha minden k√∂telez≈ë k√©sz, megjelen√≠tj√ºk a gombot (opcion√°lisok miatt vagy sim√°n)
       if (mandatoryTasks.every(t => t.done)) {
          showCheckBtn = true;
       }
    }

    // Visszavon√°s gomb (X) mindig kell, ha k√©sz van
    if (g.done) showCheckBtn = true;

    const priorityIcon = g.isPriority ? 'üìå ' : '';
    const recurringIcon = g.isRecurring ? ' üîÑ' : '';

    // === √öJ: Ponttartom√°ny sz√°m√≠t√°sa (pl. 100-120 pont) ===
    let pointsDisplay = `${g.points} pont`;
    if (hasTasks) {
        const tasks = g.subGoals.filter(sg => (sg.type || 'task') === 'task');
        const mandatoryCount = tasks.filter(t => !t.isOptional).length;
        const totalCount = tasks.length;
        // Ha van k√∂telez≈ë √©s van extra (opcion√°lis) is
        if (mandatoryCount > 0 && totalCount > mandatoryCount) {
             const maxPoints = Math.round(g.points * (totalCount / mandatoryCount));
             pointsDisplay = `${g.points}-${maxPoints} pont`;
        }
    }

    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${priorityIcon}${g.name}${recurringIcon}</div>
        ${countdownHTML}
        ${progressBarHTML} ${subGoalsHTML}
      </div>
      <div class="item-points">
        ${pointsDisplay}
      </div>
      <div class="item-actions">
        ${(g.isPunishment && isExpired) ? '' : `<button class="archive-btn" title="Archiv√°l√°s" onclick="archiveGoal(${i})">üì•</button>`}
        ${(g.isPunishment && isExpired) ? '' : `<button onclick="editGoal(${i})" title="Szerkeszt√©s">‚úèÔ∏è</button>`}

        <button onclick="deleteGoal(${i})" title="T√∂rl√©s">üóëÔ∏è</button>

        ${showCheckBtn && !(g.isPunishment && isExpired) ? (
          g.done ?
          `<button onclick="toggleGoal(${i})" title="Visszavon√°s">‚ùå</button>` :
          `<button onclick="toggleGoal(${i})" title="Teljes√≠t (+B√≥nusz)">‚úÖ</button>`
        ) : '' }
      </div>
    `;
    list.appendChild(div);
  };

  // 0. B√úNTET√âSEK RENDEREL√âSE (Legfel√ºl)
  if (punishmentGoals.length > 0) {
    const title = document.createElement("h3");
    title.className = "category-title";
    title.textContent = "üî• B√úNTET√âSEK (24h)";
    title.style.color = "#b71c1c";
    title.style.borderColor = "#b71c1c";
    list.appendChild(title);
    punishmentGoals.forEach(item => renderItem(item, item.originalIndex));
  }

  // 1. Priorit√°sos c√©lok
  if (priorityGoals.length > 0) {
    const title = document.createElement("h3");
    title.className = "category-title";
    title.textContent = "üìå Fontos C√©lok";
    title.style.color = "#c62828";
    title.style.borderColor = "#e57373";
    list.appendChild(title);
    priorityGoals.forEach(item => renderItem(item, item.originalIndex));
  }

  // 2. Kateg√≥ri√°k
  const categoryNames = Object.keys(categorized).sort();
  categoryNames.forEach(categoryName => {
    const title = document.createElement("h3");
    title.className = "category-title";
    title.textContent = categoryName;
    list.appendChild(title);
    categorized[categoryName].forEach(item => renderItem(item, item.originalIndex));
  });

  // 3. Egy√©b
  if (uncategorized.length > 0) {
    if (categoryNames.length > 0 || priorityGoals.length > 0 || punishmentGoals.length > 0) {
      const title = document.createElement("h3");
      title.className = "category-title";
      title.textContent = "Egy√©b";
      list.appendChild(title);
    }
    uncategorized.forEach(item => renderItem(item, item.originalIndex));
  }
}
// ==========================================================
// ===== √öJ FUNKCI√ì: FOGADALMAK (VOWS) KEZEL√âSE =============
// ==========================================================

async function saveVow() {
    const name = document.getElementById("vowNameInput").value.trim();
    const duration = document.getElementById("vowDurationInput").value;
    const points = parseInt(document.getElementById("vowPointsInput").value);
    const penalty = document.getElementById("vowPenaltyInput").value.trim();
    const penaltyPoints = parseInt(document.getElementById("vowPenaltyPointsInput").value) || 0;

    const subGoalsText = document.getElementById("vowSubGoalsInput").value;
    let subGoals = [];
    if (subGoalsText.trim() !== "") {
        subGoals = subGoalsText.split('\n').map(text => text.trim()).filter(text => text.length > 0).map(rawText => {
            return { type: 'task', text: rawText, done: false };
        });
    }

    if (!name || isNaN(points) || points < 0) return alert("K√©rlek adj meg egy nevet √©s √©rv√©nyes pont√©rt√©ket!");

    vows.push({
        id: Date.now(),
        name, duration, points,
        startDate: new Date().toISOString().slice(0, 10),
        lastCompletedDate: null,
        penalty: penalty || null,
        penaltyPoints: penaltyPoints,
        subGoals: subGoals,
    });

    document.getElementById("vowNameInput").value = "";
    document.getElementById("vowPointsInput").value = "";
    document.getElementById("vowPenaltyInput").value = "";
    document.getElementById("vowPenaltyPointsInput").value = "";
    document.getElementById("vowSubGoalsInput").value = "";
    closeModal('vowModal');
    renderVows();
    await logActivity(`‚úã √öj fogadalom: ${name} (${duration})`);
}

function renderVows() {
    const list = document.getElementById("vowList");
    if (!list) return;
    list.innerHTML = "";
    const todayISO = new Date().toISOString().slice(0, 10);

    if (vows.length === 0) {
        list.innerHTML = "<p style='text-align:center; padding: 10px;'>M√©g nincsenek akt√≠v fogadalmaid.</p>";
        return;
    }

    vows.forEach((vow, i) => {
        const div = document.createElement("div");
        const isCompletedToday = vow.lastCompletedDate === todayISO;
        div.className = `vow-item fade-in ${isCompletedToday ? 'completed-today' : ''}`;

        const totalTasks = vow.subGoals ? vow.subGoals.filter(sg => sg.type === 'task').length : 0;
        const completedTasks = vow.subGoals ? vow.subGoals.filter(sg => sg.type === 'task' && sg.done).length : 0;
        const progressPercent = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

        let progressBarHTML = totalTasks > 0 ? `<div class="subgoal-progress-container" style="height: 3px; background: #90caf9; border-color: #64b5f6; margin-top: 5px;"><div class="subgoal-progress-fill" style="width: ${progressPercent}%; background: #2196f3; border-radius: 5px;"></div></div>` : "";
        let endText = vow.duration === 'weekly' ? "(Heti)" : "(Havi)";

        div.innerHTML = `
            <div class="item-name" style="flex-direction: column;">
                <div class="item-name-main" style="${isCompletedToday ? 'text-decoration: none;' : ''}">‚úã ${vow.name} <span style="font-size: 0.8em; font-weight: normal; color: #1e88e5;">${endText}</span></div>
                ${progressBarHTML}
                <div class="subgoal-list" style="margin-top: 5px;">
                    ${vow.subGoals ? vow.subGoals.map((sg, subIndex) => `<div><input type="checkbox" onchange="toggleVowSubGoal(${i}, ${subIndex})" ${sg.done ? 'checked' : ''} style="margin-top: 0;"><span class="${sg.done ? 'subgoal-done' : ''}" style="color: #222;">${sg.text}</span></div>`).join('') : ''}
                </div>
                ${vow.penalty ? `<small style="color: #c62828; margin-top: 5px; font-weight: bold;">‚ö†Ô∏è B√ºntet√©s: ${vow.penalty} (${vow.penaltyPoints} pont)</small>` : ''}
            </div>
            <div class="item-actions" style="background: ${isCompletedToday ? '#90caf9' : '#e3f2fd'};">
                ${isCompletedToday ? `<button style="color:#00796b; font-size: 1.1em;" title="Teljes√≠t√©s visszavon√°sa" onclick="toggleVowCompletion(${i})">‚ùå</button>` : `<button style="color:#00796b; font-size: 1.1em;" title="Mai teljes√≠t√©s" onclick="toggleVowCompletion(${i})">‚úÖ</button>`}
                <button class="fail-btn" title="Fogadalom megszeg√©se" onclick="failVowToday(${i})">üî•</button>
                <button title="T√∂rl√©s" onclick="deleteVow(${i})">üóëÔ∏è</button>
            </div>
        `;
        list.appendChild(div);
    });
}

async function toggleVowCompletion(i) {
    const vow = vows[i];
    const todayISO = new Date().toISOString().slice(0, 10);
    if (vow.lastCompletedDate === todayISO) {
        vow.lastCompletedDate = null;
        totalPoints -= vow.points;
        addPointsLogEntry(-vow.points, `‚ùå Fogadalom visszavonva: ${vow.name}`);
    } else {
        vow.lastCompletedDate = todayISO;
        totalPoints += vow.points;
        addPointsLogEntry(vow.points, `‚úÖ Fogadalom teljes√≠tve: ${vow.name}`);
    }
    animatePoints(totalPoints);
    renderVows();
    await saveDataToFirestore();
}

async function toggleVowSubGoal(vowIndex, subGoalIndex) {
    const vow = vows[vowIndex];
    if (vow && vow.subGoals && vow.subGoals[subGoalIndex]) {
        vow.subGoals[subGoalIndex].done = !vow.subGoals[subGoalIndex].done;
        renderVows();
        await saveDataToFirestore();
    }
}

async function failVowToday(i) {
    const vow = vows[i];
    if (!vow.penalty) return alert("Nincs b√ºntet√©s megadva.");
    if (!confirm(`Megszegted? B√ºntet√©s hozz√°ad√°sa: "${vow.penalty}"`)) return;

    // 24 √≥ra milliszekundumban
    const dayInMs = 24 * 60 * 60 * 1000;
    const now = Date.now();

    const penaltyGoal = {
        name: `B√úNTET√âS: ${vow.name} - ${vow.penalty}`,
        points: 0,
        penaltyPointsIfDeleted: vow.penaltyPoints,
        done: false, category: "B√ºntet√©s", isPriority: true, isPunishment: true,
        startDate: toDateInputString(new Date()),
        deadline: now + dayInMs, // ITT A L√âNYEG: 24 √≥ra m√∫lva j√°r le
        subGoals: [{ type: 'task', text: vow.penalty, done: false }]
    };
    goals.unshift(penaltyGoal);

    if (vow.lastCompletedDate === new Date().toISOString().slice(0, 10)) {
        vow.lastCompletedDate = null;
        totalPoints -= vow.points;
        addPointsLogEntry(-vow.points, `‚ùå B√ºntet√©s miatt pontlevon√°s`);
    }
    animatePoints(totalPoints);
    renderGoals();
    renderVows();
    await logActivity(`üî• FOGADALOM MEGSZEGVE: ${vow.name}`);
}

async function deleteVow(i) {
    if (!confirm(`T√∂rl√∂d a(z) "${vows[i].name}" fogadalmat?`)) return;
    const name = vows[i].name;
    vows.splice(i, 1);
    renderVows();
    await logActivity(`üóëÔ∏è Fogadalom t√∂r√∂lve: ${name}`);
}
// ===== ARCH√çVUM FUNKCI√ìK =====
function openArchiveModal() {
  renderArchivedGoals();
  openModal('archiveModal');
}

async function archiveGoal(index) {
  const goalToArchive = goals.splice(index, 1)[0];

  if (goalToArchive) {

    // --- √öJ LOGIKA: Ha ism√©tl≈ëd≈ë, √°ll√≠tsuk be a k√∂vetkez≈ë d√°tumot ---
    if (goalToArchive.isRecurring && goalToArchive.recurrence) {
        const today = new Date();
        let nextDate = new Date(today); // Ma
        const rec = goalToArchive.recurrence;
        const interval = parseInt(rec.interval) || 1;

        // Kisz√°moljuk a k√∂vetkez≈ë d√°tumot a gyakoris√°g alapj√°n
        switch(rec.frequency) {
            case 'daily':
                nextDate.setDate(today.getDate() + interval);
                break;
            case 'weekly':
                nextDate.setDate(today.getDate() + (interval * 7));
                break;
            case 'monthly':
                nextDate.setMonth(today.getMonth() + interval);
                break;
            case 'yearly':
                nextDate.setFullYear(today.getFullYear() + interval);
                break;
            default:
                nextDate.setDate(today.getDate() + 1); // Alap√©rtelmezett: holnap
        }

        // Biztos√≠tjuk, hogy a d√°tum form√°tuma megfelel≈ë legyen (YYYY-MM-DD)
        // Ehhez felhaszn√°ljuk a l√©tez≈ë toDateInputString logik√°j√°t, de helyben gener√°ljuk
        const y = nextDate.getFullYear();
        const m = (nextDate.getMonth() + 1).toString().padStart(2, '0');
        const d = nextDate.getDate().toString().padStart(2, '0');
        const formattedNextDate = `${y}-${m}-${d}`;

        // Be√°ll√≠tjuk az √∫j d√°tumot az objektumba
        goalToArchive.recurrence.recurrenceStartDate = formattedNextDate;

        console.log(`C√©l archiv√°lva a k√∂vetkez≈ë d√°tumig: ${formattedNextDate}`);
    }
    // ----------------------------------------------------------------------

    archivedGoals.unshift(goalToArchive);
    renderGoals();

    // Edz√©s f√ºl friss√≠t√©se, ha az akt√≠v
    if (document.getElementById('workouts').classList.contains('active')) {
      populateWorkoutCategoryFilter();
      renderWorkoutGoals();
    }

    await logActivity(`üì• C√©l archiv√°lva (k√∂vetkez≈ë: ${goalToArchive.isRecurring ? goalToArchive.recurrence.recurrenceStartDate : 'manu√°lis'}): ${goalToArchive.name}`);
  }
}

function renderArchivedGoals() {
  const list = document.getElementById("archivedGoalList");
  list.innerHTML = "";

  if (archivedGoals.length === 0) {
    list.innerHTML = "<p style='text-align: center; padding: 10px;'>Nincsenek archiv√°lt c√©lok.</p>";
    return;
  }

  archivedGoals.forEach((goal, index) => {
    // √öJ, M√ìDOS√çTOTT R√âSZ
    const div = document.createElement("div");

    // Ellen≈ërizz√ºk, hogy a c√©l v√°rakoz√≥ (pending) vagy m√°r teljes√≠tett (done)
    const todayISO = toDateInputString(new Date().toISOString());

    // === JAV√çTOTT ST√ÅTUSZ LOGIKA KEZDETE ===

    // 1. √Åltal√°nos "Megjelen√©s d√°tuma" (nem ism√©tl≈ëd≈ë, vagy ism√©tl≈ëd≈ë de a f≈ë d√°tumot haszn√°lva)
    const isPendingOnStartDate = goal.startDate && goal.startDate > todayISO && !goal.done;

    // 2. Kifejezetten "Ism√©tl≈ëd√©s kezdete" d√°tumra v√°r
    const isPendingOnRecurrence = goal.isRecurring && !goal.done && goal.recurrence && goal.recurrence.recurrenceStartDate && goal.recurrence.recurrenceStartDate > todayISO;

    // 3. M√°r teljes√≠tett, √©s a k√∂vetkez≈ë ism√©tl≈ëd√©sre v√°r
    const isCompletedRecurring = goal.isRecurring && goal.done && goal.lastCompleted && goal.recurrence && typeof goal.recurrence === 'object';

    // === LOGIKA V√âGE ===

    // Csak akkor h√∫zzuk √°t, ha 'done' (teljes√≠tett)
    div.className = goal.done ? "goal-item completed" : "goal-item";

    // Gomb az ism√©tl≈ëd√©s kikapcsol√°s√°hoz (lila sz√≠nnel)
    let recurringBtn = "";
    if (goal.isRecurring) {
      recurringBtn = `<button style="color: #8e24aa;" title="Ism√©tl≈ëd√©s kikapcsol√°sa" onclick="toggleRecurrenceInArchive(${index})">üîÑ</button>`;
    }

    // N√©v √©s V√°rakoz√°si d√°tum / √öjraaktiv√°l√°s d√°tum√°nak √∂ssze√°ll√≠t√°sa
        // N√©v √©s V√°rakoz√°si d√°tum / √öjraaktiv√°l√°s d√°tum√°nak √∂ssze√°ll√≠t√°sa
        let goalNameHTML = `<div class="item-name-main">${goal.name} ${goal.isRecurring ? 'üîÑ' : ''}</div>`;
        let statusTextHTML = ""; // K√ºl√∂n v√°ltoz√≥ a st√°tuszsz√∂vegnek

        if (isPendingOnStartDate) {
          // J√ñV≈êBEN INDUL√ì (√ÅLTAL√ÅNOS D√ÅTUM)
          let displayDate = goal.startDate;
          try {
            displayDate = new Date(goal.startDate.split('-')[0], goal.startDate.split('-')[1] - 1, goal.startDate.split('-')[2]).toLocaleDateString('hu-HU');
          } catch(e) {}
          statusTextHTML = `<small style="font-weight:bold; color:#004d40;">(Indul: ${displayDate})</small>`;

        } else if (isPendingOnRecurrence) {
          // J√ñV≈êBEN INDUL√ì (ISM√âTL≈êD√âS D√ÅTUMA) - EZ AZ √öJ BLOKK
          let displayDate = goal.recurrence.recurrenceStartDate;
           try {
            displayDate = new Date(displayDate.split('-')[0], displayDate.split('-')[1] - 1, displayDate.split('-')[2]).toLocaleDateString('hu-HU');
          } catch(e) {}
          statusTextHTML = `<small style="font-weight:bold; color:#004d40;">(Ism√©tl≈ëd√©s indul: ${displayDate})</small>`;

        } else if (isCompletedRecurring) {
          // TELJES√çTETT, √öJRAAKTIV√ÅL√ÅSRA V√ÅR√ì C√âL
          const recurrence = goal.recurrence;
          const nextDate = getNextDueDate(goal.lastCompleted, recurrence);
          const displayDate = nextDate.toLocaleDateString('hu-HU');

          let remainingText = "";
          if (recurrence.endCondition === 'count') {
            const remaining = (recurrence.endCount || 0) - (recurrence.currentCount || 0);
            remainingText = `(m√©g ${remaining} alkalom)`;
          } else if (recurrence.endCondition === 'date') {
            const endDate = new Date(recurrence.endDate).toLocaleDateString('hu-HU');
            remainingText = `(${endDate}-ig)`;
          } else {
            remainingText = "(nincs korl√°t)";
        }

          statusTextHTML = `<small style="font-weight:bold; color:#004d40;">(Akt√≠v: ${displayDate} ${remainingText})</small>`;
        }

    div.innerHTML = `
      <div class="item-name">
         ${goalNameHTML}
		 ${statusTextHTML}
      </div>
      <div class="item-points">
        ${goal.points} pont
      </div>
      <div class="item-actions">
        ${recurringBtn} <button class="reactivate-btn" title="Vissza√°ll√≠t√°s a f≈ëoldalra" onclick="reactivateGoal(${index})">üîôÔ∏è</button>
		<button style="color:#00796b" title="Szerkeszt√©s" onclick="editArchivedGoal(${index})">‚úèÔ∏è</button>
        <button class="delete-btn" title="V√©gleges t√∂rl√©s" onclick="deleteArchivedGoal(${index})">üóëÔ∏è</button>
      </div>
    `;
    list.appendChild(div);
  });
}

async function reactivateGoal(index) {
  const goalToReactivate = archivedGoals.splice(index, 1)[0];

  if (goalToReactivate) {
    goalToReactivate.done = false;
	goalToReactivate.startDate = null; // EZ AZ √öJ SOR

    // Alc√©lok "kipip√°latlan√≠t√°sa"
    if (goalToReactivate.subGoals && goalToReactivate.subGoals.length > 0) {
      goalToReactivate.subGoals.forEach(sg => {
        sg.done = false;
      });
    }

    // BIZTONS√ÅGI L√âP√âS: T√∂r√∂lj√ºk a legut√≥bbi teljes√≠t√©st,
    // hogy a manu√°lisan vissza√°ll√≠tott c√©l biztosan akt√≠v maradjon.
    if (goalToReactivate.isRecurring) {
      goalToReactivate.lastCompleted = null;
    }

    goals.push(goalToReactivate);

    renderGoals();
    renderArchivedGoals(); // Ezt kell futtatni, mert az arch√≠vum lista is v√°ltozott
	// Edz√©s f√ºl friss√≠t√©se, ha az akt√≠v
  if (document.getElementById('workouts').classList.contains('active')) {
    populateWorkoutCategoryFilter();
    renderWorkoutGoals();
  }
    await logActivity(`üîô C√©l vissza√°ll√≠tva: ${goalToReactivate.name}`);
  }
}

async function deleteArchivedGoal(index) {
  if (confirm("Biztosan v√©gleg t√∂rl√∂d ezt az archiv√°lt c√©lt? Ez nem vonhat√≥ vissza.")) {
    const deletedGoal = archivedGoals.splice(index, 1)[0];

    if (deletedGoal) {
      if (deletedGoal.points > 0) {
        totalPoints -= deletedGoal.points;
        animatePoints(totalPoints);
      }
      renderArchivedGoals();
      addPointsLogEntry(-deletedGoal.points, `üóëÔ∏è Archiv√°lt c√©l t√∂r√∂lve: ${deletedGoal.name}`);
      await logActivity(`üóëÔ∏è Archiv√°lt c√©l t√∂r√∂lve: ${deletedGoal.name} (-${deletedGoal.points} pont)`);
    }
  }
}
// ===== √öJ FUNKCI√ì: ARCHIV√ÅLT C√âL SZERKESZT√âSE =====
function editArchivedGoal(index) {
  const goal = archivedGoals[index]; // Az archiv√°lt t√∂mbb≈ël vessz√ºk

  editTarget = {
    type: 'archivedGoal', // √öj t√≠pus, hogy a ment√©s tudja, mit kell tenni
    index: index
  };
  document.getElementById("editTitle").textContent = "üéØ Archiv√°lt c√©l szerkeszt√©se";

  // --- Innent≈ël a k√≥d azonos az editGoal funkci√≥val,
  // de a 'goal' v√°ltoz√≥t haszn√°lja 'goals[i]' helyett ---

  document.getElementById("editLabel1").textContent = "C√©l neve";
  document.getElementById("editInput1").value = goal.name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont √©rt√©k";
  document.getElementById("editInput2").value = goal.points;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";

  document.getElementById("editLabel3").textContent = "Kateg√≥ria (opcion√°lis)";
  document.getElementById("editInput3").value = goal.category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";

  const subGoalsText = (goal.subGoals || [])
    .map(sg => {
      const sgType = sg.type || 'task';
      if (sgType === 'header') {
        return `# ${sg.text}`;
      } else if (sgType === 'separator') {
        return '---';
      }
      return sg.text;
    })
    .join('\n');

  document.getElementById("editLabelSubGoals").style.display = "block";
  document.getElementById("editInputSubGoals").value = subGoalsText;
  document.getElementById("editInputSubGoals").style.display = "block";

  const isRecurring = goal.isRecurring || false;
  document.getElementById("editRecurringFields").style.display = "block";
  document.getElementById("editIsRecurringInput").checked = isRecurring;
  document.getElementById("editRecurrenceOptions").style.display = isRecurring ? "block" : "none";

  const recurrence = goal.recurrence;

  document.getElementById("editRecurrenceInterval").value = 1;
  document.getElementById("editRecurrenceFrequency").value = "daily";
  document.getElementById("editEndNever").checked = true;
  document.getElementById("editEndCountInput").value = 5;
  document.getElementById("editEndDateInput").value = "";

  if (recurrence) {
    if (typeof recurrence === 'object') {
      document.getElementById("editRecurrenceInterval").value = recurrence.interval || 1;
      document.getElementById("editRecurrenceFrequency").value = recurrence.frequency || "daily";
      const endCondition = recurrence.endCondition || 'never';
      document.getElementById(`editEnd${endCondition.charAt(0).toUpperCase() + endCondition.slice(1)}`).checked = true;
      if (endCondition === 'count') {
        document.getElementById("editEndCountInput").value = recurrence.endCount || 5;
      } else if (endCondition === 'date') {
        document.getElementById("editEndDateInput").value = recurrence.endDate || "";
      }

    } else if (typeof recurrence === 'string') {
      document.getElementById("editEndNever").checked = true;
      if (recurrence === 'daily') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      } else if (recurrence === 'weekly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "weekly";
      } else if (recurrence === 'monthly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "monthly";
      } else if (recurrence.endsWith('days')) {
        document.getElementById("editRecurrenceInterval").value = parseInt(recurrence) || 2;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      }
    }
  }

  const recStartDate = (recurrence && recurrence.recurrenceStartDate) ? recurrence.recurrenceStartDate : "";
  document.getElementById("editRecurrenceStartDateInput").value = toDateInputString(recStartDate);

  const isPriority = goal.isPriority || false;
  document.getElementById("editPriorityField").style.display = "block";
  document.getElementById("editIsPriorityInput").checked = isPriority;

  const startDateField = document.getElementById("editStartDateField");
  const startDateInput = document.getElementById("editStartDateInput");
  startDateField.style.display = "block";
  if (goal.startDate) {
    startDateInput.value = toDateInputString(goal.startDate);
  } else {
    startDateInput.value = "";
  }

  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";

  openModal('editModal');
}
// ===== √öJ FUNKCI√ì: ARCHIV√ÅLT C√âL SZERKESZT√âSE =====
function editArchivedGoal(index) {
  const goal = archivedGoals[index]; // Az archiv√°lt t√∂mbb≈ël vessz√ºk

  editTarget = {
    type: 'archivedGoal', // √öj t√≠pus, hogy a ment√©s tudja, mit kell tenni
    index: index
  };
  document.getElementById("editTitle").textContent = "üéØ Archiv√°lt c√©l szerkeszt√©se";

  // --- Innent≈ël a k√≥d azonos az editGoal funkci√≥val,
  // de a 'goal' v√°ltoz√≥t haszn√°lja 'goals[i]' helyett ---

  document.getElementById("editLabel1").textContent = "C√©l neve";
  document.getElementById("editInput1").value = goal.name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont √©rt√©k";
  document.getElementById("editInput2").value = goal.points;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";

  document.getElementById("editLabel3").textContent = "Kateg√≥ria (opcion√°lis)";
  document.getElementById("editInput3").value = goal.category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";

  const subGoalsText = (goal.subGoals || [])
    .map(sg => {
      const sgType = sg.type || 'task';
      if (sgType === 'header') {
        return `# ${sg.text}`;
      } else if (sgType === 'separator') {
        return '---';
      }
      return sg.text;
    })
    .join('\n');

  document.getElementById("editLabelSubGoals").style.display = "block";
  document.getElementById("editInputSubGoals").value = subGoalsText;
  document.getElementById("editInputSubGoals").style.display = "block";

  const isRecurring = goal.isRecurring || false;
  document.getElementById("editRecurringFields").style.display = "block";
  document.getElementById("editIsRecurringInput").checked = isRecurring;
  document.getElementById("editRecurrenceOptions").style.display = isRecurring ? "block" : "none";

  const recurrence = goal.recurrence;

  document.getElementById("editRecurrenceInterval").value = 1;
  document.getElementById("editRecurrenceFrequency").value = "daily";
  document.getElementById("editEndNever").checked = true;
  document.getElementById("editEndCountInput").value = 5;
  document.getElementById("editEndDateInput").value = "";

  if (recurrence) {
    if (typeof recurrence === 'object') {
      document.getElementById("editRecurrenceInterval").value = recurrence.interval || 1;
      document.getElementById("editRecurrenceFrequency").value = recurrence.frequency || "daily";
      const endCondition = recurrence.endCondition || 'never';
      document.getElementById(`editEnd${endCondition.charAt(0).toUpperCase() + endCondition.slice(1)}`).checked = true;
      if (endCondition === 'count') {
        document.getElementById("editEndCountInput").value = recurrence.endCount || 5;
      } else if (endCondition === 'date') {
        document.getElementById("editEndDateInput").value = recurrence.endDate || "";
      }

    } else if (typeof recurrence === 'string') {
      document.getElementById("editEndNever").checked = true;
      if (recurrence === 'daily') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      } else if (recurrence === 'weekly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "weekly";
      } else if (recurrence === 'monthly') {
        document.getElementById("editRecurrenceInterval").value = 1;
        document.getElementById("editRecurrenceFrequency").value = "monthly";
      } else if (recurrence.endsWith('days')) {
        document.getElementById("editRecurrenceInterval").value = parseInt(recurrence) || 2;
        document.getElementById("editRecurrenceFrequency").value = "daily";
      }
    }
  }

  const recStartDate = (recurrence && recurrence.recurrenceStartDate) ? recurrence.recurrenceStartDate : "";
  document.getElementById("editRecurrenceStartDateInput").value = toDateInputString(recStartDate);

  const isPriority = goal.isPriority || false;
  document.getElementById("editPriorityField").style.display = "block";
  document.getElementById("editIsPriorityInput").checked = isPriority;

  const startDateField = document.getElementById("editStartDateField");
  const startDateInput = document.getElementById("editStartDateInput");
  startDateField.style.display = "block";
  if (goal.startDate) {
    startDateInput.value = toDateInputString(goal.startDate);
  } else {
    startDateInput.value = "";
  }

  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";

  openModal('editModal');
}
// ===== √öJ FUNKCI√ì: Ism√©tl≈ëd√©s kikapcsol√°sa az arch√≠vumban =====
async function toggleRecurrenceInArchive(index) {
  if (index < 0 || index >= archivedGoals.length) return;

  const goal = archivedGoals[index];

  if (!confirm(`Biztosan kikapcsolod az ism√©tl≈ëd√©st enn√©l a c√©ln√©l: "${goal.name}"? Ett≈ël kezdve nem fog automatikusan √∫jra megjelenni.`)) {
    return;
  }

  // T√∂r√∂lj√ºk az ism√©tl≈ëd√©shez kapcsol√≥d√≥ tulajdons√°gokat
  delete goal.isRecurring;
  delete goal.recurrence;
  delete goal.lastCompleted;

  // √öjrarajzoljuk az arch√≠vumot, hogy a gomb elt≈±nj√∂n
  renderArchivedGoals();
  await logActivity(`üîÑ Ism√©tl≈ëd√©s kikapcsolva: ${goal.name}`);
  // A logActivity m√°r mag√°ban foglalja a saveDataToFirestore() h√≠v√°st
}

// ===== √öJ SZ√ñVEGFORM√ÅZ√ì SEG√âDF√úGGV√âNYEK =====


/**
¬†* Sz√∂vegt√∂mbb√© alak√≠tja a sima sz√∂veget (# √©s --- alapj√°n).
¬†*/
function parseTextToStructuredArray(text) {
¬† ¬† if (!text || text.trim() === "") return [];

¬† ¬† return text.split('\n')
¬† ¬† ¬† ¬† .map(text => text.trim())
¬† ¬† ¬† ¬† .filter(text => text.length > 0)
¬† ¬† ¬† ¬† .map(rawText => {
¬† ¬† ¬† ¬† ¬† if (rawText.startsWith('#')) {
¬† ¬† ¬† ¬† ¬† ¬† return {
¬† ¬† ¬† ¬† ¬† ¬† ¬† type: 'header',
¬† ¬† ¬† ¬† ¬† ¬† ¬† text: rawText.substring(1).trim()
¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† } else if (rawText === '---') {
¬† ¬† ¬† ¬† ¬† ¬† return {
¬† ¬† ¬† ¬† ¬† ¬† ¬† type: 'separator',
¬† ¬† ¬† ¬† ¬† ¬† ¬† text: '---'
¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† return {
¬† ¬† ¬† ¬† ¬† ¬† ¬† type: 'paragraph',
¬† ¬† ¬† ¬† ¬† ¬† ¬† text: rawText
¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });
}

/**
 * Visszaalak√≠tja a sz√∂vegt√∂mb√∂t sima sz√∂vegg√© a textarea-ba.
 * Kezeli a r√©gi, sima string adatokat is.
 */
function parseStructuredArrayToText(arrayOrString) {
    if (!arrayOrString) return "";
    // R√©gi adatok kezel√©se (ha m√©g sima string)
    if (typeof arrayOrString === 'string') return arrayOrString;

    // √öj, t√∂mb alap√∫ adatok visszaalak√≠t√°sa
    return arrayOrString.map(item => {
        const type = item.type || 'paragraph'; // Alap√©rtelmezett
        if (type === 'header') {
            return `# ${item.text}`;
        } else if (type === 'separator') {
            return '---';
        }
        return item.text; // 'paragraph'
    }).join('\n');
}

/**
 * HTML-t gener√°l a sz√∂vegt√∂mbb≈ël a 'noteViewModal' sz√°m√°ra.
 * Kezeli a r√©gi, sima string adatokat is.
 */
function renderStructuredArrayToHTML(arrayOrString) {
    if (!arrayOrString || (Array.isArray(arrayOrString) && arrayOrString.length === 0)) {
         return "<p style='color: #777; font-style: italic;'>Nincs jegyzet...</p>";
    }

    // R√©gi adatok kezel√©se (ha m√©g sima string)
    if (typeof arrayOrString === 'string') {
        // Alap cser√©k: sort√∂r√©sek (<br>) √©s linkek (ha vannak)
        return arrayOrString
            .replace(/</g, "&lt;").replace(/>/g, "&gt;") // XSS v√©delem
            .replace(/\n/g, "<br>")
            .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    }

    // √öj, t√∂mb alap√∫ adatok renderel√©se
    let html = "";
    arrayOrString.forEach(item => {
        const type = item.type || 'paragraph';
        const text = item.text.replace(/</g, "&lt;").replace(/>/g, "&gt;"); // XSS v√©delem

        switch (type) {
            case 'header':
                // √öjrahasznos√≠tjuk a c√©lok alc√≠m st√≠lus√°t
                html += `<h4 class="subgoal-header">${text}</h4>`;
                break;
            case 'separator':
                // √öjrahasznos√≠tjuk a c√©lok elv√°laszt√≥ st√≠lus√°t
                html += `<hr class="subgoal-separator">`;
                break;
            case 'paragraph':
            default:
                 // Linkek felismer√©se a paragrafusokban
                const linkedText = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
                html += `<p style="margin-bottom: 8px;">${linkedText}</p>`;
                break;
        }
    });
    return html;
}
// ===== JUTALMAK (REFACTORED) =====

async function saveReward() { // Make async
  const name = document.getElementById("rewardNameInput").value.trim();
  const cost = parseInt(document.getElementById("rewardCostInput").value);
  if (!name || isNaN(cost) || cost < 0) return alert("√ârv√©nytelen n√©v vagy pontsz√°m! (0 vagy nagyobb lehet)");

  rewards.push({
    name,
    cost
  });
  document.getElementById("rewardNameInput").value = "";
  document.getElementById("rewardCostInput").value = "";
  closeModal('rewardModal');
  renderRewards();
  await logActivity(`üéÅ Jutalom hozz√°adva: ${name} (${cost} pont)`);
}

async function claimReward(i) { // Make async
  if (totalPoints >= rewards[i].cost) {
    if (confirm(`Biztosan kiv√°ltod ezt: "${rewards[i].name}" (${rewards[i].cost} pont√©rt)?`)) {
      totalPoints -= rewards[i].cost;
      animatePoints(totalPoints);
      renderRewards();
      addPointsLogEntry(-rewards[i].cost, `üéâ Jutalom kiv√°ltva: ${rewards[i].name}`);
      await logActivity(`üéâ Jutalom kiv√°ltva: ${rewards[i].name} (-${rewards[i].cost} pont)`);
    }
  } else {
    alert("Nincs el√©g pontod!");
  }
}

function editReward(i) {
  editTarget = {
    type: 'reward',
    index: i
  };
  document.getElementById("editTitle").textContent = "üéÅ Jutalom szerkeszt√©se";

  document.getElementById("editLabel1").textContent = "Jutalom neve";
  document.getElementById("editInput1").value = rewards[i].name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont √°ra";
  document.getElementById("editInput2").value = rewards[i].cost;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";

  document.getElementById("editLabel3").style.display = "none";
  document.getElementById("editInput3").style.display = "none";
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  document.getElementById("editPriorityField").style.display = "none";

  openModal('editModal');
}

async function deleteReward(i) { // Make async
  const deletedName = rewards[i].name;
  rewards.splice(i, 1);
  renderRewards();
  await logActivity(`üóëÔ∏è Jutalom t√∂r√∂lve: ${deletedName}`);
}

function renderRewards() {
  const list = document.getElementById("rewardList");
  list.innerHTML = "";
  rewards.forEach((r, i) => {
    const div = document.createElement("div");
    div.className = "reward-item";

    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${r.name}</div>
      </div>
      <div class="item-points">
        ${r.cost} pont
      </div>
      <div class="item-actions">
        <button onclick="editReward(${i})">‚úèÔ∏è</button>
        <button onclick="deleteReward(${i})">üóëÔ∏è</button>
        <button onclick="claimReward(${i})">üéâ</button>
      </div>
    `;
    list.appendChild(div);
  });
}
// ===== √öJ √âTKEZ√âS FUNKCI√ìK =====
// A modal c√≠mk√©inek friss√≠t√©se a t√≠pusv√°laszt√≥ alapj√°n
function updateMealModalLabels() {
  const type = document.getElementById("mealTypeSelect").value;
  const kcalLabel = document.getElementById("mealKcalLabel");
  const proteinLabel = document.getElementById("mealProteinLabel");
  const fatLabel = document.getElementById("mealFatLabel");

  if (type === 'unit') {
    kcalLabel.textContent = "Kal√≥ria (kcal/darab)";
    proteinLabel.textContent = "Feh√©rje (g/darab)";
	fatLabel.textContent = "Zs√≠r (g/darab)";
  } else { // weight
    kcalLabel.textContent = "Kal√≥ria (kcal/100g)";
    proteinLabel.textContent = "Feh√©rje (g/100g)";
	fatLabel.textContent = "Zs√≠r (g/100g)";
  }
}

// √öj √©tel ment√©se
async function saveMeal() {
  const name = document.getElementById("mealNameInput").value.trim();
  const category = document.getElementById("mealCategoryInput").value.trim();
  const type = document.getElementById("mealTypeSelect").value;
  const kcal = parseFloat(document.getElementById("mealKcalInput").value);
  const protein = parseFloat(document.getElementById("mealProteinInput").value);
  const fat = parseFloat(document.getElementById("mealFatInput").value);
  // M√ìDOS√çT√ÅS: A sz√∂veget egyenesen a form√°z√≥ funkci√≥ba k√ºldj√ºk
  const noteArray = parseTextToStructuredArray(document.getElementById("mealNoteInput").value);

  if (!name) return alert("Az √©telnek nevet kell adni!");
  if (isNaN(kcal) || kcal < 0) return alert("√ârv√©nytelen kal√≥ria √©rt√©k!");
  if (isNaN(protein) || protein < 0) return alert("√ârv√©nytelen feh√©rje √©rt√©k!");
  if (isNaN(fat) || fat < 0) return alert("√ârv√©nytelen zs√≠r √©rt√©k!");

  const meal = {
    name,
    category: category || null,
    type,
    kcal,
    protein,
	fat,
    note: noteArray // M√ìDOS√çT√ÅS: A t√∂mb√∂t mentj√ºk
  };

  meals.push(meal);

  document.getElementById("mealNameInput").value = "";
  document.getElementById("mealCategoryInput").value = "";
  document.getElementById("mealTypeSelect").value = "unit";
  document.getElementById("mealKcalInput").value = "";
  document.getElementById("mealProteinInput").value = "";
  document.getElementById("mealFatInput").value = "";
  document.getElementById("mealFatInput").value = "";
  document.getElementById("mealNoteInput").value = ""; // <-- √öJ SOR

  closeModal('mealModal');
  renderMeals();
  await logActivity(`üçΩÔ∏è √öj √©tel mentve: ${name}`);
}
// √âtelek list√°j√°nak kirajzol√°sa
function renderMeals() {
  const list = document.getElementById("mealList");
  if (!list) return;
  list.innerHTML = "";

  // ===== KERES√âSI LOGIKA =====
  const searchInput = document.getElementById("mealSearchInput");
  let searchTerm = "";
  if (searchInput) {
    searchTerm = searchInput.value.toLowerCase().trim();
  }

  // 1. L√âP√âS: Sz≈±r√©s √©s az eredeti index hozz√°ad√°sa
  const mealsToRender = meals
    .map((meal, index) => ({ ...meal,
      originalIndex: index
    })) // Hozz√°adjuk az eredeti indexet
    .filter(mealWithIndex =>
      mealWithIndex.name.toLowerCase().includes(searchTerm)
    );
  // ===== KERES√âSI LOGIKA V√âGE =====

  // 2. L√âP√âS: √úres lista ellen≈ërz√©se a SZ≈∞RT t√∂mb alapj√°n
  if (mealsToRender.length === 0) {
    if (meals.length === 0) {
      // Ha az eredeti lista is √ºres
      list.innerHTML = "<p style='text-align:center; padding: 10px;'>M√©g nincsenek mentett √©teleid. Adj hozz√° egyet!</p>";
    } else {
      // Ha van √©tel, de a keres√©s nem tal√°lt semmit
      list.innerHTML = "<p style='text-align:center; padding: 10px;'>Nincs a keres√©snek megfelel≈ë tal√°lat.</p>";
    }
    return;
  }
  // ===== KATEGORIZ√ÅL√ÅS KEZDETE =====
  const categorized = {};
  const uncategorized = [];

  // 3. L√âP√âS: Iter√°l√°s a SZ≈∞RT t√∂mb√∂n ('mealsToRender')
  mealsToRender.forEach((item) => { // 'item' m√°r tartalmazza az originalIndex-et
    if (item.category) {
      if (!categorized[item.category]) {
        categorized[item.category] = [];
      }
      categorized[item.category].push(item);
    } else {
      uncategorized.push(item);
    }
  });
  // ===== KATEGORIZ√ÅL√ÅS V√âGE =====
  // --- Seg√©df√ºggv√©ny egy √©tel kirajzol√°s√°hoz ---
  const renderItem = (meal, i) => {
    const div = document.createElement("div");
    div.className = "food-item";

    const maxCal = 1000;
    const maxProt = 100;

    let calPercent = (meal.kcal / maxCal) * 100;
    let protPercent = (meal.protein / maxProt) * 100;

    if (calPercent > 100) calPercent = 100;
    if (protPercent > 100) protPercent = 100;
    if (calPercent < 0) calPercent = 0;
    if (protPercent < 0) protPercent = 0;

    let detailsText = "";
    if (meal.type === 'unit') {
      detailsText = `<span>${meal.kcal} kcal/db</span><span>${meal.protein}g prot./db</span>`;
    } else {
      detailsText = `<span>${meal.kcal} kcal/100g</span><span>${meal.protein}g prot./100g</span>`;
    }

    const progressHTML = `
    <div class="meal-progress-container">
        <div class="meal-progress-wrapper">
            <span class="meal-progress-label">Kal√≥ria:</span>
            <div class="meal-progress-bar-bg">
                <div class="meal-progress-bar-fill" style="width: ${calPercent}%;"></div>
            </div>
        </div>
        <div class="meal-progress-wrapper">
            <span class="meal-progress-label">Protein:</span>
            <div class="meal-progress-bar-bg">
                <div class="meal-progress-bar-fill protein" style="width: ${protPercent}%;"></div>
            </div>
        </div>
    </div>
    `;

    // === V√âGLEGES JAV√çT√ÅS KEZDETE ===
    // 1. JAV√çT√ÅS: Helyesen ellen≈ërizz√ºk, hogy a 'meal.note' t√∂mb nem √ºres-e
    const hasNote = (Array.isArray(meal.note) && meal.note.length > 0) ||
                (typeof meal.note === 'string' && meal.note.trim() !== "");
    // 2. JAV√çT√ÅS: Az ikont sz√≥k√∂z n√©lk√ºl defini√°ljuk
    const noteIcon = hasNote ? 'üóíÔ∏è' : '';
    const noteTitle = hasNote ? 'Kattints a jegyzet megtekint√©s√©hez' : '';
    const noteOnClick = hasNote ? `onclick="openMealNoteModal(${i})"` : '';
    const noteStyle = hasNote ? 'cursor: pointer; text-decoration: underline; text-decoration-style: dotted;' : '';
    // === JAV√çT√ÅS V√âGE ===

    div.innerHTML = `
    <div class="food-item-row1">
        <div class="item-name">
            <div class="item-name-main" ${noteOnClick} style="${noteStyle}" title="${noteTitle}">${meal.name}${hasNote ? ' ' : ''}${noteIcon}</div>
        </div>
        <div class="item-details">
            ${detailsText}
        </div>
        <div class="item-actions">
            <button onclick="editMeal(${i})" title="Szerkeszt√©s">‚úèÔ∏è</button>
            <button onclick="deleteMeal(${i})" title="T√∂rl√©s">üóëÔ∏è</button>
            <button onclick="openConsumeModal(${i})" title="Fogyaszt√°s">üçΩÔ∏è</button>
        </div>
    </div>
    ${progressHTML}
    `;
    list.appendChild(div);
  };
  // --- Seg√©df√ºggv√©ny v√©ge ---
  // ===== KATEG√ìRI√ÅK KIRAJZOL√ÅSA =====
  const categoryNames = Object.keys(categorized).sort();
  categoryNames.forEach(categoryName => {
    const title = document.createElement("h3");
    title.className = "category-title";
    title.textContent = categoryName;
    list.appendChild(title);

    categorized[categoryName].forEach(item => {
      renderItem(item, item.originalIndex); // 4. L√âP√âS: Az eredeti indexet adjuk √°t
    });
  });
  // ===== KATEG√ìRIA N√âLK√úLIEK KIRAJZOL√ÅSA =====
  if (uncategorized.length > 0) {
    if (categoryNames.length > 0) {
      const title = document.createElement("h3");
      title.className = "category-title";
      title.textContent = "Egy√©b";
      list.appendChild(title);
    }
    uncategorized.forEach(item => {
      renderItem(item, item.originalIndex); // 4. L√âP√âS: Az eredeti indexet adjuk √°t
    });
  }
}
// √âtel szerkeszt√©se (megnyitja a szerkeszt≈ë modalt)
function editMeal(i) {
  editTarget = {
    type: 'meal',
    index: i
  };
  const meal = meals[i];

  document.getElementById("editTitle").textContent = "üçΩÔ∏è √âtel szerkeszt√©se";

  // Alap mez≈ëk (√°tnevezve)
  document.getElementById("editLabel1").textContent = "√âtel neve";
  document.getElementById("editInput1").value = meal.name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  // Elrejtj√ºk a felesleges 'points' mez≈ët
  document.getElementById("editLabel2").style.display = "none";
  document.getElementById("editInput2").style.display = "none";

  // Haszn√°ljuk a 'v3' mez≈ët a kateg√≥ri√°nak
  document.getElementById("editLabel3").textContent = "Kateg√≥ria";
  document.getElementById("editInput3").value = meal.category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";

  // Elrejtj√ºk a t√∂bbit (kiv√©ve a jegyzetet)
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  document.getElementById("editRecurringFields").style.display = "none";

  // ===== M√ìDOS√çT√ÅS ITT =====
  // Megjelen√≠tj√ºk a Jegyzet mez≈ët (ezt haszn√°lja a notes √©s workout is)
  document.getElementById("editLabelText").textContent = "Jegyzet (opcion√°lis)";
  document.getElementById("editLabelText").style.display = "block";
  document.getElementById("editInputText").value = parseStructuredArrayToText(meal.note);
  document.getElementById("editInputText").style.display = "block";
  // ===== M√ìDOS√çT√ÅS V√âGE =====

  // Megjelen√≠tj√ºk az √©tel-specifikus mez≈ëket
  document.getElementById("editMealFields").style.display = "block";
  document.getElementById("editMealType").value = meal.type;
  document.getElementById("editMealKcal").value = meal.kcal;
  document.getElementById("editMealProtein").value = meal.protein;
  document.getElementById("editMealFat").value = meal.fat || 0;
  document.getElementById("editPriorityField").style.display = "none";

  openModal('editModal');
}

// √âtel t√∂rl√©se
async function deleteMeal(i) {
  if (confirm(`Biztosan t√∂rl√∂d ezt az √©telt: "${meals[i].name}"?`)) {
    const deletedName = meals[i].name;
    meals.splice(i, 1);
    renderMeals();
    await logActivity(`üóëÔ∏è √âtel t√∂r√∂lve: ${deletedName}`);
  }
}

// Fogyaszt√°s ablak megnyit√°sa
function openConsumeModal(i) {
  editTarget = {
    type: 'consume',
    index: i
  };
  const meal = meals[i];

  document.getElementById("consumeMealTitle").textContent = meal.name;

  const amountLabel = document.getElementById("consumeAmountLabel");
  const amountInput = document.getElementById("consumeAmountInput");

  if (meal.type === 'unit') {
    amountLabel.textContent = "Mennyis√©g (Darab)";
    amountInput.placeholder = "pl. 2";
    document.getElementById("consumeMealDetails").textContent = `${meal.kcal} kcal, ${meal.protein}g protein / darab`;
  } else {
    amountLabel.textContent = "Mennyis√©g (Gramm)";
    amountInput.placeholder = "pl. 150";
    document.getElementById("consumeMealDetails").textContent = `${meal.kcal} kcal, ${meal.protein}g protein / 100g`;
  }

  amountInput.value = "";
  openModal('consumeModal');
}

// Fogyaszt√°s meger≈ës√≠t√©se
async function confirmConsume() {
  const amount = parseFloat(document.getElementById("consumeAmountInput").value);
  if (!amount || amount <= 0) return alert("√ârv√©nytelen mennyis√©g!");

  const meal = meals[editTarget.index];

  let totalKcal = 0;
  let totalProtein = 0;
  let totalFat = 0;
  let unitLabel = "";

  if (meal.type === 'unit') {
    totalKcal = meal.kcal * amount;
    totalProtein = meal.protein * amount;
	totalFat = (meal.fat || 0) * amount;
    unitLabel = "db";
  } else { // weight
    totalKcal = (meal.kcal / 100) * amount;
    totalProtein = (meal.protein / 100) * amount;
	totalFat = ((meal.fat || 0) / 100) * amount;
    unitLabel = "g";
  }

  // √öj tranzakci√≥ l√©trehoz√°sa
  const transaction = {
    id: Date.now(),
    type: 'meal',
    name: meal.name,
    amount: amount,
    unit: unitLabel,
    totalKcal: totalKcal,
    totalProtein: totalProtein,
	totalFat: totalFat,
    date: new Date()
  };
  transactions.push(transaction);

  // Azonnali friss√≠t√©s
  dailyProgress.calories += totalKcal;
  dailyProgress.protein += totalProtein;
  dailyProgress.fat += totalFat;

  updateAllSummaries();
  updateHistory();
  await logActivity(`üçΩÔ∏è Fogyasztva: ${amount} ${unitLabel} ${meal.name} (+${totalKcal.toFixed(0)} kcal, +${totalProtein.toFixed(0)}g prot., +${totalFat.toFixed(0)}g zs√≠r)`);

  closeModal('consumeModal');
}
// ===== KIB≈êV√çTETT SZERKESZT√âS FUNKCI√ì (REFACTORED) =====
async function confirmEdit() { // Make async
  const v1 = document.getElementById("editInput1").value; // C√≠m / N√©v

  if (!editTarget) return;

  if (editTarget.type === 'goal') {
    const v2 = parseInt(document.getElementById("editInput2").value); // Pont
    const v3 = document.getElementById("editInput3").value.trim(); // Kateg√≥ria

    if (!v1) return alert("A c√©lnak nevet kell adni!");
    if (isNaN(v2) || v2 < 0) return alert("√ârv√©nytelen pontsz√°m! Adj meg 0-t vagy nagyobbat.");

    if (goals[editTarget.index].done) {
      let diff = v2 - goals[editTarget.index].points;
      if (diff !== 0) {
        totalPoints += diff;
        addPointsLogEntry(diff, `‚úèÔ∏è Pont√©rt√©k m√≥dos√≠tva: ${goals[editTarget.index].name}`);
        animatePoints(totalPoints);
      }
    }
    goals[editTarget.index].name = v1;
    goals[editTarget.index].points = v2;
    goals[editTarget.index].category = v3;
	goals[editTarget.index].startDate = document.getElementById("editStartDateInput").value || null; // EZ AZ √öJ SOR

    // ===== M√ìDOS√çTOTT ALC√âL FELDOLGOZ√ÅS KEZDETE (JAV√çTOTT LOGIK√ÅVAL) =====
    const newSubGoalsText = document.getElementById("editInputSubGoals").value;

    // L√©trehozunk egy M√ÅSOLATOT a r√©gi alc√©lokb√≥l, amib≈ël "elfogyaszthatjuk" az elemeket
    const availableOldSubGoals = [...(goals[editTarget.index].subGoals || [])];
    let newSubGoals = [];

    if (newSubGoalsText.trim() !== "") {
      newSubGoals = newSubGoalsText.split('\n')
        .map(text => text.trim())
        .filter(text => text.length > 0)
        .map(rawText => {
¬† ¬† ¬† ¬† ¬† // 1. El≈ësz√∂r meghat√°rozzuk az √öJ elem t√≠pus√°t √©s tiszta sz√∂veg√©t
¬† ¬† ¬† ¬† ¬† let newItem;
¬† ¬† ¬† ¬† ¬† if (rawText.startsWith('#')) {
¬† ¬† ¬† ¬† ¬† ¬† newItem = {
¬† ¬† ¬† ¬† ¬† ¬† ¬† type: 'header',
¬† ¬† ¬† ¬† ¬† ¬† ¬† text: rawText.substring(1).trim()
¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† } else if (rawText === '---') {
¬† ¬† ¬† ¬† ¬† ¬† newItem = {
¬† ¬† ¬† ¬† ¬† ¬† ¬† type: 'separator',
¬† ¬† ¬† ¬† ¬† ¬† ¬† text: '---'
¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† // === JAV√çT√ÅS: Opcion√°lis alc√©l felismer√©se (@ jel) ===
¬† ¬† ¬† ¬† ¬† } else if (rawText.startsWith('@')) {
¬† ¬† ¬† ¬† ¬† ¬† newItem = {
¬† ¬† ¬† ¬† ¬† ¬† ¬† type: 'task',
¬† ¬† ¬† ¬† ¬† ¬† ¬† text: rawText.substring(1).trim(), // Lev√°gjuk a @ jelet
¬† ¬† ¬† ¬† ¬† ¬† ¬† done: false,
¬† ¬† ¬† ¬† ¬† ¬† ¬† isOptional: true // Be√°ll√≠tjuk opcion√°lisnak
¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† newItem = {
¬† ¬† ¬† ¬† ¬† ¬† ¬† type: 'task',
¬† ¬† ¬† ¬† ¬† ¬† ¬† text: rawText,
¬† ¬† ¬† ¬† ¬† ¬† ¬† done: false,
¬† ¬† ¬† ¬† ¬† ¬† ¬† isOptional: false
¬† ¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† // 2. Megkeress√ºk az ELS≈ê el√©rhet≈ë, AZONOS T√çPUS√ö √âS SZ√ñVEG≈∞ r√©gi alc√©lt
¬† ¬† ¬† ¬† ¬† // JAV√çT√ÅS: Most m√°r az isOptional tulajdons√°got is figyelj√ºk az egyez√©sn√©l
¬† ¬† ¬† ¬† ¬† const existingIndex = availableOldSubGoals.findIndex(
¬† ¬† ¬† ¬† ¬† ¬† sg => (sg.type || 'task') === (newItem.type || 'task')
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†&& sg.text === newItem.text
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†&& !!sg.isOptional === !!newItem.isOptional
¬† ¬† ¬† ¬† ¬† );

¬† ¬† ¬† ¬† ¬† if (existingIndex > -1) {
¬† ¬† ¬† ¬† ¬† ¬† // Ha tal√°ltunk...
¬† ¬† ¬† ¬† ¬† ¬† const existing = availableOldSubGoals.splice(existingIndex, 1)[0];
¬† ¬† ¬† ¬† ¬† ¬† return existing;
¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† // Ha nem tal√°ltunk, ez egy √∫j alc√©l
¬† ¬† ¬† ¬† ¬† ¬† return newItem;
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });
    }
    // ===== M√ìDOS√çTOTT ALC√âL FELDOLGOZ√ÅS V√âGE =====
    goals[editTarget.index].subGoals = newSubGoals;

	// √öJ: Priorit√°s friss√≠t√©se (EZ A HELYES HELY)
    const isPriority = document.getElementById("editIsPriorityInput").checked;
    goals[editTarget.index].isPriority = isPriority;

    // ===== √öJ, B≈êV√çTETT ISM√âTL≈êD√âS MENT√âSE =====
    const isRecurring = document.getElementById("editIsRecurringInput").checked;
    if (isRecurring) {
      goals[editTarget.index].isRecurring = true;

      // 1. Beolvassuk az intervallumot √©s a frekvenci√°t
      const frequency = document.getElementById("editRecurrenceFrequency").value;
      const interval = parseInt(document.getElementById("editRecurrenceInterval").value) || 1;

      // 2. Beolvassuk a befejez√©si felt√©telt
      const endCondition = document.querySelector('input[name="editEndCondition"]:checked').value;
      const endCount = parseInt(document.getElementById("editEndCountInput").value) || 5;
      const endDate = document.getElementById("editEndDateInput").value || null;
      const recurrenceStartDate = document.getElementById("editRecurrenceStartDateInput").value || null; // <-- √öJ SOR

      // 3. √ñssze√°ll√≠tjuk az √∫j recurrence objektumot
      // Megtartjuk a 'currentCount'-ot, ha m√°r l√©tezett, k√ºl√∂nben 0-r√≥l indul
      const currentCount = (goals[editTarget.index].recurrence && typeof goals[editTarget.index].recurrence === 'object')
        ? (goals[editTarget.index].recurrence.currentCount || 0)
        : 0;

      goals[editTarget.index].recurrence = {
        frequency: frequency,
        interval: interval,
      	recurrenceStartDate: recurrenceStartDate, // <-- √öJ SOR
        endCondition: endCondition,
        endDate: (endCondition === 'date' && endDate) ? endDate : null,
        endCount: (endCondition === 'count') ? endCount : null,
        currentCount: currentCount
      };

      // lastCompleted-et nem b√°ntjuk, az a teljes√≠t√©skor friss√ºl

    } else {
      // Ha a felhaszn√°l√≥ KIKAPCSOLTA az ism√©tl≈ëd√©st
      delete goals[editTarget.index].isRecurring;
      delete goals[editTarget.index].recurrence;
      delete goals[editTarget.index].lastCompleted;
    }
    // ===== ISM√âTL≈êD√âS MENT√âS√âNEK V√âGE =====

    // √öJ: √Ållapot √∫jrasz√°mol√°sa szerkeszt√©s ut√°n
    const goal = goals[editTarget.index];
    const wasMainGoalDone = goal.done;

    // M√ìDOS√çTVA: Csak a 'task' t√≠pus√∫ alc√©lokat sz√°moljuk
    const taskSubGoals = newSubGoals.filter(sg => (sg.type || 'task') === 'task');
    const allDone = taskSubGoals.length > 0 && taskSubGoals.every(sg => sg.done);

    if (allDone && !wasMainGoalDone) {
      goal.done = true;
      if (goal.isRecurring) goal.lastCompleted = new Date().toISOString();
      totalPoints += goal.points;
      animatePoints(totalPoints);
    } else if (!allDone && wasMainGoalDone) {
      goal.done = false;
      if (goal.isRecurring) goal.lastCompleted = null;
      totalPoints -= goal.points;
      animatePoints(totalPoints);
    }
	// ILLESZD BE EZT A BLOKKOT a confirmEdit 'goal' √°g√°ba, a renderGoals() h√≠v√°s el√©:

    // Ellen≈ërz√©s: √Åt kell-e helyezni a c√©lt az arch√≠vumba id≈ëz√≠t√©s miatt?
    const editedGoal = goals[editTarget.index];
    const todayISO = toDateInputString(new Date().toISOString());
    // ===== M√ìDOS√çTOTT ARCHIV√ÅL√ÅSI LOGIKA =====
    const isPendingOnStartDate = editedGoal.startDate && editedGoal.startDate > todayISO;
    const isPendingOnRecurrenceDate = editedGoal.isRecurring && editedGoal.recurrence.recurrenceStartDate && editedGoal.recurrence.recurrenceStartDate > todayISO;

    if (editedGoal && (isPendingOnStartDate || isPendingOnRecurrenceDate)) {
      console.log(`C√©l √°thelyez√©se az arch√≠vumba (id≈ëz√≠t√©s): ${editedGoal.name}`);
      const goalToArchive = goals.splice(editTarget.index, 1)[0];
      archivedGoals.unshift(goalToArchive);

      // Mivel √°thelyezt√ºk, az arch√≠vum n√©zetet is friss√≠teni kell, ha nyitva van
      if (document.getElementById('archiveModal').style.display === 'flex') {
        renderArchivedGoals();
      }
    }
    // Edz√©s f√ºl friss√≠t√©se, ha az akt√≠v
  if (document.getElementById('workouts').classList.contains('active')) {
    populateWorkoutCategoryFilter();
    renderWorkoutGoals();
  }
    renderGoals();
    await logActivity(`‚úèÔ∏è C√©l szerkesztve: ${v1}`);
  } else if (editTarget.type === 'reward') {
    const v2 = parseInt(document.getElementById("editInput2").value); // √År

    if (!v1) return alert("A jutalomnak nevet kell adni!");
    if (isNaN(v2) || v2 < 0) return alert("√ârv√©nytelen pont √°r! A 0 vagy nagyobb √©rt√©k megengedett.");

    rewards[editTarget.index].name = v1;
    rewards[editTarget.index].cost = v2;

    renderRewards(); // Ez a fontos: a jutalmakat rajzolja √∫jra
    await logActivity(`‚úèÔ∏è Jutalom szerkesztve: ${v1}`);

  // === EZT ILLESZD BE IDE: ===
  } else if (editTarget.type === 'archivedGoal') {
    const v2 = parseInt(document.getElementById("editInput2").value); // Pont
    const v3 = document.getElementById("editInput3").value.trim(); // Kateg√≥ria

    if (!v1) return alert("A c√©lnak nevet kell adni!");
    if (isNaN(v2) || v2 < 0) return alert("√ârv√©nytelen pontsz√°m!");

    const goalToEdit = archivedGoals[editTarget.index];

    if (goalToEdit.done) {
      let diff = v2 - goalToEdit.points;
      if (diff !== 0) {
        totalPoints += diff;
        addPointsLogEntry(diff, `‚úèÔ∏è (Arch√≠v) Pont√©rt√©k m√≥dos√≠tva: ${goalToEdit.name}`);
        animatePoints(totalPoints);
      }
    }
    goalToEdit.name = v1;
    goalToEdit.points = v2;
    goalToEdit.category = v3;
    goalToEdit.startDate = document.getElementById("editStartDateInput").value || null;
    goalToEdit.isPriority = document.getElementById("editIsPriorityInput").checked;

    // Alc√©lok ment√©se
    const newSubGoalsText = document.getElementById("editInputSubGoals").value;
    const availableOldSubGoals = [...(goalToEdit.subGoals || [])];
    let newSubGoals = [];
    if (newSubGoalsText.trim() !== "") {
      newSubGoals = newSubGoalsText.split('\n').map(text => text.trim()).filter(t => t.length > 0).map(rawText => {
         let newItem;
         if (rawText.startsWith('#')) newItem = { type: 'header', text: rawText.substring(1).trim() };
         else if (rawText === '---') newItem = { type: 'separator', text: '---' };
         else newItem = { type: 'task', text: rawText, done: false };

         const existingIndex = availableOldSubGoals.findIndex(sg => (sg.type || 'task') === (newItem.type || 'task') && sg.text === newItem.text);
         if (existingIndex > -1) return availableOldSubGoals.splice(existingIndex, 1)[0];
         else return newItem;
      });
    }
    goalToEdit.subGoals = newSubGoals;

    // Ism√©tl≈ëd√©s ment√©se
    const isRecurring = document.getElementById("editIsRecurringInput").checked;
    if (isRecurring) {
      goalToEdit.isRecurring = true;
      const frequency = document.getElementById("editRecurrenceFrequency").value;
      const interval = parseInt(document.getElementById("editRecurrenceInterval").value) || 1;
      const endCondition = document.querySelector('input[name="editEndCondition"]:checked').value;
      const endCount = parseInt(document.getElementById("editEndCountInput").value) || 5;
      const endDate = document.getElementById("editEndDateInput").value || null;
      const recurrenceStartDate = document.getElementById("editRecurrenceStartDateInput").value || null;

      const currentCount = (goalToEdit.recurrence && typeof goalToEdit.recurrence === 'object') ? (goalToEdit.recurrence.currentCount || 0) : 0;

      goalToEdit.recurrence = {
        frequency, interval, recurrenceStartDate, endCondition,
        endDate: (endCondition === 'date' && endDate) ? endDate : null,
        endCount: (endCondition === 'count') ? endCount : null,
        currentCount
      };
    } else {
      delete goalToEdit.isRecurring;
      delete goalToEdit.recurrence;
      delete goalToEdit.lastCompleted;
    }
    // Edz√©s f√ºl friss√≠t√©se, ha az akt√≠v
  if (document.getElementById('workouts').classList.contains('active')) {
    populateWorkoutCategoryFilter();
    renderWorkoutGoals();
  }
    renderArchivedGoals();
    await logActivity(`‚úèÔ∏è Archiv√°lt c√©l szerkesztve: ${v1}`);
  } else if (editTarget.type === 'reward') {
    const v2 = parseInt(document.getElementById("editInput2").value); // √År
    if (!v1) return alert("A jutalomnak nevet kell adni!");
    if (isNaN(v2) || v2 < 0) return alert("√ârv√©nytelen pont √°r! A 0 vagy nagyobb √©rt√©k megengedett.");

    rewards[editTarget.index].name = v1;
    rewards[editTarget.index].cost = v2;
    renderRewards();
    await logActivity(`‚úèÔ∏è Jutalom szerkesztve: ${v1}`);
  } else if (editTarget.type === 'note') {
    const v3 = document.getElementById("editInput3").value.trim(); // Kateg√≥ria olvas√°sa
    // M√ìDOS√çT√ÅS: A sz√∂veget egyenesen a form√°z√≥ funkci√≥ba k√ºldj√ºk
    const vTextArray = parseTextToStructuredArray(document.getElementById("editInputText").value);
    if (!v1) return alert("A c√≠m nem lehet √ºres!");
    if (vTextArray.length === 0) return alert("A sz√∂veg nem lehet √ºres!");

    notes[editTarget.index].title = v1;
    notes[editTarget.index].category = v3 || null; // Kateg√≥ria ment√©se
    notes[editTarget.index].text = vTextArray; // M√ìDOS√çT√ÅS: A t√∂mb√∂t mentj√ºk
    notes[editTarget.index].date = new Date(); // D√°tum friss√≠t√©se
    renderNotes(); // √öjrarajzol√°s (hogy a kateg√≥ria friss√ºlj√∂n)
    await logActivity(`‚úèÔ∏è Jegyzet szerkesztve: ${v1}`);
  } else if (editTarget.type === 'workout') {
    const vTextArray = parseTextToStructuredArray(document.getElementById("editInputText").value);
    workouts[editTarget.index].note = vTextArray; // M√ìDOS√çT√ÅS: A t√∂mb√∂t mentj√ºk
    await logActivity(`‚úèÔ∏è Edz√©sjegyzet mentve: ${workouts[editTarget.index].date}`);
  }
// √öJ: √âTEL SZERKESZT√âS√âNEK MENT√âSE
  else if (editTarget.type === 'meal') {
    const name = v1;
    const category = document.getElementById("editInput3").value.trim();
    const type = document.getElementById("editMealType").value;
    const kcal = parseFloat(document.getElementById("editMealKcal").value);
    const protein = parseFloat(document.getElementById("editMealProtein").value);
	const fat = parseFloat(document.getElementById("editMealFat").value);
    // M√ìDOS√çT√ÅS: A sz√∂veget egyenesen a form√°z√≥ funkci√≥ba k√ºldj√ºk
    const noteArray = parseTextToStructuredArray(document.getElementById("editInputText").value);

    if (!name) return alert("Az √©telnek nevet kell adni!");
    if (isNaN(kcal) || kcal < 0) return alert("√ârv√©nytelen kal√≥ria √©rt√©k!");
    if (isNaN(protein) || protein < 0) return alert("√ârv√©nytelen feh√©rje √©rt√©k!");
	if (isNaN(fat) || fat < 0) return alert("√ârv√©nytelen zs√≠r √©rt√©k!");

    meals[editTarget.index] = {
      name,
      category: category || null,
      type,
      kcal,
      protein,
	  fat,
      note: noteArray // M√ìDOS√çT√ÅS: A t√∂mb√∂t mentj√ºk
    };
    renderMeals();
    await logActivity(`‚úèÔ∏è √âtel szerkesztve: ${name}`);
  }
  else if (editTarget.type === 'reminder') {
    const text = document.getElementById("editInput1").value.trim();
    const time = document.getElementById("editInput2").value; // 'datetime-local' string
    const highlight = document.getElementById("editIsRecurringInput").checked;
    const highlightDate = document.getElementById("editInput3").value; // 'date' string

    if (!text || !time) {
      return alert("A sz√∂veg √©s az id≈ëpont nem lehet √ºres!");
    }

    const reminderTime = new Date(time);

    if (highlight && !highlightDate) {
      return alert("Ha kiemel√©st k√©rsz, meg kell adnod a kiemel√©s kezd≈ë d√°tum√°t!");
    }

    if (highlight && new Date(highlightDate) > reminderTime) {
      alert("A kiemel√©s kezdete nem lehet k√©s≈ëbb, mint az eml√©keztet≈ë id≈ëpontja!");
	  return;
    }
    // Objektum friss√≠t√©se a t√∂mbben
    const reminder = reminders[editTarget.index];
    reminder.text = text;
    reminder.time = reminderTime.toISOString();
    reminder.highlight = highlight;
    reminder.highlightDate = highlight ? new Date(highlightDate).toISOString() : null;

    // Vissza√°ll√≠tjuk 'triggered' √°llapotra, hogy √∫jra els√ºlhessen
    reminder.triggered = false;

    renderAll(); // √öjrarajzol mindent (eml√©keztet≈ë lista, f≈ëoldali kiemel√©s)
    await logActivity(`‚úèÔ∏è Eml√©keztet≈ë szerkesztve: ${text}`);
   }
  closeModal('editModal');
  // Vissza√°ll√≠tjuk az editModal mez≈ëit alaphelyzetbe
  document.getElementById("editLabel1").style.display = "block";
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  document.getElementById("editRecurringFields").style.display = "none";
  document.getElementById("editRecurringFields").style.display = "none";
  document.getElementById("editPriorityField").style.display = "none"; // <-- EZT A SORT ADJ HOZZ√Å
}
// ===== NAPL√ì (REFACTORED) =====
async function logActivity(text) { // Make async
  const time = new Date();
  const entry = {
    time,
    text
  };

  if (!Array.isArray(logs)) {
    console.error("Logs is not an array, resetting.");
    logs = [];
  }

  logs.unshift(entry);
  if (logs.length > 100) logs.pop();
  renderLogs();

  await saveDataToFirestore();
}

function renderLogs() {
  const logDiv = document.getElementById("activityLog");
  logDiv.innerHTML = "";
  logs.forEach((l, i) => {
    let displayTime = "...";
    if (l.time) {
      if (typeof l.time.toDate === 'function') {
        displayTime = l.time.toDate().toLocaleString();
      } else {
        displayTime = new Date(l.time).toLocaleString();
      }
    }

    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `
      <span>${l.text}</span>
      <small>${displayTime}</small>
      <button style="background:none;color:#c00" onclick="deleteLog(${i})">üóëÔ∏è</button>
    `;
    logDiv.appendChild(div);
  });
}

async function deleteLog(i) { // Make async
  logs.splice(i, 1);
  renderLogs();
  await saveDataToFirestore();
}

async function clearAllLogs() { // Make async
  if (confirm("Biztos t√∂rl√∂d az √∂sszes napl√≥bejegyz√©st?")) {
    logs = [];
    renderLogs();
    await saveDataToFirestore();
  }
}
// ===== √öJ PONT T√ñRT√âNET FUNKCI√ìK =====
/**
 * L√©trehoz egy bejegyz√©st a pontnapl√≥ban.
 * Ezt a f√ºggv√©nyt NEM kell await-elni, √©s NEM ment mag√°t√≥l.
 */
function addPointsLogEntry(amount, reason) {
  if (amount === 0) return; // 0 pontos v√°ltoz√°st nem napl√≥zunk

  const entry = {
    id: Date.now() + Math.random(), // Egyedi ID a t√∂rl√©shez
    time: new Date(),
    amount: amount,
    reason: reason
  };
  pointsLog.unshift(entry);
  if (pointsLog.length > 100) pointsLog.pop(); // Limit√°ljuk a napl√≥t
}

/**
 * Kirajzolja a pontt√∂rt√©net list√°j√°t.
 */
function renderPointsLog() {
  const logDiv = document.getElementById("pointsHistoryList");
  if (!logDiv) return; // Ha nincs meg a div, ne fusson

  logDiv.innerHTML = "";

  if (pointsLog.length === 0) {
    logDiv.innerHTML = "<p style='text-align: center; padding: 10px;'>M√©g nincsenek pontbejegyz√©sek.</p>";
    return;
  }

  pointsLog.forEach((entry) => {
    let displayTime = "...";
    if (entry.time) {
      if (typeof entry.time.toDate === 'function') {
        displayTime = entry.time.toDate().toLocaleString();
      } else {
        displayTime = new Date(entry.time).toLocaleString();
      }
    }
    const amountColor = entry.amount > 0 ? '#00796b' : '#c00'; // Z√∂ld vagy piros
    const amountSign = entry.amount > 0 ? '+' : '';

    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `
      <span>
        <strong style="color: ${amountColor};">
          ${amountSign}${entry.amount} pont
        </strong>
        - ${entry.reason}
      </span>
      <small>${displayTime}</small>
      <button style="background:none;color:#c00" onclick="deletePointsLogEntry(${entry.id})">üóëÔ∏è</button>
    `;
    logDiv.appendChild(div);
  });
}

/**
 * T√∂r√∂l egy pontbejegyz√©st √©s visszavonja a pontsz√°mot.
 */
async function deletePointsLogEntry(id) {
  const index = pointsLog.findIndex(e => e.id === id);
  if (index === -1) {
    console.error("Nem tal√°lhat√≥ a pontbejegyz√©s:", id);
    return;
  }

  const entry = pointsLog.splice(index, 1)[0];

  if (entry && entry.amount) {
    // VISSZAVONJUK A PONTOKAT
    totalPoints -= entry.amount;
    animatePoints(totalPoints);

    // Friss√≠tj√ºk a n√©zetet √©s ment√ºnk
    renderPointsLog();
    // Speci√°lis napl√≥z√°s mag√°r√≥l a t√∂rl√©sr≈ël (de ez nem ker√ºl a pontnapl√≥ba)
    await logActivity(`üóëÔ∏è Pontnapl√≥ t√∂r√∂lve: ${entry.reason} (${-entry.amount} pont)`);
    // a logActivity m√°r ment, de a biztons√°g kedv√©√©rt a totalPoints-ot is mentj√ºk
    await saveDataToFirestore();
  }
}
// ===== GRAFIKON (REFACTORED) =====
function updateChart() {
  const ctx = document.getElementById("progressChart");
  if (!ctx) return;

  const weightEntries = transactions.filter(t => t.type === 'weight');
  const weights = weightEntries.map(e => e.value);
  const labels = weightEntries.map(e => {
    if (e.date) {
      if (typeof e.date.toDate === 'function') {
        return e.date.toDate().toLocaleDateString();
      } else {
        return new Date(e.date).toLocaleDateString();
      }
    }
    return "?";
  });

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "S√∫ly (kg)",
        data: weights,
        borderWidth: 3,
        borderColor: "#00796b",
        tension: 0.3,
        spanGaps: true
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: false
        }
      }
    }
  });
}

// ===== NAPI MOTIV√ÅCI√ì =====
function loadMotivation() {
  const tateTips = [
    "Ne v√°rj kedvre ‚Äì csak a gyeng√©k v√°rnak r√°. Tedd, amit kell.",
    "Ha a tested tiltakozik, az elm√©d parancsoljon neki.",
    "A fegyelem legy≈ëzi a lustas√°got minden nap.",
    "Minden korty v√≠z egy l√©p√©s az uralkod√°s fel√©.",
    "A f√©rfi, aki nem kontroll√°lja az √©tv√°gy√°t, nem uralja az √©let√©t."
  ];
  const day = new Date().getDate();
  document.getElementById("motivationBar").innerText = `Tipp: ‚Äû${tateTips[day % tateTips.length]}‚Äù`;
}

// ===== HALAD√ÅS T√ñRT√âNET =====
function updateHistory() {
  const div = document.getElementById("historyList");
  div.innerHTML = "";

  if (transactions.length === 0) {
    div.innerHTML = "<p>M√©g nincsenek adatbejegyz√©sek.</p>";
    return;
  }

  transactions.slice().reverse().forEach((t, i) => {
    const originalIndex = transactions.length - 1 - i;
    const item = document.createElement("div");
    item.className = "log-entry";

    let text = "";
    if (t.type === 'weight') {
      text = `‚öñÔ∏è S√∫ly: <b>${t.value} kg</b>`;
    } else if (t.type === 'water') {
      text = `üíß V√≠z: <b>${t.value} L</b>`;
    } else if (t.type === 'calories') {
      text = `üî• Kal√≥ria: <b>${t.value} kcal</b>`;
    } else if (t.type === 'protein') { // √öJ
      text = `ü•© Protein: <b>${t.value} g</b>`;
    } else if (t.type === 'fat') { // √öJ ZS√çR
      text = `ü•ë Zs√≠r: <b>${t.value} g</b>`;
    } else if (t.type === 'meal') { // √öJ
      text = `üçΩÔ∏è √âtkez√©s: <b>${t.name}</b> (${t.amount} ${t.unit}) - <b>${t.totalKcal.toFixed(0)} kcal</b>, <b>${t.totalProtein.toFixed(0)}g</b> protein, <b>${(t.totalFat || 0).toFixed(0)}g</b> zs√≠r`;
    }

    let displayDate = "...";
    if (t.date) {
      if (typeof t.date.toDate === 'function') {
        displayDate = t.date.toDate().toLocaleString();
      } else {
        displayDate = new Date(t.date).toLocaleString();
      }
    }

    item.innerHTML = `
      <span>
        <b>${displayDate}</b> ‚Äî ${text}
      </span>
      <button style="background:none;color:#c00" onclick="deleteTransaction(${originalIndex})">üóëÔ∏è</button>
    `;
    div.appendChild(item);
  });
}
// ===== EXPORT / IMPORT / RESET (REFACTORED) =====

function exportData() {
  const allData = {
    goals,
    rewards,
    notes,
    transactions,
    logs,
    totalPoints,
    workouts,
    meals,
    reminders, // √öJ
    archivedGoals,
    goalWeight: goalWeightSetting,
    goalWater: goalWaterSetting,
    goalCalories: goalCaloriesSetting,
    goalProtein: goalProteinSetting,
	goalFat: goalFatSetting,
  };
  const blob = new Blob([JSON.stringify(allData, null, 2)], {
    type: "application/json"
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `FitGarden_Backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  logActivity("üíæ Adatok export√°lva");
}

async function importData(event) { // Make async
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async e => { // Make async
    try {
      const data = JSON.parse(e.target.result);
      goals = data.goals || [];
      rewards = data.rewards || [];
      notes = data.notes || [];
      transactions = data.transactions || [];
      logs = data.logs || [];
      workouts = data.workouts || [];
      meals = data.meals || [];
      reminders = data.reminders || []; // √öJ
      archivedGoals = data.archivedGoals || [];
      totalPoints = data.totalPoints || 0;

      goalWeightSetting = data.goalWeight || "";
      goalWaterSetting = data.goalWater || "";
      goalCaloriesSetting = data.goalCalories || "";
      goalProteinSetting = data.goalProtein || "";
	  goalFatSetting = data.goalFat || "";

      await saveDataToFirestore();

      renderAll();
      logActivity("üìÇ Adatok import√°lva");
      alert("Sikeres import√°l√°s! Minden adat friss√≠tve ‚úÖ");
    } catch {
      alert("‚ùå Hiba: a f√°jl nem megfelel≈ë form√°tum√∫!");
    }
  };
  reader.readAsText(file);
}

async function resetAll() { // Make async
  if (confirm("Biztosan t√∂r√∂lni szeretn√©l MINDENT? Ez v√©gleges!")) {
    goals = [];
	vows = [];
    rewards = [];
    notes = [];
    transactions = [];
    logs = [];
    workouts = [];
    meals = [];
    reminders = []; // √öJ
    archivedGoals = [];
    totalPoints = 0;
    goalWeightSetting = "";
    goalWaterSetting = "";
    goalCaloriesSetting = "";
    goalProteinSetting = "";
	goalFatSetting = "";

    renderAll();
    await logActivity("‚ö†Ô∏è Teljes rendszer reset");
    alert("FitGarden √∫jraind√≠tva, minden t√∂r√∂lve ‚úÖ");
  }
}
function renderAll() {
  calculateDailyProgress();
  renderHighlights();
  document.getElementById("totalPointsDisplay").textContent = totalPoints;

  renderGoals();
  renderVows();
  renderRewards();
  renderNotes();
  renderLogs();
  renderPointsLog(); // √öJ PONTNAPL√ì RENDEREL√âSE
  renderReminders(); // √öJ

  updateAllSummaries();
  updateHistory();
  updateCompactSummaries();

  if (document.getElementById('workouts').classList.contains('active')) {
    renderWorkouts();
  }
  if (document.getElementById('meals').classList.contains('active')) {
    renderMeals();
  }
  // Nincs sz√ºks√©g k√ºl√∂n renderReminders() h√≠v√°sra itt,
  // mert a showTab() m√°r kezeli, amikor odal√©p√ºnk.
}
// ===== √öJ EML√âKEZTET≈ê FUNKCI√ìK =====
// ===== Ellen≈ërzi az √©rtes√≠t√©si enged√©lyt, √©s k√©ri, ha m√©g nincs be√°ll√≠tva.
function checkNotificationPermission() {
  // Ellen≈ërizz√ºk, hogy a b√∂ng√©sz≈ë t√°mogatja-e az √©rtes√≠t√©seket
  if (!('Notification' in window)) {
    console.warn("Ez a b√∂ng√©sz≈ë nem t√°mogatja az asztali √©rtes√≠t√©seket.");
    return;
  }
  // K√©rj√ºnk enged√©lyt, ha m√©g nincs 'granted' (enged√©lyezve) vagy 'denied' (letiltva)
  if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        console.log('√ârtes√≠t√©si enged√©ly megadva.');
        new Notification('FitGarden', {
          body: 'Sikeresen enged√©lyezted az √©rtes√≠t√©seket!',
          icon: 'üîî'
        });
      } else {
        console.log('√ârtes√≠t√©si enged√©ly elutas√≠tva.');
      }
    });
  }
}
// ===== Hozz√°ad egy √∫j eml√©keztet≈ët a list√°hoz.
    async function addReminder() {
      const textInput = document.getElementById("reminderTextInput");
      const timeInput = document.getElementById("reminderTimeInput");

      // === √öJ V√ÅLTOZ√ìK BEOLVAS√ÅSA ===
      const highlightCheck = document.getElementById("reminderHighlightCheck");
      const highlightDateInput = document.getElementById("reminderHighlightDateInput");

      const text = textInput.value.trim();
      const time = timeInput.value;

      // === √öJ V√ÅLTOZ√ìK BEOLVAS√ÅSA ===
      const highlight = highlightCheck.checked;
      const highlightDate = highlightDateInput.value;

      if (!text || !time) {
        alert("K√©rlek adj meg egy sz√∂veget √©s egy id≈ëpontot!");
        return;
      }
	  // === √öJ MEZ≈êK RESETEL√âSE ===
      highlightCheck.checked = false;
      highlightDateInput.value = toDateInputString(new Date()); // Vissza√°ll√≠t√°s mai d√°tumra

      // === RENDERALL H√çV√ÅSA ===
      const reminderTime = new Date(time);
      if (reminderTime <= new Date()) {
        alert("Az eml√©keztet≈ë id≈ëpontj√°nak a j√∂v≈ëben kell lennie!");
        return;
      }

      // === √öJ ELLEN≈êRZ√âS ===
      if (highlight && !highlightDate) {
        alert("Ha kiemel√©st k√©rsz, meg kell adnod a kiemel√©s kezd≈ë d√°tum√°t!");
        return;
      }

      // === √öJ ELLEN≈êRZ√âS ===
      if (highlight && new Date(highlightDate) > reminderTime) {
        alert("A kiemel√©s kezdete nem lehet k√©s≈ëbb, mint az eml√©keztet≈ë id≈ëpontja!");
        return;
      }

      reminders.push({
        id: Date.now(),
        text: text,
        time: reminderTime.toISOString(), // ISO stringk√©nt t√°roljuk
        triggered: false, // M√©g nem lett aktiv√°lva
        // === √öJ ADATOK HOZZ√ÅAD√ÅSA ===
        highlight: highlight,
        highlightDate: highlight ? new Date(highlightDate).toISOString() : null
      });
      closeModal('reminderModal')
      textInput.value = "";
      timeInput.value = "";
      // === √öJ MEZ≈êK RESETEL√âSE ===
      highlightCheck.checked = false;
      highlightDateInput.value = toDateInputString(new Date()); // Vissza√°ll√≠t√°s mai d√°tumra

      // === RENDERALL H√çV√ÅSA ===
      // renderReminders(); helyett renderAll(), hogy a f≈ëoldal is friss√ºlj√∂n
      renderAll();
      await saveDataToFirestore();
    }
// ===== Kirajzolja az akt√≠v eml√©keztet≈ëk list√°j√°t.
async function deleteReminder(id) {
      if (!confirm("Biztosan t√∂rl√∂d ezt az eml√©keztet≈ët?")) {
        return;
      }

      reminders = reminders.filter(r => r.id !== id);

      // Friss√≠t√ºnk mindent (a f≈ëoldalt is)
      renderAll();
      await saveDataToFirestore();
    }

function renderReminders() {
  const list = document.getElementById("reminderList");
  if (!list) return; // Ha a f√ºl m√©g nem akt√≠v, ne csin√°ljon semmit
  list.innerHTML = "";

  // Csak azokat mutatjuk, amik m√©g nem s√ºltek el
  const pendingReminders = reminders
    .filter(r => !r.triggered)
    .sort((a, b) => new Date(a.time) - new Date(b.time)); // Id≈ërendben

  if (pendingReminders.length === 0) {
    list.innerHTML = "<p>Nincsenek akt√≠v eml√©keztet≈ëk.</p>";
    return;
  }

  pendingReminders.forEach(r => {
    const div = document.createElement("div");
    div.className = "log-entry"; // √öjrahasznos√≠tjuk a log st√≠lus√°t

    const displayTime = new Date(r.time).toLocaleString(); // Felhaszn√°l√≥bar√°t d√°tum

    div.innerHTML = `
        <span>üîî <b>${r.text}</b></span>
        <small>${displayTime}</small>
        <button style="background:none;color:#00796b" onclick="editReminder(${r.id})" title="Szerkeszt√©s">‚úèÔ∏è</button>
        <button style="background:none;color:#c00" onclick="deleteReminder(${r.id})" title="T√∂rl√©s">üóëÔ∏è</button>
    `;
    list.appendChild(div);
  });
}
// ===== Elind√≠tja az id≈ëz√≠t≈ët, ami rendszeresen ellen≈ërzi az eml√©keztet≈ëket.
function startReminderEngine() {
  // Ha m√°r fut, ne ind√≠tsuk √∫jra
  if (reminderCheckInterval) {
    clearInterval(reminderCheckInterval);
  }

  // 30 m√°sodpercenk√©nt ellen≈ërizz√ºk, van-e teend≈ë
  reminderCheckInterval = setInterval(checkReminders, 30000);

  // Ind√≠t√°skor azonnal lefuttatjuk, hogy az esetleg lek√©sett eml√©keztet≈ëk megjelenjenek
  checkReminders();
}
// ===== Ellen≈ërzi az eml√©keztet≈ëket, √©s aktiv√°lja azokat, amiknek lej√°rt az ideje.
function checkReminders() {
  const now = new Date();
  let needsSave = false; // Csak akkor ment√ºnk, ha v√°ltoz√°s t√∂rt√©nt

  reminders.forEach(r => {
    if (!r.triggered && new Date(r.time) <= now) {
      // Itt az id≈ë!
      showReminderNotification(r);
      r.triggered = true;
      needsSave = true;
    }
  });

  if (needsSave) {
        // Friss√≠t√ºnk mindent (hogy a f≈ëoldali kiemel√©s is elt≈±nj√∂n)
        // √©s ment√ºnk.
        renderAll();
        saveDataToFirestore();
      }
	}

// ===== Megjelen√≠ti a b√∂ng√©sz≈ë √©rtes√≠t√©st.

function showReminderNotification(reminder) {
  if (Notification.permission === 'granted') {
    // Jelen√≠ts√ºk meg az √©rtes√≠t√©st
    new Notification('FitGarden Eml√©keztet≈ë', {
      body: reminder.text,
      icon: 'https://img.icons8.com/color/96/leaf.png' // Egy egyszer≈± lev√©l ikon
    });
  } else {
    // Ha valami√©rt nincs enged√©ly (pl. visszavonta), csak a konzolra √≠runk.
    console.warn(`Eml√©keztet≈ë els√ºtve (de nincs enged√©ly): ${reminder.text}`);
  }
}
</script>
</body>
</html>
