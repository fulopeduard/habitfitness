<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FitGarden 2.0 ‚Äì Fejedelem Edition üí™üåø</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
  margin: 0;
  padding: 0;
  color: #222;
  overflow-x: hidden;
}
header {
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(8px);
  padding: 10px;
  text-align: center;
  font-weight: bold;
  font-size: 1.3em;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
#motivationBar {
  background: #004d40;
  color: white;
  padding: 8px;
  text-align: center;
  font-style: italic;
  font-size: 0.95em;
  letter-spacing: 0.3px;
}
main {
  max-width: 1200px;
  margin: 20px auto;
  padding: 15px;
}
.card {
  background: white;
  border-radius: 18px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  padding: 20px;
  margin-bottom: 25px;
}
h2 {
  color: #00796b;
  margin-bottom: 10px;
}
button {
  background: #00796b;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 8px 15px;
  font-size: 0.95em;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  background: #004d40;
}
.icon-box {
  display: flex;
  justify-content: space-around;
  align-items: stretch;
  gap: 15px;
  flex-wrap: wrap;
}
.icon-card {
  flex: 1;
  min-width: 280px;
  background: #e8f5e9;
  border-radius: 12px;
  text-align: center;
  padding: 20px;
  position: relative;
  display: flex;
  flex-direction: column;
}
.icon-card i {
  font-size: 2em;
  color: #00796b;
  display: block;
}
.icon-card span {
  display: block;
  margin-top: 5px;
  font-weight: bold;
  font-size: 1.1em;
}
.edit-btn {
  position: absolute;
  top: 8px;
  right: 10px;
  background: none;
  color: #00796b;
  border: none;
  font-size: 1.1em;
  cursor: pointer;
}
.hidden { display: none; }

#tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 25px;
}
.tab-btn {
  background: #ccc;
  color: black;
  padding: 10px 20px;
  border-radius: 10px;
  margin: 0 5px;
  cursor: pointer;
  transition: 0.3s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.tab-btn.active {
  background: #00796b;
  color: white;
  font-weight: bold;
}
.tab-content { display: none; }
.tab-content.active { display: block; }


/* ================================================== */
/* ===== C√âL √âS JUTALOM S√ÅV ST√çLUS ===== */
/* ================================================== */
.goal-item, .reward-item {
  background: transparent;
  border-radius: 10px;
  padding: 0;
  margin-bottom: 8px;
  display: flex;
  overflow: hidden;
  align-items: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.completed { 
  text-decoration: line-through; 
  opacity: 0.7; 
}

.item-name {
  flex: 1;
  padding: 10px 15px;
  background: #e8f5e9; /* Vil√°gos z√∂ld */
  display: flex;
  align-items: center;
}
.item-points {
  flex-shrink: 0;
  width: 100px;
  padding: 10px;
  background: #dcedc8; /* √Årnyalattal s√∂t√©tebb z√∂ld */
  text-align: center;
  font-weight: bold;
  border-left: 1px solid #c8e6c9;
  border-right: 1px solid #c8e6c9;
}
.item-actions {
  flex-shrink: 0;
  padding: 10px 10px;
  background: #e8f5e9; /* Vil√°gos z√∂ld */
  display: flex;
  gap: 5px;
  justify-content: center;
}

.item-actions button {
  background: transparent;
  color: #00796b;
  font-size: 1.1em;
  cursor: pointer;
  padding: 5px;
}

/* √öJ: Kateg√≥ria c√≠m st√≠lusa */
.category-title {
  margin-top: 20px;
  margin-bottom: 8px;
  color: #004d40;
  border-bottom: 2px solid #b2dfdb; /* Enyh√©bb z√∂ld */
  padding-bottom: 4px;
  font-size: 1.1em;
}
#goalList .category-title:first-of-type {
  margin-top: 10px;
}
/* ================================================== */


.log {
  background: #f8f8f8;
  border-radius: 10px;
  padding: 10px;
  max-height: 300px;
  overflow-y: auto;
}
.log-entry {
  border-bottom: 1px solid #ddd;
  padding: 6px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.log-entry span {
    flex: 1; 
    padding-right: 10px;
}
.log-entry small { color: #777; font-size: 0.85em; margin-left: 10px; }
.log-entry button {
    flex-shrink: 0;
}

.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  border-radius: 15px;
  padding: 20px;
  width: 90%;
  max-width: 400px;
}
.modal-content h3 { margin-top: 0; color: #00796b; text-align: center; }

input, textarea {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 1em;
  box-sizing: border-box;
}

#progressChart {
  width: 100%;
  height: 300px;
}

/* ====== K√ñVET√âS ST√çLUSOK ====== */
.icon-card .content-wrapper {
  margin-top: 15px;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
}
.progress-summary {
  font-size: 0.9em;
  font-weight: bold;
  color: #004d40;
  margin-top: 10px;
  margin-bottom: 10px;
  height: 1.2em;
}
.input-group {
  display: flex;
  margin-top: 10px;
  gap: 5px;
}
.input-group input {
  flex: 1;
  width: 60%;
  margin: 0;
  font-size: 0.9em;
  text-align: center;
}
.input-group button {
  flex-shrink: 0;
  font-size: 0.85em;
  padding: 8px 10px;
}
.progress-bar-container {
  background: #c8e6c9;
  border-radius: 10px;
  height: 12px;
  width: 100%;
  margin-top: 10px;
  overflow: hidden;
  border: 1px solid #a5d6a7;
}
.progress-bar {
  background: #00796b;
  height: 100%;
  width: 0%;
  border-radius: 10px;
  transition: width 0.5s ease;
}

</style>
</head>
<body>
<header>üèãÔ∏è‚Äç‚ôÇÔ∏è FitGarden ‚Äì Fejedelem Edition üåø</header>
<div id="motivationBar">Tipp: ‚ÄûA lustas√°g a gyeng√©k vall√°sa. T√∂rj ki bel≈ële.‚Äù</div>

<main>
  <div class="card">
    <canvas id="progressChart"></canvas>
  </div>

  <div id="tabs">
    <div class="tab-btn active" onclick="showTab('main')">F≈ëoldal</div>
    <div class="tab-btn" onclick="showTab('notes')">Jegyzetek</div>
    <div class="tab-btn" onclick="showTab('history')">Halad√°s</div>
  </div>

  <div id="main" class="tab-content active">
    
    <div class="card" id="goalsDisplay">
      <div class="icon-box" id="goalSummary">
        
        <div class="icon-card">
          <button class="edit-btn" onclick="editGoals()">‚úèÔ∏è</button>
          <i>‚öñÔ∏è</i>
          <span id="goalWeightText">C√©l s√∫ly: nincs megadva</span>
          <div class="content-wrapper">
            <div class="progress-summary" id="weightSummary">M√©g nem adt√°l meg s√∫lyt.</div>
            <div class="input-group">
              <input id="weightInput" type="number" placeholder="Jelenlegi s√∫ly (kg)">
              <button onclick="addTransaction('weight')">‚öñÔ∏è Ment√©s</button>
            </div>
          </div>
        </div>

        <div class="icon-card">
          <button class="edit-btn" onclick="editGoals()">‚úèÔ∏è</button>
          <i>üíß</i>
          <span id="goalWaterText">V√≠z c√©l: nincs megadva</span>
          <div class="content-wrapper">
            <div class="progress-bar-container">
              <div id="waterProgressBar" class="progress-bar"></div>
            </div>
            <div class="progress-summary" id="waterSummary">...</div>
            <div class="input-group">
              <input id="waterInput" type="number" step="0.1" placeholder="Hozz√°ad (L)">
              <button onclick="addTransaction('water')">üíß Hozz√°ad</button>
            </div>
          </div>
        </div>

        <div class="icon-card">
          <button class="edit-btn" onclick="editGoals()">‚úèÔ∏è</button>
          <i>üî•</i>
          <span id="goalCalText">Kal√≥ria c√©l: nincs megadva</span>
           <div class="content-wrapper">
            <div class="progress-bar-container">
              <div id="calProgressBar" class="progress-bar"></div>
            </div>
            <div class="progress-summary" id="calSummary">...</div>
            <div class="input-group">
              <input id="calInput" type="number" placeholder="Hozz√°ad (kcal)">
              <button onclick="addTransaction('calories')">üî• Hozz√°ad</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>‚úÖ C√©lok</h2>
      <button onclick="openModal('goalModal')">+ √öj c√©l</button>
      <div id="goalList"></div>
    </div>

    <div class="card">
      <h2>üéÅ Jutalmak</h2>
      <button onclick="openModal('rewardModal')">+ √öj jutalom</button>
      <div id="rewardList"></div>
    </div>

    <div class="card">
      <h2>üìú Napl√≥</h2>
      <div class="log" id="activityLog"></div>
      <button style="margin-top:10px" onclick="clearAllLogs()">üßπ Napl√≥ t√∂rl√©se</button>
    </div>
  </div>
  
  <div id="notes" class="tab-content">
    <div class="card">
      <h2>üìù Jegyzetek</h2>
      <textarea id="noteText" placeholder="√çrj ide valamit..."></textarea>
      <button onclick="addNote()">Ment√©s</button>
      <div id="notesList"></div>
    </div>
  </div>

  <div id="history" class="tab-content">
    <div class="card">
      <h2>üìÖ Adat T√∂rt√©net (S√∫ly, V√≠z, Kal√≥ria)</h2>
      <div id="historyList" class="log"></div>
    </div>
  </div>
</main>
<div class="modal" id="goalSetupModal">
  <div class="modal-content">
    <h3>üéØ C√©lok be√°ll√≠t√°sa</h3>
    <label>Ide√°lis s√∫ly (kg)</label>
    <input id="goalWeightInput" type="number" placeholder="pl. 75">
    <label>Napi v√≠z c√©l (liter)</label>
    <input id="goalWaterInput" type="number" step="0.1" placeholder="pl. 2.5">
    <label>Napi kal√≥ria c√©l (kcal)</label>
    <input id="goalCalInput" type="number" placeholder="pl. 2200">
    <div style="text-align:center;margin-top:15px;">
      <button onclick="saveGoalSettings()">üíæ Ment√©s</button>
      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('goalSetupModal')">M√©gse</button>
    </div>
  </div>
</div>

<div class="modal" id="goalModal">
  <div class="modal-content">
    <h3>üéØ √öj c√©l</h3>
    <label>C√©l neve</label>
    <input id="goalNameInput" type="text" placeholder="pl. 10.000 l√©p√©s">
    <label>Pont √©rt√©k</label>
    <input id="goalPointsInput" type="number" placeholder="pl. 10 (0 is lehet)">
    <label>Kateg√≥ria (opcion√°lis)</label>
    <input id="goalCategoryInput" type="text" placeholder="pl. Val√≥s√°g">
    
    <div style="text-align:center;margin-top:15px;">
      <button onclick="saveGoal()">‚úÖ Ment√©s</button>
      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('goalModal')">M√©gse</button>
    </div>
  </div>
</div>

<div class="modal" id="rewardModal">
  <div class="modal-content">
    <h3>üéÅ √öj jutalom</h3>
    <label>Jutalom neve</label>
    <input id="rewardNameInput" type="text" placeholder="pl. Pihen≈ënap">
    <label>Pont √°ra</label>
    <input id="rewardCostInput" type="number" placeholder="pl. 20">
    <div style="text-align:center;margin-top:15px;">
      <button onclick="saveReward()">‚úÖ Ment√©s</button>
      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('rewardModal')">M√©gse</button>
    </div>
  </div>
</div>

<div class="modal" id="editModal">
  <div class="modal-content">
    <h3 id="editTitle">‚úèÔ∏è Szerkeszt√©s</h3>
    <label id="editLabel1"></label>
    <input id="editInput1" type="text">
    <label id="editLabel2"></label>
    <input id="editInput2" type="number">
    <label id="editLabel3" style="display:none;"></label>
    <input id="editInput3" type="text" style="display:none;">

    <div style="text-align:center;margin-top:15px;">
      <button onclick="confirmEdit()">üíæ Ment√©s</button>
      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('editModal')">M√©gse</button>
    </div>
  </div>
</div>

<script>
// ======= POPUP VEZ√âRL√âS =======

function openModal(id) {
  document.getElementById(id).style.display = 'flex';
}
function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}
function editGoals() {
  document.getElementById("goalWeightInput").value = localStorage.getItem("goalWeight") || "";
  document.getElementById("goalWaterInput").value = localStorage.getItem("goalWater") || "";
  document.getElementById("goalCalInput").value = localStorage.getItem("goalCalories") || "";
  openModal('goalSetupModal');
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// =======================================================
// ===== GLOB√ÅLIS V√ÅLTOZ√ìK =====
// =======================================================
let goals = JSON.parse(localStorage.getItem("goals")) || [];
let rewards = JSON.parse(localStorage.getItem("rewards")) || [];
let notes = JSON.parse(localStorage.getItem("notes")) || [];
let logs = JSON.parse(localStorage.getItem("logs")) || [];
let totalPoints = parseInt(localStorage.getItem("totalPoints")) || 0;
let chart;
let editTarget = null;
let transactions = []; 
let dailyProgress = { water: 0, calories: 0, lastWeight: 0, date: "" }; 


// =======================================================
// ===== ADATKEZEL≈ê F√úGGV√âNYEK =====
// =======================================================

function loadTransactionsAndMigrate() {
  transactions = JSON.parse(localStorage.getItem("transactions")) || [];
  const oldEntries = JSON.parse(localStorage.getItem("entries"));

  if (oldEntries && oldEntries.length > 0 && transactions.length === 0) {
    console.log("R√©gi adatok migr√°l√°sa...");
    transactions = oldEntries
      .filter(e => e.w)
      .map(e => ({
        id: new Date(e.date).getTime() + Math.floor(Math.random() * 1000),
        type: 'weight',
        value: e.w,
        date: e.date
      }));
    
    localStorage.setItem("transactions", JSON.stringify(transactions));
    localStorage.removeItem("entries");
    localStorage.removeItem("dailyProgress");
    logActivity("üîß Adatstrukt√∫ra sikeresen friss√≠tve!");
  }
}

function calculateDailyProgress() {
  const today = new Date().toISOString().slice(0, 10);
  dailyProgress = { water: 0, calories: 0, lastWeight: 0, date: today };
  
  let lastWeightEntry = null;

  for (const t of transactions) {
    if (t.type === 'weight' && t.value > 0) {
      lastWeightEntry = t;
    }
    
    try {
      let entryDate;
      if (t.date.includes('/')) { 
          entryDate = new Date(t.date);
      } else if (t.date.includes('.')) { 
          let parts = t.date.split(' ');
          if (parts.length >= 3) {
            let datePart = parts.slice(0, 3).join('').replace(/\./g, '-');
            datePart = datePart.substring(0, 10);
            let timePart = parts.length > 3 ? parts.slice(3).join(' ') : '00:00:00';
            entryDate = new Date(datePart + 'T' + timePart);
          } else {
             entryDate = new Date(t.date);
          }
      } else {
           entryDate = new Date(t.date);
      }

      if (entryDate.toISOString().slice(0, 10) === today) {
        if (t.type === 'water') {
          dailyProgress.water += t.value;
        } else if (t.type === 'calories') {
          dailyProgress.calories += t.value;
        }
      }
    } catch (e) {
      console.error("D√°tumfeldolgoz√°si hiba a calculateDailyProgress-ben:", e, t.date);
    }
  }

  if (lastWeightEntry) {
    dailyProgress.lastWeight = lastWeightEntry.value;
  }
}

// ===== TAB KEZEL√âS =====
function showTab(id) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  
  if (event && event.target) {
     event.target.classList.add('active');
  } else {
     document.querySelector(`.tab-btn[onclick="showTab('${id}')"]`).classList.add('active');
  }
  
  document.getElementById(id).classList.add('active');
}

// ===== C√âLBE√ÅLL√çT√ÅS =====
function saveGoalSettings() {
  const gw = parseFloat(document.getElementById("goalWeightInput").value) || null;
  const gwat = parseFloat(document.getElementById("goalWaterInput").value) || null;
  const gcal = parseFloat(document.getElementById("goalCalInput").value) || null;

  localStorage.setItem("goalWeight", gw || "");
  localStorage.setItem("goalWater", gwat || "");
  localStorage.setItem("goalCalories", gcal || "");

  updateAllSummaries();
  logActivity(`üéØ C√©lok be√°ll√≠tva: ${gw || "-"}kg, ${gwat || "-"}L, ${gcal || "-"}kcal`);
  closeModal('goalSetupModal');
}

function updateAllSummaries() {
  const gw = parseFloat(localStorage.getItem("goalWeight"));
  const gwat = parseFloat(localStorage.getItem("goalWater"));
  const gcal = parseFloat(localStorage.getItem("goalCalories"));
  
  const dp = dailyProgress; 

  // --- S√∫ly (Weight) ---
  const goalWeightText = document.getElementById("goalWeightText");
  const weightSummary = document.getElementById("weightSummary");
  if (gw) {
    goalWeightText.textContent = `C√©l s√∫ly: ${gw} kg`;
    if (dp.lastWeight > 0) {
      const diff = dp.lastWeight - gw;
      if (diff > 0) {
        weightSummary.textContent = `M√©g ${diff.toFixed(1)} kg-t kell leadnod.`;
      } else if (diff === 0) {
         weightSummary.textContent = `üéâ El√©rted a c√©ls√∫lyod! Gratul√°lok!`;
      } else {
        weightSummary.textContent = `C√©l t√∫lteljes√≠tve! (${Math.abs(diff).toFixed(1)} kg-al)`;
      }
    } else {
      weightSummary.textContent = "M√©g nem adt√°l meg s√∫lyt.";
    }
  } else {
    goalWeightText.textContent = "C√©l s√∫ly: nincs megadva";
    weightSummary.textContent = "";
  }

  // --- V√≠z (Water) ---
  const goalWaterText = document.getElementById("goalWaterText");
  const waterSummary = document.getElementById("waterSummary");
  const waterBar = document.getElementById("waterProgressBar");
  if (gwat) {
    goalWaterText.textContent = `V√≠z c√©l: ${gwat} L`;
    const rem_water = gwat - dp.water;
    let perc_water = (dp.water / gwat) * 100;
    
    if (rem_water > 0) {
      waterSummary.textContent = `M√©g ${rem_water.toFixed(1)} L hi√°nyzik.`;
    } else {
      waterSummary.textContent = `C√©l teljes√≠tve! (${dp.water.toFixed(1)} L)`;
    }
    if (perc_water > 100) perc_water = 100;
    if (perc_water < 0) perc_water = 0;
    waterBar.style.width = perc_water + '%';
  } else {
    goalWaterText.textContent = "V√≠z c√©l: nincs megadva";
    waterSummary.textContent = "Nincs napi c√©l be√°ll√≠tva.";
    waterBar.style.width = '0%';
  }

  // --- Kal√≥ria (Calories) ---
  const goalCalText = document.getElementById("goalCalText");
  const calSummary = document.getElementById("calSummary");
  const calBar = document.getElementById("calProgressBar");
  if (gcal) {
    goalCalText.textContent = `Kal√≥ria c√©l: ${gcal} kcal`;
    const rem_cal = gcal - dp.calories;
    let perc_cal = (dp.calories / gcal) * 100;
    
    if (rem_cal > 0) {
      calSummary.textContent = `M√©g ${rem_cal.toFixed(0)} kcal van h√°tra.`;
    } else {
      calSummary.textContent = `C√©l el√©rve! (${dp.calories.toFixed(0)} kcal)`;
    }
    if (perc_cal > 100) perc_cal = 100;
    if (perc_cal < 0) perc_cal = 0;
    calBar.style.width = perc_cal + '%';
  } else {
    goalCalText.textContent = "Kal√≥ria c√©l: nincs megadva";
    calSummary.textContent = "Nincs napi c√©l be√°ll√≠tva.";
    calBar.style.width = '0%';
  }
}


// =======================================================
// ===== ADATBEVITEL √âS T√ñRL√âS =====
// =======================================================
function addTransaction(type) {
  let inputElem, value, logText;
  
  if (type === 'weight') {
    inputElem = document.getElementById("weightInput");
    value = parseFloat(inputElem.value);
    if (!value || value <= 0) return alert("√ârv√©nytelen s√∫ly!");
    logText = `‚öñÔ∏è S√∫ly r√∂gz√≠tve: ${value}kg`;
    dailyProgress.lastWeight = value;
  } 
  else if (type === 'water') {
    inputElem = document.getElementById("waterInput");
    value = parseFloat(inputElem.value);
    if (!value || value < 0) return;
    logText = `üíß V√≠z hozz√°adva: ${value}L`;
    dailyProgress.water += value;
  }
  else if (type === 'calories') {
    inputElem = document.getElementById("calInput");
    value = parseFloat(inputElem.value);
    if (!value || value < 0) return;
    logText = `üî• Kal√≥ria hozz√°adva: ${value}kcal`;
    dailyProgress.calories += value;
  }
  else {
    return;
  }
  
  const transaction = {
    id: Date.now(),
    type: type,
    value: value,
    date: new Date().toLocaleString()
  };
  transactions.push(transaction);
  localStorage.setItem("transactions", JSON.stringify(transactions));
  
  logActivity(logText);
  
  updateAllSummaries();
  updateHistory();
  if (type === 'weight') {
    updateChart();
  }
  
  inputElem.value = "";
}

function deleteTransaction(index) {
  if (!confirm("Biztosan t√∂rl√∂d ezt a bejegyz√©st?")) {
    return;
  }
  
  const entry = transactions.splice(index, 1)[0]; 
  localStorage.setItem("transactions", JSON.stringify(transactions));

  logActivity(`üóëÔ∏è Bejegyz√©s t√∂r√∂lve: ${entry.type} (${entry.value})`);
  
  calculateDailyProgress();
  updateAllSummaries();
  updateHistory();
  updateChart();
}


// ===== JEGYZETEK =====
function addNote() {
  const text = document.getElementById("noteText").value.trim();
  if (!text) return;
  const note = { text, date: new Date().toLocaleString() };
  notes.unshift(note);
  localStorage.setItem("notes", JSON.stringify(notes));
  document.getElementById("noteText").value = "";
  renderNotes();
  logActivity("üìù Jegyzet hozz√°adva");
}

function renderNotes() {
  const container = document.getElementById("notesList");
  container.innerHTML = "";
  notes.forEach((n, i) => {
    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `
      <span><b>${n.date}:</b> ${n.text}</span>
      <button style='background:none;color:#c00;' onclick='deleteNote(${i})'>üóëÔ∏è</button>`;
    container.appendChild(div);
  });
}

function deleteNote(i) {
  notes.splice(i, 1);
  localStorage.setItem("notes", JSON.stringify(notes));
  renderNotes();
}

// =======================================================
// ===== C√âLOK (M√ìDOS√çTVA: 0 PONT √âS KATEG√ìRI√ÅK) =====
// =======================================================
function saveGoal() {
  const name = document.getElementById("goalNameInput").value.trim();
  const points = parseInt(document.getElementById("goalPointsInput").value);
  const category = document.getElementById("goalCategoryInput").value.trim(); // √öJ
  
  // JAV√çTOTT VALID√ÅCI√ì (0 PONT ENGED√âLYEZVE)
  if (!name) return alert("A c√©lnak nevet kell adni!");
  if (isNaN(points) || points < 0) return alert("√ârv√©nytelen pontsz√°m! Adj meg 0-t vagy nagyobbat.");
  
  // M√ìDOS√çTVA: Kateg√≥ria hozz√°ad√°sa
  goals.push({ name, points, done: false, category: category });
  localStorage.setItem("goals", JSON.stringify(goals));
  
  document.getElementById("goalNameInput").value = "";
  document.getElementById("goalPointsInput").value = "";
  document.getElementById("goalCategoryInput").value = ""; // √öJ
  
  closeModal('goalModal');
  renderGoals();
  logActivity(`üéØ C√©l hozz√°adva: ${name} (${points} pont)`);
}

function toggleGoal(i) {
  goals[i].done = !goals[i].done;
  if (goals[i].done) {
    totalPoints += goals[i].points;
    logActivity(`‚úÖ C√©l teljes√≠tve: ${goals[i].name} (+${goals[i].points} pont)`);
  } else {
    totalPoints -= goals[i].points;
    logActivity(`‚ùå C√©l visszavonva: ${goals[i].name} (-${goals[i].points} pont)`);
  }
  localStorage.setItem("totalPoints", totalPoints);
  localStorage.setItem("goals", JSON.stringify(goals));
  renderGoals();
  renderRewards();
}

function editGoal(i) {
  editTarget = { type: 'goal', index: i };
  document.getElementById("editTitle").textContent = "üéØ C√©l szerkeszt√©se";
  document.getElementById("editLabel1").textContent = "C√©l neve";
  document.getElementById("editLabel2").textContent = "Pont √©rt√©k";
  document.getElementById("editInput1").value = goals[i].name;
  document.getElementById("editInput2").value = goals[i].points;
  
  // √öJ: Kateg√≥ria mez≈ë megjelen√≠t√©se √©s felt√∂lt√©se
  document.getElementById("editLabel3").textContent = "Kateg√≥ria (opcion√°lis)";
  document.getElementById("editInput3").value = goals[i].category || "";
  document.getElementById("editLabel3").style.display = "block";
  document.getElementById("editInput3").style.display = "block";

  openModal('editModal');
}

function deleteGoal(i) {
  if(goals[i].done) {
      totalPoints -= goals[i].points;
      localStorage.setItem("totalPoints", totalPoints);
  }
  goals.splice(i, 1);
  localStorage.setItem("goals", JSON.stringify(goals));
  renderGoals();
  renderRewards();
}

// ==========================================================
// ===== √öJRA√çRT RENDERGOALS (KATEG√ìRI√ÅKKAL) =====
// ==========================================================
function renderGoals() {
  const list = document.getElementById("goalList");
  list.innerHTML = `<p>üíé √ñsszes pont: <b>${totalPoints}</b></p>`;
  
  // 1. C√©lok csoportos√≠t√°sa
  const categorized = {};
  const uncategorized = [];
  
  goals.forEach((goal, index) => {
    const item = { goal, index }; // Elt√°roljuk az eredeti indexet
    if (goal.category) {
      if (!categorized[goal.category]) {
        categorized[goal.category] = [];
      }
      categorized[goal.category].push(item);
    } else {
      uncategorized.push(item);
    }
  });

  // Seg√©df√ºggv√©ny egy-egy c√©l elem kirajzol√°s√°hoz
  const renderItem = (g, i) => {
    const div = document.createElement("div");
    div.className = "goal-item" + (g.done ? " completed" : "");
    div.innerHTML = `
      <div class="item-name">
        ${g.name}
      </div>
      <div class="item-points">
        ${g.points} pont
      </div>
      <div class="item-actions">
        <button onclick="editGoal(${i})">‚úèÔ∏è</button>
        <button onclick="deleteGoal(${i})">üóëÔ∏è</button>
        <button onclick="toggleGoal(${i})">${g.done ? '‚ùå' : '‚úÖ'}</button>
      </div>
    `;
    list.appendChild(div);
  };

  // 2. Kategoriz√°lt c√©lok kirajzol√°sa (ABC sorrendben)
  const categoryNames = Object.keys(categorized).sort();
  categoryNames.forEach(categoryName => {
    const title = document.createElement("h3");
    title.className = "category-title";
    title.textContent = categoryName;
    list.appendChild(title);
    
    categorized[categoryName].forEach(item => {
      renderItem(item.goal, item.index); // √Åtadjuk az EREDETI indexet
    });
  });

  // 3. Kateg√≥ria n√©lk√ºli c√©lok kirajzol√°sa
  if (uncategorized.length > 0) {
    // Csak akkor √≠rjuk ki, hogy "Egy√©b", ha voltak kateg√≥ri√°k is
    if (categoryNames.length > 0) {
      const title = document.createElement("h3");
      title.className = "category-title";
      title.textContent = "Egy√©b";
      list.appendChild(title);
    }
    uncategorized.forEach(item => {
      renderItem(item.goal, item.index); // √Åtadjuk az EREDETI indexet
    });
  }
}

// =======================================================
// ===== JUTALMAK =====
// =======================================================
function saveReward() {
  const name = document.getElementById("rewardNameInput").value.trim();
  const cost = parseInt(document.getElementById("rewardCostInput").value);
  // Jutalomn√°l 0 pontnak nincs √©rtelme, marad a > 0 ellen≈ërz√©s
  if (!name || isNaN(cost) || cost <= 0) return alert("√ârv√©nytelen n√©v vagy pontsz√°m!");
  
  rewards.push({ name, cost });
  localStorage.setItem("rewards", JSON.stringify(rewards));
  document.getElementById("rewardNameInput").value = "";
  document.getElementById("rewardCostInput").value = "";
  closeModal('rewardModal');
  renderRewards();
  logActivity(`üéÅ Jutalom hozz√°adva: ${name} (${cost} pont)`);
}

function claimReward(i) {
  if (totalPoints >= rewards[i].cost) {
    if (confirm(`Biztosan kiv√°ltod ezt: "${rewards[i].name}" (${rewards[i].cost} pont√©rt)?`)) {
      totalPoints -= rewards[i].cost;
      localStorage.setItem("totalPoints", totalPoints);
      logActivity(`üéâ Jutalom kiv√°ltva: ${rewards[i].name} (-${rewards[i].cost} pont)`);
      renderRewards();
      renderGoals();
    }
  } else {
    alert("Nincs el√©g pontod!");
  }
}

function editReward(i) {
  editTarget = { type: 'reward', index: i };
  document.getElementById("editTitle").textContent = "üéÅ Jutalom szerkeszt√©se";
  document.getElementById("editLabel1").textContent = "Jutalom neve";
  document.getElementById("editLabel2").textContent = "Pont √°ra";
  document.getElementById("editInput1").value = rewards[i].name;
  document.getElementById("editInput2").value = rewards[i].cost;
  
  // √öJ: Kateg√≥ria mez≈ë elrejt√©se jutalom szerkeszt√©sn√©l
  document.getElementById("editLabel3").style.display = "none";
  document.getElementById("editInput3").style.display = "none";

  openModal('editModal');
}

function deleteReward(i) {
  rewards.splice(i, 1);
  localStorage.setItem("rewards", JSON.stringify(rewards));
  renderRewards();
}

function renderRewards() {
  const list = document.getElementById("rewardList");
  list.innerHTML = `<p>üíé √ñsszes pont: <b>${totalPoints}</b></p>`;
  rewards.forEach((r, i) => {
    const div = document.createElement("div");
    div.className = "reward-item";
    
    div.innerHTML = `
      <div class="item-name">
        ${r.name}
      </div>
      <div class="item-points">
        ${r.cost} pont
      </div>
      <div class="item-actions">
        <button onclick="editReward(${i})">‚úèÔ∏è</button>
        <button onclick="deleteReward(${i})">üóëÔ∏è</button>
        <button onclick="claimReward(${i})">üéâ</button>
      </div>
    `;
    list.appendChild(div);
  });
}

// ===== SZERKESZT√âS (M√ìDOS√çTVA) =====
function confirmEdit() {
  const v1 = document.getElementById("editInput1").value;
  const v2 = parseInt(document.getElementById("editInput2").value);
  
  if (editTarget.type === 'goal') {
    // VALID√ÅCI√ì (0 PONT ENGED√âLYEZVE)
    if (!v1) return alert("A c√©lnak nevet kell adni!");
    if (isNaN(v2) || v2 < 0) return alert("√ârv√©nytelen pontsz√°m! Adj meg 0-t vagy nagyobbat.");
    
    const v3 = document.getElementById("editInput3").value.trim(); // √öJ
    
    if(goals[editTarget.index].done) {
        let diff = v2 - goals[editTarget.index].points;
        totalPoints += diff;
        localStorage.setItem("totalPoints", totalPoints);
    }
    goals[editTarget.index].name = v1;
    goals[editTarget.index].points = v2;
    goals[editTarget.index].category = v3; // M√ìDOS√çTVA
    localStorage.setItem("goals", JSON.stringify(goals));
    renderGoals();
    renderRewards();
  } else {
    // JUTALOM VALID√ÅCI√ì (0 PONT TILTVA)
    if (!v1) return alert("A jutalomnak nevet kell adni!");
    if (isNaN(v2) || v2 <= 0) return alert("√ârv√©nytelen pont √°r! Nagyobbnak kell lennie 0-n√°l.");
    
    rewards[editTarget.index].name = v1;
    rewards[editTarget.index].cost = v2;
    localStorage.setItem("rewards", JSON.stringify(rewards));
    renderRewards();
  }
  closeModal('editModal');
}

// ===== NAPL√ì =====
function logActivity(text) {
  const time = new Date().toLocaleString();
  const entry = { time, text };
  logs.unshift(entry);
  if (logs.length > 100) logs.pop();
  localStorage.setItem("logs", JSON.stringify(logs));
  renderLogs();
}

function renderLogs() {
  const logDiv = document.getElementById("activityLog");
  logDiv.innerHTML = "";
  logs.forEach((l, i) => {
    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `
      <span>${l.text}</span>
      <small>${l.time}</small>
      <button style="background:none;color:#c00" onclick="deleteLog(${i})">üóëÔ∏è</button>
    `;
    logDiv.appendChild(div);
  });
}

function deleteLog(i) {
  logs.splice(i, 1);
  localStorage.setItem("logs", JSON.stringify(logs));
  renderLogs();
}

function clearAllLogs() {
  if (confirm("Biztos t√∂rl√∂d az √∂sszes napl√≥bejegyz√©st?")) {
    logs = [];
    localStorage.setItem("logs", JSON.stringify([]));
    renderLogs();
  }
}

// ===== GRAFIKON =====
function updateChart() {
  const ctx = document.getElementById("progressChart");
  
  const weightEntries = transactions.filter(t => t.type === 'weight');
  const weights = weightEntries.map(e => e.value);
  const labels = weightEntries.map(e => e.date);
  
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "S√∫ly (kg)",
        data: weights,
        borderWidth: 3,
        borderColor: "#00796b",
        tension: 0.3,
        spanGaps: true
      }]
    },
    options: {
      scales: { y: { beginAtZero: false } }
    }
  });
}

// ===== NAPI MOTIV√ÅCI√ì =====
function loadMotivation() {
  const tateTips = [
    "Ne v√°rj kedvre ‚Äì csak a gyeng√©k v√°rnak r√°. Tedd, amit kell.",
    "Ha a tested tiltakozik, az elm√©d parancsoljon neki.",
    "A fegyelem legy≈ëzi a lustas√°got minden nap.",
    "Minden korty v√≠z egy l√©p√©s az uralkod√°s fel√©.",
    "A f√©rfi, aki nem kontroll√°lja az √©tv√°gy√°t, nem uralja az √©let√©t."
  ];
  const day = new Date().getDate();
  document.getElementById("motivationBar").innerText = `Tipp: ‚Äû${tateTips[day % tateTips.length]}‚Äù`;
}

// ===== HALAD√ÅS T√ñRT√âNET =====
function updateHistory() {
  const div = document.getElementById("historyList");
  div.innerHTML = "";
  
  if (transactions.length === 0) {
    div.innerHTML = "<p>M√©g nincsenek adatbejegyz√©sek.</p>";
    return;
  }

  transactions.slice().reverse().forEach((t, i) => {
    const originalIndex = transactions.length - 1 - i; 
    const item = document.createElement("div");
    item.className = "log-entry"; 
    
    let text = "";
    if (t.type === 'weight') {
      text = `‚öñÔ∏è S√∫ly: <b>${t.value} kg</b>`;
    } else if (t.type === 'water') {
      text = `üíß V√≠z: <b>${t.value} L</b>`;
    } else if (t.type === 'calories') {
      text = `üî• Kal√≥ria: <b>${t.value} kcal</b>`;
    }
    
    item.innerHTML = `
      <span>
        <b>${t.date}</b> ‚Äî ${text}
      </span>
      <button style="background:none;color:#c00" onclick="deleteTransaction(${originalIndex})">üóëÔ∏è</button>
    `;
    div.appendChild(item);
  });
}

// ===== INIT =====
window.onload = function() {
  loadTransactionsAndMigrate();
  calculateDailyProgress();
  
  renderGoals();
  renderRewards();
  renderNotes();
  renderLogs();
  updateChart();
  updateAllSummaries();
  updateHistory();
  loadMotivation();
};
</script>

<style>
/* ====== ANIM√ÅCI√ìK ====== */
.fade-in {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeIn 0.6s ease forwards;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
button, .tab-btn {
  transition: transform 0.15s ease, background-color 0.3s;
}
button:hover, .tab-btn:hover {
  transform: scale(1.03);
}

/* ====== EXPORT / RESET PANEL ====== */
#controlPanel {
  text-align: center;
  margin-top: 25px;
}
#controlPanel button {
  background: #004d40;
  margin: 5px;
}
#controlPanel input[type="file"] {
  display: none;
}
</style>

<div class="card fade-in" id="controlPanel">
  <h2>üß† Fejedelem Kontrollpanel</h2>
  <p>Adatment√©s, vissza√°ll√≠t√°s √©s teljes reset</p>
  <button onclick="exportData()">üíæ Export√°l√°s</button>
  <button onclick="document.getElementById('importFile').click()">üìÇ Import√°l√°s</button>
  <input type="file" id="importFile" accept=".json" onchange="importData(event)">
  <button style="background:#b71c1c" onclick="resetAll()">‚ö†Ô∏è Teljes reset</button>
</div>

<script>
// ====== EXPORT / IMPORT ======
function exportData() {
  const allData = {
    goals, rewards, notes, transactions, logs, totalPoints,
    goalWeight: localStorage.getItem("goalWeight"),
    goalWater: localStorage.getItem("goalWater"),
    goalCalories: localStorage.getItem("goalCalories")
  };
  const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `FitGarden_Backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  logActivity("üíæ Adatok export√°lva");
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      goals = data.goals || [];
      rewards = data.rewards || [];
      notes = data.notes || [];
      transactions = data.transactions || [];
      logs = data.logs || [];
      totalPoints = data.totalPoints || 0;
      
      localStorage.setItem("goalWeight", data.goalWeight || "");
      localStorage.setItem("goalWater", data.goalWater || "");
      localStorage.setItem("goalCalories", data.goalCalories || "");
      
      localStorage.setItem("goals", JSON.stringify(goals));
      localStorage.setItem("rewards", JSON.stringify(rewards));
      localStorage.setItem("notes", JSON.stringify(notes));
      localStorage.setItem("transactions", JSON.stringify(transactions));
      localStorage.setItem("logs", JSON.stringify(logs));
      localStorage.setItem("totalPoints", totalPoints);
      
      localStorage.removeItem("entries");
      localStorage.removeItem("dailyProgress");

      renderAll();
      logActivity("üìÇ Adatok import√°lva");
      alert("Sikeres import√°l√°s! Minden adat friss√≠tve ‚úÖ");
    } catch {
      alert("‚ùå Hiba: a f√°jl nem megfelel≈ë form√°tum√∫!");
    }
  };
  reader.readAsText(file);
}

// ====== TELJES RESET ======
function resetAll() {
  if (confirm("Biztosan t√∂r√∂lni szeretn√©l MINDENT? Ez v√©gleges!")) {
    localStorage.clear();
    goals = [];
    rewards = [];
    notes = [];
    transactions = [];
    logs = [];
    totalPoints = 0;
    renderAll();
    logActivity("‚ö†Ô∏è Teljes rendszer reset");
    alert("FitGarden √∫jraind√≠tva, minden t√∂r√∂lve ‚úÖ");
  }
}

// ====== EGYSZER≈∞ √öJRARAJZOL√ÅS ======
function renderAll() {
  calculateDailyProgress();
  
  renderGoals();
  renderRewards();
  renderNotes();
  renderLogs();
  updateChart();
  updateAllSummaries();
  updateHistory();
  loadMotivation();
}
</script>

</body>
</html>
