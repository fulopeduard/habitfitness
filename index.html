<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FitGarden 2.0 ‚Äì Fejedelem Edition üí™üåø</title>

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
  margin: 0;
  padding: 0;
  color: #222;
  overflow-x: hidden;
}
#motivationBar {
  background: #004d40;
  color: white;
  padding: 8px;
  text-align: center;
  font-style: italic;
  font-size: 0.95em;
  letter-spacing: 0.3px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
main {
  max-width: 1200px;
  margin: 20px auto;
  padding: 15px;
}
.card {
  background: white;
  border-radius: 18px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  padding: 20px;
  margin-bottom: 25px;
}
h2 {
  color: #00796b;
  margin-bottom: 10px;
}
button {
  background: #00796b;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 8px 15px;
  font-size: 0.95em;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  background: #004d40;
}
.icon-box {
  display: flex;
  justify-content: space-around;
  align-items: stretch;
  gap: 15px;
  flex-wrap: wrap;
}
.icon-card {
  flex: 1;
  min-width: 280px;
  background: #e8f5e9;
  border-radius: 12px;
  text-align: center;
  padding: 20px;
  position: relative;
  display: flex;
  flex-direction: column;
}
.icon-card i {
  font-size: 2em;
  color: #00796b;
  display: block;
}
.icon-card span {
  display: block;
  margin-top: 5px;
  font-weight: bold;
  font-size: 1.1em;
}
.edit-btn {
  position: absolute;
  top: 8px;
  right: 10px;
  background: none;
  color: #00796b;
  border: none;
  font-size: 1.1em;
  cursor: pointer;
}
.hidden { display: none; }

#tabs {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 25px;
  gap: 5px;
}
.tab-btn {
  background: #ccc;
  color: black;
  padding: 10px 20px;
  border-radius: 10px;
  margin: 0;
  cursor: pointer;
  transition: 0.3s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.tab-btn.active {
  background: #00796b;
  color: white;
  font-weight: bold;
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ================================================== */
/* ===== C√âL/JUTALOM ELRENDEZ√âS ===== */
/* ================================================== */
.flex-container {
  display: flex;
  gap: 25px;
  flex-wrap: wrap;
  align-items: flex-start;
}
.flex-container > .card {
  flex: 1;
  min-width: 300px;
}

/* ================================================== */
/* ===== K√ÅRTYA FEJL√âC (C√çM + GOMB/PONTOK) ST√çLUS ===== */
/* ================================================== */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.card-header h2 {
  margin-bottom: 0;
}
/* √öJ ST√çLUS A FEJL√âC ARCH√çV GOMBJ√ÅHOZ */
.card-header .archive-header-btn {
  background: #004d40;
  font-size: 0.9em;
  padding: 6px 12px;
}
/* ================================================== */

/* ================================================== */
/* ===== PONTSZ√ÅML√ÅL√ì (JUTALMAK FEJL√âC) ===== */
/* ================================================== */
.header-points-display {
  display: flex;
  align-items: center;
  font-weight: bold;
}
.header-points-display .points-icon {
  font-size: 1.3em;
  margin-right: 8px;
  color: #00796b; /* T√©ma z√∂ld */
  line-height: 1;
}
.header-points-display .points-number {
  color: #004d40; /* S√∂t√©t z√∂ld */
  font-size: 1.4em; /* Kiemelt sz√°m */
  line-height: 1;
}
.header-points-display .points-label {
  color: #00796b; /* T√©ma z√∂ld */
  margin-left: 5px;
  font-size: 1.1em;
  line-height: 1;
}
/* ================================================== */

/* ================================================== */
/* ===== √öJ GOMB ST√çLUS (K√ÅRTYA ALJ√ÅN) ===== */
/* ================================================== */
.new-item-button {
  width: 100%; /* Teljes sz√©less√©g */
  padding: 12px; /* Nagyobb, k√©nyelmesebb gomb */
  font-size: 1em;
  font-weight: bold;
  margin-top: 15px; /* T√°vols√°g a list√°t√≥l */
}
/* ================================================== */


/* ================================================== */
/* ===== C√âL, JUTALOM, √âTEL S√ÅV ST√çLUS ===== */
/* ================================================== */
.goal-item, .reward-item, .food-item {
  background: transparent;
  border-radius: 10px;
  padding: 0;
  margin-bottom: 8px;
  display: flex;
  overflow: hidden;
  align-items: stretch;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.completed {
  text-decoration: line-through;
  opacity: 0.7;
}

.item-name {
  flex: 1;
  padding: 10px 15px;
  background: #e8f5e9; /* Vil√°gos z√∂ld */
  display: flex;
  flex-direction: column; /* M√ìDOS√çTVA */
  align-items: flex-start; /* M√ìDOS√çTVA */
}
.item-points {
  flex-shrink: 0;
  align-items: center;
  justify-content: center;
  width: 69px;
  padding: 10px;
  background: #dcedc8; /* √Årnyalattal s√∂t√©tebb z√∂ld */
  text-align: center;
  font-weight: bold;
  border-left: 1px solid #c8e6c9;
  border-right: 1px solid #c8e6c9;
  display: flex;
¬† align-items: center;
¬† justify-content: center;
}
/* √öJ ST√çLUS AZ √âTEL K√ÅRTY√ÅHOZ */
.food-item .item-details {
  flex-shrink: 0;
  width: 120px;
  padding: 10px;
  background: #dcedc8;
  text-align: center;
  font-weight: bold;
  border-left: 1px solid #c8e6c9;
  border-right: 1px solid #c8e6c9;
  font-size: 0.9em;
  line-height: 1.3;
}
.food-item .item-details span {
  display: block;
}
/* ================================================== */

.item-actions {
  flex-shrink: 0;
  padding: 10px 10px;
  background: #e8f5e9; /* Vil√°gos z√∂ld */
  display: flex;
  gap: 5px;
  justify-content: center;
  align-items: center;
}

.item-actions button {
  background: transparent;
  color: #00796b;
  font-size: 1.1em;
  cursor: pointer;
  padding: 5px;
}

/* √öJ ST√çLUSOK AZ ARCHIV√ÅL√ÅSHOZ */
.item-actions button.archive-btn {
  color: #004d40; /* S√∂t√©tz√∂ld az archiv√°l√°shoz */
}
/* St√≠lus az archiv√°lt elemek gombjaihoz */
#archivedGoalList .item-actions button.reactivate-btn {
  color: #00796b; /* Z√∂ld */
}
#archivedGoalList .item-actions button.delete-btn {
  color: #c00; /* Piros */
}


.category-title {
  margin-top: 20px;
  margin-bottom: 8px;
  color: #004d40;
  border-bottom: 2px solid #b2dfdb;
  padding-bottom: 4px;
  font-size: 1.1em;
}
#goalList .category-title:first-of-type {
  margin-top: 10px;
}

/* ================================================== */
/* ===== √öJ ALC√âL (SUB-GOAL) ST√çLUSOK ===== */
/* ================================================== */
.subgoal-list {
  margin-top: 10px;
  padding-left: 15px;
  font-size: 0.9em;
  text-align: left;
  width: 100%; /* Kit√∂lti a .item-name sz√©less√©g√©t */
}
.subgoal-list div {
  display: flex;
  align-items: center;
  margin-bottom: 5px;
  text-decoration: none; /* Ne h√∫zza √°t az alc√©l sz√∂veg√©t */
}
.subgoal-list input[type="checkbox"] {
  width: auto;
  margin: 0 10px 0 0;
}
.subgoal-list span.subgoal-done {
  text-decoration: line-through;
  opacity: 0.7;
}
/* Amikor a F≈ê c√©l k√©sz, a F≈ê c√≠m √°th√∫zva */
.goal-item.completed .item-name-main {
  text-decoration: line-through;
}
/* De a sub-goal lista soha (csak a bels≈ë span) */
.goal-item.completed .subgoal-list {
  text-decoration: none;
}
/* ================================================== */


.log {
  background: #f8f8f8;
  border-radius: 10px;
  padding: 10px;
  max-height: 300px;
  overflow-y: auto;
}
.log-entry {
  border-bottom: 1px solid #ddd;
  padding: 6px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.log-entry span {
  flex: 1;
  padding-right: 10px;
}
.log-entry small { color: #777; font-size: 0.85em; margin-left: 10px; }
.log-entry button {
  flex-shrink: 0;
}

.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  border-radius: 15px;
  padding: 20px;
  width: 90%;
  max-width: 400px;
}
.modal-content h3 { margin-top: 0; color: #00796b; text-align: center; }

input, textarea, select {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 1em;
  box-sizing: border-box;
  background-color: white; /* Select h√°t√©rsz√≠n */
}

/* ================================================== */
/* ===== GRAFIKON MODAL ST√çLUSOK ===== */
/* ================================================== */
#chartModalContent {
  max-width: 90%;
  width: 800px;
}

#progressChart {
  width: 100%;
  height: 400px;
}
/* ================================================== */


/* ====== K√ñVET√âS ST√çLUSOK ====== */
.icon-card .content-wrapper {
  margin-top: 15px;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
}
.progress-summary {
  font-size: 0.9em;
  font-weight: bold;
  color: #004d40;
  margin-top: 10px;
  margin-bottom: 10px;
  height: 1.2em;
}
.input-group {
  display: flex;
  margin-top: 10px;
  gap: 5px;
}
.input-group input {
  flex: 1;
  width: 60%;
  margin: 0;
  font-size: 0.9em;
  text-align: center;
}
.input-group button {
  flex-shrink: 0;
  font-size: 0.85em;
  padding: 8px 10px;
}
.progress-bar-container {
  background: #c8e6c9;
  border-radius: 10px;
  height: 12px;
  width: 100%;
  margin-top: 10px;
  overflow: hidden;
  border: 1px solid #a5d6a7;
}
.progress-bar {
  background: #00796b;
  height: 100%;
  width: 0%;
  border-radius: 10px;
  transition: width 0.5s ease;
}

/* √öJ: A PROTEIN S√ÅV SZ√çNE */
#proteinProgressBar {
  background: #8e24aa; /* Lila */
}

/* ====== ANIM√ÅCI√ìK ====== */
.fade-in {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeIn 0.6s ease forwards;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
button, .tab-btn {
  transition: transform 0.15s ease, background-color 0.3s;
}
button:hover, .tab-btn:hover {
  transform: scale(1.03);
}

/* ====== EXPORT / RESET PANEL ====== */
#controlPanel {
  text-align: center;
  margin-top: 25px;
}
#controlPanel button {
  background: #004d40;
  margin: 5px;
}
#controlPanel input[type="file"] {
  display: none;
}


/* ================================================== */
/* ===== √öJ JEGYZET ST√çLUSOK ===== */
/* ================================================== */
#noteViewModal .modal-content {
  background: #f1f8e9;
  max-width: 600px;
}
#noteViewText {
  background: #ffffff;
  border-radius: 8px;
  padding: 15px;
  min-height: 100px;
  max-height: 60vh;
  overflow-y: auto;
  white-space: pre-wrap;
  border: 1px solid #dcedc8;
}
.note-summary-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #e8f5e9;
  padding: 12px 15px;
  border-radius: 10px;
  margin-bottom: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.note-summary-title {
  flex: 1;
  font-weight: bold;
  font-size: 1.1em;
  color: #004d40;
  cursor: pointer;
  margin-right: 10px;
}
.note-summary-date {
  font-size: 0.85em;
  color: #555;
  margin-right: 15px;
  flex-shrink: 0;
}
.note-summary-actions button {
  background: transparent;
  color: #00796b;
  font-size: 1.1em;
  padding: 5px;
}
#editInputText {
  height: 150px;
  resize: vertical;
  font-family: 'Segoe UI', sans-serif;
}

/* ================================================== */
/* ===== √öJ EDZ√âS ST√çLUSOK (NAPT√ÅR T√ñR√ñLVE) ===== */
/* ================================================== */
.workout-adder {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}
.workout-adder input[type="date"] {
  flex: 1; /* A d√°tumv√°laszt√≥ t√∂ltse ki a helyet */
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 10px;
  font-size: 1em;
}
.workout-adder button {
  flex-shrink: 0; /* A gomb ne zsugorodjon */
  padding: 10px 15px;
  font-weight: bold;
}
.workout-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #e8f5e9;
  padding: 12px 15px;
  border-radius: 10px;
  margin-bottom: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.workout-item span {
  font-weight: bold;
  font-size: 1.1em;
  color: #004d40;
  cursor: pointer; /* HOZZ√ÅADVA */
  flex: 1; /* HOZZ√ÅADVA */
  margin-right: 10px; /* HOZZ√ÅADVA */
}
.workout-item button {
  background: transparent;
  color: #c00; /* V√∂r√∂s a t√∂rl√©shez */
  font-size: 1.2em;
}
/* EZT A GOMBOT ADJUK HOZZ√Å A SZERKESZT√âSHEZ */
.workout-item button.edit-note-btn {
  color: #00796b; /* T√©ma z√∂ld */
  font-size: 1.1em;
}
/* ================================================== */


</style>
</head>
<body>

<!-- ======================================================= -->
<!-- ===== LOGIN CONTAINER (NEW) ===== -->
<!-- ======================================================= -->
<div id="loginContainer" style="padding: 20px; max-width: 400px; margin: 40px auto; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
  <h2 style="color: #00796b; text-align: center;">FitGarden 2.0</h2>
  <h3 style="text-align: center;">Bel√©p√©s / Regisztr√°ci√≥</h3>
  <label>Email</label>
  <input type="email" id="loginEmail" placeholder="email@cim.com">
  <label>Jelsz√≥</label>
  <input type="password" id="loginPassword" placeholder="min. 6 karakter">
  <div style="display: flex; gap: 10px; margin-top: 15px;">
    <button onclick="handleLogin()" style="flex: 1;">Bel√©p√©s</button>
    <button onclick="handleSignUp()" style="flex: 1; background: #004d40;">Regisztr√°ci√≥</button>
  </div>
  <p id="loginError" style="color: red; text-align: center; margin-top: 10px;"></p>
</div>

<!-- ======================================================= -->
<!-- ===== MAIN APP CONTAINER (WRAPS YOUR EXISTING APP) ===== -->
<!-- ======================================================= -->
<!-- We hide this by default, onAuthStateChanged will show it -->
<div id="appContainer" style="display: none;">

	<div id="motivationBar">Tipp: ‚ÄûA lustas√°g a gyeng√©k vall√°sa. T√∂rj ki bel≈ële.‚Äù</div>

	<main>
	  <div id="tabs">
	    <div class="tab-btn active" onclick="showTab('main')">F≈ëoldal</div>
	    <div class="tab-btn" onclick="showTab('notes')">Jegyzetek</div>
	    <!-- √öJ √âTKEZ√âS F√úL -->
	    <div class="tab-btn" onclick="showTab('meals')">√âtkez√©s</div>
	    <div class="tab-btn" onclick="showTab('history')">Halad√°s</div>
	    <div class="tab-btn" onclick="showTab('workouts')">Edz√©sek</div>
	  </div>

	  <div id="main" class="tab-content active">
	    
	    <div class="card" style="text-align:center; padding: 10px;">
	      <button onclick="openChartModal()" style="width: 100%; padding: 10px; font-size: 1em;">
	        üìà S√∫ly Grafikon Megnyit√°sa
	      </button>
	    </div>

	    <!-- √öJ GOMB A C√âLOK V√ÅLT√ÅS√ÅHOZ -->
	    <div class="card" id="goalsToggleCard" style="text-align:center; padding: 10px;">
	      <button onclick="toggleGoalsDisplay()" style="width: 100%; padding: 10px; font-size: 1em;">
	        üéØ Napi C√©lok Megnyit√°sa/Elrejt√©se
	      </button>
	    </div>

	    <!-- A C√âL K√ÅRTY√ÅK √öJ HELYTART√ìJA -->
	    <div id="mainGoalsPlaceholder">
	      <!-- JAV√çTOTT R√âSZ: VISSZA√ÅLL√çTOTTAM A HI√ÅNYZ√ì K√ÅRTY√ÅKAT -->
	      <div class="card" id="goalsDisplay" style="display: none;">
	        <div class="icon-box" id="goalSummary">
	          
	          <!-- S√öLY K√ÅRTYA (VISSZA√ÅLL√çTVA) -->
	          <div class="icon-card">
	            <button class="edit-btn" onclick="editGoals()">‚úèÔ∏è</button>
	            <i>‚öñÔ∏è</i>
	            <span id="goalWeightText">C√©l s√∫ly: nincs megadva</span>
	            <div class="content-wrapper">
	              <div class="progress-summary" id="weightSummary">M√©g nem adt√°l meg s√∫lyt.</div>
	              <div class="input-group">
	                <input id="weightInput" type="number" placeholder="Jelenlegi s√∫ly (kg)">
	                <button onclick="addTransaction('weight')">‚öñÔ∏è Ment√©s</button>
	              </div>
	            </div>
	          </div>

	          <!-- V√çZ K√ÅRTYA (EZ EREDETILEG IS J√ì VOLT) -->
	          <div class="icon-card">
	            <button class="edit-btn" onclick="editGoals()">‚úèÔ∏è</button>
	            <i>üíß</i>
	            <span id="goalWaterText">V√≠z c√©l: nincs megadva</span>
	            <div class="content-wrapper">
	              <div class="progress-bar-container">
	                <div id="waterProgressBar" class="progress-bar"></div>
	              </div>
	              <div class="progress-summary" id="waterSummary">...</div>
	              <div class="input-group">
	                <input id="waterInput" type="number" step="0.1" placeholder="Hozz√°ad (L)">
	                <button onclick="addTransaction('water')">üíß Hozz√°ad</button>
	              </div>
	            </div>
	          </div>

	          <!-- KAL√ìRIA K√ÅRTYA (VISSZA√ÅLL√çTVA) -->
	          <div class="icon-card">
	            <button class="edit-btn" onclick="editGoals()">‚úèÔ∏è</button>
	            <i>üî•</i>
	            <span id="goalCalText">Kal√≥ria c√©l: nincs megadva</span>
	              <div class="content-wrapper">
	              <div class="progress-bar-container">
	                <div id="calProgressBar" class="progress-bar"></div>
	              </div>
	              <div class="progress-summary" id="calSummary">...</div>
	              <div class="input-group">
	                <input id="calInput" type="number" placeholder="Hozz√°ad (kcal)">
	                <button onclick="addTransaction('calories')">üî• Hozz√°ad</button>
	              </div>
	            </div>
	          </div>
	          
	          <!-- PROTEIN K√ÅRTYA (VISSZA√ÅLL√çTVA) -->
	          <div class="icon-card">
	            <button class="edit-btn" onclick="editGoals()">‚úèÔ∏è</button>
	            <i>ü•©</i>
	            <span id="goalProteinText">Protein c√©l: nincs megadva</span>
	              <div class="content-wrapper">
	              <div class="progress-bar-container">
	                <div id="proteinProgressBar" class="progress-bar"></div>
	              </div>
	              <div class="progress-summary" id="proteinSummary">...</div>
	              <div class="input-group">
	                <input id="proteinInput" type="number" placeholder="Hozz√°ad (g)">
	                <button onclick="addTransaction('protein')">ü•© Hozz√°ad</button>
	              </div>
	            </div>
	          </div>
	          
	        </div>
	      </div>
	    </div>

	    <div class="flex-container">
	      <div class="card">
	        <div class="card-header">
	          <h2>‚úÖ C√©lok</h2>
	          <!-- √öJ ARCH√çVUM GOMB HOZZ√ÅADVA -->
	          <button class="archive-header-btn" onclick="openArchiveModal()">üì• Arch√≠vum</button>
	        </div>
	        <div id="goalList"></div>
	        <button onclick="openModal('goalModal')" class="new-item-button">+ √öj c√©l</button>
	      </div>

	      <div class="card">
	        <div class="card-header">
	          <h2>üéÅ Jutalmak</h2>
	          <div class="header-points-display">
	            <span class="points-icon">üíé</span>
	            <span id="totalPointsDisplay" class="points-number">0</span>
	            <span class="points-label"> pont</span>
	          </div>
	        </div>
	        <div id="rewardList"></div>
	        <button onclick="openModal('rewardModal')" class="new-item-button">+ √öj jutalom</button>
	      </div>
	    </div>

	    <div class="card">
	      <h2>üìú Napl√≥</h2>
	      <div class="log" id="activityLog"></div>
	      <button style="margin-top:10px" onclick="clearAllLogs()">üßπ Napl√≥ t√∂rl√©se</button>
	    </div>
	    
	    <div class="card fade-in" id="controlPanel">
	      <h2>üß† Fejedelem Kontrollpanel</h2>
	      <p>Adatment√©s, vissza√°ll√≠t√°s √©s teljes reset</p>
	      <button onclick="exportData()">üíæ Export√°l√°s</button>
	      <button onclick="document.getElementById('importFile').click()">üìÇ Import√°l√°s</button>
	      <input type="file" id="importFile" accept=".json" onchange="importData(event)">
	      <button style="background:#b71c1c" onclick="resetAll()">‚ö†Ô∏è Teljes reset</button>
          <!-- Added Logout Button -->
	      <button onclick="handleLogout()" style="background:#555">üö™ Kijelentkez√©s</button>
	    </div>
	    
	  </div>
	  
	  <div id="notes" class="tab-content">
	    <div class="card">
	      <h2>üìù √öj Jegyzet</h2>
	      <label for="noteTitleInput">C√≠m</label>
	      <input type="text" id="noteTitleInput" placeholder="Jegyzet c√≠me...">
	      <label for="noteTextInput">Sz√∂veg</label>
	      <textarea id="noteTextInput" placeholder="√çrj ide valamit..."></textarea>
	      <button onclick="addNote()">Ment√©s</button>
	      
	      <h2 style="margin-top: 25px;">Mentett Jegyzetek</h2>
	      <div id="notesList"></div>
	    </div>
	  </div>
	  
	  <!-- √öJ √âTKEZ√âS OLDAL TARTALMA -->
	  <div id="meals" class="tab-content">
	    <!-- √öJ HELYTART√ì A C√âLOKNAK -->
	    <div id="mealsGoalsPlaceholder"></div>
	    
	    <div class="card">
	      <h2>Mentett √©telek</h2>
	      <p>Itt kezelheted az √©teleket, amiket gyakran fogyasztasz. Fogyaszd el ≈ëket, hogy automatikusan friss√ºlj√∂n a kal√≥ria- √©s feh√©rjebeviteled.</p>
	      <div id="mealList">
	        <!-- √âtelek list√°ja ide ker√ºl -->
	      </div>
	      <button onclick="openMealModal()" class="new-item-button">+ √öj √©tel hozz√°ad√°sa</button>
	    </div>
	  </div>

	  <div id="history" class="tab-content">
	    <div class="card">
	      <h2>üìÖ Adat T√∂rt√©net (S√∫ly, V√≠z, Kal√≥ria, Protein)</h2>
	      <div id="historyList" class="log"></div>
	    </div>
	  </div>

	  <div id="workouts" class="tab-content">
	    <div class="card">
	      <h2>üìÖ Edz√©s r√∂gz√≠t√©se</h2>
	      <p>V√°laszd ki a napot, √©s r√∂gz√≠tsd az edz√©st.</p>
	      <div class="workout-adder">
	        <input type="date" id="workoutDateInput">
	        <button onclick="addWorkout()">üèãÔ∏è‚Äç‚ôÇÔ∏è Edz√©s r√∂gz√≠t√©se</button>
	      </div>
	      
	      <h2 style="margin-top: 25px;">R√∂gz√≠tett edz√©sek</h2>
	      <div id="workoutList">
	          </div>
	    </div>
	  </div>

	</main>

	<!-- All Modals -->
	<div class="modal" id="noteViewModal">
	  <div class="modal-content">
	    <h3 id="noteViewTitle">Jegyzet c√≠me</h3>
	    <div id="noteViewText">
	      Jegyzet tartalma...
	    </div>
	    <div style="text-align:center;margin-top:15px;">
	      <button style="background:#ccc;color:black;" onclick="closeModal('noteViewModal')">Bez√°r√°s</button>
	    </div>
	  </div>
	</div>

	<div class="modal" id="chartModal">
	  <div class="modal-content" id="chartModalContent">
	    <h3>üìà S√∫ly Grafikon</h3>
	    <canvas id="progressChart"></canvas>
	    <div style="text-align:center;margin-top:15px;">
	      <button style="background:#ccc;color:black;" onclick="closeModal('chartModal')">Bez√°r√°s</button>
	    </div>
	  </div>
	</div>
	<div class="modal" id="goalSetupModal">
	  <div class="modal-content">
	    <h3>üéØ C√©lok be√°ll√≠t√°sa</h3>
	    <label>Ide√°lis s√∫ly (kg)</label>
	    <input id="goalWeightInput" type="number" placeholder="pl. 75">
	    <label>Napi v√≠z c√©l (liter)</label>
	    <input id="goalWaterInput" type="number" step="0.1" placeholder="pl. 2.5">
	    <label>Napi kal√≥ria c√©l (kcal)</label>
	    <input id="goalCalInput" type="number" placeholder="pl. 2200">
	    <!-- √öJ PROTEIN C√âL MEZ≈ê -->
	    <label>Napi protein c√©l (gramm)</label>
	    <input id="goalProteinInput" type="number" placeholder="pl. 120">
	    
	    <div style="text-align:center;margin-top:15px;">
	      <button onclick="saveGoalSettings()">üíæ Ment√©s</button>
	      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('goalSetupModal')">M√©gse</button>
	    </div>
	  </div>
	</div>

	<div class="modal" id="goalModal">
	  <div class="modal-content">
	    <h3>üéØ √öj c√©l</h3>
	    <label>C√©l neve</label>
	    <input id="goalNameInput" type="text" placeholder="pl. 10.000 l√©p√©s">
	    <label>Pont √©rt√©k</label>
	    <input id="goalPointsInput" type="number" placeholder="pl. 10 (0 is lehet)">
	    <label>Kateg√≥ria (opcion√°lis)</label>
	    <!-- M√ìDOS√çTOTT INPUT √âS √öJ DATALIST -->
	    <input id="goalCategoryInput" type="text" placeholder="pl. Val√≥s√°g (v√°lassz vagy √≠rj be √∫jat)" list="categoryDatalist">
	    <datalist id="categoryDatalist">
	      <!-- JavaScript t√∂lti fel dinamikusan -->
	    </datalist>
	    
	    <!-- √öJ ALC√âL MEZ≈ê -->
	    <label>Alc√©lok (opcion√°lis, minden sor egy alc√©l)</label>
	    <textarea id="goalSubGoalsInput" rows="5" placeholder="pl. Csere cip≈ë&#10;Edz≈ë nadr√°g&#10;T√∂r√∂lk√∂z≈ë..."></textarea>
	    
	    <div style="text-align:center;margin-top:15px;">
	      <button onclick="saveGoal()">‚úÖ Ment√©s</button>
	      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('goalModal')">M√©gse</button>
	    </div>
	  </div>
	</div>

	<div class="modal" id="rewardModal">
	  <div class="modal-content">
	    <h3>üéÅ √öj jutalom</h3>
	    <label>Jutalom neve</label>
	    <input id="rewardNameInput" type="text" placeholder="pl. Pihen≈ënap">
	    <label>Pont √°ra</label>
	    <input id="rewardCostInput" type="number" placeholder="pl. 20">
	    <div style="text-align:center;margin-top:15px;">
	      <button onclick="saveReward()">‚úÖ Ment√©s</button>
	      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('rewardModal')">M√©gse</button>
	    </div>
	  </div>
	</div>

	<div class="modal" id="editModal">
	  <div class="modal-content">
	    <h3 id="editTitle">‚úèÔ∏è Szerkeszt√©s</h3>
	    
	    <label id="editLabel1"></label>
	    <input id="editInput1" type="text">
	    
	    <label id="editLabel2"></label>
	    <input id="editInput2" type="number">
	    
	    <label id="editLabel3" style="display:none;"></label>
	    <input id="editInput3" type="text" style="display:none;">
	    
	    <!-- √öJ: ALC√âL SZERKESZT≈ê -->
	    <label id="editLabelSubGoals" style="display:none;">Alc√©lok (minden sor egy alc√©l)</label>
	    <textarea id="editInputSubGoals" rows="5" style="display:none;"></textarea>

	    <label id="editLabelText" style="display:none;">Sz√∂veg</label>
	    <textarea id="editInputText" style="display:none;"></textarea>
	    
	    <!-- √öJ MEZ≈êK AZ √âTEL SZERKESZT√âS√âHEZ -->
	    <div id="editMealFields" style="display: none;">
	        <label for="editMealType">T√≠pus</label>
	        <select id="editMealType">
	            <option value="unit">Darab alap√∫</option>
	            <option value="weight">S√∫ly alap√∫ (100g)</option>
	        </select>
	        <label for="editMealKcal">Kal√≥ria (kcal)</label>
	        <input id="editMealKcal" type="number" placeholder="pl. 150">
	        <label for="editMealProtein">Feh√©rje (g)</label>
	        <input id="editMealProtein" type="number" placeholder="pl. 12">
	    </div>

	    <div style="text-align:center;margin-top:15px;">
	      <button onclick="confirmEdit()">üíæ Ment√©s</button>
	      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('editModal')">M√©gse</button>
	    </div>
	  </div>
	</div>

	<!-- √öJ ARCH√çVUM MODAL HOZZ√ÅADVA -->
	<div class="modal" id="archiveModal">
	  <div class="modal-content" style="max-width: 600px;">
	    <h3>üì• Archiv√°lt C√©lok</h3>
	    <div id="archivedGoalList" style="max-height: 400px; overflow-y: auto;">
	      <!-- Archiv√°lt c√©lok list√°ja ide ker√ºl dinamikusan -->
	    </div>
	    <div style="text-align:center;margin-top:15px;">
	      <button style="background:#ccc;color:black;" onclick="closeModal('archiveModal')">Bez√°r√°s</button>
	    </div>
	  </div>
	</div>
	
	<!-- √öJ √âTEL MODAL -->
	<div class="modal" id="mealModal">
	  <div class="modal-content">
	    <h3>√öj √©tel hozz√°ad√°sa</h3>
	    <label for="mealNameInput">√âtel neve</label>
	    <input id="mealNameInput" type="text" placeholder="pl. F≈ëtt toj√°s">
	    
	    <label for="mealTypeSelect">Sz√°mol√°s t√≠pusa</label>
	    <select id="mealTypeSelect" onchange="updateMealModalLabels()">
	        <option value="unit">Darab alap√∫</option>
	        <option value="weight">S√∫ly alap√∫ (100g)</option>
	    </select>
	    
	    <label id="mealKcalLabel" for="mealKcalInput">Kal√≥ria (kcal/darab)</label>
	    <input id="mealKcalInput" type="number" placeholder="pl. 78">
	    
	    <label id="mealProteinLabel" for="mealProteinInput">Feh√©rje (g/darab)</label>
	    <input id="mealProteinInput" type="number" placeholder="pl. 6">
	    
	    <div style="text-align:center;margin-top:15px;">
	      <button onclick="saveMeal()">‚úÖ Ment√©s</button>
	      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('mealModal')">M√©gse</button>
	    </div>
	  </div>
	</div>
	
	<!-- √öJ √âTEL FOGYASZT√ÅSA MODAL -->
	<div class="modal" id="consumeModal">
	  <div class="modal-content">
	    <h3 id="consumeMealTitle">√âtel fogyaszt√°sa</h3>
	    <p style="text-align: center; font-weight: bold;" id="consumeMealDetails"></p>
	    
	    <label id="consumeAmountLabel" for="consumeAmountInput">Mennyis√©g (Darab)</label>
	    <input id="consumeAmountInput" type="number" placeholder="pl. 2">
	    
	    <div style="text-align:center;margin-top:15px;">
	      <button onclick="confirmConsume()">üçΩÔ∏è Fogyaszt√°s</button>
	      <button style="background:#ccc;color:black;margin-left:8px;" onclick="closeModal('consumeModal')">M√©gse</button>
	    </div>
	  </div>
	</div>


</div> <!-- End of #appContainer -->


<!-- ================================================== -->
<!-- ===== START: FIREBASE SCRIPTS (FROM STEP 2) ===== -->
<!-- ================================================== -->

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

<script>
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCZJLWZFJFEFWQqZYmAcZjgqoc88FDfPwQ",
    authDomain: "habit-tracker-32c11.firebaseapp.com",
    databaseURL: "https://habit-tracker-32c11-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "habit-tracker-32c11",
    storageBucket: "habit-tracker-32c11.appspot.com",
    messagingSenderId: "637775270587",
    appId: "1:637775270587:web:11b31d9f64510d81c20f9e",
    measurementId: "G-SS9TX286CF"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  
  // Create global variables to access Firebase services
  const auth = firebase.auth();
  const db = firebase.firestore();
  let currentUser = null; // This will be set on login
  
  console.log("Firebase is connected!");
  
</script>

<!-- ================================================== -->
<!-- ===== END: FIREBASE SCRIPTS ===== -->
<!-- ================================================== -->


<!-- Your existing Chart.js script -->
<!-- JAV√çT√ÅS: √ÅTHELYEZVE IDE, HOGY A F≈ê SCRIPT EL≈êTT BET√ñLTS√ñN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ======================================================= -->
<!-- ===== ALL APP LOGIC (NOW FIREBASE ENABLED) ===== -->
<!-- JAV√çT√ÅS: EGYES√çTVE EGY BLOKKBAN -->
<!-- ======================================================= -->
<script>
// ======= POPUP VEZ√âRL√âS =======
function openModal(id) {
  document.getElementById(id).style.display = 'flex';
  // HOZZ√ÅADVA: Kateg√≥ria lista felt√∂lt√©se, amikor a c√©l modalt nyitjuk meg
  if (id === 'goalModal') {
    populateCategoryDatalist();
    // T√∂r√∂lj√ºk a r√©gi alc√©l bevitelt
    document.getElementById("goalSubGoalsInput").value = "";
  }
}
// √öJ: Az √©tel modal megnyit√°sa (alaphelyzetbe √°ll√≠t√°s)
function openMealModal() {
  // Ez biztos√≠tja, hogy szerkeszt√©s helyett "√∫j" m√≥dban ny√≠ljon meg
  editTarget = null; 
  
  document.getElementById('mealModal').querySelector('h3').textContent = "√öj √©tel hozz√°ad√°sa";
  document.getElementById("mealNameInput").value = "";
  document.getElementById("mealTypeSelect").value = "unit";
  document.getElementById("mealKcalInput").value = "";
  document.getElementById("mealProteinInput").value = "";
  updateMealModalLabels(); // C√≠mk√©k friss√≠t√©se
  
  openModal('mealModal');
}

function closeModal(id) {
  document.getElementById(id).style.display = 'none';
  // Biztos√≠tjuk, hogy a szerkeszt√©s mez≈ëi elrejtsenek, amikor bez√°rjuk
  if (id === 'editModal') {
    document.getElementById("editLabel1").style.display = "block";
    document.getElementById("editInput1").style.display = "block";
    document.getElementById("editLabel2").style.display = "block";
    document.getElementById("editInput2").style.display = "block";
    document.getElementById("editLabel3").style.display = "block";
    document.getElementById("editInput3").style.display = "block";
    document.getElementById("editLabelText").style.display = "none";
    document.getElementById("editInputText").style.display = "none";
    document.getElementById("editMealFields").style.display = "none";
    // Alc√©l mez≈ë elrejt√©se
    document.getElementById("editLabelSubGoals").style.display = "none";
    document.getElementById("editInputSubGoals").style.display = "none";
  }
}
function editGoals() {
  // Refactored to use global vars instead of localStorage
  document.getElementById("goalWeightInput").value = goalWeightSetting || "";
  document.getElementById("goalWaterInput").value = goalWaterSetting || "";
  document.getElementById("goalCalInput").value = goalCaloriesSetting || "";
  document.getElementById("goalProteinInput").value = goalProteinSetting || ""; // HOZZ√ÅADVA
  openModal('goalSetupModal');
}
// =======================================================
// ===== ALL APP LOGIC (NOW FIREBASE ENABLED) =====
// =======================================================
// =======================================================
// ===== GLOB√ÅLIS V√ÅLTOZ√ìK (REFACTORED) =====
// =======================================================
// These are now initialized as empty.
// They will be filled by loadDataFromFirestore()
let goals = [];
let rewards = [];
let notes = [];
let logs = [];
let workouts = [];
let meals = []; // √öJ
let totalPoints = 0;
let transactions = [];
let archivedGoals = [];

// App settings
let goalWeightSetting = "";
let goalWaterSetting = "";
let goalCaloriesSetting = "";
let goalProteinSetting = ""; // √öJ

// Other global vars
let chart;
let editTarget = null;
let dailyProgress = { water: 0, calories: 0, protein: 0, lastWeight: 0, date: "" }; // 'protein' HOZZ√ÅADVA


// =======================================================
// ===== √öJ FUNKCI√ì: KATEG√ìRIA LISTA L√âTREHOZ√ÅSA =====
// =======================================================
function populateCategoryDatalist() {
  const datalist = document.getElementById('categoryDatalist');
  if (!datalist) return;

  datalist.innerHTML = ""; // T√∂r√∂lj√ºk a r√©gi opci√≥kat

  // √ñsszegy≈±jtj√ºk a megl√©v≈ë kateg√≥ri√°kat (csak egyedi √©rt√©kek)
  const existingCategories = new Set(
    goals
      .map(goal => goal.category)
      .filter(category => category) // Csak a l√©tez≈ë kateg√≥ri√°k
  );
  
  // Hozz√°adjuk az archiv√°lt c√©lok kateg√≥ri√°it is
  archivedGoals
    .map(goal => goal.category)
    .filter(category => category)
    .forEach(category => existingCategories.add(category));

  // Hozz√°adjuk ≈ëket a list√°hoz
  existingCategories.forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    datalist.appendChild(option);
  });
}
// =======================================================


// =======================================================
// ===== AUTHENTICATION (NEW FUNCTIONS) =====
// =======================================================
function handleLogin() {
  const email = document.getElementById('loginEmail').value;
  const pass = document.getElementById('loginPassword').value;
  document.getElementById('loginError').innerText = "";
  
  auth.signInWithEmailAndPassword(email, pass)
    .then((userCredential) => {
      // Sign-in successful, onAuthStateChanged will handle the rest
      console.log("User logged in:", userCredential.user.uid);
    })
    .catch((error) => {
      document.getElementById('loginError').innerText = "Hiba: " + error.message;
    });
}

function handleSignUp() {
  const email = document.getElementById('loginEmail').value;
  const pass = document.getElementById('loginPassword').value;
  document.getElementById('loginError').innerText = "";

  auth.createUserWithEmailAndPassword(email, pass)
    .then((userCredential) => {
      // Sign-up successful, onAuthStateChanged will handle the rest
      console.log("User created:", userCredential.user.uid);
    })
    .catch((error) => {
      document.getElementById('loginError').innerText = "Hiba: " + error.message;
    });
}

function handleLogout() {
  auth.signOut();
}

// =======================================================
// ===== DATA SYNC (NEW FUNCTIONS) =====
// =======================================================

// A function to get all data from Firestore
async function loadDataFromFirestore() {
  if (!currentUser) return; // Safety check
  console.log("Loading data from Firestore...");
  const docRef = db.collection('users').doc(currentUser.uid);
  
  try {
    const doc = await docRef.get();
    if (doc.exists) {
      // Document exists, load the data into our global variables
      const data = doc.data();
      goals = data.goals || [];
      rewards = data.rewards || [];
      notes = data.notes || [];
      logs = Array.isArray(data.logs) ? data.logs : [];
      workouts = data.workouts || [];
      meals = data.meals || []; // √öJ
      archivedGoals = data.archivedGoals || [];
      totalPoints = data.totalPoints || 0;
      transactions = Array.isArray(data.transactions) ? data.transactions : [];
      
      // Also load the settings
      goalWeightSetting = data.goalWeight || "";
      goalWaterSetting = data.goalWater || "";
      goalCaloriesSetting = data.goalCalories || "";
      goalProteinSetting = data.goalProtein || ""; // √öJ
      
      // ===== EDZ√âS ADAT MIGR√ÅCI√ì (√öJ) =====
      if (workouts.length > 0 && typeof workouts[0] === 'string') {
        console.log("Migrating workouts data structure...");
        workouts = workouts.map(dateStr => ({ date: dateStr, note: "" }));
      }
      // ===== MIGR√ÅCI√ì V√âGE =====

      console.log("Data loaded successfully.");
    } else {
      console.log("No data found for this user, starting fresh.");
    }
  } catch (error) {
    console.error("Error loading data:", error);
    alert("Hiba t√∂rt√©nt az adatok bet√∂lt√©se k√∂zben.");
  }
}

// A function to save all data to Firestore
async function saveDataToFirestore() {
  if (!currentUser) return; // Safety check

  console.log("Saving data to Firestore...");
  const docRef = db.collection('users').doc(currentUser.uid);
  
  const dataToSave = {
    goals,
    rewards,
    notes,
    logs,
    workouts,
    meals, // √öJ
    archivedGoals,
    totalPoints,
    transactions,
    goalWeight: goalWeightSetting,
    goalWater: goalWaterSetting,
    goalCalories: goalCaloriesSetting,
    goalProtein: goalProteinSetting // √öJ
  };
  
  try {
    await docRef.set(dataToSave);
    console.log("Data saved successfully.");
  } catch (error) {
    console.error("Error saving data:", error);
  }
}

// =======================================================
// ===== APP INITIALIZATION (REFACTORED) =====
// =======================================================

auth.onAuthStateChanged(async (user) => {
  if (user) {
    // === USER IS LOGGED IN ===
    currentUser = user;
    console.log("Auth state changed: Logged in as", user.uid);
    
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('loginContainer').style.display = 'none';
    
    await loadDataFromFirestore();
    
    calculateDailyProgress();
    loadMotivation();
    renderAll(); 

  } else {
    // === USER IS LOGGED OUT ===
    currentUser = null;
    console.log("Auth state changed: Logged out");

    document.getElementById('appContainer').style.display = 'none';
    document.getElementById('loginContainer').style.display = 'block';
    
    // Clear all local data
    goals = [];
    rewards = [];
    notes = [];
    logs = [];
    workouts = [];
    meals = []; // √öJ
    archivedGoals = [];
    totalPoints = 0;
    transactions = [];
    goalWeightSetting = "";
    goalWaterSetting = "";
    goalCaloriesSetting = "";
    goalProteinSetting = ""; // √öJ
  }
});


// =======================================================
// ===== PONTSZ√ÅML√ÅL√ì ANIM√ÅCI√ì =====
// =======================================================
function animatePoints(newValue) {
  const displayElement = document.getElementById("totalPointsDisplay");
  if (!displayElement) return;

  let startValue = parseInt(displayElement.textContent);
  if (isNaN(startValue)) {
      startValue = 0;
  }
  if (startValue === newValue) return;

  const duration = 750;
  const range = newValue - startValue;
  let startTime = null;

  function step(timestamp) {
    if (!startTime) startTime = timestamp;
    const progress = Math.min((timestamp - startTime) / duration, 1);
    const currentValue = Math.floor(startValue + range * progress);
    
    displayElement.textContent = currentValue;

    if (progress < 1) {
      window.requestAnimationFrame(step);
    } else {
      displayElement.textContent = newValue;
    }
  }
  window.requestAnimationFrame(step);
}


// =======================================================
// ===== GRAFIKON MODAL FUNKCI√ì =====
// =======================================================
function openChartModal() {
  openModal('chartModal');
  setTimeout(updateChart, 100);
}

// =======================================================
// ===== ADATKEZEL≈ê F√úGGV√âNYEK =====
// =======================================================

function calculateDailyProgress() {
  const today = new Date().toISOString().slice(0, 10);
  // 'protein' HOZZ√ÅADVA
  dailyProgress = { water: 0, calories: 0, protein: 0, lastWeight: 0, date: today };
  
  let lastWeightEntry = null;

  if (!Array.isArray(transactions)) {
    console.error("Transactions is not an array!", transactions);
    transactions = [];
    return;
  }

  for (const t of transactions) {
    if (t.type === 'weight' && t.value > 0) {
      lastWeightEntry = t;
    }
    
    try {
      let entryDate;
      if (t.date && typeof t.date.toDate === 'function') {
        entryDate = t.date.toDate(); 
      } else {
        entryDate = new Date(t.date);
      }
      
      if (!entryDate || isNaN(entryDate.getTime())) {
          console.warn("Invalid date object encountered:", t.date);
          continue;
      }

      if (entryDate.toISOString().slice(0, 10) === today) {
        if (t.type === 'water') {
          dailyProgress.water += t.value;
        } else if (t.type === 'calories') {
          dailyProgress.calories += t.value;
        } else if (t.type === 'protein') { // √öJ
          dailyProgress.protein += t.value;
        } else if (t.type === 'meal') { // √öJ
          dailyProgress.calories += t.totalKcal;
          dailyProgress.protein += t.totalProtein;
        }
      }
    } catch (e) {
      console.error("D√°tumfeldolgoz√°si hiba a calculateDailyProgress-ben:", e, t.date);
    }
  }

  if (lastWeightEntry) {
    dailyProgress.lastWeight = lastWeightEntry.value;
  }
}

// =======================================================
// ===== M√ìDOS√çTOTT TAB KEZEL√âS =====
// =======================================================
function showTab(id) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  
  if (event && event.target) {
     event.target.classList.add('active');
  } else {
     document.querySelector(`.tab-btn[onclick="showTab('${id}')"]`).classList.add('active');
  }
  
  document.getElementById(id).classList.add('active');
  
  if (id === 'workouts') {
    renderWorkouts();
  }
  // √öJ: √âtkez√©s f√ºl renderel√©se
  if (id === 'meals') {
    renderMeals();
  }
  
  // ===== C√âL K√ÅRTY√ÅK √ÅTHELYEZ√âSE (√öJ LOGIKA) =====
  const goalsDisplayCard = document.getElementById('goalsDisplay');
  const mainPlaceholder = document.getElementById('mainGoalsPlaceholder');
  const mealsPlaceholder = document.getElementById('mealsGoalsPlaceholder');
  const goalsToggleButton = document.getElementById('goalsToggleCard');

  if (goalsDisplayCard && mainPlaceholder && mealsPlaceholder && goalsToggleButton) {
    if (id === 'main') {
      mainPlaceholder.appendChild(goalsDisplayCard);
      // A gomb √°llapot√°t√≥l f√ºgg≈ëen hagyjuk rejtve vagy mutatva, de alapb√≥l rejtve
      // goalsDisplayCard.style.display = 'none'; // Alapb√≥l rejtve a f≈ëoldalon
      goalsToggleButton.style.display = 'block'; // Gomb l√°that√≥
    } else if (id === 'meals') {
      mealsPlaceholder.appendChild(goalsDisplayCard);
      goalsDisplayCard.style.display = 'block'; // Alapb√≥l l√°that√≥ az √©tkez√©s oldalon
      goalsToggleButton.style.display = 'none'; // Gomb rejtve
    } else {
      goalsToggleButton.style.display = 'none'; // Gomb rejtve minden m√°s oldalon
    }
  }
}

// ===== √öJ FUNKCI√ì: NAPI C√âLOK V√ÅLT√ÅSA =====
function toggleGoalsDisplay() {
  const goalsCard = document.getElementById('goalsDisplay');
  if (!goalsCard) return;
  
  if (goalsCard.style.display === 'none') {
    goalsCard.style.display = 'block';
  } else {
    goalsCard.style.display = 'none';
  }
}

// =======================================================
// ===== EDZ√âS FUNKCI√ìK (REFACTORED) =====
// =======================================================
async function addWorkout() { // Make async
  const dateInput = document.getElementById("workoutDateInput");
  const selectedDate = dateInput.value; 

  if (!selectedDate) {
    alert("K√©rlek v√°lassz ki egy d√°tumot!");
    return;
  }
  
  if (workouts.find(w => w.date === selectedDate)) {
    alert("Ehhez a naphoz m√°r r√∂gz√≠tett√©l edz√©st!");
    return;
  }
  
  workouts.push({ date: selectedDate, note: "" });
  await saveWorkouts();
  logActivity(`üèãÔ∏è‚Äç‚ôÇÔ∏è Edz√©s r√∂gz√≠tve: ${selectedDate}`);
  renderWorkouts();
  
  dateInput.value = "";
}

function renderWorkouts() {
  const list = document.getElementById("workoutList");
  if (!list) return; 

  workouts.sort((a, b) => b.date.localeCompare(a.date));
  list.innerHTML = "";
  
  if (workouts.length === 0) {
    list.innerHTML = "<p>M√©g nincsenek r√∂gz√≠tett edz√©seid.</p>";
    return;
  }
  
  workouts.forEach((workout, index) => {
    const div = document.createElement("div");
    div.className = "workout-item";
    div.innerHTML = `
      <span onclick="openWorkoutNoteModal(${index})">üèãÔ∏è‚Äç‚ôÇÔ∏è ${workout.date}</span>
      <div>
        <button class="edit-note-btn" onclick="editWorkout(${index})">‚úèÔ∏è</button>
        <button onclick="deleteWorkout(${index})">üóëÔ∏è</button>
      </div>
    `;
    list.appendChild(div);
  });
}

async function deleteWorkout(index) {
  if (!confirm(`Biztosan t√∂rl√∂d az edz√©st err≈ël a napr√≥l: ${workouts[index].date}?`)) {
    return;
  }
  
  const deletedWorkout = workouts.splice(index, 1)[0];
  if (deletedWorkout) {
    await saveWorkouts();
    logActivity(`üóëÔ∏è Edz√©s t√∂r√∂lve: ${deletedWorkout.date}`);
    renderWorkouts();
  }
}

async function saveWorkouts() {
  await saveDataToFirestore();
}

function editWorkout(index) {
  editTarget = { type: 'workout', index: index };
  
  const workoutDate = workouts[index].date;
  document.getElementById("editTitle").textContent = `üèãÔ∏è‚Äç‚ôÇÔ∏è Edz√©sjegyzet (${workoutDate})`;

  document.getElementById("editLabel1").style.display = "none";
  document.getElementById("editInput1").style.display = "none";
  document.getElementById("editLabel2").style.display = "none";
  document.getElementById("editInput2").style.display = "none";
  document.getElementById("editLabel3").style.display = "none";
  document.getElementById("editInput3").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";

  document.getElementById("editLabelText").textContent = "Jegyzet";
  document.getElementById("editLabelText").style.display = "block";
  document.getElementById("editInputText").value = workouts[index].note || "";
  document.getElementById("editInputText").style.display = "block";

  openModal('editModal');
}
// =======================================================


// ===== C√âLBE√ÅLL√çT√ÅS (REFACTORED) =====
async function saveGoalSettings() { // Make async
  const gw = parseFloat(document.getElementById("goalWeightInput").value) || null;
  const gwat = parseFloat(document.getElementById("goalWaterInput").value) || null;
  const gcal = parseFloat(document.getElementById("goalCalInput").value) || null;
  const gprot = parseFloat(document.getElementById("goalProteinInput").value) || null; // √öJ

  // Save to global variables
  goalWeightSetting = gw ? gw.toString() : "";
  goalWaterSetting = gwat ? gwat.toString() : "";
  goalCaloriesSetting = gcal ? gcal.toString() : "";
  goalProteinSetting = gprot ? gprot.toString() : ""; // √öJ

  updateAllSummaries();
  // logActivity will call saveDataToFirestore
  await logActivity(`üéØ C√©lok be√°ll√≠tva: ${gw || "-"}kg, ${gwat || "-"}L, ${gcal || "-"}kcal, ${gprot || "-"}g protein`);
  closeModal('goalSetupModal');
}

function updateAllSummaries() {
  const gw = parseFloat(goalWeightSetting);
  const gwat = parseFloat(goalWaterSetting);
  const gcal = parseFloat(goalCaloriesSetting);
  const gprot = parseFloat(goalProteinSetting); // √öJ
  
  const dp = dailyProgress;

  // --- S√∫ly (Weight) ---
  const goalWeightText = document.getElementById("goalWeightText");
  const weightSummary = document.getElementById("weightSummary");
  if (gw) {
    goalWeightText.textContent = `C√©l s√∫ly: ${gw} kg`;
    if (dp.lastWeight > 0) {
      const diff = dp.lastWeight - gw;
      if (diff > 0) {
        weightSummary.textContent = `M√©g ${diff.toFixed(1)} kg-t kell leadnod.`;
      } else if (diff === 0) {
         weightSummary.textContent = `üéâ El√©rted a c√©ls√∫lyod! Gratul√°lok!`;
      } else {
        weightSummary.textContent = `C√©l t√∫lteljes√≠tve! (${Math.abs(diff).toFixed(1)} kg-al)`;
      }
    } else {
      weightSummary.textContent = "M√©g nem adt√°l meg s√∫lyt.";
    }
  } else {
    goalWeightText.textContent = "C√©l s√∫ly: nincs megadva";
    weightSummary.textContent = "";
  }

  // --- V√≠z (Water) ---
  const goalWaterText = document.getElementById("goalWaterText");
  const waterSummary = document.getElementById("waterSummary");
  const waterBar = document.getElementById("waterProgressBar");
  if (gwat) {
    goalWaterText.textContent = `V√≠z c√©l: ${gwat} L`;
    const rem_water = gwat - dp.water;
    let perc_water = (dp.water / gwat) * 100;
    
    if (rem_water > 0) {
      waterSummary.textContent = `M√©g ${rem_water.toFixed(1)} L hi√°nyzik.`;
    } else {
      waterSummary.textContent = `C√©l teljes√≠tve! (${dp.water.toFixed(1)} L)`;
    }
    if (perc_water > 100) perc_water = 100;
    if (perc_water < 0) perc_water = 0;
    waterBar.style.width = perc_water + '%';
  } else {
    goalWaterText.textContent = "V√≠z c√©l: nincs megadva";
    waterSummary.textContent = "Nincs napi c√©l be√°ll√≠tva.";
    waterBar.style.width = '0%';
  }

  // --- Kal√≥ria (Calories) ---
  const goalCalText = document.getElementById("goalCalText");
  const calSummary = document.getElementById("calSummary");
  const calBar = document.getElementById("calProgressBar");
  if (gcal) {
    goalCalText.textContent = `Kal√≥ria c√©l: ${gcal} kcal`;
    const rem_cal = gcal - dp.calories;
    let perc_cal = (dp.calories / gcal) * 100;
    
    if (rem_cal > 0) {
      calSummary.textContent = `M√©g ${rem_cal.toFixed(0)} kcal van h√°tra.`;
    } else {
      calSummary.textContent = `C√©l el√©rve! (${dp.calories.toFixed(0)} kcal)`;
    }
    if (perc_cal > 100) perc_cal = 100;
    if (perc_cal < 0) perc_cal = 0;
    calBar.style.width = perc_cal + '%';
  } else {
    goalCalText.textContent = "Kal√≥ria c√©l: nincs megadva";
    calSummary.textContent = "Nincs napi c√©l be√°ll√≠tva.";
    calBar.style.width = '0%';
  }
  
  // --- √öJ: PROTEIN ---
  const goalProteinText = document.getElementById("goalProteinText");
  const proteinSummary = document.getElementById("proteinSummary");
  const proteinBar = document.getElementById("proteinProgressBar");
  if (gprot) {
    goalProteinText.textContent = `Protein c√©l: ${gprot} g`;
    const rem_prot = gprot - dp.protein;
    let perc_prot = (dp.protein / gprot) * 100;
    
    if (rem_prot > 0) {
      proteinSummary.textContent = `M√©g ${rem_prot.toFixed(0)} g hi√°nyzik.`;
    } else {
      proteinSummary.textContent = `C√©l teljes√≠tve! (${dp.protein.toFixed(0)} g)`;
    }
    if (perc_prot > 100) perc_prot = 100;
    if (perc_prot < 0) perc_prot = 0;
    proteinBar.style.width = perc_prot + '%';
  } else {
    goalProteinText.textContent = "Protein c√©l: nincs megadva";
    proteinSummary.textContent = "Nincs napi c√©l be√°ll√≠tva.";
    proteinBar.style.width = '0%';
  }
}


// =======================================================
// ===== ADATBEVITEL √âS T√ñRL√âS (REFACTORED) =====
// =======================================================
async function addTransaction(type) { // Make async
  let inputElem, value, logText;
  
  if (type === 'weight') {
    inputElem = document.getElementById("weightInput");
    value = parseFloat(inputElem.value);
    if (!value || value <= 0) return alert("√ârv√©nytelen s√∫ly!");
    logText = `‚öñÔ∏è S√∫ly r√∂gz√≠tve: ${value}kg`;
    dailyProgress.lastWeight = value;
  }
  else if (type === 'water') {
    inputElem = document.getElementById("waterInput");
    value = parseFloat(inputElem.value);
    if (!value || value < 0) return;
    logText = `üíß V√≠z hozz√°adva: ${value}L`;
    dailyProgress.water += value;
  }
  else if (type === 'calories') {
    inputElem = document.getElementById("calInput");
    value = parseFloat(inputElem.value);
    if (!value || value < 0) return;
    logText = `üî• Kal√≥ria hozz√°adva: ${value}kcal`;
    dailyProgress.calories += value;
  }
  else if (type === 'protein') { // √öJ
    inputElem = document.getElementById("proteinInput");
    value = parseFloat(inputElem.value);
    if (!value || value < 0) return;
    logText = `ü•© Protein hozz√°adva: ${value}g`;
    dailyProgress.protein += value;
  }
  else {
    return;
  }
  
  const transaction = {
    id: Date.now(),
    type: type,
    value: value,
    date: new Date()
  };
  transactions.push(transaction);
  await logActivity(logText);
  
  updateAllSummaries();
  updateHistory();
  if (type === 'weight') {
    if (document.getElementById('chartModal').style.display === 'flex') {
        updateChart();
    }
  }
  
  inputElem.value = "";
}

async function deleteTransaction(index) { // Make async
  if (!confirm("Biztosan t√∂rl√∂d ezt a bejegyz√©st?")) {
    return;
  }
  
  const entry = transactions.splice(index, 1)[0];
  await logActivity(`üóëÔ∏è Bejegyz√©s t√∂r√∂lve: ${entry.type} (${entry.value || entry.name})`);
  
  // √öjrasz√°moljuk az eg√©szet
  calculateDailyProgress();
  updateAllSummaries();
  updateHistory();
  if (document.getElementById('chartModal').style.display === 'flex') {
    updateChart();
  }
}


// =======================================================
// ===== JEGYZETEK FUNKCI√ìK (REFACTORED) =====
// =======================================================
async function addNote() { // Make async
  const title = document.getElementById("noteTitleInput").value.trim();
  const text = document.getElementById("noteTextInput").value.trim();
  
  if (!title || !text) return alert("K√©rlek adj meg egy c√≠met √©s sz√∂veget is!");
  
  const note = { 
    title, 
    text, 
    date: new Date()
  };
  notes.unshift(note);
  
  document.getElementById("noteTitleInput").value = "";
  document.getElementById("noteTextInput").value = "";
  
  renderNotes();
  await logActivity("üìù Jegyzet hozz√°adva");
}

function renderNotes() {
  const container = document.getElementById("notesList");
  container.innerHTML = "";
  if (notes.length === 0) {
    container.innerHTML = "<p>M√©g nincsenek mentett jegyzeteid.</p>";
    return;
  }
  
  notes.forEach((n, i) => {
    let displayDate = "...";
    if (n.date) {
      if (typeof n.date.toDate === 'function') {
        displayDate = n.date.toDate().toLocaleString().split(',')[0];
      } else {
        displayDate = new Date(n.date).toLocaleString().split(',')[0];
      }
    }

    const div = document.createElement("div");
    div.className = "note-summary-item";
    div.innerHTML = `
      <div>
        <span class="note-summary-title" onclick="openNoteModal(${i})">${n.title}</span>
        <span class="note-summary-date">${displayDate}</span>
      </div>
      <div class="note-summary-actions">
        <button onclick='editNote(${i})'>‚úèÔ∏è</button>
        <button onclick='deleteNote(${i})'>üóëÔ∏è</button>
      </div>`;
    container.appendChild(div);
  });
}

async function deleteNote(i) { // Make async
  if (!confirm(`Biztosan t√∂rl√∂d ezt a jegyzetet: "${notes[i].title}"?`)) {
    return;
  }
  const deletedTitle = notes[i].title;
  notes.splice(i, 1);
  renderNotes();
  await logActivity(`üóëÔ∏è Jegyzet t√∂r√∂lve: ${deletedTitle}`);
}

function openNoteModal(i) {
  const note = notes[i];
  document.getElementById("noteViewTitle").textContent = note.title;
  document.getElementById("noteViewText").textContent = note.text;
  openModal('noteViewModal');
}

function openWorkoutNoteModal(index) {
  const workout = workouts[index];
  document.getElementById("noteViewTitle").textContent = `Edz√©sjegyzet: ${workout.date}`;
  document.getElementById("noteViewText").textContent = workout.note || "Ehhez az edz√©shez nem tartozik jegyzet.";
  openModal('noteViewModal');
}

function editNote(i) {
  editTarget = { type: 'note', index: i };
  
  document.getElementById("editTitle").textContent = "üìù Jegyzet szerkeszt√©se";
  document.getElementById("editLabel1").textContent = "C√≠m";
  document.getElementById("editInput1").value = notes[i].title;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabelText").style.display = "block";
  document.getElementById("editInputText").value = notes[i].text;
  document.getElementById("editInputText").style.display = "block";
  
  document.getElementById("editLabel2").style.display = "none";
  document.getElementById("editInput2").style.display = "none";
  document.getElementById("editLabel3").style.display = "none";
  document.getElementById("editInput3").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";

  openModal('editModal');
}
// =======================================================


// =======================================================
// ===== C√âLOK (REFACTORED) =====
// =======================================================
async function saveGoal() { // Make async
  const name = document.getElementById("goalNameInput").value.trim();
  const points = parseInt(document.getElementById("goalPointsInput").value);
  const category = document.getElementById("goalCategoryInput").value.trim();
  
  if (!name) return alert("A c√©lnak nevet kell adni!");
  if (isNaN(points) || points < 0) return alert("√ârv√©nytelen pontsz√°m! Adj meg 0-t vagy nagyobbat.");
  
  // √öJ: Alc√©lok beolvas√°sa
  const subGoalsText = document.getElementById("goalSubGoalsInput").value;
  let subGoals = [];
  if (subGoalsText.trim() !== "") {
    subGoals = subGoalsText.split('\n')
      .map(text => text.trim())
      .filter(text => text.length > 0)
      .map(text => ({ text: text, done: false }));
  }
  
  goals.push({ name, points, done: false, category: category, subGoals: subGoals });
  
  document.getElementById("goalNameInput").value = "";
  document.getElementById("goalPointsInput").value = "";
  document.getElementById("goalCategoryInput").value = "";
  document.getElementById("goalSubGoalsInput").value = ""; // Textarea √ºr√≠t√©se
  
  closeModal('goalModal');
  renderGoals();
  await logActivity(`üéØ C√©l hozz√°adva: ${name} (${points} pont)`);
}

async function toggleGoal(i) { // Make async
  if (i < 0 || i >= goals.length) {
      console.error("Invalid index for toggleGoal:", i);
      return;
  }
  // √öJ: Ellen≈ërz√©s, hogy van-e alc√©l. Ha igen, ez a funkci√≥ nem futhat.
  if (goals[i].subGoals && goals[i].subGoals.length > 0) {
    console.warn("toggleGoal called on a goal with sub-goals. This shouldn't happen.");
    return; 
  }
  
  goals[i].done = !goals[i].done;
  if (goals[i].done) {
    totalPoints += goals[i].points;
    await logActivity(`‚úÖ C√©l teljes√≠tve: ${goals[i].name} (+${goals[i].points} pont)`);
  } else {
    totalPoints -= goals[i].points;
    await logActivity(`‚ùå C√©l visszavonva: ${goals[i].name} (-${goals[i].points} pont)`);
  }
  animatePoints(totalPoints);
  await saveDataToFirestore(); 
  renderGoals();
}

// ===== √öJ FUNKCI√ì: ALC√âL KIPIP√ÅL√ÅSA =====
async function toggleSubGoal(goalIndex, subGoalIndex) {
  const goal = goals[goalIndex];
  if (!goal || !goal.subGoals || !goal.subGoals[subGoalIndex]) {
    console.error("Invalid sub-goal toggle.", goalIndex, subGoalIndex);
    return;
  }
  
  const wasMainGoalDone = goal.done;
  
  // 1. Alc√©l √°llapot√°nak v√°lt√°sa
  goal.subGoals[subGoalIndex].done = !goal.subGoals[subGoalIndex].done;
  
  // 2. Ellen≈ërz√©s, hogy az √∂sszes alc√©l k√©sz van-e
  const allDone = goal.subGoals.length > 0 && goal.subGoals.every(sg => sg.done);
  
  // 3. F≈ë c√©l √°llapot√°nak √©s pontoknak friss√≠t√©se
  if (allDone && !wasMainGoalDone) {
    // √âpp most lett k√©sz
    goal.done = true;
    totalPoints += goal.points;
    animatePoints(totalPoints);
    await logActivity(`‚úÖ C√©l teljes√≠tve: ${goal.name} (+${goal.points} pont)`);
  } else if (!allDone && wasMainGoalDone) {
    // √âpp most lett visszavonva
    goal.done = false;
    totalPoints -= goal.points;
    animatePoints(totalPoints);
    await logActivity(`‚ùå C√©l visszavonva: ${goal.name} (-${goal.points} pont)`);
  } else {
    // A f≈ë c√©l √°llapota nem v√°ltozott, csak az alc√©l√©
    await saveDataToFirestore();
  }
  
  // 4. F≈ë c√©l lista √∫jra-rajzol√°sa (hogy a pipa megjelenjen/elt≈±nj√∂n)
  renderGoals();
}


function editGoal(i) {
  editTarget = { type: 'goal', index: i };
  document.getElementById("editTitle").textContent = "üéØ C√©l szerkeszt√©se";
  
  document.getElementById("editLabel1").textContent = "C√©l neve";
  document.getElementById("editInput1").value = goals[i].name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont √©rt√©k";
  document.getElementById("editInput2").value = goals[i].points;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";
  
  document.getElementById("editLabel3").textContent = "Kateg√≥ria (opcion√°lis)";
  document.getElementById("editInput3").value = goals[i].category || "";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editInput3").style.display = "block";
  
  // √öJ: Alc√©lok bet√∂lt√©se a szerkeszt≈ëbe
  const subGoalsText = (goals[i].subGoals || [])
    .map(sg => sg.text)
    .join('\n');
  document.getElementById("editLabelSubGoals").style.display = "block";
  document.getElementById("editInputSubGoals").value = subGoalsText;
  document.getElementById("editInputSubGoals").style.display = "block";

  // M√°s mez≈ëk elrejt√©se
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";

  openModal('editModal');
}

async function deleteGoal(i) { // Make async
  if (i < 0 || i >= goals.length) {
      console.error("Invalid index for deleteGoal:", i);
      return;
  }
  const goalToDelete = goals[i]; 

  if (goalToDelete.done) {
    totalPoints -= goalToDelete.points;
    animatePoints(totalPoints);
  }

  goals.splice(i, 1);
  renderGoals();
  await logActivity(`üóëÔ∏è C√©l t√∂r√∂lve: ${goalToDelete ? goalToDelete.name : 'ismeretlen c√©l'}`);
}


function renderGoals() {
  const list = document.getElementById("goalList");
  list.innerHTML = "";

  const categorized = {};
  const uncategorized = [];

  goals.forEach((goal, i) => {
    const item = { ...goal, originalIndex: i };

    if (item.category) {
      if (!categorized[item.category]) {
        categorized[item.category] = [];
      }
      categorized[item.category].push(item);
    } else {
      uncategorized.push(item);
    }
  });

  const renderItem = (g, i) => {
    const div = document.createElement("div");
    div.className = "goal-item" + (g.done ? " completed" : "");
    
    // ===== ALC√âL LOGIKA KEZDETE =====
    let subGoalsHTML = "";
    let hasSubGoals = g.subGoals && g.subGoals.length > 0;
    
    if (hasSubGoals) {
      subGoalsHTML = '<div class="subgoal-list">';
      g.subGoals.forEach((sg, subIndex) => {
        subGoalsHTML += `
          <div>
            <input type="checkbox" onchange="toggleSubGoal(${i}, ${subIndex})" ${sg.done ? 'checked' : ''}>
            <span class="${sg.done ? 'subgoal-done' : ''}">${sg.text}</span>
          </div>
        `;
      });
      subGoalsHTML += '</div>';
    }
    // ===== ALC√âL LOGIKA V√âGE =====
    
    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${g.name}</div>
        ${subGoalsHTML}
      </div>
      <div class="item-points">
        ${g.points} pont
      </div>
      <div class="item-actions">
        <button onclick="editGoal(${i})" title="Szerkeszt√©s">‚úèÔ∏è</button>
        <button onclick="deleteGoal(${i})" title="T√∂rl√©s">üóëÔ∏è</button>
        ${!hasSubGoals ? (g.done 
            ? `<button onclick="toggleGoal(${i})" title="Visszavon√°s">‚ùå</button>
               <button class="archive-btn" title="Archiv√°l√°s" onclick="archiveGoal(${i})">üì•</button>` 
            : `<button onclick="toggleGoal(${i})" title="Teljes√≠t">‚úÖ</button>`)
          : (g.done ? `<button class="archive-btn" title="Archiv√°l√°s" onclick="archiveGoal(${i})">üì•</button>` : '')
        }
      </div>
    `;
    list.appendChild(div);
  };

  const categoryNames = Object.keys(categorized).sort();
  categoryNames.forEach(categoryName => {
    const title = document.createElement("h3");
    title.className = "category-title";
    title.textContent = categoryName;
    list.appendChild(title);

    categorized[categoryName].forEach(item => {
      renderItem(item, item.originalIndex);
    });
  });

  if (uncategorized.length > 0) {
    if (categoryNames.length > 0) {
      const title = document.createElement("h3");
      title.className = "category-title";
      title.textContent = "Egy√©b";
      list.appendChild(title);
    }
    uncategorized.forEach(item => {
      renderItem(item, item.originalIndex);
    });
  }
}

// =======================================================
// ===== ARCH√çVUM FUNKCI√ìK =====
// =======================================================
function openArchiveModal() {
  renderArchivedGoals();
  openModal('archiveModal');
}

async function archiveGoal(index) {
  const goalToArchive = goals.splice(index, 1)[0];
  
  if (goalToArchive) {
    archivedGoals.unshift(goalToArchive);
    renderGoals();
    await logActivity(`üì• C√©l archiv√°lva: ${goalToArchive.name}`); 
  }
}

function renderArchivedGoals() {
  const list = document.getElementById("archivedGoalList");
  list.innerHTML = "";

  if (archivedGoals.length === 0) {
    list.innerHTML = "<p style='text-align: center; padding: 10px;'>Nincsenek archiv√°lt c√©lok.</p>";
    return;
  }

  archivedGoals.forEach((goal, index) => {
    const div = document.createElement("div");
    div.className = "goal-item completed";
    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${goal.name}</div>
      </div>
      <div class="item-points">
        ${goal.points} pont
      </div>
      <div class="item-actions">
        <button class="reactivate-btn" title="Vissza√°ll√≠t√°s" onclick="reactivateGoal(${index})">‚ôªÔ∏è</button>
        <button class="delete-btn" title="V√©gleges t√∂rl√©s" onclick="deleteArchivedGoal(${index})">üóëÔ∏è</button>
      </div>
    `;
    list.appendChild(div);
  });
}

async function reactivateGoal(index) {
  const goalToReactivate = archivedGoals.splice(index, 1)[0];
  
  if (goalToReactivate) {
    goalToReactivate.done = false;
    
    // √öJ: Alc√©lok "kipip√°latlan√≠t√°sa"
    if (goalToReactivate.subGoals && goalToReactivate.subGoals.length > 0) {
      goalToReactivate.subGoals.forEach(sg => {
        sg.done = false;
      });
    }
    
    goals.push(goalToReactivate);
    
    renderGoals();
    renderArchivedGoals();
    await logActivity(`‚ôªÔ∏è C√©l vissza√°ll√≠tva: ${goalToReactivate.name}`);
  }
}

async function deleteArchivedGoal(index) {
  if (confirm("Biztosan v√©gleg t√∂rl√∂d ezt az archiv√°lt c√©lt? Ez nem vonhat√≥ vissza.")) {
    const deletedGoal = archivedGoals.splice(index, 1)[0];
    
    if (deletedGoal) {
      if (deletedGoal.points > 0) {
          totalPoints -= deletedGoal.points;
          animatePoints(totalPoints);
      }
      renderArchivedGoals();
      await logActivity(`üóëÔ∏è Archiv√°lt c√©l t√∂r√∂lve: ${deletedGoal.name} (-${deletedGoal.points} pont)`);
    }
  }
}
// =======================================================


// =======================================================
// ===== JUTALMAK (REFACTORED) =====
// =======================================================
async function saveReward() { // Make async
  const name = document.getElementById("rewardNameInput").value.trim();
  const cost = parseInt(document.getElementById("rewardCostInput").value);
  if (!name || isNaN(cost) || cost <= 0) return alert("√ârv√©nytelen n√©v vagy pontsz√°m!");

  rewards.push({ name, cost });
  document.getElementById("rewardNameInput").value = "";
  document.getElementById("rewardCostInput").value = "";
  closeModal('rewardModal');
  renderRewards();
  await logActivity(`üéÅ Jutalom hozz√°adva: ${name} (${cost} pont)`);
}

async function claimReward(i) { // Make async
  if (totalPoints >= rewards[i].cost) {
    if (confirm(`Biztosan kiv√°ltod ezt: "${rewards[i].name}" (${rewards[i].cost} pont√©rt)?`)) {
      totalPoints -= rewards[i].cost;
      animatePoints(totalPoints);
      renderRewards();
      await logActivity(`üéâ Jutalom kiv√°ltva: ${rewards[i].name} (-${rewards[i].cost} pont)`);
    }
  } else {
    alert("Nincs el√©g pontod!");
  }
}

function editReward(i) {
  editTarget = { type: 'reward', index: i };
  document.getElementById("editTitle").textContent = "üéÅ Jutalom szerkeszt√©se";

  document.getElementById("editLabel1").textContent = "Jutalom neve";
  document.getElementById("editInput1").value = rewards[i].name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  document.getElementById("editLabel2").textContent = "Pont √°ra";
  document.getElementById("editInput2").value = rewards[i].cost;
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";

  document.getElementById("editLabel3").style.display = "none";
  document.getElementById("editInput3").style.display = "none";
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";

  openModal('editModal');
}

async function deleteReward(i) { // Make async
  const deletedName = rewards[i].name;
  rewards.splice(i, 1);
  renderRewards();
  await logActivity(`üóëÔ∏è Jutalom t√∂r√∂lve: ${deletedName}`);
}

function renderRewards() {
  const list = document.getElementById("rewardList");
  list.innerHTML = "";
  rewards.forEach((r, i) => {
    const div = document.createElement("div");
    div.className = "reward-item";

    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${r.name}</div>
      </div>
      <div class="item-points">
        ${r.cost} pont
      </div>
      <div class="item-actions">
        <button onclick="editReward(${i})">‚úèÔ∏è</button>
        <button onclick="deleteReward(${i})">üóëÔ∏è</button>
        <button onclick="claimReward(${i})">üéâ</button>
      </div>
    `;
    list.appendChild(div);
  });
}

// =======================================================
// ===== √öJ √âTKEZ√âS FUNKCI√ìK =====
// =======================================================

// A modal c√≠mk√©inek friss√≠t√©se a t√≠pusv√°laszt√≥ alapj√°n
function updateMealModalLabels() {
  const type = document.getElementById("mealTypeSelect").value;
  const kcalLabel = document.getElementById("mealKcalLabel");
  const proteinLabel = document.getElementById("mealProteinLabel");
  
  if (type === 'unit') {
    kcalLabel.textContent = "Kal√≥ria (kcal/darab)";
    proteinLabel.textContent = "Feh√©rje (g/darab)";
  } else { // weight
    kcalLabel.textContent = "Kal√≥ria (kcal/100g)";
    proteinLabel.textContent = "Feh√©rje (g/100g)";
  }
}

// √öj √©tel ment√©se
async function saveMeal() {
  const name = document.getElementById("mealNameInput").value.trim();
  const type = document.getElementById("mealTypeSelect").value;
  const kcal = parseFloat(document.getElementById("mealKcalInput").value);
  const protein = parseFloat(document.getElementById("mealProteinInput").value);
  
  if (!name) return alert("Az √©telnek nevet kell adni!");
  if (isNaN(kcal) || kcal < 0) return alert("√ârv√©nytelen kal√≥ria √©rt√©k!");
  if (isNaN(protein) || protein < 0) return alert("√ârv√©nytelen feh√©rje √©rt√©k!");
  
  const meal = { name, type, kcal, protein };
  
  meals.push(meal);
  
  document.getElementById("mealNameInput").value = "";
  document.getElementById("mealTypeSelect").value = "unit";
  document.getElementById("mealKcalInput").value = "";
  document.getElementById("mealProteinInput").value = "";
  
  closeModal('mealModal');
  renderMeals();
  await logActivity(`üçΩÔ∏è √öj √©tel mentve: ${name}`);
}

// √âtelek list√°j√°nak kirajzol√°sa
function renderMeals() {
  const list = document.getElementById("mealList");
  list.innerHTML = "";
  
  if (meals.length === 0) {
    list.innerHTML = "<p style='text-align:center; padding: 10px;'>M√©g nincsenek mentett √©teleid. Adj hozz√° egyet!</p>";
    return;
  }
  
  meals.forEach((meal, i) => {
    const div = document.createElement("div");
    div.className = "food-item"; // √öj CSS oszt√°ly
    
    let detailsText = "";
    if (meal.type === 'unit') {
      detailsText = `<span>${meal.kcal} kcal/db</span><span>${meal.protein}g prot./db</span>`;
    } else {
      detailsText = `<span>${meal.kcal} kcal/100g</span><span>${meal.protein}g prot./100g</span>`;
    }
    
    div.innerHTML = `
      <div class="item-name">
        <div class="item-name-main">${meal.name}</div>
      </div>
      <div class="item-details">
        ${detailsText}
      </div>
      <div class="item-actions">
        <button onclick="editMeal(${i})" title="Szerkeszt√©s">‚úèÔ∏è</button>
        <button onclick="deleteMeal(${i})" title="T√∂rl√©s">üóëÔ∏è</button>
        <button onclick="openConsumeModal(${i})" title="Fogyaszt√°s">üçΩÔ∏è</button>
      </div>
    `;
    list.appendChild(div);
  });
}

// √âtel szerkeszt√©se (megnyitja a szerkeszt≈ë modalt)
function editMeal(i) {
  editTarget = { type: 'meal', index: i };
  const meal = meals[i];
  
  document.getElementById("editTitle").textContent = "üçΩÔ∏è √âtel szerkeszt√©se";

  // Alap mez≈ëk (√°tnevezve)
  document.getElementById("editLabel1").textContent = "√âtel neve";
  document.getElementById("editInput1").value = meal.name;
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel1").style.display = "block";

  // Elrejtj√ºk a t√∂bbi alap mez≈ët
  document.getElementById("editLabel2").style.display = "none";
  document.getElementById("editInput2").style.display = "none";
  document.getElementById("editLabel3").style.display = "none";
  document.getElementById("editInput3").style.display = "none";
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
  
  // Megjelen√≠tj√ºk az √©tel-specifikus mez≈ëket
  document.getElementById("editMealFields").style.display = "block";
  document.getElementById("editMealType").value = meal.type;
  document.getElementById("editMealKcal").value = meal.kcal;
  document.getElementById("editMealProtein").value = meal.protein;

  openModal('editModal');
}

// √âtel t√∂rl√©se
async function deleteMeal(i) {
  if (confirm(`Biztosan t√∂rl√∂d ezt az √©telt: "${meals[i].name}"?`)) {
    const deletedName = meals[i].name;
    meals.splice(i, 1);
    renderMeals();
    await logActivity(`üóëÔ∏è √âtel t√∂r√∂lve: ${deletedName}`);
  }
}

// Fogyaszt√°s ablak megnyit√°sa
function openConsumeModal(i) {
  editTarget = { type: 'consume', index: i };
  const meal = meals[i];
  
  document.getElementById("consumeMealTitle").textContent = meal.name;
  
  const amountLabel = document.getElementById("consumeAmountLabel");
  const amountInput = document.getElementById("consumeAmountInput");
  
  if (meal.type === 'unit') {
    amountLabel.textContent = "Mennyis√©g (Darab)";
    amountInput.placeholder = "pl. 2";
    document.getElementById("consumeMealDetails").textContent = `${meal.kcal} kcal, ${meal.protein}g protein / darab`;
  } else {
    amountLabel.textContent = "Mennyis√©g (Gramm)";
    amountInput.placeholder = "pl. 150";
    document.getElementById("consumeMealDetails").textContent = `${meal.kcal} kcal, ${meal.protein}g protein / 100g`;
  }
  
  amountInput.value = "";
  openModal('consumeModal');
}

// Fogyaszt√°s meger≈ës√≠t√©se
async function confirmConsume() {
  const amount = parseFloat(document.getElementById("consumeAmountInput").value);
  if (!amount || amount <= 0) return alert("√ârv√©nytelen mennyis√©g!");
  
  const meal = meals[editTarget.index];
  
  let totalKcal = 0;
  let totalProtein = 0;
  let unitLabel = "";
  
  if (meal.type === 'unit') {
    totalKcal = meal.kcal * amount;
    totalProtein = meal.protein * amount;
    unitLabel = "db";
  } else { // weight
    totalKcal = (meal.kcal / 100) * amount;
    totalProtein = (meal.protein / 100) * amount;
    unitLabel = "g";
  }
  
  // √öj tranzakci√≥ l√©trehoz√°sa
  const transaction = {
    id: Date.now(),
    type: 'meal',
    name: meal.name,
    amount: amount,
    unit: unitLabel,
    totalKcal: totalKcal,
    totalProtein: totalProtein,
    date: new Date()
  };
  transactions.push(transaction);
  
  // Azonnali friss√≠t√©s
  dailyProgress.calories += totalKcal;
  dailyProgress.protein += totalProtein;
  
  updateAllSummaries();
  updateHistory();
  await logActivity(`üçΩÔ∏è Fogyasztva: ${amount} ${unitLabel} ${meal.name} (+${totalKcal.toFixed(0)} kcal, +${totalProtein.toFixed(0)}g prot.)`);
  
  closeModal('consumeModal');
}


// =======================================================
// ===== KIB≈êV√çTETT SZERKESZT√âS FUNKCI√ì (REFACTORED) =====
// =======================================================
async function confirmEdit() { // Make async
  const v1 = document.getElementById("editInput1").value; // C√≠m / N√©v

  if (!editTarget) return;

  if (editTarget.type === 'goal') {
    const v2 = parseInt(document.getElementById("editInput2").value); // Pont
    const v3 = document.getElementById("editInput3").value.trim(); // Kateg√≥ria

    if (!v1) return alert("A c√©lnak nevet kell adni!");
    if (isNaN(v2) || v2 < 0) return alert("√ârv√©nytelen pontsz√°m! Adj meg 0-t vagy nagyobbat.");

    if(goals[editTarget.index].done) {
        let diff = v2 - goals[editTarget.index].points;
        totalPoints += diff;
        animatePoints(totalPoints);
    }
    goals[editTarget.index].name = v1;
    goals[editTarget.index].points = v2;
    goals[editTarget.index].category = v3;
    
    // √öJ: Alc√©lok friss√≠t√©se
    const newSubGoalsText = document.getElementById("editInputSubGoals").value;
    const oldSubGoals = goals[editTarget.index].subGoals || [];
    let newSubGoals = [];

    if (newSubGoalsText.trim() !== "") {
      newSubGoals = newSubGoalsText.split('\n')
        .map(text => text.trim())
        .filter(text => text.length > 0)
        .map(text => {
          // Meg≈ërizz√ºk a 'done' st√°tuszt, ha a sz√∂veg ugyanaz
          const existing = oldSubGoals.find(sg => sg.text === text);
          return existing ? existing : { text: text, done: false };
        });
    }
    
    goals[editTarget.index].subGoals = newSubGoals;
    
    // √öJ: √Ållapot √∫jrasz√°mol√°sa szerkeszt√©s ut√°n
    const goal = goals[editTarget.index];
    const wasMainGoalDone = goal.done;
    const allDone = newSubGoals.length > 0 && newSubGoals.every(sg => sg.done);

    if (allDone && !wasMainGoalDone) {
      goal.done = true;
      totalPoints += goal.points;
      animatePoints(totalPoints);
      // Itt nem kell logolni, mert a saveDataToFirestore ment, √©s a pontokat m√°r kezelt√ºk
    } else if (!allDone && wasMainGoalDone) {
      goal.done = false;
      totalPoints -= goal.points;
      animatePoints(totalPoints);
      // Itt sem kell logolni
    }
    
    renderGoals();
    await logActivity(`‚úèÔ∏è C√©l szerkesztve: ${v1}`);
  }
  else if (editTarget.type === 'reward') {
    const v2 = parseInt(document.getElementById("editInput2").value); // √År

    if (!v1) return alert("A jutalomnak nevet kell adni!");
    if (isNaN(v2) || v2 <= 0) return alert("√ârv√©nytelen pont √°r! Nagyobbnak kell lennie 0-n√°l.");

    rewards[editTarget.index].name = v1;
    rewards[editTarget.index].cost = v2;
    renderRewards();
    await logActivity(`‚úèÔ∏è Jutalom szerkesztve: ${v1}`);
  }
  else if (editTarget.type === 'note') {
    const vText = document.getElementById("editInputText").value.trim();
    if (!v1 || !vText) return alert("A c√≠m √©s a sz√∂veg nem lehet √ºres!");

    notes[editTarget.index].title = v1;
    notes[editTarget.index].text = vText;
    notes[editTarget.index].date = new Date();
    renderNotes();
    await logActivity(`‚úèÔ∏è Jegyzet szerkesztve: ${v1}`);
  }
  else if (editTarget.type === 'workout') {
    const vText = document.getElementById("editInputText").value.trim();
    workouts[editTarget.index].note = vText;
    await logActivity(`‚úèÔ∏è Edz√©sjegyzet mentve: ${workouts[editTarget.index].date}`);
  }
  // √öJ: √âTEL SZERKESZT√âS√âNEK MENT√âSE
  else if (editTarget.type === 'meal') {
    const name = v1;
    const type = document.getElementById("editMealType").value;
    const kcal = parseFloat(document.getElementById("editMealKcal").value);
    const protein = parseFloat(document.getElementById("editMealProtein").value);

    if (!name) return alert("Az √©telnek nevet kell adni!");
    if (isNaN(kcal) || kcal < 0) return alert("√ârv√©nytelen kal√≥ria √©rt√©k!");
    if (isNaN(protein) || protein < 0) return alert("√ârv√©nytelen feh√©rje √©rt√©k!");
    
    meals[editTarget.index] = { name, type, kcal, protein };
    renderMeals();
    await logActivity(`‚úèÔ∏è √âtel szerkesztve: ${name}`);
  }

  closeModal('editModal');
  // Vissza√°ll√≠tjuk az editModal mez≈ëit alaphelyzetbe
  document.getElementById("editLabel1").style.display = "block";
  document.getElementById("editInput1").style.display = "block";
  document.getElementById("editLabel2").style.display = "block";
  document.getElementById("editInput2").style.display = "block";
  document.getElementById("editLabel3").style.display = "block";
  document.getElementById("editInput3").style.display = "block";
  document.getElementById("editLabelText").style.display = "none";
  document.getElementById("editInputText").style.display = "none";
  document.getElementById("editMealFields").style.display = "none";
  document.getElementById("editLabelSubGoals").style.display = "none";
  document.getElementById("editInputSubGoals").style.display = "none";
}

// ===== NAPL√ì (REFACTORED) =====
async function logActivity(text) { // Make async
  const time = new Date();
  const entry = { time, text };
  
  if (!Array.isArray(logs)) {
    console.error("Logs is not an array, resetting.");
    logs = [];
  }

  logs.unshift(entry);
  if (logs.length > 100) logs.pop();
  renderLogs();
  
  await saveDataToFirestore();
}

function renderLogs() {
  const logDiv = document.getElementById("activityLog");
  logDiv.innerHTML = "";
  logs.forEach((l, i) => {
    let displayTime = "...";
    if (l.time) {
      if (typeof l.time.toDate === 'function') {
        displayTime = l.time.toDate().toLocaleString();
      } else {
        displayTime = new Date(l.time).toLocaleString();
      }
    }

    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `
      <span>${l.text}</span>
      <small>${displayTime}</small>
      <button style="background:none;color:#c00" onclick="deleteLog(${i})">üóëÔ∏è</button>
    `;
    logDiv.appendChild(div);
  });
}

async function deleteLog(i) { // Make async
  logs.splice(i, 1);
  renderLogs();
  await saveDataToFirestore();
}

async function clearAllLogs() { // Make async
  if (confirm("Biztos t√∂rl√∂d az √∂sszes napl√≥bejegyz√©st?")) {
    logs = [];
    renderLogs();
    await saveDataToFirestore();
  }
}

// =======================================================
// ===== GRAFIKON (REFACTORED) =====
// =======================================================
function updateChart() {
  const ctx = document.getElementById("progressChart");
  if (!ctx) return;

  const weightEntries = transactions.filter(t => t.type === 'weight');
  const weights = weightEntries.map(e => e.value);
  const labels = weightEntries.map(e => {
    if (e.date) {
      if (typeof e.date.toDate === 'function') {
        return e.date.toDate().toLocaleDateString();
      } else {
        return new Date(e.date).toLocaleDateString();
      }
    }
    return "?";
  });

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "S√∫ly (kg)",
        data: weights,
        borderWidth: 3,
        borderColor: "#00796b",
        tension: 0.3,
        spanGaps: true
      }]
    },
    options: {
      scales: { y: { beginAtZero: false } }
    }
  });
}

// ===== NAPI MOTIV√ÅCI√ì =====
function loadMotivation() {
  const tateTips = [
    "Ne v√°rj kedvre ‚Äì csak a gyeng√©k v√°rnak r√°. Tedd, amit kell.",
    "Ha a tested tiltakozik, az elm√©d parancsoljon neki.",
    "A fegyelem legy≈ëzi a lustas√°got minden nap.",
    "Minden korty v√≠z egy l√©p√©s az uralkod√°s fel√©.",
    "A f√©rfi, aki nem kontroll√°lja az √©tv√°gy√°t, nem uralja az √©let√©t."
  ];
  const day = new Date().getDate();
  document.getElementById("motivationBar").innerText = `Tipp: ‚Äû${tateTips[day % tateTips.length]}‚Äù`;
}

// ===== HALAD√ÅS T√ñRT√âNET =====
function updateHistory() {
  const div = document.getElementById("historyList");
  div.innerHTML = "";

  if (transactions.length === 0) {
    div.innerHTML = "<p>M√©g nincsenek adatbejegyz√©sek.</p>";
    return;
  }

  transactions.slice().reverse().forEach((t, i) => {
    const originalIndex = transactions.length - 1 - i;
    const item = document.createElement("div");
    item.className = "log-entry";

    let text = "";
    if (t.type === 'weight') {
      text = `‚öñÔ∏è S√∫ly: <b>${t.value} kg</b>`;
    } else if (t.type === 'water') {
      text = `üíß V√≠z: <b>${t.value} L</b>`;
    } else if (t.type === 'calories') {
      text = `üî• Kal√≥ria: <b>${t.value} kcal</b>`;
    } else if (t.type === 'protein') { // √öJ
      text = `ü•© Protein: <b>${t.value} g</b>`;
    } else if (t.type === 'meal') { // √öJ
      text = `üçΩÔ∏è √âtkez√©s: <b>${t.name}</b> (${t.amount} ${t.unit}) - <b>${t.totalKcal.toFixed(0)} kcal</b>, <b>${t.totalProtein.toFixed(0)}g</b> protein`;
    }
    
    let displayDate = "...";
    if (t.date) {
      if (typeof t.date.toDate === 'function') {
        displayDate = t.date.toDate().toLocaleString();
      } else {
        displayDate = new Date(t.date).toLocaleString();
      }
    }

    item.innerHTML = `
      <span>
        <b>${displayDate}</b> ‚Äî ${text}
      </span>
      <button style="background:none;color:#c00" onclick="deleteTransaction(${originalIndex})">üóëÔ∏è</button>
    `;
    div.appendChild(item);
  });
}


// =======================================================
// ===== EXPORT / IMPORT / RESET (REFACTORED) =====
// =======================================================
function exportData() {
  const allData = {
    goals, rewards, notes, transactions, logs, totalPoints,
    workouts,
    meals, // √öJ
    archivedGoals,
    goalWeight: goalWeightSetting,
    goalWater: goalWaterSetting,
    goalCalories: goalCaloriesSetting,
    goalProtein: goalProteinSetting // √öJ
  };
  const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `FitGarden_Backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  logActivity("üíæ Adatok export√°lva");
}

async function importData(event) { // Make async
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async e => { // Make async
    try {
      const data = JSON.parse(e.target.result);
      goals = data.goals || [];
      rewards = data.rewards || [];
      notes = data.notes || [];
      transactions = data.transactions || [];
      logs = data.logs || [];
      workouts = data.workouts || [];
      meals = data.meals || []; // √öJ
      archivedGoals = data.archivedGoals || [];
      totalPoints = data.totalPoints || 0;
      
      goalWeightSetting = data.goalWeight || "";
      goalWaterSetting = data.goalWater || "";
      goalCaloriesSetting = data.goalCalories || "";
      goalProteinSetting = data.goalProtein || ""; // √öJ
      
      await saveDataToFirestore();
      
      renderAll();
      logActivity("üìÇ Adatok import√°lva");
      alert("Sikeres import√°l√°s! Minden adat friss√≠tve ‚úÖ");
    } catch {
      alert("‚ùå Hiba: a f√°jl nem megfelel≈ë form√°tum√∫!");
    }
  };
  reader.readAsText(file);
}

async function resetAll() { // Make async
  if (confirm("Biztosan t√∂r√∂lni szeretn√©l MINDENT? Ez v√©gleges!")) {
    goals = [];
    rewards = [];
    notes = [];
    transactions = [];
    logs = [];
    workouts = [];
    meals = []; // √öJ
    archivedGoals = [];
    totalPoints = 0;
    goalWeightSetting = "";
    goalWaterSetting = "";
    goalCaloriesSetting = "";
    goalProteinSetting = ""; // √öJ
    
    renderAll();
    await logActivity("‚ö†Ô∏è Teljes rendszer reset");
    alert("FitGarden √∫jraind√≠tva, minden t√∂r√∂lve ‚úÖ");
  }
}

function renderAll() {
  calculateDailyProgress();
  
  document.getElementById("totalPointsDisplay").textContent = totalPoints;
  
  renderGoals();
  renderRewards();
  renderNotes();
  renderLogs();
  
  updateAllSummaries();
  updateHistory();
  
  if(document.getElementById('workouts').classList.contains('active')) {
    renderWorkouts();
  }
  // √öJ: √âtkez√©s f√ºl renderel√©se, ha az akt√≠v
  if(document.getElementById('meals').classList.contains('active')) {
    renderMeals();
  }
}
</script>

</body>
</html>
